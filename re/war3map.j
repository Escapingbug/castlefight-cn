globals
group o
boolexpr V
string array E
integer X
real array O
real array R
real array I
real array A
real N
timer B
item array Coins
integer D
code GiveBountyVar
real GoldValue
integer array H
timer J
integer L
integer array M
integer array P
integer array q
integer array Q
integer array S
integer array T
integer array U
real array W
real array Y
real Z
real vv
string array ev
integer xv=0
integer ov=0
constant integer rv=$C8
integer LogId
boolean nv=true
boolean array notAgreeDraw
boolean array VotingNuke
boolean array SurrenderingPlayer
player Ov=null
constant force Rv=CreateForce()
constant trigger FirstBuilderTrigger=CreateTrigger()
integer Av
integer FirstNth
constant player Bv=Player($F)
constant timer cv=CreateTimer()
destructable array Cv
unit array dv
boolean Dv=false
integer Fv
integer gv
timer Gv=null
timer array hv
timer array Hv
timerdialog array jv
real array Jv
integer array kv
string array Kv
location array StartLocation
boolean array Lv
constant trigger mv=CreateTrigger()
boolean Mv=false
integer array Pv
integer qv
integer array Qv
integer sv
integer array Sv
real MapMinX
real MapMaxX
real MapMinY
real MapMaxY
unit array yv
integer Yv
integer Zv=32
string ve=" !\"#$%&'()*+,-./0123456789:;<=>?@ABCDEFGHIJKLMNOPQRSTUVWXYZ[\\]^_`abcdefghijklmnopqrstuvwxyz{|}~"
boolean ee=true
constant group ErasingGroup=CreateGroup()
player EraserIssuer
integer array UnitPrices
integer array BuildingToItsTrained
integer array PVToBuildingType
real array ne
integer array Ve
real array BuildingPVWoodCost
boolean array Xe
integer array RaceBuildingArena
integer array UpgradeFrom
integer array Ie
integer BuildingNums
integer ChunkBase
unit be
trigger array Be
unit ce
real array Ce
trigger array de
unit De
trigger array UnitSpellTrigger
integer array UnitSpellWTF
unit ge
unit Ge
timer he
real array He
boolean je=false
timer Je
boolean ke
boolean Ke
boolexpr le
integer Le
rect me
boolean Me=false
multiboard array pe
multiboard array Pe
integer array qe
integer array Qe
integer array se
multiboard Se=null
integer array te
integer Te=0
string array PlayerNames2
multiboarditem Ue
integer Round=0
constant timer ye=CreateTimer()
integer Ye
integer ze
integer Ze
integer vx
integer ex
real xx
hashtable ox
hashtable rx
constant group ix=CreateGroup()
constant group ax=CreateGroup()
rect nx
location Vx
boolean CommandAvailable=true
boolean Xx=false
boolean Ox=false
string Rx
integer Ix=$FA
integer Ax=$7D
integer Nx=1
integer bx=-1
integer Bx=0
integer cx=3
integer AutoBalanceVariation=2
integer Dx=-1
real IncomeTime=10.
real IncomeRate=1.
boolean EnableStreamingIncome=false
boolean Gx
boolean DuralRaceMode=false
boolean haveArtillery=false
boolean NoTreasureBox=false
boolean NoBounty=false
boolean HasSpecials=true
boolean HaveItem=true
boolean haveLegend=true
boolean HaveDS=true
boolean UniqueRaceMode=false
boolean CagingMode=true
boolean EnableCastleGates=false
boolean qx=false
boolean DominationMode=false
boolean NoAFK=false
boolean haveAI=false
integer TaxMode=0
integer LumberLimit=-1
integer NumberOfBans=0
integer Wx=0
integer CoinsEveryPeriod=0
integer RoundTimeLimit=0
integer zx=0
integer Zx=0
boolean array vo
integer array eo
location array xo
integer array oo
integer array ro
integer array io
integer array ao
rect array no
integer array Vo
integer array Eo
integer array Xo
string array ForceName
unit array Ro
real array Io
boolean array Ao
integer array No
location array BuilderInitialPosition
integer array Bo
integer array Co
integer array do
integer array Do
real array fo
integer array Fo
integer array go
integer array Go
integer array ho
integer array Ho
integer array jo
integer array PayedGolds
real array IncomeMultiplier
integer array Ko
constant force WesternForce=CreateForce()
constant force EasternForce=CreateForce()
constant force EmptyForce=CreateForce()
integer array PlayerForce
force array PerPlayerForce
unit array MainCastle
string array PlayerNames
boolean Qo
boolexpr so
trigger So=null
integer to=0
integer array To
integer array RaceWorkers
string array RaceNames
integer array wo
sound array RaceChooseSound
boolean array yo
integer raceNum=0
constant trigger zo=CreateTrigger()
integer array Zo
boolexpr vr
boolexpr er
boolexpr xr
unittype ir
real ar=.0
integer nr=-1
boolean array Vr
integer Er=0
timer Xr
integer array Rr
integer array Ir
integer array Ar
real array Nr
integer array br
integer array Br
integer array cr
integer array Cr
boolean array dr
integer array Dr
real array fr
hashtable Fr
real array gr
integer Gr
unit array hr
integer array Hr
boolean array jr
unit array Jr
force array kr
timer array Kr
boolean array lr
player array Lr
boolean mr=true
boolean Mr=false
trigger Pr=CreateTrigger()
real array qr
real array Qr
boolean sr
integer Sr
boolexpr tr
real Tr
real ur
integer Ur
real wr
real Wr
boolexpr yr
boolexpr Yr
unit zr
real Zr
integer array vi
integer array ei
trigger array xi
boolean array oi
real array ri
real array ai
boolean ni=true
real Vi
real Ei
real Xi
real Oi
constant timer IncomeTimer=CreateTimer()
real Ii=25.
real array Ai
integer array PlayerIncome
string bi
real array Bi
real ci
group Ci=CreateGroup()
timer di=CreateTimer()
string Di
timer fi=null
constant trigger Fi=CreateTrigger()
timer gi=CreateTimer()
timerdialog Gi
trigger hi=CreateTrigger()
dialog Hi=DialogCreate()
button array ji
boolean Ji=false
boolexpr ki
boolexpr Ki
boolexpr li
constant group Li=CreateGroup()
boolexpr mi
constant timer Mi=CreateTimer()
constant timer pi=CreateTimer()
boolexpr Pi
integer qi
boolean Qi
integer si='A01I'
integer erasingUnitTypeId
boolexpr EraserFilter
integer ErasingCount
integer ErasePossibilityBound
boolexpr Ui
integer wi='n01C'
player Wi
weathereffect yi
integer Yi='A0I8'
integer zi='A0I6'
integer array Zi
boolexpr va
boolexpr ea
boolexpr xa
integer array oa
constant group ra=CreateGroup()
boolexpr ia
integer aa
boolexpr na
constant group Va=CreateGroup()
boolexpr Ea
boolexpr Xa
integer Oa='A0BD'
integer array Ra
boolexpr Ia
boolexpr Aa
player ba
integer Ba
boolexpr Ca
group Da
integer fa='A0GD'
constant group Fa=CreateGroup()
boolexpr ga
boolexpr Ga
integer ha
integer array Ha
constant trigger ja=CreateTrigger()
boolexpr Ja
boolexpr ka
boolexpr Ka
constant timer la=CreateTimer()
unit array La
real array ma
real array Ma
integer pa=0
weathereffect Pa
real qa
real Qa
real sa
real Sa
boolexpr ta
integer array Ta
group ua=CreateGroup()
constant timer Ua=CreateTimer()
constant timerdialog wa=CreateTimerDialog(Ua)
integer IncreaseRound=-1
integer VotesStillNeeded
boolean array PlayerNotAgree
boolean SkippingModeWaiting=false
string Za=null
boolean GamePausing=false
trigger en=null
trigger xn=null
trigger on=null
integer array rn
timer AFKTimer=null
boolean RoundRunning=false
trigger Vn
trigger En
trigger DrawTrigger
boolexpr DrawFilter
integer Rn=0
constant timer In=CreateTimer()
boolean An=false
constant trigger Nn=CreateTrigger()
fogmodifier bn
fogmodifier Bn
constant sound cn=CreateSound("Sound\\Interface\\BattlenetDeath1.wav",false,false,false,$A,$A,"DefaultEAXON")
integer Cn=-1
integer dn
trigger Dn
rect EasternBuildArea=null
rect WesternBuildArea=null
rect gn=null
rect Gn=null
rect hn=null
sound HornOfCenariusSound=null
sound CreepAggroSound=null
sound HeroPitLordYesAttackSound=null
sound WispPissedSound=null
sound BloodElfEngineerWarcrySound=null
sound PeasantReadySound=null
sound HeroTinkerReadySound=null
sound MurlocPissedSound=null
sound EntReadySound=null
sound RunnerWarcrySound=null
sound BanditWhatSound=null
sound PeonReadySound=null
sound AcolyteWarcrySound=null
sound PitLordYesAttackSound=null
sound ChatroomTimerTickSound=null
sound HintSound=null
sound KoboldPissedSound=null
sound TranquilitySound=null
trigger PlayerLeaveTrigger=null
trigger BuyItemTrigger=null
trigger WorkerLeaveCastleTrigger=null
trigger Yn=null
trigger zn=null
trigger Zn=null
trigger vV=null
trigger eV=null
trigger xV=null
trigger oV=null
trigger rV=null
trigger iV=null
trigger aV=null
force nV
boolean VV=true
boolexpr EV
boolexpr XV
integer OV
player RV
real NV=.0
real bV=.0
boolexpr PassThruFilter=null
endglobals
native GetUpgradeWoodCost takes integer id returns integer
native GetUpgradeGoldCost takes integer id returns integer
native GetUpgradeLevel takes integer id returns integer
native GetUnitBuildTime takes integer unitid returns integer
native GetUnitWoodCost takes integer unitid returns integer
native GetUnitGoldCost takes integer unitid returns integer
function DV takes location fV,real FV,real gV returns location
return Location(GetLocationX(fV)+FV*Cos(gV*bj_DEGTORAD),GetLocationY(fV)+FV*Sin(gV*bj_DEGTORAD))
endfunction
function EnumDstrutablesInCircle takes nothing returns boolean
    local real dx=GetDestructableX(GetFilterDestructable())-NV
    local real dy=GetDestructableY(GetFilterDestructable())-bV
    return(dx*dx+dy*dy<=bj_enumDestructableRadius)
endfunction
function hV takes itemtype HV,integer jV returns nothing
    local group g
    set bj_stockPickedItemType=HV
    set bj_stockPickedItemLevel=jV
    set g=CreateGroup()
    call GroupEnumUnitsOfType(g,"marketplace",PassThruFilter)
    call ForGroup(g,function UpdateEachStockBuildingEnum)
    call DestroyGroup(g)
    set g=null
endfunction
function JV takes nothing returns nothing
    local integer pickedItemId
    local itemtype kV
    local integer KV=0
    local integer lV=0
    local integer i
    set i=1
    loop
        if(bj_stockAllowedPermanent[i])then
            set lV=lV+1
            if(GetRandomInt(1,lV)==1)then
                set kV=ITEM_TYPE_PERMANENT
                set KV=i
            endif
        endif
        if(bj_stockAllowedCharged[i])then
            set lV=lV+1
            if(GetRandomInt(1,lV)==1)then
                set kV=ITEM_TYPE_CHARGED
                set KV=i
            endif
        endif
        if(bj_stockAllowedArtifact[i])then
            set lV=lV+1
            if(GetRandomInt(1,lV)==1)then
                set kV=ITEM_TYPE_ARTIFACT
                set KV=i
            endif
        endif
        set i=i+1
        exitwhen i>$A
    endloop
    if(lV==0)then
    set kV=null
    return
    endif
    call hV(kV,KV)
    set kV=null
endfunction

function DealStock takes nothing returns nothing
    call JV()
    call TimerStart(bj_stockUpdateTimer,bj_STOCK_RESTOCK_INTERVAL,true,function JV)
endfunction

function AlwaysTrue takes nothing returns boolean
    return true
endfunction
function cj_group_copy_75hJKJ3745gf takes nothing returns nothing
call GroupAddUnit(o,GetEnumUnit())
endfunction
function QV takes nothing returns boolean
    return true
endfunction
function sV takes nothing returns nothing
    set V=Condition(function QV)
endfunction
function SV takes nothing returns string
local integer i=GetRandomInt(0,X)
local string s=E[i]
set E[i]=E[X]
set X=X-1
return s
endfunction
function tV takes nothing returns nothing
set E[0]="General"
set E[1]="FanToMace"
set E[2]="antiPOD"
set E[3]="ADMIN"
set E[4]="Mr.Jack"
set E[5]="C|c00ff008000l|r"
set E[6]="O|c00ff00ff:|r"
set E[7]=":|c00ff8040O|r"
set E[8]="INqUSitor"
set E[9]="Your_Death"
set E[$A]="NanYanoi"
set E[$B]="Impale"
set E[$C]="Proxima"
set E[$D]="13|c00ff0000th|r"
set E[$E]="Dumb"
set E[$F]="ProFan"
set E[16]="IWin"
set E[17]="Master"
set E[18]="JustNiceGuy"
set E[19]="Kasr'Kin"
set E[20]="Pr0"
set E[21]="Imperor"
set E[22]="FBI"
set E[23]="Scheemer"
set E[24]="WTFG0D"
set E[25]="Dude"
set E[26]="YourDaddy"
set E[27]="GreatWarrior"
set E[28]="Shadow"
set E[29]="No_Ob"
set E[30]="Shurf"
set E[31]="AI'("
set E[32]="Grrr!"
set E[33]="Brain"
set E[34]="L|c0000ff40ord|r"
set E[35]="Princess"
set X=35
endfunction
function TV takes boolean uV returns nothing
if(haveArtillery or uV)then
set N=128.
else
set N=128.*2.
endif
set I[0]=-1.*N
set A[0]=1.*N
set I[1]=-1.*N
set A[1]=-1.*N
set I[2]=1.*N
set A[2]=-1.*N
set I[3]=1.*N
set A[3]=1.*N
set O[0]=5508.
set R[0]=512.
set O[1]=5508.
set R[1]=-1.*512.
set O[2]=-1.*5508.
set R[2]=-1.*512.
set O[3]=-1.*5508.
set R[3]=512.
endfunction
function UV takes integer wV returns nothing
set R[wV]=R[wV]+(A[wV])
if(RAbsBJ(R[wV])>2172.)then
set O[wV]=O[wV]+(I[wV])
if(R[wV]>0)then
set R[wV]=512.
else
set R[wV]=-1*512.
endif
if(RAbsBJ(O[wV])<1664.)then
call TV(true)
return
endif
endif
endfunction
function RemoveCoins takes nothing returns nothing
    local integer i=0
    loop
    call RemoveItem(Coins[i])
    set i=i+1
    exitwhen i>=D
    endloop
    call TimerStart(B,31.25,false,GiveBountyVar)
endfunction
function CreateCoins takes nothing returns nothing
    local integer i=0
    set GoldValue=GoldValue+(3.)
    loop
        set Coins[i]=CreateItem('I000',GetRandomReal(GetRectMinX(WesternBuildArea),GetRectMaxX(WesternBuildArea)),GetRandomReal(GetRectMinY(WesternBuildArea),GetRectMaxY(WesternBuildArea)))
        call DestroyEffect(AddSpecialEffect("Abilities\\Spells\\Demon\\DarkPortal\\DarkPortalTarget.mdl",GetItemX(Coins[i]),GetItemY(Coins[i])))
        set Coins[i+1]=CreateItem('I000',GetRandomReal(GetRectMinX(EasternBuildArea),GetRectMaxX(EasternBuildArea)),GetRandomReal(GetRectMinY(EasternBuildArea),GetRectMaxY(EasternBuildArea)))
        call DestroyEffect(AddSpecialEffect("Abilities\\Spells\\Demon\\DarkPortal\\DarkPortalTarget.mdl",GetItemX(Coins[i+1]),GetItemY(Coins[i+1])))
        set i=i+(2)
        exitwhen i>=D
    endloop
    call TimerStart(B,4.75,false,function RemoveCoins)
endfunction
function GiveBounty takes nothing returns nothing
    call DisplayTextToForce(bj_FORCE_ALL_PLAYERS,"|cffFFFF80Bounty incoming!|r")
    call TimerStart(B,4.,false,function CreateCoins)
endfunction
function PlayerFoundGold takes player p returns nothing
    local integer id=GetPlayerId(p)
    local integer goldAmount=R2I(IncomeMultiplier[id]*(8.+GoldValue))
    set Go[id]=Go[id]+1
    call DisplayTextToPlayer(p,.0,.0,"|cffFFFF80You found |cffFFFF00"+I2S(goldAmount)+"|cffFFFF80 gold!|r")
    set ho[id]=ho[id]+(goldAmount)
    call AdjustPlayerStateBJ(goldAmount,p,PLAYER_STATE_RESOURCE_GOLD)
endfunction
function vE takes boolean eE returns nothing
if(B==null)then
return
endif
call PauseTimer(B)
if(eE)then
call PauseTimer(B)
call DestroyTimer(B)
set B=null
endif
endfunction
function StartBounty takes nothing returns nothing
    local integer i=0
    if(CoinsEveryPeriod<=0)then
        return
    endif
    if(B==null)then
        set B=CreateTimer()
        set D=CoinsEveryPeriod*2
    endif
    set GoldValue=.0
    loop
        set H[i]=-1
        set i=i+1
        exitwhen i>=4
    endloop
    set H[4]=0
    set H[5]=0
    call TimerStart(B,40.,false,function GiveBounty)
endfunction
function SetupBounty takes nothing returns nothing
    set B=null
    set GiveBountyVar=function GiveBounty
endfunction
function rE takes nothing returns nothing
call DisplayTextToForce(bj_FORCE_ALL_PLAYERS,"|cffC6FF00Icy Environment|r has been selected. Note that a custom environment has no influence on gameplay.")
set Q[0]='Ibsq'
set Q[1]='Iice'
set Q[2]='Isnw'
set Q[3]='Idki'
set Q[4]='Nsnw'
set Q[5]='Nsnr'
set Q[6]='Irbk'
set Q[7]='Nsnw'
set S[0]='ITtw'
set T[0]=$A
set S[1]='ITtc'
set T[1]=3
set U[0]='B00M'
set Y[0]=.5
set W[0]=.0
set U[1]='B00N'
set Y[1]=.5
set W[1]=.0
set U[2]='B00O'
set Y[2]=.5
set W[2]=.0
set U[3]='B00P'
set Y[3]=.5
set W[3]=.0
set U[4]='B00G'
set Y[4]=.97
set W[4]=-30.
call SetTerrainFogExBJ(0,1200.,6000.,0,80.,80.,100.)
endfunction
function iE takes nothing returns nothing
call DisplayTextToForce(bj_FORCE_ALL_PLAYERS,"|cffC6FF00Lava Environment|r has been selected. Note that a custom environment has no influence on gameplay.")
set Q[0]='Ddkr'
set Q[1]='Dgrs'
set Q[2]='Dlvc'
set Q[3]='Dlav'
set Q[4]='Drds'
set Q[5]='Ddrt'
set Q[6]='Dsqd'
set Q[7]='Dgrs'
set S[0]='B001'
set T[0]=8
set S[1]='B000'
set T[1]=$A
set U[0]='B00H'
set Y[0]=1.1
set W[0]=.0
set U[1]='B00J'
set Y[1]=1.1
set W[1]=.0
set U[2]='B00K'
set Y[2]=1.1
set W[2]=.0
set U[3]='B00L'
set Y[3]=1.1
set W[3]=.0
set U[4]='B00I'
set Y[4]=1.
set W[4]=-70.
call SetTerrainFogExBJ(0,$3E8,3000.,0,50.,.0,.0)
call SetWaterBaseColorBJ('d',.0,.0,0)
endfunction
function aE takes nothing returns nothing
call DisplayTextToForce(bj_FORCE_ALL_PLAYERS,"|cffC6FF00Icy Environment|r has been selected. Note that a custom environment has no influence on gameplay.")
set Q[0]='Ibsq'
set Q[1]='Iice'
set Q[2]='Isnw'
set Q[3]='Idki'
set Q[4]='Nsnw'
set Q[5]='Nsnr'
set Q[6]='Irbk'
set Q[7]='Nsnw'
set S[0]='ITtw'
set T[0]=$A
set S[1]='ITtc'
set T[1]=3
set U[0]='B007'
set Y[0]=1.2
set W[0]=.0
set U[1]='B008'
set Y[1]=1.2
set W[1]=.0
set U[2]='B009'
set Y[2]=1.2
set W[2]=.0
set U[3]='B00A'
set Y[3]=1.2
set W[3]=.0
set U[4]='B00G'
set Y[4]=.97
set W[4]=-30.
endfunction
function nE takes nothing returns nothing
call DisplayTextToForce(bj_FORCE_ALL_PLAYERS,"|cffC6FF00Barrens Environment|r has been selected. Note that a custom environment has no influence on gameplay.")
set Q[0]='Klgb'
set Q[1]='Odrt'
set Q[2]='Bdrt'
set Q[3]='Ofst'
set Q[4]='Bdrh'
set Q[5]='Bgrr'
set Q[6]='Bdsd'
set Q[7]='Bdrr'
set S[0]='ITtw'
set T[0]=$A
set S[1]='ITtc'
set T[1]=3
set U[0]='B007'
set Y[0]=1.2
set W[0]=.0
set U[1]='B008'
set Y[1]=1.2
set W[1]=.0
set U[2]='B009'
set Y[2]=1.2
set W[2]=.0
set U[3]='B00A'
set Y[3]=1.2
set W[3]=.0
set U[4]='B00G'
set Y[4]=.97
set W[4]=-30.
call SetTerrainFogEx(0,1000.,8000.,.0,.686,.369,.098)
call SetAmbientDaySound("BarrensDay")
call SetAmbientNightSound("BarrensNight")
endfunction
function VE takes nothing returns nothing
local destructable EE=GetEnumDestructable()
local integer i=0
local real x
local real y
local real z
local location l
loop
exitwhen i>1
if GetDestructableTypeId(EE)==P[i]then
set x=GetDestructableX(EE)
set y=GetDestructableY(EE)
call RemoveDestructable(EE)
call CreateDestructable(S[i],x,y,GetRandomReal(.0,360.),1,GetRandomInt(0,T[i]-1))
return
endif
set i=i+1
endloop
set EE=null
endfunction
function XE takes nothing returns nothing
local real x=0
local real y=L*512
local real zG
local real ZG
local integer i
local integer j
if(L<50)then
loop
exitwhen(y>Z)
set x=0
loop
exitwhen(x>vv)
set i=0
loop
exitwhen i>3
set zG=I2R((i/ 2)*2-1)*x
set ZG=I2R(ModuloInteger(i,2)*2-1)*y
set j=0
loop
exitwhen j>7
if(GetTerrainType(zG,ZG)==M[j])then
call SetTerrainType(zG,ZG,Q[j],-1,1,0)
exitwhen true
endif
set j=j+1
endloop
set i=i+1
endloop
set x=x+$80
endloop
set y=y+$80
if(ModuloReal(y,512)==0)then
set L=L+1
call TimerStart(J,.0,false,function XE)
return
endif
endloop
set L=50
call TimerStart(J,.0,false,function XE)
return
elseif L==50 then
set j=0
loop
exitwhen j>6
set M[j]=Q[j]
set j=j+1
endloop
call EnumDestructablesInRectAll(bj_mapInitialPlayableArea,function VE)
set j=0
loop
exitwhen j>1
set P[j]=S[j]
set j=j+1
endloop
set j=0
loop
exitwhen j>4
set q[j]=U[j]
set j=j+1
endloop
call PauseTimer(J)
call DestroyTimer(J)
set J=null
endif
endfunction
function Log takes string s returns nothing
    local integer l=StringLength(s)
    local integer lp=0
    loop
    if(l+ov>rv)then
    set ev[xv]=ev[xv]+SubString(s,lp,lp+rv-ov)
    set lp=lp+(rv-ov)
    set l=l-(rv-ov)
    set xv=xv+1
    set ov=0
    else
    set ev[xv]=ev[xv]+SubString(s,lp,8192)+"
    "
    set ov=ov+(l)
    set l=0
    endif
    exitwhen(l==0)
    endloop
endfunction
function SaveLog takes nothing returns nothing
    local integer i=0
    call PreloadGenClear()
    call PreloadGenStart()
    loop
    exitwhen(i>xv)
    call Preload("\")
    "+ev[i]+"
    (\"")
    set i=i+1
    endloop
    call PreloadGenEnd("Replay\\CF"+I2S(LogId)+".log")
endfunction
function DebugLog___DebugLogOnTimer takes nothing returns nothing
    call SaveLog()
endfunction
function SetupDebugLog takes nothing returns nothing
    set LogId=GetRandomInt(0,$186A0)
    call Log("Castle Fight log")
    call SaveLog()
endfunction

function bE takes nothing returns nothing
    local integer i=0
    loop
        if(GetPlayerController(Player(i))==MAP_CONTROL_USER and GetPlayerSlotState(Player(i))==PLAYER_SLOT_STATE_PLAYING and(IsPlayerInForce(Player(i),WesternForce)or IsPlayerInForce(Player(i),EasternForce)))then
            set notAgreeDraw[i]=true
            set VotingNuke[i]=false
            set SurrenderingPlayer[i]=false
        endif
        set i=i+1
        exitwhen i>$B
    endloop
    set nv=false
endfunction

function PlayersAgreeVote takes nothing returns boolean
    local integer i=0
    loop
        if(notAgreeDraw[i])then
            return false
        endif
        set i=i+1
        exitwhen i>$B
    endloop
    set nv=true
    return true
endfunction

function PlayersAgreeNuke takes nothing returns boolean
    local integer i=0
    loop
    if(GetPlayerController(Player(i))==MAP_CONTROL_USER and GetPlayerSlotState(Player(i))==PLAYER_SLOT_STATE_PLAYING and(IsPlayerInForce(Player(i),WesternForce)or IsPlayerInForce(Player(i),EasternForce)))then
    if(not VotingNuke[i])then
    return false
    endif
    endif
    set i=i+1
    exitwhen i>$B
    endloop
    return true
endfunction
function AllAgreeSurrender takes integer surrenderPlayerIdx returns boolean
    local integer i=0
    local integer j=6
    if(surrenderPlayerIdx>5)then
        set i=i+(5)
        set j=j+(5)
    endif

    loop
        if(GetPlayerController(Player(i))==MAP_CONTROL_USER and GetPlayerSlotState(Player(i))==PLAYER_SLOT_STATE_PLAYING and(IsPlayerInForce(Player(i),WesternForce)or IsPlayerInForce(Player(i),EasternForce)))then
            if(not SurrenderingPlayer[i])then
                return false
            endif
        endif
        set i=i+1
        exitwhen i>j
    endloop
    return true
endfunction
function IssueDraw takes integer playerIdx returns nothing
    if(nv)then
        return
    endif

    if(notAgreeDraw[playerIdx])then
        call DisplayTextToForce(bj_FORCE_ALL_PLAYERS,PlayerNames[playerIdx]+" has voted for a draw!")
        set notAgreeDraw[playerIdx]=false
        if(PlayersAgreeVote())then
            call TriggerExecute(DrawTrigger)
        endif
    else
        call DisplayTextToPlayer(Player(playerIdx),.0,.0,"|cffFF0000You have already voted for a draw!|r")
    endif
endfunction

function NukeUnit takes nothing returns nothing
    if(IsUnitType(GetEnumUnit(),UNIT_TYPE_SAPPER))then
    call ExplodeUnitBJ(GetEnumUnit())
    endif
endfunction

function Nuke takes nothing returns nothing
    local integer i=0
    loop
        set VotingNuke[i]=false
        set i=i+1
        exitwhen i>$B
    endloop
    call GroupEnumUnitsInRect(ErasingGroup,bj_mapInitialPlayableArea,null)
    call ForGroup(ErasingGroup,function NukeUnit)
endfunction
function IssueNuke takes integer issuePlayer returns nothing
    if(not VotingNuke[issuePlayer])then
        call DisplayTextToForce(bj_FORCE_ALL_PLAYERS,PlayerNames[issuePlayer]+" has voted for a nuke!")
        set VotingNuke[issuePlayer]=true
    if(PlayersAgreeNuke())then
        call Nuke()
    endif
    else
    call DisplayTextToPlayer(Player(issuePlayer),.0,.0,"|cffFF0000You have already voted for a nuke!|r")
    endif
endfunction
function IssueSurrender takes integer issuePlayer returns nothing
    if(not SurrenderingPlayer[issuePlayer])then
        call DisplayTextToForce(bj_FORCE_ALL_PLAYERS,PlayerNames[issuePlayer]+" has voted for surrender!")
    set SurrenderingPlayer[issuePlayer]=true
    if(AllAgreeSurrender(issuePlayer))then
        call KillUnit(MainCastle[PlayerForce[issuePlayer]])
        call DisplayTextToForce(bj_FORCE_ALL_PLAYERS,ForceName[PlayerForce[issuePlayer]]+" has voted for surrender!")
    endif
    else
    call DisplayTextToPlayer(Player(issuePlayer),.0,.0,"|cffFF0000You have already voted for surrender!|r")
    endif
endfunction
function hE takes integer HE returns string
if(HE==1)then
return"first"
endif
if(HE==2)then
return"second"
endif
if(HE==3)then
return"third"
endif
return"fourth"
endfunction
function FirstBuilderBountyAction takes nothing returns nothing
    local integer JE
    local player p=GetTriggerPlayer()
    if(not IsPlayerInForce(p,Rv))then
    if(Ov==null)then
    set Ov=p
    endif
    call AdjustPlayerStateBJ(Av,GetTriggerPlayer(),PLAYER_STATE_RESOURCE_GOLD)
    call DisplayTextToPlayer(p,.0,.0,"|cffFFFF80You receive |cffFFCC00"+I2S(Av)+"|cffFFFF80 gold for being the "+hE(FirstNth)+" player that finishes a structure!")
    set JE=GetPlayerId(p)
    set Ho[JE]=Ho[JE]+(Av)
    set Av=Av-(5)
    set FirstNth=FirstNth+1
    if(FirstNth>4)then
        call DisableTrigger(FirstBuilderTrigger)
    else
        call ForceAddPlayer(Rv,p)
    endif
    endif
endfunction
function kE takes nothing returns nothing
    set Ov=null
    call ForceClear(Rv)
    set Av=20
    set FirstNth=1
    call EnableTrigger(FirstBuilderTrigger)
endfunction
function SetupFirstBuilderBounty takes nothing returns nothing
    call TriggerAddAction(FirstBuilderTrigger,function FirstBuilderBountyAction)
    call TriggerRegisterAnyUnitEventBJ(FirstBuilderTrigger,EVENT_PLAYER_UNIT_CONSTRUCT_FINISH)
    call DisableTrigger(FirstBuilderTrigger)
endfunction
function lE takes nothing returns nothing
    call DestroyEffect(AddSpecialEffect("Abilities\\Spells\\NightElf\\Barkskin\\BarkSkinTarget.mdl",.0,.0))
    call DestroyEffect(AddSpecialEffect("Abilities\\Spells\\Other\\HowlOfTerror\\HowlCaster.mdl",.0,.0))
    call DestroyEffect(AddSpecialEffect("Units\\NightElf\\Wisp\\WispExplode.mdl",.0,.0))
    call DestroyEffect(AddSpecialEffect("Abilities\\Spells\\Items\\AIam\\AIamTarget.mdl",.0,.0))
    call DestroyEffect(AddSpecialEffect("Abilities\\Spells\\Human\\DispelMagic\\DispelMagicTarget.mdl",.0,.0))
    call DestroyEffect(AddSpecialEffect("Abilities\\Spells\\Undead\\DeathCoil\\DeathCoilSpecialArt.mdl",.0,.0))
    call DestroyEffect(AddSpecialEffect("Abilities\\Spells\\Orc\\AncestralSpirit\\AncestralSpiritCaster.mdl",.0,.0))
    call DestroyEffect(AddSpecialEffect("Abilities\\Spells\\Human\\Resurrect\\ResurrectCaster.mdl",.0,.0))
    call DestroyEffect(AddSpecialEffect("Abilities\\Spells\\Undead\\DeathPact\\DeathPactTarget.mdl",.0,.0))
    call DestroyEffect(AddSpecialEffect("Abilities\\Spells\\Undead\\ReplenishHealth\\ReplenishHealthCasterOverhead.mdl",.0,.0))
    call DestroyEffect(AddSpecialEffect("Objects\\Spawnmodels\\Naga\\NagaDeath\\NagaDeath.mdl",.0,.0))
    call DestroyEffect(AddSpecialEffect("Abilities\\Spells\\Orc\\FeralSpirit\\feralspiritdone.mdl",.0,.0))
    call DestroyEffect(AddSpecialEffect("Abilities\\Spells\\Human\\Avatar\\AvatarCaster.mdl",.0,.0))
    call DestroyEffect(AddSpecialEffect("Abilities\\Spells\\Items\\TomeOfRetraining\\TomeOfRetrainingCaster.mdl",.0,.0))
    call DestroyEffect(AddSpecialEffect("Abilities\\Spells\\Human\\MarkOfChaos\\MarkOfChaosTarget.mdl",.0,.0))
    call DestroyEffect(AddSpecialEffect("Abilities\\Spells\\NightElf\\BattleRoar\\RoarCaster.mdl",.0,.0))
    call DestroyEffect(AddSpecialEffect("Abilities\\Spells\\Human\\Polymorph\\PolyMorphTarget.mdl",.0,.0))
    call DestroyEffect(AddSpecialEffect("Abilities\\Spells\\Human\\ControlMagic\\ControlMagicTarget.mdl",.0,.0))
    call DestroyEffect(AddSpecialEffect("Abilities\\Spells\\Items\\AIda\\AIdaCaster.mdl",.0,.0))
    call DestroyEffect(AddSpecialEffect("Abilities\\Spells\\Human\\Feedback\\SpellBreakerAttack.mdl",.0,.0))
    call DestroyEffect(AddSpecialEffect("Abilities\\Spells\\Human\\Avatar\\AvatarCaster.mdl",.0,.0))
    call DestroyEffect(AddSpecialEffect("Abilities\\Spells\\Items\\AIvi\\AIviTarget.mdl",.0,.0))
    call DestroyEffect(AddSpecialEffect("Abilities\\Spells\\Items\\TomeOfRetraining\\TomeOfRetrainingCaster.mdl",.0,.0))
    call DestroyEffect(AddSpecialEffect("Abilities\\Spells\\Demon\\DarkPortal\\DarkPortalTarget.mdl",.0,.0))
    call DestroyEffect(AddSpecialEffect("Abilities\\Spells\\Other\\Transmute\\PileofGold.mdl",.0,.0))
    call DestroyEffect(AddSpecialEffect("Abilities\\Spells\\Items\\AIil\\AIilTarget.mdl",.0,.0))
    call DestroyEffect(AddSpecialEffect("Abilities\\Spells\\Orc\\MirrorImage\\MirrorImageDeathCaster.mdl",.0,.0))
    call DestroyEffect(AddSpecialEffect("Abilities\\Spells\\Human\\MarkOfChaos\\MarkOfChaosDone.mdl",.0,.0))
    call DestroyEffect(AddSpecialEffect("Abilities\\Spells\\Human\\MassTeleport\\MassTeleportCaster.mdl",.0,.0))
    call DestroyEffect(AddSpecialEffect("Objects\\Spawnmodels\\NightElf\\NEDeathMedium\\NEDeath.mdl",.0,.0))
    call DestroyEffect(AddSpecialEffect("Objects\\Spawnmodels\\NightElf\\EntBirthTarget\\EntBirthTarget.mdl",.0,.0))
    call DestroyEffect(AddSpecialEffect("mdx\\sfx\\sin2.mdx",.0,.0))
    call DestroyEffect(AddSpecialEffect("Abilities\\Weapons\\Bolt\\BoltImpact.mdl",.0,.0))
    call DestroyEffect(AddSpecialEffect("mdx\\sfx\\]TrapUp.mdx",.0,.0))
    call DestroyEffect(AddSpecialEffect("Abilities\\Spells\\Human\\HolyBolt\\HolyBoltSpecialArt.mdl",.0,.0))
    call DestroyEffect(AddSpecialEffect("Abilities\\Spells\\Undead\\ReplenishMana\\ReplenishManaCasterOverhead.mdl",.0,.0))
    call DestroyEffect(AddSpecialEffect("Abilities\\Spells\\Other\\Volcano\\VolcanoDeath.mdl",.0,.0))
    call DestroyEffect(AddSpecialEffect("Abilities\\Weapons\\Bolt\\BoltImpact.mdl",.0,.0))
    call DestroyEffect(AddSpecialEffect("mdx\\sfx\\FireTrapUp.mdx",.0,.0))
    call DestroyEffect(AddSpecialEffect("Abilities\\Spells\\Human\\Heal\\HealTarget.mdl",.0,.0))
    call DestroyEffect(AddSpecialEffect("Abilities\\Spells\\Undead\\DeathPact\\DeathPactCaster.mdl",.0,.0))
    call KillUnit(CreateUnit(Player($D),'e008',.0,.0,.0))
    call KillUnit(CreateUnit(Player($D),'h00O',.0,.0,.0))
    call KillUnit(CreateUnit(Player($D),'u006',.0,.0,.0))
    call KillUnit(CreateUnit(Player($D),'h00C',.0,.0,.0))
    call KillUnit(CreateUnit(Player($D),'h019',.0,.0,.0))
    call KillUnit(CreateUnit(Player($D),'h00E',.0,.0,.0))
    call KillUnit(CreateUnit(Player($D),'h017',.0,.0,.0))
    call KillUnit(CreateUnit(Player($D),'h089',.0,.0,.0))
    call KillUnit(CreateUnit(Player($D),'h00P',.0,.0,.0))
    call KillUnit(CreateUnit(Player($D),'h018',.0,.0,.0))
    call KillUnit(CreateUnit(Player($D),'h06P',.0,.0,.0))
    call KillUnit(CreateUnit(Player($D),'h01A',.0,.0,.0))
    call KillUnit(CreateUnit(Player($D),'h051',.0,.0,.0))
    call KillUnit(CreateUnit(Player($D),'h06N',.0,.0,.0))
endfunction
function LE takes nothing returns nothing
    call lE()
endfunction
function mE takes nothing returns nothing
local integer i=0
local unit u
loop
if(dv[i]==null)then
set u=CreateUnit(Bv,'h06B',GetDestructableX(Cv[i]),GetDestructableY(Cv[i]),270.)
call SetUnitFlyHeight(u,30.,85.)
call IssueTargetOrderById(u,$D0003,Cv[i])
set dv[i]=u
endif
set i=i+1
exitwhen i>=24
endloop
set u=null
endfunction
function NatureWispControl_StartCalling takes nothing returns nothing
call TimerStart(cv,6.,true,function mE)
endfunction
function ME takes nothing returns nothing
local integer i=0
call PauseTimer(cv)
loop
if(dv[i]!=null)then
call RemoveUnit(dv[i])
set dv[i]=null
endif
set i=i+1
exitwhen i>=24
endloop
endfunction
function pE takes nothing returns nothing
local destructable d=GetEnumDestructable()
local integer id=GetDestructableTypeId(d)
if(Fv<gv and(id=='ATtc' or id=='ATtr' or id=='B001' or id=='B000' or id=='ITtw' or id=='ITtc')and GetRandomInt(0,99)<85)then
call SetDestructableInvulnerable(d,true)
set Cv[Fv]=d
set Fv=Fv+1
endif
set d=null
endfunction
function PE takes nothing returns nothing
local rect r
if(Dv)then
return
endif
set Dv=true
set r=Rect(MapMaxX,-2300.,-MapMaxX,-MapMaxY)
set Fv=0
set gv=$C
call EnumDestructablesInRect(r,null,function pE)
call RemoveRect(r)
set r=Rect(MapMaxX,2300.,-MapMaxX,MapMaxY)
set gv=24
call EnumDestructablesInRect(r,null,function pE)
call RemoveRect(r)
set r=null
endfunction
function qE takes nothing returns nothing
call PlaySoundBJ(CreepAggroSound)
if(RoundTimeLimit>0 and Ov!=null)then
if(IsPlayerInForce(Ov,WesternForce))then
call TriggerExecute(En)
else
call TriggerExecute(Vn)
endif
return
endif
call TriggerExecute(DrawTrigger)
endfunction
function QE takes nothing returns nothing
    call DisplayTimedTextToForce(bj_FORCE_ALL_PLAYERS,10.,"1 minute before round ends!")
    call TimerStart(Gv,60.,false,function qE)
    call PlaySoundBJ(CreepAggroSound)
endfunction
function sE takes nothing returns nothing
    call DisplayTimedTextToForce(bj_FORCE_ALL_PLAYERS,10.,"3 minutes before round ends!")
    call TimerStart(Gv,120.,false,function QE)
    call PlaySoundBJ(CreepAggroSound)
endfunction
function SE takes nothing returns nothing
    call DisplayTimedTextToForce(bj_FORCE_ALL_PLAYERS,10.,"Warnning! 5 minutes before round ends!")
    call TimerStart(Gv,120.,false,function sE)
    call PlaySoundBJ(CreepAggroSound)
endfunction
function tE takes nothing returns nothing
    if(Gv!=null)then
        call PauseTimer(Gv)
    endif
    if(RoundTimeLimit!=0)then
        if(Gv==null)then
            set Gv=CreateTimer()
        endif
        call TimerStart(Gv,(IAbsBJ(RoundTimeLimit)-5)*60.,false,function SE)
    endif
endfunction
function TE takes nothing returns nothing
local integer id=LoadInteger(rx,30,GetHandleId(GetExpiredTimer()))
set kv[id]=kv[id]-1
if(kv[id]<0)then
if(GetLocalPlayer()==Player(id))then
call StartSound(HintSound)
endif
set kv[id]=3
call TimerDialogSetTitle(jv[id],Kv[3])
call TimerStart(hv[id],Jv[id],false,function TE)
call TimerStart(Hv[id],Jv[id]+3,false,null)
return
endif
if(GetLocalPlayer()==Player(id))then
call StartSound(ChatroomTimerTickSound)
endif
call TimerDialogSetTitle(jv[id],Kv[kv[id]])
call TimerStart(hv[id],1.,false,function TE)
endfunction
function uE takes integer p,real UE returns nothing
if(hv[p]==null)then
set hv[p]=CreateTimer()
set Hv[p]=CreateTimer()
set jv[p]=CreateTimerDialog(Hv[p])
call SaveInteger(rx,30,GetHandleId(hv[p]),p)
endif
call TimerDialogDisplay(jv[p],GetLocalPlayer()==Player(p))
set Jv[p]=UE-3
set kv[p]=3
call TimerDialogSetTitle(jv[p],Kv[3])
call TimerStart(hv[p],Jv[p],false,function TE)
call TimerStart(Hv[p],Jv[p]+3,false,null)
endfunction
function wE takes integer p returns boolean
if(Jv[p]<=.0)then
return false
endif
call PauseTimer(hv[p])
set Jv[p]=.0
call PauseTimer(Hv[p])
call TimerDialogDisplay(jv[p],false)
return true
endfunction
function WE takes boolean yE returns nothing
local integer i=0
if(yE)then
loop
if(Jv[i]>.0)then
call TimerDialogSetTitle(jv[i],Kv[3])
call TimerStart(hv[i],Jv[i],false,function TE)
call TimerStart(Hv[i],Jv[i]+3,false,null)
endif
set i=i+1
exitwhen i>$B
endloop
return
endif
loop
if(Jv[i]>.0)then
call PauseTimer(hv[i])
call PauseTimer(Hv[i])
endif
set i=i+1
exitwhen i>$B
endloop
endfunction
function YE takes nothing returns nothing
    set Kv[0]="!!!"
    set Kv[1]=".!!"
    set Kv[2]="..!"
    set Kv[3]="..."
endfunction
function GetInitialBuilderPos takes boolean isWestern returns location
    local integer i=0
    if(not isWestern)then
        set i=6
    endif
    loop
        if(not Lv[i])then
            set Lv[i]=true
            return StartLocation[i]
        endif
        set i=i+1
        exitwhen i>$B
    endloop
    call DisplayTextToForce(bj_FORCE_ALL_PLAYERS,"GENERAL FAILURE AT MODULE 'SP:GMR'. PLEASE REPORT ABOUT THIS BUG!")
    return Location(.0,.0)
endfunction
function vX takes location eX returns nothing
local integer i=0
loop
if(eX==StartLocation[i])then
set Lv[i]=false
return
endif
set i=i+1
exitwhen i>$B
endloop
endfunction
function SetupStartLocation takes nothing returns nothing
    local integer i=0
    loop
        set StartLocation[i]=GetPlayerStartLocationLoc(Player(i))
        set i=i+1
        exitwhen i>$B
    endloop
endfunction
function oX takes nothing returns nothing
local destructable d=GetTriggerDestructable()
local timer t=CreateTimer()
call TimerStart(t,30.,false,null)
loop
call TriggerSleepAction(1.)
exitwhen TimerGetRemaining(t)<.5
endloop
call PauseTimer(t)
call DestroyTimer(t)
set t=null
call DestructableRestoreLife(d,GetDestructableMaxLife(d),true)
set d=null
endfunction
function rX takes nothing returns nothing
    call TriggerRegisterDeathEvent(mv,GetEnumDestructable())
endfunction
function iX takes nothing returns boolean
local destructable d=GetFilterDestructable()
local integer t=GetDestructableTypeId(d)
local boolean aX=t=='ATtc' or t=='ATtr' or t=='B001' or t=='B000' or t=='ITtw' or t=='ITtc'
set d=null
return aX
endfunction
function nX takes nothing returns nothing
local boolexpr f
if(Mv)then
return
endif
set Mv=true
set f=Filter(function iX)
call EnumDestructablesInRect(bj_mapInitialPlayableArea,f,function rX)
call DestroyBoolExpr(f)
set f=null
call TriggerAddAction(mv,function oX)
endfunction
function VX takes nothing returns nothing
local integer i=0
local integer j
local integer k
local integer EX
set qv=0
set sv=0
loop
set Sv[i]=RaceWorkers[i]
set i=i+1
exitwhen i>=raceNum
endloop
set i=0
loop
set EX=Sv[i]
if(yo[i])then
set Pv[qv]=EX
set qv=qv+1
endif
if(yo[raceNum+i])then
set Qv[sv]=EX
set sv=sv+1
endif
set i=i+1
exitwhen i>=raceNum
endloop
endfunction
function XX takes integer EX,boolean OX returns nothing
local integer i=0
if(OX)then
loop
exitwhen Pv[i]==EX or i>=qv
set i=i+1
endloop
if(i>=qv)then
return
endif
set qv=qv-1
set Pv[i]=Pv[qv]
else
loop
exitwhen Qv[i]==EX or i>=sv
set i=i+1
endloop
if(i>=sv)then
return
endif
set sv=sv-1
set Qv[i]=Qv[sv]
endif
endfunction
function RX takes boolean OX returns integer
if(OX)then
return Pv[GetRandomInt(0,qv-1)]
else
return Qv[GetRandomInt(0,sv-1)]
endif
endfunction
function Utils___GetRandomUnitPersonal takes nothing returns nothing
    set yv[Yv]=GetEnumUnit()
    set Yv=Yv+1
endfunction
function IX takes group g returns unit
local unit u
set Yv=0
loop
set u=FirstOfGroup(g)
exitwhen u==null
set yv[Yv]=u
set Yv=Yv+1
call GroupRemoveUnit(g,u)
endloop
set u=null
if(Yv<=0)then
return null
endif
return yv[GetRandomInt(0,Yv-1)]
endfunction
function AX takes real x,real y returns real
return SquareRoot(x*x+y*y)
endfunction
function NX takes unit tu,real tx,real ty,real bX returns nothing
local integer pn=GetPlayerId(GetOwningPlayer(tu))
local integer n=5
local real d
loop
set d=AX(tx-GetUnitX(tu),ty-GetUnitY(tu))
exitwhen d<bX or n<=0
call IssuePointOrderById(tu,$D022D,tx,ty)
call TriggerSleepAction(.15)
set n=n-1
endloop
endfunction
function BX takes integer x,integer y returns integer
local integer r
if(x==0 or y==0)then
return x+y
endif
set r=x-y*(x/ y)
loop
exitwhen r==0
set x=y
set y=r
set r=x-y*(x/ y)
endloop
return y
endfunction
function cX takes integer x,integer y returns integer
return(x*y)/ BX(x,y)
endfunction
function CX takes force f returns player
local integer i=0
loop
if(IsPlayerInForce(Player(i),f))then
return Player(i)
endif
set i=i+1
exitwhen i>$B
endloop
return null
endfunction
function dX takes force f1,force f2 returns nothing
local integer i=0
local player p
loop
set p=Player(i)
if(IsPlayerInForce(p,f2)and IsPlayerInForce(p,f1))then
call ForceRemovePlayer(f1,p)
endif
set i=i+1
exitwhen i>$B
endloop
endfunction
function DX takes nothing returns integer
local integer i=0
local integer j=0
loop
if(IsPlayerInForce(Player(i),WesternForce)and GetPlayerSlotState(Player(i))==PLAYER_SLOT_STATE_PLAYING)then
set j=j+1
endif
set i=i+1
exitwhen i>$B
endloop
return j
endfunction
function fX takes nothing returns integer
local integer i=0
local integer j=0
loop
if(IsPlayerInForce(Player(i),EasternForce)and GetPlayerSlotState(Player(i))==PLAYER_SLOT_STATE_PLAYING)then
set j=j+1
endif
set i=i+1
exitwhen i>$B
endloop
return j
endfunction
function DisplayUnitId takes integer gX returns string
    local integer GX
    local string hX=""
    if(gX<Zv)then
    return hX
    endif
    loop
    exitwhen gX==0
    set GX=ModuloInteger(gX,256)-Zv
    set hX=SubString(ve,GX,GX+1)+hX
    set gX=gX/ 256
    endloop
    return hX
endfunction
function FindHostPlayer takes boolean isWestern returns player
    local integer i=0
    set ee=true
    if(not isWestern)then
        set i=7
    endif
    loop
        exitwhen IsPlayerInForce(Player(i),EmptyForce)or i>$B
        set i=i+1
    endloop
    if(i>$B)then
        if(isWestern)then
            return null
        endif
        set i=0
        loop
            exitwhen IsPlayerInForce(Player(i),EmptyForce)or i>6
            set i=i+1
        endloop
        if(i>6)then
            return null
        endif
    endif
    return Player(i)
endfunction
function jX takes nothing returns nothing
local integer i=0
local integer j
loop
set j=0
loop
if(PlayerForce[i]==PlayerForce[j])then
if(PerPlayerForce[j]!=null and IsPlayerInForce(Player(i),PerPlayerForce[j]))then
call SetPlayerAllianceStateBJ(Player(i),Player(j),5)
else
call SetPlayerAllianceStateAllyBJ(Player(i),Player(j),true)
call SetPlayerAlliance(Player(i),Player(j),ALLIANCE_SHARED_VISION,true)
if(GetPlayerController(Player(i))==MAP_CONTROL_COMPUTER)then
call SetPlayerAllianceStateControlBJ(Player(i),Player(j),true)
endif
endif
else
call SetPlayerAllianceStateBJ(Player(i),Player(j),0)
endif
set j=j+1
exitwhen j>$B
endloop
set i=i+1
exitwhen i>$B
endloop
endfunction
function JX takes nothing returns nothing
call jX()
set ee=false
endfunction
function SetupMapArea takes nothing returns nothing
    set MapMinX=GetRectMinX(bj_mapInitialPlayableArea)
    set MapMaxX=GetRectMaxX(bj_mapInitialPlayableArea)
    set MapMinY=GetRectMinY(bj_mapInitialPlayableArea)
    set MapMaxY=GetRectMaxY(bj_mapInitialPlayableArea)
endfunction
function WarnForRS takes unit lX,unit fV returns boolean
    local real x=wr
    local real y=Wr
    local real d
    set EraserIssuer=GetOwningPlayer(fV)
    if(IsPlayerInForce(EraserIssuer,WesternForce))then
        call DisplayTextToForce(WesternForce,PlayerNames[GetPlayerId(GetOwningPlayer(lX))]+": I'm going to use RS!!!")
    elseif(IsPlayerInForce(EraserIssuer,EasternForce))then
        call DisplayTextToForce(EasternForce,PlayerNames[GetPlayerId(GetOwningPlayer(lX))]+": I'm going to use RS!!!")
    endif
    call NX(lX,x,y,900.)
    return IssuePointOrderById(lX,$D0208,x,y)
endfunction
function PrepareRaceBuildingSetup takes integer chunkNum returns nothing
    set ChunkBase=chunkNum*50
    set BuildingNums=0
endfunction
function SetupBuildingUpgrades takes integer buildingType,real ZV,boolean PX,integer upgradeFromBuilding returns nothing
    local integer buildingPV=GetUnitPointValueByType(buildingType)
    local integer unitPrice=GetUnitGoldCost(buildingType)
    if(buildingPV>8000)then
    call DisplayTextToPlayer(GetLocalPlayer(),.0,.0," Wrong PV value for "+GetObjectName(buildingType))
    endif
    if(UnitPrices[buildingPV]!=0 and(buildingType!='h008'))then
        call DisplayTextToPlayer(GetLocalPlayer(),.0,.0,"!Check unit PV "+GetObjectName(buildingType)+"/"+GetObjectName(PVToBuildingType[buildingPV]))
    endif
    set UnitPrices[buildingPV]=unitPrice
    if(unitPrice==0)then
        call DisplayTextToPlayer(GetLocalPlayer(),.0,.0,GetObjectName(buildingType)+" price "+I2S(unitPrice))
    endif
    set ne[buildingPV]=unitPrice*ZV*.1
    if(PX)then
        set Ve[buildingPV]=1
    else
        set Ve[buildingPV]=-1
    endif
    set UpgradeFrom[buildingPV]=upgradeFromBuilding
    set PVToBuildingType[buildingPV]=buildingType
    set BuildingPVWoodCost[buildingPV]=GetUnitWoodCost(buildingType)
    if(buildingType=='h008')then // h008 <-- treasure box
    return
    endif
    set BuildingNums=BuildingNums+1
    set RaceBuildingArena[ChunkBase]=BuildingNums
    set RaceBuildingArena[BuildingNums+ChunkBase]=buildingType
endfunction
function SetupSiegeBuildingUpgrades takes integer unitId,real ZV,boolean PX,integer qX returns nothing
    local integer id=GetUnitPointValueByType(unitId)
    local integer buildingCost=GetUnitGoldCost(unitId)
    if(id>8000)then
        call DisplayTextToPlayer(GetLocalPlayer(),.0,.0," Wrong PV value for "+GetObjectName(unitId))
    endif
    if(UnitPrices[id]!=0)then
        call DisplayTextToPlayer(GetLocalPlayer(),.0,.0,"!Check unit PV "+GetObjectName(unitId)+"/"+GetObjectName(PVToBuildingType[id]))
    endif
    set UnitPrices[id]=buildingCost
    if(buildingCost==0)then
        call DisplayTextToPlayer(GetLocalPlayer(),.0,.0,GetObjectName(unitId)+" price "+I2S(buildingCost))
    endif
    set ne[id]=buildingCost*ZV*.1
    if(PX)then
    set Ve[id]=1
    else
    set Ve[id]=-1
    endif
    set UpgradeFrom[id]=qX
    set Xe[id]=true
    set PVToBuildingType[id]=unitId
    set BuildingNums=BuildingNums+1
    set RaceBuildingArena[ChunkBase]=BuildingNums
    set RaceBuildingArena[BuildingNums+ChunkBase]=unitId
endfunction
function BuildingTrains takes integer building,integer trained returns nothing
    set BuildingToItsTrained[GetUnitPointValueByType(building)]=trained
endfunction
function SpawnCreep takes unit u,integer uX,real an,real x,real y returns nothing
    local integer HE=GetUnitUserData(u)
    local real mx=GetUnitX(u)+x
    local real my=GetUnitY(u)+y
    set be=CreateUnit(GetOwningPlayer(u),uX,mx,my,an)
    call SetUnitPathing(be,false)
    call SetUnitX(be,mx)
    call SetUnitY(be,my)
    call SaveUnitHandle(ox,GetHandleId(u),HE,be)
    call SetUnitUserData(u,HE+1)
endfunction
function UX takes unit u returns nothing
    local integer wX=GetUnitUserData(u)
    local integer WX=GetHandleId(u)
    local unit ju
    if(wX>0)then
    loop
    set wX=wX-1
    set ju=LoadUnitHandle(ox,WX,wX)
    if(ju!=null)then
    call RemoveUnit(ju)
    endif
    exitwhen wX<=0
    endloop
    set ju=null
    endif
endfunction

// Registers attach buildings, so that it looks different from the base building after upgrade.
// This is more of a visual effect.
function AttachRegister takes integer obj,code YX returns nothing
    local integer id=GetUnitPointValueByType(obj)
    if(Be[id]!=null)then
    call DisplayTextToPlayer(GetLocalPlayer(),.0,.0,"Conflict in Attach registration! ("+GetObjectName(obj)+")")
    endif
    set Be[id]=CreateTrigger()
    call TriggerAddCondition(Be[id],Condition(YX))
endfunction
function zX takes unit u returns nothing
    local integer id=GetUnitPointValue(u)
    if(Be[id]!=null)then
    set ce=u
    call TriggerEvaluate(Be[id])
    endif
endfunction
function ZX takes integer pX,real r returns nothing
    set Ce[GetUnitPointValueByType(pX)]=r
endfunction
function SetupSpecialBuildingAction takes integer pX,code eO returns nothing
    local integer id=GetUnitPointValueByType(pX)
    set de[id]=CreateTrigger()
    call TriggerAddAction(de[id],eO)
endfunction
function xO takes unit u returns nothing
    local integer id=GetUnitPointValue(u)
    if(de[id]!=null)then
    set De=u
    call TriggerExecute(de[id])
    endif
endfunction
function RegisterSpell takes integer unitId,integer rO,code spellAction returns nothing
    local integer id=GetUnitPointValueByType(unitId)
    if(UnitSpellTrigger[id]!=null)then
        call DisplayTextToPlayer(GetLocalPlayer(),.0,.0,"!Spell registration error "+DisplayUnitId(unitId))
    endif
    set UnitSpellTrigger[id]=CreateTrigger()
    call TriggerAddAction(UnitSpellTrigger[id],spellAction)
    set UnitSpellWTF[id]=rO
endfunction
function aO takes unit u,integer rO,unit t returns nothing
local integer id=GetUnitPointValue(u)
if(UnitSpellTrigger[id]!=null and rO==UnitSpellWTF[id])then
set ge=u
set Ge=t
call TriggerExecute(UnitSpellTrigger[id])
endif
endfunction
function nO takes nothing returns nothing
    set he=CreateTimer()
endfunction
function VO takes nothing returns boolean
local unit u=GetFilterUnit()
if(Le<$A and IsUnitEnemy(u,EraserIssuer)and IsUnitType(u,UNIT_TYPE_SAPPER)and GetWidgetLife(u)>200. and GetUnitAbilityLevel(u,'A08H')<=0 and GetUnitAbilityLevel(u,'B012')<=0 and GetUnitAbilityLevel(u,'BHbn')<=0 and GetUnitAbilityLevel(u,'BOhx')<=0)then
set Le=Le+1
endif
set u=null
return false
endfunction
function EO takes nothing returns nothing
    local boolean XO
    local boolean OO
    set Le=0
    set EraserIssuer=Player(6)
    call GroupEnumUnitsInRect(ErasingGroup,WesternBuildArea,le)
    set OO=(Le>=$A)
    set Le=0
    set EraserIssuer=Player(0)
    call GroupEnumUnitsInRect(ErasingGroup,EasternBuildArea,le)
    set XO=(Le>=$A)
    if(OO)then
    if(not ke)then
    set ke=true
    call DisplayTimedTextToForce(bj_FORCE_ALL_PLAYERS,8.,ForceName[0]+"|cffFFFF00 are dominating!|r")
    endif
    if(He[1]>.7)then
    set He[1]=He[1]-(.02)
    endif
    elseif(ke)then
    if(He[1]<1.)then
    set He[1]=He[1]+(.05)
    else
    set ke=false
    set He[1]=1.
    call DisplayTimedTextToForce(bj_FORCE_ALL_PLAYERS,8.,ForceName[0]+"|cffFFFF00 are no longer dominating!|r")
    endif
    endif
    if(XO)then
    if(not Ke)then
    set Ke=true
    call DisplayTimedTextToForce(bj_FORCE_ALL_PLAYERS,8.,ForceName[1]+"|cffFFFF00 are dominating!|r")
    endif
    if(He[0]>.7)then
    set He[0]=He[0]-(.02)
    endif
    elseif(Ke)then
    if(He[0]<1.)then
    set He[0]=He[0]+(.05)
    else
    set Ke=false
    set He[0]=1.
    call DisplayTimedTextToForce(bj_FORCE_ALL_PLAYERS,8.,ForceName[1]+"|cffFFFF00 are no longer dominating!|r")
    endif
    endif
endfunction
function SetupDomination takes nothing returns nothing
    if(not je)then
    set le=Filter(function VO)
    set Je=CreateTimer()
    call TimerStart(Je,2.5,true,function EO)
    set je=true
    endif
    set ke=false
    set Ke=false
    set He[0]=1.
    set He[1]=1.
endfunction
function IO takes nothing returns nothing
local integer i=0
local integer j
local integer k
local integer l
loop
set Qe[i]=i
set i=i+1
exitwhen i>$B
endloop
set i=0
loop
set j=GetRandomInt(0,$B)
set k=GetRandomInt(0,$B)
set l=Qe[j]
set Qe[j]=Qe[k]
set Qe[k]=l
set i=i+1
exitwhen i>7
endloop
endfunction
function AO takes integer x,integer y,string lb returns nothing
local integer i=0
if(lb==null)then
set lb="?"
endif
loop
if(pe[i]!=null)then
set Ue=MultiboardGetItem(pe[i],y,x)
call MultiboardSetItemValue(Ue,lb)
call MultiboardReleaseItem(Ue)
endif
set i=i+1
exitwhen i>$B
endloop
if(x==1)then
set Ue=MultiboardGetItem(Se,1,(y-1)*6+1)
call MultiboardSetItemValue(Ue,lb)
call MultiboardReleaseItem(Ue)
elseif(x>2 and x<5)then
set Ue=MultiboardGetItem(Se,1,(y-1)*6+x-1)
call MultiboardSetItemValue(Ue,lb)
call MultiboardReleaseItem(Ue)
elseif(x==5)then
set Ue=MultiboardGetItem(Se,Te,$A)
call MultiboardSetItemValue(Ue,lb)
call MultiboardReleaseItem(Ue)
endif
endfunction
function NO takes integer x,integer y,string lb returns nothing
set Ue=MultiboardGetItem(Se,x,y)
call MultiboardSetItemValue(Ue,lb)
call MultiboardReleaseItem(Ue)
endfunction
function bO takes nothing returns string
local string s=I2S(ze)
if(ze<$A)then
set s="0"+s
endif
return"|cffFFFF00"+I2S(Ye)+"|cffFF8000:|cffFFFF00"+s+"|r"
endfunction
function BO takes nothing returns nothing
set Ze=Ze+1
if(Ze>=vx)then
set vx=Ze+5
set ze=ze+1
if(ze==60)then
set ze=0
set Ye=Ye+1
set xx=xx*.85+.15
endif
call AO(5,3,bO())
endif
endfunction
function EnoughPlayerForBanRace takes nothing returns boolean
    local integer pl=CountPlayersInForceBJ(WesternForce)
    local integer pr=CountPlayersInForceBJ(EasternForce)
    local integer pq=CountPlayersInForceBJ(EmptyForce)
    local integer pc=pl+pr
    local integer CO=IntegerTertiaryOp(NumberOfBans>0,2*NumberOfBans,-NumberOfBans)
    if(Wx>0 and pc*Wx>raceNum-CO)then
    return false
    endif
    if(pc>raceNum-CO)then
    return false
    endif
    if(pc*(Wx-1)>pq)then
    return false
    endif
    if(pc>raceNum and UniqueRaceMode)then
    return false
    endif
    if(zx>0 and cX(IMaxBJ(pl,pr)*zx,IMinBJ(pl,pr))*2>pq+pc)then
    return false
    endif
    return true
endfunction
function EnableAI takes boolean enable returns nothing
    set haveAI=enable
    call DisplayTextToForce(bj_FORCE_ALL_PLAYERS,"|cffC6FF00AI|r enabled. Units will choose targets by its armor type.")
endfunction
function EnableNoArtilleryMode takes boolean enable returns nothing
    set haveArtillery=not enable
    if(enable)then
    call DisplayTextToForce(bj_FORCE_ALL_PLAYERS,"|cffC6FF00Artillery|r enabled. You can build structures that attack enemy structures.")
    set wi='n01C'
    set fa='A0GH'
    set si='A01I'
    set Oa='A0BD'
    set Yi='A0I8'
    set zi='A0I6'
    else
    call DisplayTextToForce(bj_FORCE_ALL_PLAYERS,"|cffC6FF00No Artillery|r has been chosen. You cannot build structures that attack enemy structures.")
    set wi='n021'
    set fa='A08T'
    set si='A05H'
    set Oa='A0BQ'
    set Yi='A0I9'
    set zi='A0I7'
    endif
    set bj_forLoopAIndex=0
    set bj_forLoopAIndexEnd=$B
    loop
    exitwhen bj_forLoopAIndex>bj_forLoopAIndexEnd
    call SetPlayerUnitAvailableBJ('h001',enable,Player(bj_forLoopAIndex))
    call SetPlayerUnitAvailableBJ('h048',enable,Player(bj_forLoopAIndex))
    call SetPlayerUnitAvailableBJ('h01E',enable,Player(bj_forLoopAIndex))
    set bj_forLoopAIndex=bj_forLoopAIndex+1
    endloop
endfunction
function EnableNoAFKMode takes boolean enable returns nothing
    set NoAFK=enable
    if(not enable)then
    call DisplayTextToForce(bj_FORCE_ALL_PLAYERS,"|cffC6FF00No AFK|r mode has been disabled. Command -afk enabled.")
    else
    call DisplayTextToForce(bj_FORCE_ALL_PLAYERS,"|cffC6FF00No AFK|r has been chosen. Command -afk disabled.")
    endif
endfunction
function EnableCoinMode takes nothing returns nothing
    set CoinsEveryPeriod=1
    call DisplayTextToForce(bj_FORCE_ALL_PLAYERS,"|cffC6FF00Coin|r has been chosen. There will be a coin spawn every 40 seconds.")
endfunction
function EnableCrazyCoinMode takes nothing returns nothing
    set CoinsEveryPeriod=$A
    call DisplayTextToForce(bj_FORCE_ALL_PLAYERS,"|cffC6FF00Crazy Coins|r has been chosen. Ten coins will spawn every 40 seconds.")
endfunction
function EnableDualRaceMode takes boolean enable returns nothing
    set DuralRaceMode=enable
    if(not enable)then
        call DisplayTextToForce(bj_FORCE_ALL_PLAYERS,"|cffC6FF00Dual Race|r mode has been disabled.")
    else
        call DisplayTextToForce(bj_FORCE_ALL_PLAYERS,"|cffC6FF00Dual Race|r has been chosen. Each race can be chosen more than once per team.")
    endif
endfunction
function EnableUniqueRaceMode takes boolean enable returns nothing
    set UniqueRaceMode=enable
    if(enable)then
        call DisplayTextToForce(bj_FORCE_ALL_PLAYERS,"|cffC6FF00Unique Races|r has been chosen. Each race can be chosen only once (even across the teams).")
        if((CountPlayersInForceBJ(WesternForce)+CountPlayersInForceBJ(EasternForce))+NumberOfBans*2>$A)then
            set UniqueRaceMode=false
            call DisplayTextToForce(bj_FORCE_ALL_PLAYERS,"|cffC6FF00Unique Races|r mode has been disabled due so many players.")
        endif
    else
        call DisplayTextToForce(bj_FORCE_ALL_PLAYERS,"|cffC6FF00Unique Races|r mode has been disabled.")
    endif
endfunction
function EnableNoTreasureBoxMode takes boolean enable returns nothing
    set NoTreasureBox=enable
    if(enable)then
    call DisplayTextToForce(bj_FORCE_ALL_PLAYERS,"|cffC6FF00No Treasure Box|r mode has been disabled.")
    else
    call DisplayTextToForce(bj_FORCE_ALL_PLAYERS,"|cffC6FF00No Treasure Box|r has been chosen. You cannot build Treasure Boxes.")
    endif
    set bj_forLoopAIndex=0
    set bj_forLoopAIndexEnd=$B
    loop
    exitwhen bj_forLoopAIndex>bj_forLoopAIndexEnd
    call SetPlayerUnitAvailableBJ('h008',enable,Player(bj_forLoopAIndex))
    set bj_forLoopAIndex=bj_forLoopAIndex+1
    endloop
endfunction
function EnableNoBountyMode takes boolean enable returns nothing
    set NoBounty=enable
    if(enable)then
    call DisplayTextToForce(bj_FORCE_ALL_PLAYERS,"|cffC6FF00No Bounty|r mode has been disabled.")
    else
    call DisplayTextToForce(bj_FORCE_ALL_PLAYERS,"|cffC6FF00No Bounty|r has been chosen. Neither units nor buildings will give bounty when destroyed.")
    endif
    set bj_forLoopAIndex=0
    set bj_forLoopAIndexEnd=$B
    loop
    exitwhen bj_forLoopAIndex>bj_forLoopAIndexEnd
    call SetPlayerFlagBJ(PLAYER_STATE_GIVES_BOUNTY,enable,Player(bj_forLoopAIndex))
    set bj_forLoopAIndex=bj_forLoopAIndex+1
    endloop
endfunction
function EnableNoSpecialsMode takes boolean enable returns nothing
    set HasSpecials=enable
    if(enable)then
        call DisplayTextToForce(bj_FORCE_ALL_PLAYERS,"|cffC6FF00No Specials|r mode has been disabled.")
    else
        call DisplayTextToForce(bj_FORCE_ALL_PLAYERS,"|cffC6FF00No Specials|r has been chosen. You can't build special buildings except towers and Treasure Boxes.")
    endif
    set bj_forLoopAIndex=0
    set bj_forLoopAIndexEnd=$B
    // 只有这些是 special?
    loop
        exitwhen bj_forLoopAIndex>bj_forLoopAIndexEnd
        call SetPlayerUnitAvailableBJ('h01P',enable,Player(bj_forLoopAIndex)) // 头骨堆
        call SetPlayerUnitAvailableBJ('h056',enable,Player(bj_forLoopAIndex)) // 骷髅神社 （？)
        call SetPlayerUnitAvailableBJ('h014',enable,Player(bj_forLoopAIndex)) // 奥术塔
        call SetPlayerUnitAvailableBJ('h03Q',enable,Player(bj_forLoopAIndex)) // 冰冻塔
        call SetPlayerUnitAvailableBJ('h01O',enable,Player(bj_forLoopAIndex)) // 灵魂炮塔
        call SetPlayerUnitAvailableBJ('o000',enable,Player(bj_forLoopAIndex)) // 防空塔
        call SetPlayerUnitAvailableBJ('h006',enable,Player(bj_forLoopAIndex)) // 望塔
        call SetPlayerUnitAvailableBJ('n01J',enable,Player(bj_forLoopAIndex)) // 腐化守卫者
        call SetPlayerUnitAvailableBJ('h073',enable,Player(bj_forLoopAIndex)) // 艾露恩的灯笼
        call SetPlayerUnitAvailableBJ('h05L',enable,Player(bj_forLoopAIndex)) // 能量塔
        set bj_forLoopAIndex=bj_forLoopAIndex+1
    endloop
endfunction
function EnableNoItemMode takes boolean enable returns nothing
    set HaveItem=enable
    if(enable)then
    call DisplayTextToForce(bj_FORCE_ALL_PLAYERS,"|cffC6FF00No Items|r mode has been disabled.")
    else
    call DisplayTextToForce(bj_FORCE_ALL_PLAYERS,"|cffC6FF00No Items|r has been chosen. The castle doesn't sell any items.")
    endif
endfunction
function EnableNoLegendMode takes boolean enable returns nothing
    set haveLegend=enable
    if(enable)then
    call DisplayTextToForce(bj_FORCE_ALL_PLAYERS,"|cffC6FF00No Legendaries|r mode has been disabled.")
    else
    call DisplayTextToForce(bj_FORCE_ALL_PLAYERS,"|cffC6FF00No Legendaries|r has been chosen. You don't get food to buy legendary buildings.")
    endif
endfunction
function EnableNoDevastatingStrikeMode takes boolean enable returns nothing
    set HaveDS=enable
    if(enable)then
        call DisplayTextToForce(bj_FORCE_ALL_PLAYERS,"|cffC6FF00No Devastating Strike|r mode has been disabled.")
    else
        call DisplayTextToForce(bj_FORCE_ALL_PLAYERS,"|cffC6FF00No Devastating Strike|r has been chosen. Your worker doesn't have a Devastating Strike!")
    endif
endfunction
function EnableLumberLimitMode takes integer limit returns nothing
    if(limit<$96)then
        set LumberLimit=-1
        call DisplayTextToForce(bj_FORCE_ALL_PLAYERS,"|cffC6FF00Lumber Limit|r mode has been disabled.")
    else
    set LumberLimit=limit
    call DisplayTextToForce(bj_FORCE_ALL_PLAYERS,"|cffC6FF00Lumber Limit|r has been set to |cffFFFF00"+I2S(LumberLimit)+"|r.")
    endif
endfunction
function MO takes real mO returns nothing
    set IncomeTime=RMaxBJ(RMinBJ(mO,15.),5.)
    call DisplayTextToForce(bj_FORCE_ALL_PLAYERS,"|cffC6FF00Income Timer|r has been set to |cffFFFF00"+R2SW(IncomeTime,2,1)+"|r.")
endfunction

function SetTax takes integer taxMode returns nothing
    set TaxMode=taxMode
    if(TaxMode==1)then
    set Ii=1000.
    call DisplayTextToForce(bj_FORCE_ALL_PLAYERS,"|cffC6FF00No Taxes|r has been chosen. You don't have to pay taxes on your income.")
    elseif(TaxMode==2)then
    set Ii=12.5
    call DisplayTextToForce(bj_FORCE_ALL_PLAYERS,"|cffC6FF00High Taxes|r has been chosen. Tax rate increases 10% every 12.5 income.")
    endif
endfunction

function EnableCagingMode takes boolean enable returns nothing
    set CagingMode=enable
    if(enable)then
    call DisplayTextToForce(bj_FORCE_ALL_PLAYERS,"|cffC6FF00Caging|r mode has been disabled.")
    else
    call DisplayTextToForce(bj_FORCE_ALL_PLAYERS,"|cffC6FF00Caging|r has been chosen. You can trap units with your buildings")
    endif
endfunction
function EnableDominationMode takes boolean enable returns nothing
set DominationMode=enable
if(enable)then
call DisplayTextToForce(bj_FORCE_ALL_PLAYERS,"|cffC6FF00Domination|r has been chosen. Forces will loose income(up to 30%) if 10 or more units besiege its base.")
else
call DisplayTextToForce(bj_FORCE_ALL_PLAYERS,"TODO::SetDOMStatus(false)")
endif
endfunction
function EnableAutoBalance takes integer variation returns nothing
    if(variation>2)then
    call DisplayTextToPlayer(Player(0),.0,.0,"|cffFF0000Wrong Autobalance variation!|r")
    return
    endif
    set AutoBalanceVariation=variation
    if(variation==0)then
        call DisplayTextToForce(bj_FORCE_ALL_PLAYERS,"|cffC6FF00Autobalance|r has been setted to |cffFFFF000|r. All units of any left player will be divided between members in team.")
    elseif(variation==1)then
        call DisplayTextToForce(bj_FORCE_ALL_PLAYERS,"|cffC6FF00Autobalance|r has been setted to |cffFFFF001|r. All depended players of any left player will be shared between members in team.")
    else
        call DisplayTextToForce(bj_FORCE_ALL_PLAYERS,"|cffC6FF00Autobalance|r has been setted to |cffFFFF001|r. AI will take control of any left player.")
    endif
endfunction
function enableRandomBanRaceMode takes integer banNumber returns nothing
    if(banNumber==0)then
    set NumberOfBans=-1
    else
    set NumberOfBans=-banNumber
    endif
    if(not EnoughPlayerForBanRace())then
        call DisplayTextToPlayer(Player(0),.0,.0,"|cffFF0000Too many players for Random Ban Race mode!|r")
        set NumberOfBans=0
    return
    endif
    call DisplayTextToForce(bj_FORCE_ALL_PLAYERS,"|cffC6FF00Random Ban Race|r has been chosen. Number of bans: |cffFFFF00"+I2S(IAbsBJ(NumberOfBans))+"|r.")
endfunction
function enableBanRaceMode takes integer banNumber returns nothing
    if(banNumber==0)then
        set NumberOfBans=1
    else
        set NumberOfBans=banNumber
    endif
    if(not EnoughPlayerForBanRace())then
        call DisplayTextToPlayer(Player(0),.0,.0,"|cffFF0000Too many players for Ban Race mode!|r")
        set NumberOfBans=0
        return
    endif
    call DisplayTextToForce(bj_FORCE_ALL_PLAYERS,"|cffC6FF00Ban Race|r has been chosen. Number of bans per team: |cffFFFF00"+I2S(NumberOfBans)+"|r.")
endfunction
function TO takes integer PO returns nothing
if(PO==0)then
set zx=1
else
set zx=PO
endif
set Wx=0
if(not EnoughPlayerForBanRace())then
call DisplayTextToPlayer(Player(0),.0,.0,"|cffFF0000Too many players for Extended Multi Race mode!|r")
set zx=0
return
endif
set AutoBalanceVariation=1
call DisplayTextToForce(bj_FORCE_ALL_PLAYERS,"|cffC6FF00Extended Multiple Players|r has been chosen. Parameter's value is: |cffFFFF00"+I2S(zx)+"|r.")
endfunction
function uO takes integer PO returns nothing
if(PO<1 or PO>5)then
call DisplayTextToPlayer(Player(0),.0,.0,"|cffFF0000Wrong number of players per player! Must be between 2 and 4!|r")
return
endif
set zx=0
set Wx=PO
if(not EnoughPlayerForBanRace())then
call DisplayTextToPlayer(Player(0),.0,.0,"|cffFF0000Too many players for Multi Race mode!|r")
set Wx=0
return
endif
set AutoBalanceVariation=1
call DisplayTextToForce(bj_FORCE_ALL_PLAYERS,"|cffC6FF00Multiple Players|r has been chosen. Number of additional players per human player: |cffFFFF00"+I2S(PO)+"|r")
endfunction
function UO takes integer RE returns nothing
if(IAbsBJ(RE)>5)then
set RoundTimeLimit=RE
if(RE>0)then
call DisplayTextToForce(bj_FORCE_ALL_PLAYERS,"|cffC6FF00Round time limit for win|r has been activated. Round will automatically end after "+I2S(IAbsBJ(RE))+" minutes and owner of first building will win.")
else
call DisplayTextToForce(bj_FORCE_ALL_PLAYERS,"|cffC6FF00Round time limit for draw|r has been activated. Round will automatically end after "+I2S(IAbsBJ(RE))+" minutes with draw result.")
endif
else
call DisplayTextToPlayer(Player(0),.0,.0,"|cffFF0000Wrong value of minutes for round time limitation! Must be more 5!|r")
endif
endfunction
function wO takes integer RE returns nothing
local integer p=raceNum
if(RE==0)then
set RE=1
endif
set raceNum=raceNum-RE
if(not EnoughPlayerForBanRace())then
call DisplayTextToPlayer(Player(0),.0,.0,"|cffFF0000Not possible to disable so many races!|r")
set raceNum=p
return
endif
set Zx=RE
call DisplayTextToForce(bj_FORCE_ALL_PLAYERS,"|cffC6FF00System-races-pool|r has been changed. There are |cffFFFF00"+I2S(RE)+"|r new races have been removed.|r")
endfunction
function WO takes nothing returns nothing
local integer i=0
local integer j
local player p
local unit u
loop
exitwhen i>$B
set j=1
set p=Player(i)
loop
set u=CreateUnitAtLoc(p,'tec0'+j,Vx,.0)
call ShowUnit(u,false)
set j=j+1
exitwhen j>3
endloop
set i=i+1
endloop
endfunction
function yO takes integer i returns nothing
set IncomeMultiplier[i]=1.
set fo[i]=.0
set Ai[i]=.0
set PlayerIncome[i]=0
set Bo[i]=-1
set Co[i]=-1
set do[i]=-1
set Do[i]=-1
set Fo[i]=-1
set go[i]=-1
set Go[i]=-1
set ho[i]=-1
set Ho[i]=-1
set jo[i]=-1
set PayedGolds[i]=-1
set Ko[i]=0
endfunction
function YO takes integer i returns nothing
set IncomeMultiplier[i]=1.
set fo[i]=.0
set Ai[i]=5.
set PlayerIncome[i]=5
set Bo[i]=0
set Co[i]=0
set do[i]=0
set Do[i]=0
set Fo[i]=0
set go[i]=0
set Go[i]=0
set ho[i]=0
set Ho[i]=0
set jo[i]=0
set PayedGolds[i]=0
set Ko[i]='}'
endfunction
function zO takes integer dE returns string
local playercolor pc=GetPlayerColor(Player(dE))
local string aX
if(pc==PLAYER_COLOR_RED)then
set aX="|cffff0000"
elseif(pc==PLAYER_COLOR_BLUE)then
set aX="|cff0000FF"
elseif(pc==PLAYER_COLOR_CYAN)then
set aX="|cff00FFFF"
elseif(pc==PLAYER_COLOR_PURPLE)then
set aX="|cff800080"
elseif(pc==PLAYER_COLOR_YELLOW)then
set aX="|cffFFFF00"
elseif(pc==PLAYER_COLOR_ORANGE)then
set aX="|cffFFCC00"
elseif(pc==PLAYER_COLOR_GREEN)then
set aX="|cff00ff00"
elseif(pc==PLAYER_COLOR_PINK)then
set aX="|cffff00ff"
elseif(pc==PLAYER_COLOR_LIGHT_GRAY)then
set aX="|cffc0c0c0"
elseif(pc==PLAYER_COLOR_LIGHT_BLUE)then
set aX="|cffCCFFFF"
elseif(pc==PLAYER_COLOR_AQUA)then
set aX="|cff087329"
elseif(pc==PLAYER_COLOR_BROWN)then
set aX="|cffC16D00"
else
set aX="|CFFFFFFFF"
endif
set pc=null
return aX
endfunction
function ZO takes integer dE returns nothing
set PlayerNames[dE]=zO(dE)+GetPlayerName(Player(dE))+"|r"
endfunction
function MoveEnumPlayerToEmpty takes nothing returns nothing
    local player p=GetEnumPlayer()
    local integer i=GetPlayerId(p)
    call ForceRemovePlayer(WesternForce,p)
    call ForceRemovePlayer(EasternForce,p)
    call ForceAddPlayer(EmptyForce,p)
    set Pe[i]=null
    set p=null
endfunction
function eR takes nothing returns nothing
    local integer i=0
    local integer j
    local player hostPlayer
    local boolean isWestern
    loop
        if(PerPlayerForce[i]!=null)then
            call ForForce(PerPlayerForce[i],function MoveEnumPlayerToEmpty)
            call SetPlayerName(Player(i),PlayerNames2[i])
        endif
            set i=i+1
        exitwhen i>$B
    endloop
    set i=0
    loop
        if(PerPlayerForce[i]!=null)then
            set isWestern=IsPlayerInForce(Player(i),WesternForce)
            set j=1
            loop
                set hostPlayer=FindHostPlayer(isWestern)
                call ForceRemovePlayer(EmptyForce,hostPlayer)
                call ForceAddPlayer(PerPlayerForce[i],hostPlayer)
                if(isWestern)then
                    call ForceAddPlayer(WesternForce,hostPlayer)
                    set BuilderInitialPosition[GetPlayerId(hostPlayer)]=DV(BuilderInitialPosition[i],96.*j,.0)
                else
                    call ForceAddPlayer(EasternForce,hostPlayer)
                    set BuilderInitialPosition[GetPlayerId(hostPlayer)]=DV(BuilderInitialPosition[i],96.*j,180.)
                endif
                call SetPlayerName(hostPlayer,PlayerNames2[i])
                set PlayerNames[GetPlayerId(hostPlayer)]=zO(GetPlayerId(hostPlayer))+GetPlayerName(hostPlayer)+"|r"
                set PlayerForce[GetPlayerId(hostPlayer)]=PlayerForce[i]
                set j=j+1
                exitwhen j>=Wx
            endloop
        endif
        set i=i+1
        exitwhen i>$B
    endloop
endfunction
function oR takes nothing returns nothing
local integer pl=CountPlayersInForceBJ(WesternForce)
local integer pr=CountPlayersInForceBJ(EasternForce)
local integer rR=cX(IMaxBJ(pl,pr)*zx,IMinBJ(pl,pr))
local integer iR=rR/ pl
local integer aR=rR/ pr
local integer i=0
local integer j
local integer l
local player p
local boolean xR
loop
if(PerPlayerForce[i]!=null)then
call ForForce(PerPlayerForce[i],function MoveEnumPlayerToEmpty)
call SetPlayerName(Player(i),PlayerNames2[i])
endif
set i=i+1
exitwhen i>$B
endloop
set i=0
loop
if(PerPlayerForce[i]!=null)then
set xR=IsPlayerInForce(Player(i),WesternForce)
set l=IntegerTertiaryOp(xR,iR,aR)
set j=1
loop
exitwhen j>=l
set p=FindHostPlayer(xR)
call ForceRemovePlayer(EmptyForce,p)
call ForceAddPlayer(PerPlayerForce[i],p)
if(xR)then
call ForceAddPlayer(WesternForce,p)
set BuilderInitialPosition[GetPlayerId(p)]=DV(BuilderInitialPosition[i],96.*j,.0)
else
call ForceAddPlayer(EasternForce,p)
set BuilderInitialPosition[GetPlayerId(p)]=DV(BuilderInitialPosition[i],96.*j,180.)
endif
call SetPlayerName(p,PlayerNames2[i])
set PlayerNames[GetPlayerId(p)]=zO(GetPlayerId(p))+GetPlayerName(p)+"|r"
set PlayerForce[GetPlayerId(p)]=PlayerForce[i]
set j=j+1
endloop
endif
set i=i+1
exitwhen i>$B
endloop
endfunction
function nR takes nothing returns nothing
if(zx>0)then
call oR()
return
elseif(Wx>0)then
call eR()
return
endif
call DisplayTimedTextToPlayer(GetLocalPlayer(),.0,.0,60.,"Unknown exception at module Main::SunAMP. Please report.")
endfunction
function InitialSetups takes nothing returns nothing
    local integer i=0
    local player p=Player($C)
    set ox=InitHashtable()
    set rx=InitHashtable()
    set me=GetWorldBounds()
    set nx=Rect(-288.,3296.,-96.,3488.)
    loop
        set PlayerForce[i]=0
        if(GetPlayerSlotState(Player(i))==PLAYER_SLOT_STATE_PLAYING)then
            call ForceAddPlayer(WesternForce,Player(i))
            call CreateFogModifierRectBJ(true,Player(i),FOG_OF_WAR_VISIBLE,nx)
            set BuilderInitialPosition[i]=GetInitialBuilderPos(true)
            set PerPlayerForce[i]=CreateForce()
            set PlayerNames2[i]=GetPlayerName(Player(i))
        elseif(GetPlayerSlotState(Player(i))==PLAYER_SLOT_STATE_EMPTY)then
            call ForceAddPlayer(EmptyForce,Player(i))
        endif
        set PlayerForce[i+6]=1
        if(GetPlayerSlotState(Player(i+6))==PLAYER_SLOT_STATE_PLAYING)then
            call ForceAddPlayer(EasternForce,Player(i+6))
            call CreateFogModifierRectBJ(true,Player(i+6),FOG_OF_WAR_VISIBLE,nx)
            set BuilderInitialPosition[i+6]=GetInitialBuilderPos(false)
            set PerPlayerForce[i+6]=CreateForce()
            set PlayerNames2[i+6]=GetPlayerName(Player(i+6))
        elseif(GetPlayerSlotState(Player(i+6))==PLAYER_SLOT_STATE_EMPTY)then
            call ForceAddPlayer(EmptyForce,Player(i+6))
        endif
        set i=i+1
        exitwhen i>=6
    endloop
    set Vx=Location(-192.,3392.)
    set xo[0]=GetRectCenter(Gn)
    set xo[1]=GetRectCenter(gn)
    set xo[2]=GetRectCenter(gn)
    set xo[3]=GetRectCenter(Gn)
    set no[0]=WesternBuildArea
    set no[1]=EasternBuildArea
    set ForceName[0]="|cffff0303Western Forces|r"
    set ForceName[1]="|cff20c000Eastern Forces|r"
    set i=0
    loop
        call GroupAddUnit(ix,CreateUnit(p,'h00L',-192.,3300.,.0))
        set i=i+1
        exitwhen i>33
    endloop
    set p=Player($F)
    call WO()
    set bj_forLoopAIndex=0
    set bj_forLoopAIndexEnd=$B
    loop
    exitwhen bj_forLoopAIndex>bj_forLoopAIndexEnd
    call SetPlayerFlagBJ(PLAYER_STATE_GIVES_BOUNTY,true,Player(bj_forLoopAIndex))
    set PlayerNames[bj_forLoopAIndex]=zO(bj_forLoopAIndex)+GetPlayerName(Player(bj_forLoopAIndex))+"|r"
    set vo[bj_forLoopAIndex]=true
    set io[bj_forLoopAIndex]=0
    set ro[bj_forLoopAIndex]=0
    set bj_forLoopAIndex=bj_forLoopAIndex+1
    endloop
    call SetMapFlag(MAP_LOCK_RESOURCE_TRADING,true)
    call FogMaskEnable(false)
    call FogEnable(false)
    call CreateQuestBJ(0,"游戏模式","游戏模式由红色玩家在游戏时间的前 20 秒内进入。
    游戏模式由一个破折号后跟两个字符和一个数字组成：

    第一个字符决定种族分布。
    |cffFFFF00p :|r 选择种族
    |cffFFFF00d :|r 计划种族
    |cffFFFF00r :|r 随机种族
    |cffFFFF00m :|r 随机镜像

    第二个字符决定了比赛的持续时间：
    |cffFFFF00g :|r 种族在第一轮确定，并且 |cffFFFF80整场不变|r
    |cffFFFF00r :|r 种族在 |cffFFFF80每一轮前确定|r

    第三个字符是一个数字，范围为 |cffFFFF001|r 到 |cffFFFF006|r ，给出需要获胜的游戏局数。

    |cffFFFF00举例:|r
    -|cffFF0000r|cff00FF00r|cffFFFF002|r 将会使用 |cffFF0000随机|r 种族|cff00FF00每轮重选|r ，需要获胜 |cffFFFF002 次|r 来获得最终胜利
    -|cffFF0000p|cff00FF00g|cffFFFF004|r 将会使用 |cffFF0000自选|r 种族|cff00FF00全场选一次|r ，需要获胜 |cffFFFF004 次|r 来获得最终胜利","ReplaceableTextures\\CommandButtons\\BTNPickUpItem.blp")
    call CreateQuestBJ(0,"Modifications","TRIGSTR_005","ReplaceableTextures\\CommandButtons\\BTNSpy.blp")
    call CreateQuestBJ(0,"Other Commands","TRIGSTR_006","ReplaceableTextures\\CommandButtons\\BTNAuraOfDarkness.blp")
    call CreateQuestBJ(2,"First Match?","|cffFFFF80This is your very first match of Castle Fight?|r

    This game is easy to learn - just pick a builder and construct something.
    Read the basic hints AFKTimer the questlog and watch for armor and damage types to counter your enemies best.

    |cffFF0000Note that the game may have more than one Round, so please don't leave at the end of the Round, another Round may come after this one!.|r

    Good luck and have fun!","ReplaceableTextures\\CommandButtons\\BTNSelectHeroOff.blp")
    call CreateQuestBJ(2,"Basic Hints","-Don't use your Rescue Strike if only 3 units are attacking your building and try to use it only if one building is about to be destroyed, but don't wait with your RS until a few buildings are down. Destroyed buildings gives a huge advantage to the enemy team!

    -Some units are particularly strong against others because of their damage/armor type or abilities. Try to build units with best armor and attack types considering what units your enemies have built. You can type \"-armor\" to see a list of which attack type is good/bad against different armor type. In addition you'll see the same list if you when you set mouse pointer over the attack or armor icon of a unit

    -CF is a TEAM GAME. If there is an enemy unit with divine armor and you can't build chaos damage units, ask a team mate to help you with chaos instead of trying it yourself. Also ask teammates to build towers if you cannot build 'em.

    |cffFF0000 There are a lot of tutorials and articles about Castle Fight AFKTimer the Internet.|r","ReplaceableTextures\\CommandButtons\\BTNMilitia.blp")
    call CreateQuestBJ(2,"About","|cffFFFF80The recommended gamemode is 3x3 with 3 wins (to ensure that nobody with a slow pc lags out).|r

    Map is based on CF 1.14b by |cffFFFF00Gex|r; CF 1.22ES by |c0000ffffElf_Stratigo|r and |c0000ffffVam-pirrr|r.
    Authors of races:
    Orcs - |cffFFFF00gex|r
    Humans - |cffFFFF00gex|r
    Elf Union - |cffFFFF00gex|r
    Undead - |cffFFFF00gex|r
    Chaos - |cffFFFF00gex|r
    Naga - |cffFFFF00gex|r
    Corrupted - |cffFFFF00Natac|r
    Northern - |cffFFFF00gex|r
    Night Elf - |cffFFFF00gex|r
    Mechanical - |cffFFFF00gex|r
    Nature - |cffFFFF00sushi159|r
    Elementals - |cffFFFF00Vam-pirrr|r, |cffFFFF00K_O_S|r, |cffFFFF00Elf_Stratigo|r, |cffFFFF00sushi159|r
    Desert - |cffFFFF00Ricirich91 

    External models: Sin (Thrikodius), Mage (ossus)
    Thanks to the next tools developers: |cffFFFF00Vexorian|r, |cffFFFF00Adolf|r, |cffFFFF00Shadow Daemon|r, |cffFFFF00PitzerMike|r, |cffFFFF00Doc|r, |cffFFFF00ZeToX2007|r.","ReplaceableTextures\\CommandButtons\\BTNTomeOfRetraining.blp")
endfunction
function ER takes nothing returns boolean
local unit u=GetFilterUnit()
local boolean aX=GetWidgetLife(u)>.405 and IsUnitAlly(u,EraserIssuer)and IsUnitType(u,UNIT_TYPE_SAPPER)and(Qo or GetUnitAbilityLevel(u,'A0F1')<=0)
set u=null
return aX
endfunction
function XR takes nothing returns nothing
local integer i=GetRandomInt(1,3)
set EraserIssuer=GetOwningPlayer(De)
set Qo=false
call GroupEnumUnitsInRect(ErasingGroup,bj_mapInitialPlayableArea,so)
set bj_groupRandomCurrentPick=IX(ErasingGroup)
if(bj_groupRandomCurrentPick==null)then
set Qo=true
call GroupEnumUnitsInRect(ErasingGroup,bj_mapInitialPlayableArea,so)
set bj_groupRandomCurrentPick=IX(ErasingGroup)
if(bj_groupRandomCurrentPick==null)then
return
endif
endif
call UnitAddAbility(bj_groupRandomCurrentPick,'A03B')
call UnitAddAbility(bj_groupRandomCurrentPick,'A03A')
call UnitAddAbility(bj_groupRandomCurrentPick,'A03D')
call UnitAddAbility(bj_groupRandomCurrentPick,'A08L')
if(i==1)then
call UnitAddAbility(bj_groupRandomCurrentPick,'A05I')
call UnitAddAbility(bj_groupRandomCurrentPick,'A06W')
elseif(i==2)then
call UnitAddAbility(bj_groupRandomCurrentPick,'A08M')
call UnitAddAbility(bj_groupRandomCurrentPick,'A06Y')
else
call UnitAddAbility(bj_groupRandomCurrentPick,'A08R')
call UnitAddAbility(bj_groupRandomCurrentPick,'A06X')
endif
call DestroyEffect(AddSpecialEffectTarget("Abilities\\Spells\\Undead\\ReplenishHealth\\ReplenishHealthCasterOverhead.mdl",bj_groupRandomCurrentPick,"overhead"))
call DestroyEffect(AddSpecialEffect("Abilities\\Spells\\Human\\DispelMagic\\DispelMagicTarget.mdl",GetUnitX(De),GetUnitY(De)))
endfunction
function OR takes nothing returns nothing
local unit c=CreateUnit(GetOwningPlayer(De),'e008',GetUnitX(De),GetUnitY(De),.0)
call UnitAddAbility(c,'A031')
call IssueImmediateOrderById(c,$D009F)
call UnitApplyTimedLife(c,'BTLF',1.)
set c=De
call SetUnitState(c,UNIT_STATE_MANA,GetUnitState(c,UNIT_STATE_MANA)+GetRandomReal(.0,10.))
call TriggerSleepAction(1.)
call SetUnitAnimation(c,"stand")
set c=null
endfunction
function RR takes nothing returns nothing
local unit c
set EraserIssuer=GetOwningPlayer(De)
call GroupEnumUnitsInRect(ErasingGroup,bj_mapInitialPlayableArea,li)
set bj_groupRandomConsidered=0
set bj_groupRandomCurrentPick=null
call ForGroup(ErasingGroup,function GroupPickRandomUnitEnum)
if(bj_groupRandomCurrentPick==null)then
return
endif
set c=CreateUnit(GetOwningPlayer(De),'e008',GetUnitX(De),GetUnitY(De),.0)
call UnitAddAbility(c,'A030')
call UnitShareVision(bj_groupRandomCurrentPick,EraserIssuer,true)
call IssueTargetOrderById(c,$D02B6,bj_groupRandomCurrentPick)
call UnitShareVision(bj_groupRandomCurrentPick,EraserIssuer,false)
call UnitApplyTimedLife(c,'BTLF',30.)
set c=De
call TriggerSleepAction(.5)
call SetUnitAnimation(c,"attack")
call TriggerSleepAction(1.)
call SetUnitAnimation(c,"stand")
set c=null
endfunction
function EnsnareAbility takes nothing returns nothing
    local unit c=CreateUnit(GetOwningPlayer(ge),'e008',GetUnitX(ge),GetUnitY(ge),.0)
    // A06H <- ensnare
    call UnitAddAbility(c,'A06H')
    call IssueTargetOrderById(c,$D008A,Ge)
    call UnitApplyTimedLife(c,'BTLF',2.)
    set c=null
endfunction
function AR takes nothing returns nothing
call SetupSpecialBuildingAction('h02R',function XR) // Ceremonial Totem
call BuildingTrains('h02P','o009')
call BuildingTrains('h02K','o007')
call BuildingTrains('h092','o00B')
call BuildingTrains('h035','o008')
call BuildingTrains('h036','o006')
call SetupSpecialBuildingAction('h02O',function OR) // Stasis Totem
call SetupSpecialBuildingAction('h02N',function RR) // Serpent Rock
call BuildingTrains('h029','o002')
call BuildingTrains('h02U','o004')
call BuildingTrains('h031','o005')
call BuildingTrains('h02B','o003')
call BuildingTrains('h06E','o00F')
call BuildingTrains('h02I','o001')
call ZX('o000',900.)
call BuildingTrains('h02H','n00V')
call BuildingTrains('h05E','n01O')
endfunction
function NR takes nothing returns nothing
call PrepareRaceBuildingSetup(2)
call SetupBuildingUpgrades('h02P',.2,true,0)
call SetupBuildingUpgrades('h02K',.2,true,0)
call SetupBuildingUpgrades('h092',.2,true,'h02K')
call SetupBuildingUpgrades('h035',.2,true,'h02K')
call SetupBuildingUpgrades('h036',.2,true,'h02K')
call SetupBuildingUpgrades('h029',.2,true,0)
call SetupBuildingUpgrades('h02U',.2,true,'h029')
call SetupBuildingUpgrades('h031',.2,true,'h02U')
call SetupBuildingUpgrades('h02B',.2,true,0)
call SetupBuildingUpgrades('h06E',.2,true,'h02B')
call SetupSiegeBuildingUpgrades('h02I',.18,true,0) // <- orcish siege factory
call SetupBuildingUpgrades('h02H',.2,true,0)
call SetupBuildingUpgrades('h05E',.2,true,'h02H')
call SetupBuildingUpgrades('h02R',.12,false,0)
call SetupBuildingUpgrades('h02O',.12,false,0)
call SetupBuildingUpgrades('o000',.0,false,0)
call SetupBuildingUpgrades('h02N',.09,false,0)
call SetupBuildingUpgrades('h008',.05,false,0)
endfunction
function Orc__RegisterUnitCasts takes nothing returns nothing
    // n01O <- troll trapper
    // A06I <- parasite (dummy?)
    call RegisterSpell('n01O','A06I',function EnsnareAbility)
endfunction
function bR takes nothing returns nothing
    call AR()
    call NR()
    call RegisterSpell('n01O','A06I',function EnsnareAbility)
    set so=Filter(function ER)
endfunction
function BR takes integer tX returns integer
local integer i=0
loop
exitwhen RaceWorkers[i]==tX or i>=raceNum
set i=i+1
endloop
if(i>=raceNum)then
return-1
endif
return i
endfunction
function cR takes integer tX returns string
local integer i=0
loop
exitwhen RaceWorkers[i]==tX or i>=raceNum
set i=i+1
endloop
if(i>=raceNum)then
return"Unregistred Race"
endif
return RaceNames[i]
endfunction
function CR takes integer dR returns nothing
local integer i=0
local integer z
loop
set z=Zo[i]*9
call SetPlayerAbilityAvailable(Player(i),wo[dR],yo[PlayerForce[i]*raceNum+dR]and dR>z and dR<(z+9))
set i=i+1
exitwhen i>=$C
endloop
endfunction
function DR takes integer fR,boolean fl returns nothing
local integer i=0
loop
exitwhen RaceWorkers[i]==fR or i>=raceNum
set i=i+1
endloop
if(i>=raceNum)then
return
endif
set yo[i]=fl
set yo[raceNum+i]=fl
call CR(i)
endfunction
function FR takes integer fR,boolean fl,integer gR returns nothing
local integer i=0
loop
exitwhen RaceWorkers[i]==fR or i>=raceNum
set i=i+1
endloop
if(i>=raceNum)then
return
endif
set yo[raceNum*gR+i]=fl
call CR(i)
endfunction
function GR takes unit u returns nothing
local integer i=0
local player p=GetOwningPlayer(u)
loop
call UnitAddAbility(u,wo[i])
set i=i+1
exitwhen i>=raceNum
endloop
call UnitAddAbility(u,'A0DP')
call UnitAddAbility(u,'A0DQ')
call UnitAddAbility(u,'A0DR')
call SelectUnitForPlayerSingle(u,p)
call PanCameraToForPlayer(p,GetUnitX(u),GetUnitY(u))
endfunction
function hR takes unit u returns unit
call GR(u)
return u
endfunction
function HR takes unit u,real UE returns integer
local integer dE=GetPlayerId(GetOwningPlayer(u))
local timer jR=CreateTimer()
local integer aX=0
call GR(u)
call TimerStart(jR,UE,false,null)
loop
call TriggerSleepAction(.33)
exitwhen To[dE]!=0 or TimerGetRemaining(jR)<.33
endloop
call PauseTimer(jR)
call DestroyTimer(jR)
set jR=null
call RemoveUnit(u)
if(To[dE]==0)then
return-1
endif
set aX=To[dE]
set To[dE]=0
return aX
endfunction
function JR takes integer dE returns nothing
local integer i=0
local integer kR=Zo[dE]*9
local integer KR=kR+9
local integer lR=PlayerForce[dE]*raceNum
local player p=Player(dE)
loop
call SetPlayerAbilityAvailable(p,wo[i],yo[lR+i]and i>=kR and i<KR)
set i=i+1
exitwhen i>=raceNum
endloop
call SetPlayerAbilityAvailable(p,'A0DP',KR<raceNum)
call SetPlayerAbilityAvailable(p,'A0DQ',kR>0)
endfunction
function RaceSelector_Finally takes nothing returns nothing
call DisableTrigger(zo)
endfunction
function LR takes nothing returns nothing
    local integer i=0
    loop
    set Zo[i]=0
    set To[i]=0
    call JR(i)
    set i=i+1
    exitwhen i>=$C
    endloop
    set So=null
endfunction
function mR takes nothing returns nothing
    local integer i=0
    loop
        set yo[i]=true
        set i=i+1
        exitwhen i>=raceNum*2
    endloop
    call LR()
    call EnableTrigger(zo)
endfunction
function MR takes nothing returns boolean
    local unit u=GetTriggerUnit()
    local integer dE=GetPlayerId(GetOwningPlayer(u))
    local integer pR=GetSpellAbilityId()
    local integer i=0
    if(pR=='A0DP')then
    set Zo[dE]=Zo[dE]+1
    call JR(dE)
    set u=null
    return false
    elseif(pR=='A0DQ')then
    set Zo[dE]=Zo[dE]-1
    call JR(dE)
    set u=null
    return false
    elseif(pR=='A0DR')then
    set To[dE]=-1
    if(So!=null)then
    set to=dE
    call TriggerEvaluate(So)
    endif
    call RemoveUnit(u)
    set u=null
    return false
    endif
    loop
    exitwhen wo[i]==pR or i>=raceNum
    set i=i+1
    endloop
    call RemoveUnit(u)
    set u=null
    if(i>=raceNum)then
    return false
    endif
    set To[dE]=RaceWorkers[i]
    if(GetLocalPlayer()==Player(dE))then
    call StartSound(RaceChooseSound[i])
    endif
    if(So!=null)then
    set to=dE
    call TriggerEvaluate(So)
    endif
    return false
endfunction
function SetupRaces takes nothing returns nothing
    set RaceNames[raceNum]="Chaos Legions"
    set RaceWorkers[raceNum]='h00O'
    set wo[raceNum]='A0DD'
    set RaceChooseSound[raceNum]=CreateSound("Units\\Demon\\HeroPitLord\\HPitLordYesAttack2.wav",false,false,false,$A,$A,"DefaultEAXON")
    set raceNum=raceNum+1
    set RaceNames[raceNum]="Elven Union"
    set RaceWorkers[raceNum]='h00P'
    set wo[raceNum]='A0DE'
    set RaceChooseSound[raceNum]=CreateSound("Units\\Critters\\BloodElfPeasant\\BloodElfEngineerWarcry1.wav",false,false,false,$A,$A,"DefaultEAXON")
    set raceNum=raceNum+1
    set RaceNames[raceNum]="Corrupted Conglomerate"
    set RaceWorkers[raceNum]='u006'
    set wo[raceNum]='A0DF'
    set RaceChooseSound[raceNum]=CreateSound("Units\\Demon\\Pitlord\\PitLordYesAttack1.wav",false,false,false,$A,$A,"DefaultEAXON")
    set raceNum=raceNum+1
    set RaceNames[raceNum]="Human Alliance"
    set RaceWorkers[raceNum]='h00C'
    set wo[raceNum]='A0DG'
    set RaceChooseSound[raceNum]=CreateSound("Units\\Human\\Peasant\\PeasantReady1.wav",false,false,false,$A,$A,"DefaultEAXON")
    set raceNum=raceNum+1
    set RaceNames[raceNum]="Orcish Horde"
    set RaceWorkers[raceNum]='h019'
    set wo[raceNum]='A0DH'
    set RaceChooseSound[raceNum]=CreateSound("Units\\Orc\\Peon\\PeonReady1.wav",false,false,false,$A,$A,"DefaultEAXON")
    set raceNum=raceNum+1
    set RaceNames[raceNum]="Naga Faction"
    set RaceWorkers[raceNum]='h00E'
    set wo[raceNum]='A0DI'
    set RaceChooseSound[raceNum]=CreateSound("Units\\Creeps\\Murloc\\MurlocPissed2.wav",false,false,false,$A,$A,"DefaultEAXON")
    set raceNum=raceNum+1
    set RaceNames[raceNum]="Northern Realms"
    set RaceWorkers[raceNum]='h017'
    set wo[raceNum]='A0DJ'
    set RaceChooseSound[raceNum]=CreateSound("Units\\Creeps\\Bandit\\BanditWhat1.wav",false,false,false,$A,$A,"DefaultEAXON")
    set raceNum=raceNum+1
    set RaceNames[raceNum]="Night Elfs"
    set RaceWorkers[raceNum]='h089'
    set wo[raceNum]='A0DK'
    set RaceChooseSound[raceNum]=CreateSound("Units\\NightElf\\Runner\\RunnerWarcry1.wav",false,false,false,$A,$A,"DefaultEAXON")
    set raceNum=raceNum+1
    set RaceNames[raceNum]="Undead Forces"
    set RaceWorkers[raceNum]='h018'
    set wo[raceNum]='A0DL'
    set RaceChooseSound[raceNum]=CreateSound("Units\\Undead\\Acolyte\\AcolyteWarcry1.wav",false,false,false,$A,$A,"HeroAcksEAX")
    set raceNum=raceNum+1
    set RaceNames[raceNum]="Mech Coalition"
    set RaceWorkers[raceNum]='h06P'
    set wo[raceNum]='A0DM'
    set RaceChooseSound[raceNum]=CreateSound("Units\\Creeps\\HeroTinker\\HeroTinkerReady1.wav",false,false,false,$A,$A,"HeroAcksEAX")
    set raceNum=raceNum+1
    set RaceNames[raceNum]="Nature Force"
    set RaceWorkers[raceNum]='h01A'
    set wo[raceNum]='A0DN'
    set RaceChooseSound[raceNum]=CreateSound("Units\\NightElf\\Ent\\EntReady1.wav",false,false,false,$A,$A,"DefaultEAXON")
    set raceNum=raceNum+1
    set RaceNames[raceNum]="Elementals' Universe"
    set RaceWorkers[raceNum]='h051'
    set wo[raceNum]='A0DO'
    set RaceChooseSound[raceNum]=CreateSound("Units\\NightElf\\Wisp\\WispPissed3.wav",false,false,false,$A,$A,"DefaultEAXON")
    set raceNum=raceNum+1
    set RaceNames[raceNum]="Desert Plains"
    set RaceWorkers[raceNum]='h06N'
    set wo[raceNum]='A0GL'
    set RaceChooseSound[raceNum]=CreateSound("Units\\Creeps\\Kobold\\KoboldPissed3.wav",false,false,false,$A,$A,"DefaultEAXON")
    set raceNum=raceNum+1
    call DisableTrigger(zo)
    call TriggerAddCondition(zo,Condition(function MR))
    call TriggerRegisterAnyUnitEventBJ(zo,EVENT_PLAYER_UNIT_SPELL_CAST)
endfunction
function qR takes nothing returns boolean
local unit u=GetFilterUnit()
local real r=GetWidgetLife(u)
local boolean aX=r>.405 and IsUnitEnemy(u,EraserIssuer)and IsUnitType(u,UNIT_TYPE_GROUND)and GetUnitAbilityLevel(u,'A0CV')>0 and GetUnitAbilityLevel(u,'BHbn')<=0 and r<=600.
set u=null
return aX
endfunction
function QR takes nothing returns boolean
local unit u=GetFilterUnit()
local real r=GetWidgetLife(u)
local boolean aX=r>.405 and IsUnitEnemy(u,EraserIssuer)and IsUnitType(u,UNIT_TYPE_SAPPER)and IsUnitType(u,UNIT_TYPE_GROUND)and GetUnitAbilityLevel(u,'A08H')<=0 and GetUnitAbilityLevel(u,'B012')<=0 and GetUnitAbilityLevel(u,'BHbn')<=0 and((GetUnitState(u,UNIT_STATE_MAX_MANA)>15.)or r<500.)
set u=null
return aX
endfunction
function sR takes nothing returns boolean
local unit u=GetFilterUnit()
local real r=GetWidgetLife(u)
local boolean aX=r>.405 and IsUnitAlly(u,EraserIssuer)and IsUnitType(u,ir)and GetUnitState(u,UNIT_STATE_MAX_LIFE)-r>ar
set u=null
return aX
endfunction
function SR takes unit u returns nothing
local integer uX=GetUnitPointValue(u)
local integer id=GetHandleId(u)
local unit tu
set EraserIssuer=GetOwningPlayer(u)
set tu=LoadUnitHandle(rx,'ASTR',id)
if(uX==$81)then
if(tu!=null and GetWidgetLife(tu)>.405 and IsUnitEnemy(tu,EraserIssuer))then
if(GetUnitAbilityLevel(tu,'B012')>0 or GetUnitAbilityLevel(tu,'BHbn')>0 or not IssueTargetOrderById(u,$D000F,tu))then
call RemoveSavedHandle(rx,'ASTR',id)
endif
elseif(GetUnitAbilityLevel(u,'B012')>0 or IssueImmediateOrderById(u,$D00A1))then
call GroupEnumUnitsInRect(ErasingGroup,hn,vr)
set bj_groupRandomCurrentPick=IX(ErasingGroup)
if(bj_groupRandomCurrentPick==null)then
call GroupEnumUnitsInRect(ErasingGroup,hn,er)
set bj_groupRandomCurrentPick=IX(ErasingGroup)
endif
if(bj_groupRandomCurrentPick==null)then
if(GetRandomInt(0,99)<33)then
call IssuePointOrderById(u,$D0012,GetRandomReal(-800.,800.)+GetUnitX(u),GetRandomReal(-500.,500.)+GetUnitY(u))
endif
else
call SaveUnitHandle(rx,'ASTR',id,bj_groupRandomCurrentPick)
call IssuePointOrderById(u,$D0012,GetUnitX(bj_groupRandomCurrentPick),GetUnitY(bj_groupRandomCurrentPick))
endif
else
call IssuePointOrderByIdLoc(u,$D000F,xo[PlayerForce[GetPlayerId(EraserIssuer)]])
endif
endif
endfunction
function tR takes nothing returns nothing
    set vr=Filter(function qR)
    set er=Filter(function QR)
    set xr=Filter(function sR)
endfunction
function TR takes integer unitType,integer uR,integer UR,integer hp,integer wR,integer WR,integer yR,integer fl,integer YR returns nothing
    local integer i=GetUnitPointValueByType(unitType)
    local integer zR
    local integer ut
    if(HaveSavedInteger(Fr,i,'tmp1'))then
    endif
    set Ir[i]=UR
    set Ar[i]=uR
    set Nr[i]=(hp*(1+.06*I2R(wR))/ I2R(YR))
    set br[i]=WR
    set Br[i]=yR
    call SaveInteger(Fr,unitType,0,1)
    call SaveInteger(Fr,i,'tmp1',unitType)
    set ut=BuildingToItsTrained[i]
    if(ut!=0)then
    set zR=fl
    if(IsUnitIdType(ut,UNIT_TYPE_ATTACKS_FLYING))then
        set zR=zR+(2)
    endif
    if(IsUnitIdType(ut,UNIT_TYPE_ATTACKS_GROUND))then
        set zR=zR+(4)
    endif
    if(zR==0)then
    endif
    if(IsUnitIdType(ut,UNIT_TYPE_FLYING))then
        set zR=zR+(1)
    endif
    endif
    set cr[i]=zR
endfunction
function ZR takes string s returns nothing
local integer i=0
loop
set gr[Gr]=S2R(SubString(s,i*5,i*5+5))
set Gr=Gr+1
set i=i+1
exitwhen i>=7
endloop
endfunction
function vI takes nothing returns nothing
set Gr=0
call ZR("1.75 1.00 0.70 0.45 0.60 0.25 1.05")
call ZR("0.70 0.70 0.70 1.60 0.40 0.20 1.00")
call ZR("0.70 1.75 1.00 0.50 0.60 0.25 1.05")
call ZR("1.00 0.70 1.75 0.40 0.60 0.25 1.05")
call ZR("1.10 1.10 1.10 0.60 0.60 0.40 1.10")
call ZR("1.00 1.00 1.00 1.00 1.00 1.00 1.00")
call ZR("1.00 1.00 1.00 1.00 0.70 0.25 1.00")
endfunction
function eI takes integer ut,integer xI returns nothing
local integer i=GetUnitPointValueByType(ut)
set i=i+xI*300
set Ie[i]=Ie[i]-1
endfunction
function oI takes nothing returns nothing
local integer i=0
loop
set Ie[i]=0
set i=i+1
exitwhen i>300*2
endloop
endfunction
function AILibrary_DumpC takes nothing returns nothing
local integer i=0
local string s1="WGH "
local string s2="WAH "
local string s3="EGH "
local string s4="EAH "
local string s5="EGA "
local string s6="EAA "
local string s7="WGA "
local string s8="WAA "
loop
set s1=s1+(R2SW(qr[i],5,1))
set s2=s2+(R2SW(qr[i+$A],5,1))
set s3=s3+(R2SW(qr[i+20],5,1))
set s4=s4+(R2SW(qr[i+30],5,1))
set s5=s5+(R2SW(Qr[i],5,1))
set s6=s6+(R2SW(Qr[i+$A],5,1))
set s7=s7+(R2SW(Qr[i+20],5,1))
set s8=s8+(R2SW(Qr[i+30],5,1))
set i=i+1
exitwhen i>=7
endloop
call DisplayTextToPlayer(GetLocalPlayer(),.0,.0,s1)
call DisplayTextToPlayer(GetLocalPlayer(),.0,.0,s2)
call DisplayTextToPlayer(GetLocalPlayer(),.0,.0,s3)
call DisplayTextToPlayer(GetLocalPlayer(),.0,.0,s4)
call DisplayTextToPlayer(GetLocalPlayer(),.0,.0,s5)
call DisplayTextToPlayer(GetLocalPlayer(),.0,.0,s6)
call DisplayTextToPlayer(GetLocalPlayer(),.0,.0,s7)
call DisplayTextToPlayer(GetLocalPlayer(),.0,.0,s8)
endfunction
function rI takes integer ut,integer dE returns nothing
local integer pv
local integer iI
local integer fl
local integer j
local integer aI
local integer nI
set sr=false
set pv=GetUnitPointValueByType(ut)
set iI=PlayerForce[dE]*20
set fl=cr[pv]
set j=iI+Ar[pv]
if((fl==4 or fl==5 or fl==6 or fl==7))then
set Qr[j]=Qr[j]+(br[pv])
endif
if((fl==2 or fl==3 or fl==6 or fl==7))then
set j=j+($A)
set Qr[j]=Qr[j]+(br[pv])
endif
set j=20-iI+Ir[pv]
if((fl==1 or fl==3 or fl==5 or fl==7))then
set j=j+($A)
endif
set qr[j]=qr[j]+(Nr[pv])
set aI=PlayerForce[dE]*300
if(UpgradeFrom[pv]!=0)then
set nI=GetUnitPointValueByType(UpgradeFrom[pv])
set fl=cr[nI]
set j=iI+Ar[nI]
if((fl==4 or fl==5 or fl==6 or fl==7))then
set Qr[j]=Qr[j]-(br[nI])
endif
if((fl==2 or fl==3 or fl==6 or fl==7))then
set j=j+($A)
set Qr[j]=Qr[j]-(br[nI])
endif
set j=20-iI+Ir[nI]
if((fl==1 or fl==3 or fl==5 or fl==7))then
set j=j+($A)
endif
set qr[j]=qr[j]-(Nr[nI])
set Ie[aI+nI]=Ie[aI+nI]-1
endif
set aI=aI+(pv)
set Ie[aI]=Ie[aI]+1
set ni=false
set ei[dE]=0
endfunction
function VI takes nothing returns boolean
return GetUnitTypeId(GetFilterUnit())==Sr
endfunction
function EI takes integer XI,player p returns unit
set Sr=XI
call GroupEnumUnitsOfPlayer(ErasingGroup,p,tr)
return FirstOfGroup(ErasingGroup)
endfunction
function OI takes nothing returns nothing
if(GetExpiredTimer()==Kr[0])then
set lr[0]=true
else
set lr[1]=true
endif
endfunction
function RI takes integer dE returns boolean
if(GetUnitAbilityLevel(hr[dE],'A005')<=0)then
    set Lr[PlayerForce[dE]]=Player($E)
    call ForceRemovePlayer(kr[PlayerForce[dE]],Player(dE))
    else
    set lr[PlayerForce[dE]]=false
    set Lr[PlayerForce[dE]]=Player(dE)
    call TimerStart(Kr[PlayerForce[dE]],10.,false,function OI)
    return WarnForRS(hr[dE],Jr[PlayerForce[dE]])
    endif
    return false
endfunction
function II takes nothing returns boolean
local unit u=GetFilterUnit()
local real uh=GetWidgetLife(u)
local boolean aX=uh>50. and IsUnitType(u,UNIT_TYPE_SAPPER)and GetUnitAbilityLevel(u,'Avul')<=0 and GetUnitAbilityLevel(u,'A08H')<=0
if(aX)then
if(IsUnitEnemy(u,EraserIssuer))then
set Tr=Tr+(uh)
set Ur=Ur+1
set wr=wr+(GetUnitX(u))
set Wr=Wr+(GetUnitY(u))
else
set ur=ur+(uh)
endif
endif
set u=null
return false
endfunction
function AI takes nothing returns boolean
local unit u
local integer xI
local player p
local real NI
if(Ze<ex)then
return false
endif
if(IsUnitType(GetAttacker(),UNIT_TYPE_SAPPER))then
set ex=Ze+2
set u=GetTriggerUnit()
set EraserIssuer=GetOwningPlayer(u)
set xI=PlayerForce[GetPlayerId(EraserIssuer)]
if(Vo[xI]<=0)then
set u=null
return false
endif
set NI=GetWidgetLife(u)/ GetUnitState(u,UNIT_STATE_MAX_LIFE)
set Jr[xI]=u
set Tr=500.
set ur=1000.*NI
set Ur=0
set wr=.0
set Wr=.0
call GroupEnumUnitsInRange(ErasingGroup,GetUnitX(u),GetUnitY(u),1400.,yr)
if(Ur>0)then
set wr=wr/(I2R(Ur))
set Wr=Wr/(I2R(Ur))
endif
set p=CX(kr[xI])
if(p!=null and(Ur>4)and(NI<.3 or Tr/ ur>6.)and(lr[xI]or Lr[xI]==p))then
set ex=Ze+8
call RI(GetPlayerId(p))
endif
endif
set u=null
return false
endfunction
function bI takes nothing returns boolean
local unit u=GetFilterUnit()
local real r=GetWidgetLife(u)
local boolean aX=r>.405 and IsUnitAlly(u,EraserIssuer)and IsUnitType(u,UNIT_TYPE_STRUCTURE)
if(aX)then
if(GetUnitState(u,UNIT_STATE_MAX_LIFE)-r>150. and r<Zr)then
set Zr=r
set zr=u
endif
endif
set u=null
return false
endfunction
function BI takes nothing returns nothing
local integer i=0
local unit u
if(mr)then
return
endif
loop
if(jr[i]and hr[i]!=null and GetWidgetLife(hr[i])>.405)then
set u=Jr[PlayerForce[i]]
if(u!=null and GetWidgetLife(u)>.405 and GetUnitState(u,UNIT_STATE_MAX_LIFE)-GetWidgetLife(u)>150.)then
call NX(hr[i],GetUnitX(u),GetUnitY(u),500.)
call IssueTargetOrderById(hr[i],$D0038,u)
else
set EraserIssuer=Player(i)
set zr=null
set Zr=9999.
call GroupEnumUnitsInRect(ErasingGroup,bj_mapInitialPlayableArea,Yr)
set Jr[PlayerForce[i]]=zr
endif
endif
set i=i+1
exitwhen i>$B
endloop
set u=null
endfunction
function cI takes integer tX returns integer
if(tX=='h00O')then
return 5
endif
if(tX=='u006')then
return 0
endif
if(tX=='h00C')then
return 1
endif
if(tX=='h019')then
return 2
endif
if(tX=='h00E')then
return 3
endif
if(tX=='h017')then
return 4
endif
if(tX=='h089')then
return 8
endif
if(tX=='h00P')then
return 7
endif
if(tX=='h018')then
return 6
endif
if(tX=='h06P')then
return 9
endif
if(tX=='h01A')then
return $A
endif
if(tX=='h051')then
return $B
endif
if(tX=='h06N')then
return $C
endif
call DisplayTextToPlayer(GetLocalPlayer(),.0,.0,"Uknown builder!")
return-1
endfunction
function CI takes integer p returns integer
if(p<0)then
return 0
elseif(p>$B)then
return $B
else
return p
endif
endfunction
function dI takes nothing returns nothing
local integer dE=CI(LoadInteger(rx,'TrAi',GetHandleId(GetTriggeringTrigger())))
local integer iI=Rr[dE]
local integer n=2
local integer m=6
local integer tX
local unit bu=null
local real g=GetPlayerState(Player(dE),PLAYER_STATE_RESOURCE_GOLD)
local real w=GetPlayerState(Player(dE),PLAYER_STATE_RESOURCE_LUMBER)
local integer pX
if(ei[dE]==0)then
return
endif
set pX=GetUnitPointValueByType(ei[dE])
if(UnitPrices[pX]>g or Cr[pX]>w)then
return
endif
set tX=UpgradeFrom[pX]
if(tX!=0)then
set bu=EI(tX,Player(dE))
if(bu!=null)then
call SetUnitOwner(bu,Player($F),false)
call SetUnitOwner(bu,Player(dE),false)
call IssueImmediateOrderById(bu,ei[dE])
endif
else
set oi[dE]=true
set bu=hr[dE]
set g=O[iI]
set w=R[iI]
call NX(bu,g,w,300.)
loop
set g=O[iI]
set w=R[iI]
if(IssueBuildOrderById(bu,ei[dE],g,w))then
set m=6
loop
call TriggerSleepAction(.5)
set m=m-1
exitwhen(m<=0 or ei[dE]==0)
endloop
endif
call UV(iI)
call TriggerSleepAction(.3)
set n=n-1
exitwhen n<=0 or ei[dE]==0
endloop
call IssuePointOrderByIdLoc(bu,$D022D,BuilderInitialPosition[dE])
endif
set oi[dE]=false
set bu=null
endfunction
function DI takes nothing returns nothing
local integer fI=0
local integer FI
local real gI
local real GI
local real hI
local real HI
local real jI
local string s
loop
set FI=0
set gI=1.
set GI=1.
set hI=1.
set HI=1.
loop
set jI=gr[FI*7+fI]
set GI=GI+(Qr[FI]*jI)
set gI=gI+(Qr[FI+$A]*jI)
set HI=HI+(Qr[FI+20]*jI)
set hI=hI+(Qr[FI+30]*jI)
set FI=FI+1
exitwhen FI>=7
endloop
set ri[fI]=qr[fI]/(GI)
set ri[fI+$A]=qr[fI+$A]/(gI)
set ri[fI+20]=qr[fI+20]/(HI)
set ri[fI+30]=qr[fI+30]/(hI)
if(ri[fI]<.05)then
set ri[fI]=.0
endif
if(ri[fI+$A]<.05)then
set ri[fI+$A]=.0
endif
if(ri[fI+20]<.05)then
set ri[fI+20]=.0
endif
if(ri[fI+30]<.05)then
set ri[fI+30]=.0
endif
set fI=fI+1
exitwhen fI>=7
endloop
set FI=0
set gI=.01
set GI=.01
set hI=.01
set HI=.01
loop
set GI=GI+(Qr[FI])
set gI=gI+(Qr[FI+$A])
set HI=HI+(Qr[FI+20])
set hI=hI+(Qr[FI+30])
set FI=FI+1
exitwhen FI>=7
endloop
set FI=0
loop
set ai[FI]=Qr[FI]/ GI
set ai[FI+$A]=Qr[FI+$A]/ gI
set ai[FI+20]=Qr[FI+20]/ HI
set ai[FI+30]=Qr[FI+30]/ hI
set FI=FI+1
exitwhen FI>=7
endloop
set FI=0
set gI=.01
set GI=.01
set hI=.01
set HI=.01
loop
set GI=GI+(ri[FI])
set gI=gI+(ri[FI+$A])
set HI=HI+(ri[FI+20])
set hI=hI+(ri[FI+30])
set FI=FI+1
exitwhen FI>=7
endloop
set GI=GI+(gI)
set gI=GI
set HI=HI+(hI)
set hI=HI
set FI=0
loop
set ri[FI]=ri[FI]/ GI
set ri[FI+$A]=ri[FI+$A]/ gI
set ri[FI+20]=ri[FI+20]/ HI
set ri[FI+30]=ri[FI+30]/ hI
set FI=FI+1
exitwhen FI>=7
endloop
set Vi=gI/(gI+GI)
set Ei=hI/(hI+HI)
set ni=true
endfunction
function JI takes integer FI,integer iI returns real
local integer i=0
local real r=.0
loop
set r=r+(ri[iI+i]*gr[FI*7+i])
set i=i+1
exitwhen i>=7
endloop
return r
endfunction
function kI takes integer KI,integer iI returns real
local integer i=0
local real r=.0
local real r1
loop
set r1=ai[iI+i]*gr[KI+7*i]
set r=r+(r1)
set i=i+1
exitwhen i>=7
endloop
return r
endfunction
function lI takes integer pX,integer OX returns real
local integer LI=GetUnitPointValueByType(pX)
local integer fl=Dr[LI]
local real v=fr[LI]
if((fl==2 or fl==3 or fl==6 or fl==7))then
if(OX==1)then
set v=v*Ei
else
set v=v*Vi
endif
endif
if((fl==4 or fl==5 or fl==6 or fl==7))then
if(OX==1)then
set v=v*(1.-Ei)
else
set v=v*(1.-Vi)
endif
endif
if((fl==1 or fl==3 or fl==5 or fl==7))then
set v=v*xx
endif
set Xi=Vi
set Oi=xx
return v/(1.+.05*Ie[OX*300+LI])
endfunction
function mI takes integer pX,integer OX returns real
local integer LI=GetUnitPointValueByType(pX)
local integer fl=cr[LI]
local integer iI=OX*20
set Xi=.0
set Oi=.0
if((fl==4 or fl==5 or fl==6 or fl==7))then
set Xi=Xi+(JI(Ar[LI],iI))
endif
if((fl==2 or fl==3 or fl==6 or fl==7))then
set Xi=Xi+(JI(Ar[LI],iI+$A))
endif
if(Xi<.1)then
return .0
endif
if(Xi>2.2)then
set Xi=2.4
endif
set Xi=Xi*((br[LI]+xx*Br[LI]))
set iI=20-iI
if((fl==1 or fl==3 or fl==5 or fl==7))then
set iI=iI+($A)
endif
set Oi=kI(Ir[LI],iI)
if(Oi>.0)then
set Oi=Nr[LI]/ Oi
else
set Oi=Nr[LI]*2.
endif
return(Xi+Oi)/(1.+.06*Ie[OX*300+LI])
endfunction
function MI takes integer dE,integer ff returns nothing
local integer iI=Hr[dE]*50
local integer n=RaceBuildingArena[iI]
local integer pX=0
local integer i
local integer j
local integer pv
local integer fl
local real pI=GetPlayerState(Player(dE),PLAYER_STATE_RESOURCE_GOLD)
local real PI=GetPlayerState(Player(dE),PLAYER_STATE_RESOURCE_LUMBER)
local real uv=.0
local real bv
local real ik
if(pI<80.)then
return
endif
if(sr)then
if(GetRandomInt(0,99)>60)then
return
endif
set i=n
set j=0
loop
set pX=RaceBuildingArena[iI+i]
set pv=GetUnitPointValueByType(pX)
set pI=pI+(PlayerIncome[dE]*GetRandomReal(2.,4.)/ IncomeTime)
set fl=cr[pv]
if(UnitPrices[pv]<=pI and Ve[pv]>0 and UpgradeFrom[pv]==0 and(fl==4 or fl==5 or fl==6 or fl==7))then
set vi[j]=pX
set j=j+1
if((fl==1 or fl==3 or fl==5 or fl==7))then
set vi[j]=pX
set j=j+1
endif
endif
set i=i-1
exitwhen i==0
endloop
if(j>0)then
set pX=vi[GetRandomInt(0,j-1)]
set ei[dE]=pX
endif
return
endif
set i=n
set j=PlayerForce[dE]
set n=0
set ik=IncomeTime*.012/(.01+PlayerIncome[dE])
set bv=28.
loop
set pX=RaceBuildingArena[iI+i]
set pv=GetUnitPointValueByType(pX)
if((Ve[pv]>0 or BuildingPVWoodCost[pv]<=PI)and((UpgradeFrom[pv]==0)or(Ie[j*300+GetUnitPointValueByType(UpgradeFrom[pv])]>0))and(not dr[pv]or ff>0))then
if(fr[pv]!=.0)then
set uv=lI(pX,j)
else
set uv=mI(pX,j)
endif
if(UnitPrices[pv]>pI)then
set uv=uv/(1.+(UnitPrices[pv]-pI)*ik)
endif
if(uv/ bv>1.1 or(uv/ bv>.75 and GetRandomInt(0,99)<30))then
set bv=uv
set n=pX
endif
endif
set i=i-1
exitwhen i==0
endloop
if(n!=0)then
set ei[dE]=n
endif
endfunction
function qI takes nothing returns nothing
local integer i=0
local integer co=0
local integer ff
local integer j=0
if(mr)then
return
endif
if(GetRandomInt(0,99)>70)then
call IO()
endif
loop
set i=Qe[j]
if(jr[i])then
if(not ni)then
call DI()
endif
set EraserIssuer=Player(i)
if(hr[i]==null or GetWidgetLife(hr[i])<=.405)then
call GroupEnumUnitsOfPlayer(ErasingGroup,EraserIssuer,Pi)
set hr[i]=FirstOfGroup(ErasingGroup)
if(hr[i]!=null)then
set Hr[i]=cI(GetUnitTypeId(hr[i]))
if(GetUnitAbilityLevel(hr[i],'A005')>0)then
call ForceAddPlayer(kr[PlayerForce[i]],EraserIssuer)
endif
endif
else
set co=GetUnitCurrentOrder(hr[i])
if((co==0 or co==$D0038)and GetRandomInt(0,99)<75)then
set ff=GetPlayerState(EraserIssuer,PLAYER_STATE_RESOURCE_FOOD_CAP)-GetPlayerState(EraserIssuer,PLAYER_STATE_RESOURCE_FOOD_USED)
if(ei[i]==0 or GetRandomInt(0,99)>86)then
call MI(i,ff)
if(ei[i]!=0)then
if(i<=5)then
call DisplayTextToForce(WesternForce,GetPlayerName(Player(i))+" waits for |cffFF8204"+GetObjectName(ei[i])+"|r")
else
call DisplayTextToForce(EasternForce,GetPlayerName(Player(i))+" waits for |cffFF8204"+GetObjectName(ei[i])+"|r")
endif
if(not oi[i])then
call TriggerRegisterTimerEvent(xi[i],GetRandomReal(.0,.3),false)
endif
endif
elseif(not oi[i])then
call TriggerRegisterTimerEvent(xi[i],GetRandomReal(.0,.3),false)
endif
endif
endif
endif
set j=j+1
exitwhen j>$B
endloop
endfunction
function AILibrary_PrepareAI takes nothing returns nothing
call ExecuteFunc("QI")
endfunction
function AILibrary_ResetBuildPlaces takes nothing returns nothing
local integer i=0
if(not Mr)then
return
endif
loop
if(jr[i])then
if(IsPlayerInForce(Player(i),WesternForce))then
set Rr[i]=ModuloInteger(i,2)+2
elseif(IsPlayerInForce(Player(i),EasternForce))then
set Rr[i]=ModuloInteger(i,2)
endif
endif
set i=i+1
exitwhen i>$B
endloop
endfunction
function JoinAI takes integer aiIdx returns nothing
local string s
call ExecuteFunc("QI")
if(IsPlayerInForce(Player(aiIdx),WesternForce))then
set Rr[aiIdx]=ModuloInteger(aiIdx,2)+2
elseif(IsPlayerInForce(Player(aiIdx),EasternForce))then
set Rr[aiIdx]=ModuloInteger(aiIdx,2)
endif
set s=SV()
call SetPlayerName(Player(aiIdx),s)
set PlayerNames2[aiIdx]=s
call ZO(aiIdx)
set jr[aiIdx]=true
call DisplayTextToForce(bj_FORCE_ALL_PLAYERS,PlayerNames[aiIdx]+" (AI) joined to game")
endfunction
function SI takes integer dE returns boolean
if(not jr[dE])then
return false
endif
set jr[dE]=false
call ForceRemovePlayer(kr[PlayerForce[dE]],Player(dE))
return true
endfunction
function tI takes nothing returns nothing
local integer i=0
loop
if(Vr[i])then
call DisplayTextToPlayer(Player(i),.0,.0,"|cffCA0000WARNING|r: AI took control over your builder! Type -afk to disable AI.")
endif
set i=i+1
exitwhen i>$B
endloop
endfunction
function GoAFK takes integer dE returns nothing
if(Vr[dE])then
set Vr[dE]=false
call SI(dE)
call SetPlayerName(Player(dE),PlayerNames2[dE])
call DisplayTextToForce(bj_FORCE_ALL_PLAYERS,PlayerNames[dE]+"|cffCA0000 is no longer AFK!|r")
set Er=Er-1
if(Er==0)then
call PauseTimer(Xr)
call DestroyTimer(Xr)
set Xr=null
endif
else
set Vr[dE]=true
set vo[dE]=true
call ExecuteFunc("QI")
if(IsPlayerInForce(Player(dE),WesternForce))then
set Rr[dE]=ModuloInteger(dE,2)+2
elseif(IsPlayerInForce(Player(dE),EasternForce))then
set Rr[dE]=ModuloInteger(dE,2)
endif
call SetPlayerName(Player(dE),"[AFK] "+PlayerNames2[dE])
set jr[dE]=true
call DisplayTextToForce(bj_FORCE_ALL_PLAYERS,PlayerNames[dE]+"|cffCA0000 is AFK!|r AI took control over his units.")
if(Er==0)then
set Xr=CreateTimer()
call TimerStart(Xr,15.,true,function tI)
endif
set Er=Er+1
endif
endfunction
function FillAI takes nothing returns nothing
    local integer i=0
    local boolean hasAI=false
    loop
    if(GetPlayerController(Player(i))==MAP_CONTROL_COMPUTER)then
        call JoinAI(i)
        set hasAI=true
    endif
    set i=i+1
    exitwhen i>$B
    endloop
    if(hasAI)then
    call DisplayTextToForce(bj_FORCE_ALL_PLAYERS,"AI may work improperly: you are playing with computer slots.
    In future use command -fill.")
    endif
endfunction
function UI takes nothing returns nothing
local integer i=0
local integer h
local integer ii
loop
set qr[i]=.0
set Qr[i]=.0
set i=i+1
exitwhen i>40
endloop
call IO()
set i=0
loop
set ei[i]=0
if(xi[i]==null)then
set xi[i]=CreateTrigger()
call TriggerAddAction(xi[i],function dI)
endif
call ResetTrigger(xi[i])
set h=GetHandleId(xi[i])
call SaveInteger(rx,'TrAi',h,i)
set oi[i]=false
set i=i+1
exitwhen i>$B
endloop
call oI()
call TV(false)
call ForceClear(kr[0])
call ForceClear(kr[1])
call PauseTimer(Kr[0])
call PauseTimer(Kr[1])
set lr[0]=true
set lr[1]=true
set Lr[0]=Player($E)
set Lr[1]=Player($E)
set mr=false
set sr=true
endfunction
function AILibrary_Sleep takes nothing returns nothing
set mr=true
endfunction
function QI takes nothing returns nothing
local integer i
local integer ut
local integer zR
if(Mr)then
return
endif
set Fr=InitHashtable()
call vI()
call tV()
call TV(false)
set Yr=Filter(function bI)
call TimerStart(CreateTimer(),2.,true,function qI)
call TimerStart(CreateTimer(),7.,true,function BI)
call TriggerAddCondition(Pr,Condition(function AI))
set yr=Filter(function II)
set tr=Filter(function VI)
set kr[0]=CreateForce()
set kr[1]=CreateForce()
set Kr[0]=CreateTimer()
set Kr[1]=CreateTimer()
set lr[0]=true
set lr[1]=true
set Lr[0]=Player($E)
set Lr[1]=Player($E)
call TR('h025',5,6,570,5,46,0,0,29)
call TR('h009',5,2,850,5,46,30,0,32)
call TR('h007',5,2,$640,7,92,$A,0,40)
call TR('h01C',3,0,450,2,33,0,0,26)
call TR('h01I',2,0,$FA,3,20,0,0,21)
call TR('h026',2,0,700,4,56,20,0,32)
call TR('h01D',2,1,400,5,27,5,0,23)
call TR('h03G',2,1,850,8,60,$F,0,32)
set i=GetUnitPointValueByType('h01M')
set Cr[i]=GetUnitWoodCost('h01M')
set dr[i]=true
set Dr[i]=2+4+1
set fr[i]=350
set i=GetUnitPointValueByType('h01W')
set Cr[i]=GetUnitWoodCost('h01W')
set dr[i]=false
set Dr[i]=2+4+1
set fr[i]=400
set i=GetUnitPointValueByType('h01X')
set Cr[i]=GetUnitWoodCost('h01X')
set dr[i]=false
set Dr[i]=2+4+1
set fr[i]=500
set i=GetUnitPointValueByType('h01E')
set Cr[i]=GetUnitWoodCost('h01E')
set dr[i]=true
set Dr[i]=2+4
set fr[i]=350
set i=GetUnitPointValueByType('h01F')
set Cr[i]=GetUnitWoodCost('h01F')
set dr[i]=false
set Dr[i]=4+1
set fr[i]=$FA
set i=GetUnitPointValueByType('h05I')
set Cr[i]=GetUnitWoodCost('h05I')
set dr[i]=false
set Dr[i]=2+4
set fr[i]='}'
call TR('h000',2,2,$FA,4,20,0,0,20)
call TR('h039',2,2,575,8,38,0,0,29)
call TR('h003',0,1,270,0,22,0,0,22)
call TR('h05D',0,1,500,3,50,20,0,31)
call TR('h0A1',0,1,450,1,45,0,0,30)
call TR('h004',1,0,280,0,20,$F,0,25)
call TR('h015',3,1,500,2,23,0,0,27)
call TR('h037',4,2,600,6,42,5,0,28)
call TR('h038',4,2,820,9,65,$F,0,41)
call TR('h00K',6,6,320,1,32,25,0,30)
call TR('h072',4,2,$578,$C,'d',25,0,52)
set i=GetUnitPointValueByType('h05G')
set Cr[i]=GetUnitWoodCost('h05G')
set dr[i]=true
set Dr[i]=0
set fr[i]=$96
set i=GetUnitPointValueByType('h072')
set Cr[i]=GetUnitWoodCost('h072')
set dr[i]=true
set Dr[i]=0
set fr[i]=$8C
set i=GetUnitPointValueByType('h001')
set Cr[i]=GetUnitWoodCost('h001')
set dr[i]=false
set Dr[i]=1
set fr[i]=50
call TR('h04S',0,1,650,7,37,8,0,27)
call TR('h04V',2,2,320,4,19,5,0,21)
call TR('h04W',2,2,640,5,38,$A,0,27)
call TR('h09Y',2,2,$708,8,'x',$F,0,52)
call TR('h04L',3,0,375,2,30,5,0,24)
call TR('h04N',3,0,740,4,55,$A,0,34)
call TR('h04O',3,1,425,2,27,5,0,26)
call TR('h04M',3,1,700,4,45,$A,0,35)
call TR('h04Q',1,2,600,3,45,8,0,30)
call TR('h04P',1,2,850,4,60,24,0,37)
call TR('h04U',5,1,$3E8,4,65,$F,0,41)
set i=GetUnitPointValueByType('h09Y')
set Cr[i]=GetUnitWoodCost('h09Y')
set dr[i]=true
set Dr[i]=0
set fr[i]=0
set i=GetUnitPointValueByType('h04T')
set Cr[i]=GetUnitWoodCost('h04T')
set dr[i]=true
set Dr[i]=1
set fr[i]=$B9
set i=GetUnitPointValueByType('h04K')
set Cr[i]=GetUnitWoodCost('h04K')
set dr[i]=false
set Dr[i]=2+4
set fr[i]=$87
set i=GetUnitPointValueByType('h04R')
set Cr[i]=GetUnitWoodCost('h04R')
set dr[i]=false
set Dr[i]=4
set fr[i]='}'
call TR('h02K',0,0,$3E8,6,24,0,0,28)
call TR('h092',0,0,$4B0,7,36,0,0,33)
call TR('h035',0,0,$4B0,7,36,5,0,33)
call TR('h036',0,0,$4B0,7,36,5,0,33)
call TR('h02P',0,6,440,2,31,0,0,26)
call TR('h029',2,2,325,4,18,0,0,20)
call TR('h02U',2,2,575,6,30,0,0,25)
call TR('h031',2,2,$3E8,$A,90,$A,0,37)
call TR('h02H',2,1,450,3,30,0,0,25)
call TR('h05E',2,1,600,4,38,0,0,29)
call TR('h02B',3,6,340,1,28,0,0,23)
call TR('h06E',3,6,420,2,43,0,0,28)
call TR('h02I',1,1,475,5,35,35,0,34)
set i=GetUnitPointValueByType('h02O')
set Cr[i]=GetUnitWoodCost('h02O')
set dr[i]=true
set Dr[i]=0
set fr[i]=$E6
set i=GetUnitPointValueByType('h02R')
set Cr[i]=GetUnitWoodCost('h02R')
set dr[i]=false
set Dr[i]=0
set fr[i]=70
set i=GetUnitPointValueByType('h02N')
set Cr[i]=GetUnitWoodCost('h02N')
set dr[i]=false
set Dr[i]=2+4+1
set fr[i]=$C3
call TR('h00F',0,2,625,6,51,$A,0,27)
call TR('h032',0,2,$44C,9,71,20,0,37)
call TR('h020',2,6,650,4,48,0,0,23)
call TR('h021',2,6,$44C,6,68,$A,0,32)
call TR('h022',2,6,$5DC,8,'d',20,0,41)
call TR('h01B',1,2,700,8,55,0,0,29)
call TR('h01Z',5,6,750,4,70,$A,0,32)
call TR('h01Y',3,0,450,2,34,$A,0,26)
call TR('h00J',2,1,325,3,28,0,0,23)
call TR('h05F',5,1,$672,9,$82,50,0,57)
set i=GetUnitPointValueByType('h05F')
set Cr[i]=GetUnitWoodCost('h05F')
set dr[i]=true
set Dr[i]=0
set fr[i]=0
set i=GetUnitPointValueByType('h00N')
set Cr[i]=GetUnitWoodCost('h00N')
set dr[i]=true
set Dr[i]=4+1
set fr[i]=$CD
set i=GetUnitPointValueByType('h00I')
set Cr[i]=GetUnitWoodCost('h00I')
set dr[i]=false
set Dr[i]=4+1
set fr[i]=$A0
set i=GetUnitPointValueByType('h00M')
set Cr[i]=GetUnitWoodCost('h00M')
set dr[i]=false
set Dr[i]=0
set fr[i]=95
set i=GetUnitPointValueByType('h00G')
set Cr[i]=GetUnitWoodCost('h00G')
set dr[i]=false
set Dr[i]=0
set fr[i]=70
call TR('h03U',0,2,325,2,33,0,0,23)
call TR('h03T',0,1,800,5,46,0,0,28)
call TR('h043',0,1,$5DC,7,80,$A,0,39)
call TR('h049',2,6,280,4,20,0,0,21)
call TR('h04F',2,6,550,5,43,$A,0,27)
call TR('h03W',2,6,$4B0,8,95,25,0,39)
call TR('h03K',3,0,350,1,27,0,0,23)
call TR('h03J',3,0,650,3,50,0,0,30)
call TR('h03I',5,2,650,4,33,20,0,29)
call TR('h03S',5,6,650,4,58,0,0,35)
call TR('h076',5,2,$640,6,73,30,0,55)
set i=GetUnitPointValueByType('h03O')
set Cr[i]=GetUnitWoodCost('h03O')
set dr[i]=true
set Dr[i]=1
set fr[i]=$A0
set i=GetUnitPointValueByType('h076')
set Cr[i]=GetUnitWoodCost('h076')
set dr[i]=true
set Dr[i]=0
set fr[i]=0
set i=GetUnitPointValueByType('h048')
set Cr[i]=GetUnitWoodCost('h048')
set dr[i]=false
set Dr[i]=0
set fr[i]=75
set i=GetUnitPointValueByType('h03L')
set Cr[i]=GetUnitWoodCost('h03L')
set dr[i]=false
set Dr[i]=1
set fr[i]='}'
set i=GetUnitPointValueByType('h047')
set Cr[i]=GetUnitWoodCost('h047')
set dr[i]=false
set Dr[i]=2
set fr[i]=85
call TR('h01P',3,0,$FA,2,17,0,0,25)
call TR('h056',4,0,500,4,33,0,0,30)
call TR('h01K',3,6,320,1,31,0,0,25)
call TR('h04B',3,6,550,3,47,5,0,33)
call TR('h055',3,6,900,5,75,$A,0,53)
call TR('h01S',2,0,$4B0,5,74,25,0,40)
call TR('h01N',0,4,425,3,36,5,0,26)
call TR('h054',0,4,650,4,53,$A,0,38)
call TR('h01L',3,5,310,2,48,5,0,29)
call TR('h01T',1,1,$4B0,8,74,$A,0,33)
call TR('h01R',5,1,265,3,22,2,0,21)
call TR('h04Z',5,1,500,5,38,7,0,26)
call TR('h03M',5,1,$41A,6,67,$F,0,36)
set i=GetUnitPointValueByType('h055')
set Cr[i]=GetUnitWoodCost('h055')
set dr[i]=true
set Dr[i]=0
set fr[i]=0
set i=GetUnitPointValueByType('h01Q')
set Cr[i]=GetUnitWoodCost('h01Q')
set dr[i]=true
set Dr[i]=0
set fr[i]=350
set i=GetUnitPointValueByType('h00A')
set Cr[i]=GetUnitWoodCost('h00A')
set dr[i]=false
set Dr[i]=0
set fr[i]=95
call TR('h00S',0,0,350,1,21,0,0,22)
call TR('h03D',0,0,500,3,70,20,0,32)
call TR('h03E',0,0,900,5,90,60,0,52)
call TR('h07M',0,1,375,1,32,0,0,25)
call TR('h07L',0,1,575,2,65,0,0,31)
call TR('h07O',3,0,425,5,38,0,0,26)
call TR('h07N',3,0,700,8,78,0,0,37)
call TR('h00B',3,0,460,2,28,0,0,28)
call TR('h011',1,2,400,2,32,20,0,33)
call TR('h088',5,6,375,1,28,5,0,24)
call TR('h07D',5,6,550,3,50,$F,0,30)
set i=GetUnitPointValueByType('h03E')
set Cr[i]=GetUnitWoodCost('h03E')
set dr[i]=true
set Dr[i]=0
set fr[i]=0
set i=GetUnitPointValueByType('h07I')
set Cr[i]=GetUnitWoodCost('h07I')
set dr[i]=true
set Dr[i]=2+4+1
set fr[i]=$FA
set i=GetUnitPointValueByType('h07H')
set Cr[i]=GetUnitWoodCost('h07H')
set dr[i]=false
set Dr[i]=0
set fr[i]=55
set i=GetUnitPointValueByType('h08P')
set Cr[i]=GetUnitWoodCost('h08P')
set dr[i]=false
set Dr[i]=1
set fr[i]=80
call TR('h08X',0,6,320,2,28,0,0,24)
call TR('h08Y',0,6,550,4,85,0,0,34)
call TR('h06Y',0,2,650,3,46,5,0,30)
call TR('h00T',2,2,450,7,38,0,0,26)
call TR('h03F',2,2,760,$A,'x',0,0,38)
call TR('h00V',3,1,525,3,38,$A,0,28)
call TR('h09X',6,6,550,2,48,$A,0,33)
call TR('h00X',5,6,800,4,65,40,0,54)
call TR('h070',1,1,500,3,32,30,0,32)
set i=GetUnitPointValueByType('h00X')
set Cr[i]=GetUnitWoodCost('h00X')
set dr[i]=true
set Dr[i]=0
set fr[i]=0
set i=GetUnitPointValueByType('h059')
set Cr[i]=GetUnitWoodCost('h059')
set dr[i]=true
set Dr[i]=0
set fr[i]=$F0
set i=GetUnitPointValueByType('h00Z')
set Cr[i]=GetUnitWoodCost('h00Z')
set dr[i]=false
set Dr[i]=0
set fr[i]=65
set i=GetUnitPointValueByType('h005')
set Cr[i]=GetUnitWoodCost('h005')
set dr[i]=false
set Dr[i]=0
set fr[i]=70
call TR('h05X',2,2,450,5,33,0,0,24)
call TR('h09I',5,2,750,8,48,$F,0,34)
call TR('h06G',1,1,550,5,30,30,0,33)
call TR('h09B',2,2,900,$C,62,0,0,34)
call TR('h09J',2,2,650,7,44,0,0,31)
call TR('h05T',5,0,500,4,36,$A,0,26)
call TR('h09P',5,0,700,7,65,$F,0,33)
call TR('h05U',0,1,$3E8,9,58,$F,0,36)
call TR('h05M',6,6,300,0,36,30,0,25)
call TR('h06D',6,6,400,0,45,36,0,30)
call TR('h09H',2,2,950,$C,76,0,2,41)
call TR('h05J',0,0,300,4,28,0,0,23)
call TR('h09L',0,0,625,6,50,0,0,32)
call TR('h05V',5,1,550,$C,47,0,0,28)
call TR('h097',5,5,950,$F,95,5,0,53)
set i=GetUnitPointValueByType('h097')
set Cr[i]=GetUnitWoodCost('h097')
set dr[i]=true
set Dr[i]=0
set fr[i]=0
set i=GetUnitPointValueByType('h06J')
set Cr[i]=GetUnitWoodCost('h06J')
set dr[i]=false
set Dr[i]=0
set fr[i]=45
set i=GetUnitPointValueByType('h05R')
set Cr[i]=GetUnitWoodCost('h05R')
set dr[i]=false
set Dr[i]=0
set fr[i]=75
set i=GetUnitPointValueByType('h069')
set Cr[i]=GetUnitWoodCost('h069')
set dr[i]=false
set Dr[i]=0
set fr[i]=60
call TR('h002',0,6,500,1,36,0,0,23)
call TR('h00Q',0,6,800,3,75,5,0,33)
call TR('h00R',0,6,$4B0,6,'d',$A,0,45)
call TR('h028',1,3,$44C,8,85,5,0,40)
call TR('h00Y',3,0,450,1,37,0,0,25)
call TR('h012',3,0,650,3,51,0,0,35)
call TR('h013',0,1,500,3,37,0,0,26)
call TR('h01H',0,1,950,5,60,5,0,37)
call TR('h01J',5,1,$5DC,4,'d',0,0,57)
call TR('h027',5,2,700,5,45,$F,0,30)
call TR('h023',2,6,680,6,48,5,0,28)
call TR('h024',2,6,$4E2,8,74,0,0,41)
set i=GetUnitPointValueByType('h01J')
set Cr[i]=GetUnitWoodCost('h01J')
set dr[i]=true
set Dr[i]=0
set fr[i]=0
set i=GetUnitPointValueByType('h02D')
set Cr[i]=GetUnitWoodCost('h02D')
set dr[i]=true
set Dr[i]=2+4+1
set fr[i]=$DC
set i=GetUnitPointValueByType('h02C')
set Cr[i]=GetUnitWoodCost('h02C')
set dr[i]=false
set Dr[i]=0
set fr[i]=65
set i=GetUnitPointValueByType('h02A')
set Cr[i]=GetUnitWoodCost('h02A')
set dr[i]=false
set Dr[i]=1
set fr[i]=95
call TR('h045',5,1,480,3,38,0,0,27)
call TR('h046',5,1,900,6,65,$A,0,39)
call TR('h040',1,6,700,5,50,5,0,27)
call TR('h041',1,6,$546,$A,85,$C,0,42)
call TR('h03Y',2,0,330,3,25,0,0,23)
call TR('h03Z',2,0,620,7,45,5,0,31)
call TR('h042',3,2,450,3,40,5,0,26)
call TR('h044',3,2,800,9,65,$F,0,40)
call TR('h04A',0,6,325,2,30,0,0,23)
call TR('h04C',0,6,600,4,40,0,0,33)
call TR('h04D',0,6,480,3,38,0,0,45)
call TR('h04E',5,1,950,6,70,25,0,54)
set i=GetUnitPointValueByType('h04E')
set Cr[i]=GetUnitWoodCost('h04E')
set dr[i]=true
set Dr[i]=0
set fr[i]=0
set i=GetUnitPointValueByType('h063')
set Cr[i]=GetUnitWoodCost('h063')
set dr[i]=true
set Dr[i]=0
set fr[i]=$AA
set i=GetUnitPointValueByType('h060')
set Cr[i]=GetUnitWoodCost('h060')
set dr[i]=false
set Dr[i]=0
set fr[i]=60
set i=GetUnitPointValueByType('h05Z')
set Cr[i]=GetUnitWoodCost('h05Z')
set dr[i]=false
set Dr[i]=1
set fr[i]=$82
call TR('n02O',2,0,320,2,25,0,0,23)
call TR('n02I',2,0,500,4,50,0,0,32)
call TR('n02K',0,6,400,1,33,0,0,27)
call TR('n031',0,6,680,3,50,0,0,35)
call TR('n033',4,6,$4E2,6,70,0,0,56)
call TR('n02L',1,2,650,5,55,5,0,27)
call TR('n02R',1,2,$4B0,9,75,0,0,35)
call TR('n02J',0,6,350,1,27,$A,0,24)
call TR('n02N',0,6,750,4,58,$F,0,32)
call TR('n02M',5,2,850,6,55,30,0,36)
call TR('n02P',3,1,600,6,37,0,0,26)
call TR('n036',3,1,$3E8,8,65,0,0,37)
set i=GetUnitPointValueByType('n033')
set Cr[i]=GetUnitWoodCost('n033')
set dr[i]=true
set Dr[i]=0
set fr[i]=0
set i=GetUnitPointValueByType('h06L')
set Cr[i]=GetUnitWoodCost('h06L')
set dr[i]=false
set Dr[i]=4
set fr[i]=$96
set i=GetUnitPointValueByType('h06I')
set Cr[i]=GetUnitWoodCost('h06I')
set dr[i]=false
set Dr[i]=0
set fr[i]=$9B
set i=GetUnitPointValueByType('h06M')
set Cr[i]=GetUnitWoodCost('h06M')
set dr[i]=true
set Dr[i]=0
set fr[i]=$E1
set Mr=true
endfunction
function wI takes unit u returns nothing
    call IssuePointOrderByIdLoc(u,$D000F,xo[PlayerForce[GetPlayerId(GetOwningPlayer(u))]])
endfunction
function WI takes unit u returns nothing
if(IsUnitType(u,UNIT_TYPE_TAUREN))then
return
endif
if(GetUnitAbilityLevel(u,'A07M')>=1)then
call SR(u)
elseif(GetUnitAbilityLevel(u,'A0ID')>=1)then
call IssueImmediateOrderById(u,$D0004)
return
else
call IssuePointOrderByIdLoc(u,$D000F,xo[PlayerForce[GetPlayerId(GetOwningPlayer(u))]])
endif
endfunction
function yI takes integer dE returns real
return Ai[dE]*IncomeMultiplier[dE]
endfunction
function YI takes integer dE returns real
local real i=yI(dE)
local integer xI=PlayerForce[dE]
if(i<150.)then
set i=i*1.05-(.04*i)*(.05*i)
else
set i=i*.75
endif
return i*He[xI]*Io[xI]
endfunction
function zI takes integer dE,unit u returns nothing
local integer tX=GetHandleId(u)
local real iv=ne[GetUnitPointValue(u)]
local real ZI=LoadReal(rx,'incm',tX)
set Ai[dE]=Ai[dE]+(iv)
if(ZI==null)then
set ZI=.0
endif
call SaveReal(rx,'incm',tX,ZI+iv)
endfunction
function vA takes integer dE,unit u returns nothing
set Ai[dE]=Ai[dE]-(LoadReal(rx,'incm',GetHandleId(u)))
endfunction
function eA takes integer dE,unit u returns nothing
set Ai[dE]=Ai[dE]+(LoadReal(rx,'incm',GetHandleId(u)))
endfunction
function xA takes nothing returns nothing
    set bi=bi+(" "+I2S(PlayerIncome[GetPlayerId(GetEnumPlayer())]))
endfunction
function AddIncome takes nothing returns nothing
    local player p=GetEnumPlayer()
    local integer id=GetPlayerId(p)
    local integer ii
    local real mO=YI(id)
    set ci=ci+(mO)
    set PlayerIncome[id]=R2I(mO)
    set mO=mO*IncomeRate+fo[id]
    set ii=R2I(mO)
    if(ii>0)then
    set mO=mO-(I2R(ii))
    set Do[id]=Do[id]+(ii)
    call SetPlayerState(p,PLAYER_STATE_RESOURCE_GOLD,GetPlayerState(p,PLAYER_STATE_RESOURCE_GOLD)+ii)
    call SetPlayerState(p,PLAYER_STATE_GOLD_GATHERED,GetPlayerState(p,PLAYER_STATE_GOLD_GATHERED)+ii)
    endif
    set fo[id]=mO
endfunction
function IncomeAction takes nothing returns nothing
    local integer i=0
    set ci=.0
    call ForForce(WesternForce,function AddIncome)
    call AO(4,1,I2S(R2I(ci)))
    set ci=.0
    call ForForce(EasternForce,function AddIncome)
    call AO(4,2,I2S(R2I(ci)))
    if(not EnableStreamingIncome)then
    loop
        if(PlayerIncome[i]>0)then
            set bi="Income: |cffFFFF00"+I2S(PlayerIncome[i])
            if(PerPlayerForce[i]!=null)then
                call ForForce(PerPlayerForce[i],function xA)
            endif
            call DisplayTextToPlayer(Player(i),0,0,bi)
        endif
        set i=i+1
        exitwhen i>$B
    endloop
    endif
endfunction
function CheckIncome takes player p returns nothing
    local integer playerId=GetPlayerId(p)
    local string s="Your Treasure Box income multiplier is |cffFFFF00"+R2SW(IncomeMultiplier[playerId],1,2)
    set s=s+("|r, your income is |cffFFFF00"+I2S(R2I(yI(playerId))))
    set s=s+("|r. After paying taxes your income is |cffFFFF00"+I2S(PlayerIncome[playerId])+"|r.")
call DisplayTextToPlayer(p,.0,.0,s)
endfunction
function ShowStat takes player p returns nothing
    local integer id=GetPlayerId(p)
    call DisplayTimedTextToPlayer(p,.0,.0,15.,"-------- Round statistics: --------")
    call DisplayTimedTextToPlayer(p,.0,.0,15.,"Income: |cffFFFF00"+I2S(R2I(YI(id)))+"|r (|cffFFFF00"+I2S(Do[id])+"|r gold in total)")
    if(CoinsEveryPeriod>0)then
        call DisplayTimedTextToPlayer(p,.0,.0,15.,"Coins collected: |cffFFFF00"+I2S(Go[id])+"|r (|cffFFFF00"+I2S(ho[id])+"|r gold)")
    endif
    call DisplayTimedTextToPlayer(p,.0,.0,15.,"Units killed: |cffFFFF00"+I2S(Bo[id])+"|r (|cffFFFF00"+I2S(GetPlayerState(Player(id),PLAYER_STATE_RESOURCE_GOLD)+jo[id]+PayedGolds[id]-Ho[id]-Do[id]-ho[id]-$FA)+"|r gold in total)")
    call DisplayTimedTextToPlayer(p,.0,.0,15.,"|cffFFFF00"+I2S(Co[id])+"|r creepspawning buildings")
    call DisplayTimedTextToPlayer(p,.0,.0,15.,"Specials built: |cffFFFF00"+I2S(do[id])+"|r")
    call DisplayTimedTextToPlayer(p,.0,.0,15.,"Devastating Strike damage: |cffFFFF00"+I2S(Fo[id])+"|r (|cffFFFF00"+I2S(go[id])+"|r units killed)")
    call DisplayTimedTextToPlayer(p,.0,.0,15.,"----------------------------------------------------")
endfunction
function nA takes nothing returns integer
local integer j=1
local integer i=0
loop
if(Fo[i]>Fo[j])then
set j=i
endif
if(Fo[i]>0)then
call Log(I2S(i)+" DSD "+I2S(Fo[i]))
endif
set i=i+1
exitwhen i>$B
endloop
return j
endfunction
function VA takes nothing returns integer
local integer j=1
local integer i=0
loop
if(do[i]>do[j])then
set j=i
endif
set i=i+1
exitwhen i>$B
endloop
return do[j]
endfunction
function EA takes nothing returns integer
local integer j=1
local integer i=0
loop
if(Co[i]>Co[j])then
set j=i
endif
if(Co[i]>0)then
call Log(I2S(i)+" built "+I2S(Co[i])+"/"+I2S(do[i]))
endif
set i=i+1
exitwhen i>$B
endloop
return Co[j]
endfunction
function XA takes nothing returns integer
local integer j=1
local integer i=0
loop
if(Bo[i]>Bo[j])then
set j=i
endif
if(Bo[i]>0)then
call Log(I2S(i)+" killed "+I2S(Bo[i]))
endif
set i=i+1
exitwhen i>$B
endloop
return j
endfunction
function OA takes nothing returns integer
local integer j=0
local integer i=1
loop
if(Go[i]>Go[j])then
set j=i
endif
set i=i+1
exitwhen i>$B
endloop
return j
endfunction
function RA takes nothing returns integer
local integer j=0
local integer v=0
local integer i=0
local integer t
loop
set t=R2I(YI(i))
if(t>v)then
set v=t
set j=i
endif
if(t>.0)then
call Log(I2S(i)+" incomed "+I2S(GetPlayerState(Player(i),PLAYER_STATE_RESOURCE_GOLD)+jo[i]+PayedGolds[i]+Do[i]+ho[i]-$FA-Ho[i]))
endif
set i=i+1
exitwhen i>$B
endloop
return j
endfunction
function IA takes nothing returns nothing
local string s
local string t
local integer g
local integer i
local player p
call DisplayTimedTextToForce(bj_FORCE_ALL_PLAYERS,20.,"|cffFFFF80-----------  End of round statistics  -----------|r")
call DisplayTimedTextToForce(bj_FORCE_ALL_PLAYERS,20.,"Round time: "+bO())
call Log("=== Round finished ===")
set g=R2I(YI(RA()))
set s=""
set i=0
loop
if(R2I(YI(i))==g)then
if(s=="")then
set s=PlayerNames[i]
set t=I2S(Do[i])
else
set s=s+", "+PlayerNames[i]
set t=t+"|r, |cffFFFF00"+I2S(Do[i])
endif
endif
set i=i+1
exitwhen i>$B
endloop
call DisplayTimedTextToForce(bj_FORCE_ALL_PLAYERS,20.,"Moneymaker: "+s+" - |cffFFFF00"+I2S(g)+"|r (|cffFFFF00"+t+"|r gold in total)")
if(CoinsEveryPeriod>0)then
set g=OA()
set s=""
set i=0
loop
set p=Player(i)
if(Go[i]==Go[g])then
if(s=="")then
set s=PlayerNames[i]
set t=I2S(ho[i])
else
set s=s+", "+PlayerNames[i]
set t=t+"|r, |cffFFFF00"+I2S(ho[i])
endif
endif
set i=i+1
exitwhen i>$B
endloop
call DisplayTimedTextToForce(bj_FORCE_ALL_PLAYERS,20.,"Coinminer: "+s+" - |cffFFFF00"+I2S(Go[g])+"|r (|cffFFFF00"+t+"|r gold in total)")
endif
set g=XA()
set s=""
set i=0
loop
if(Bo[i]==Bo[g])then
if(s=="")then
set s=PlayerNames[i]
set t=I2S(GetPlayerState(Player(i),PLAYER_STATE_RESOURCE_GOLD)+jo[i]+PayedGolds[i]-Ho[i]-Do[i]-ho[i]-$FA)
else
set s=s+", "+PlayerNames[i]
set t=t+"|r, |cffFFFF00"+I2S(GetPlayerState(Player(i),PLAYER_STATE_RESOURCE_GOLD)+jo[i]+PayedGolds[i]-Ho[i]-Do[i]-ho[i]-$FA)
endif
endif
set i=i+1
exitwhen i>$B
endloop
set s="Warlord: "+s+" - |cffFFFF00"+I2S(Bo[g])+"|r"
if(NoBounty)then
call DisplayTimedTextToForce(bj_FORCE_ALL_PLAYERS,20.,s)
else
call DisplayTimedTextToForce(bj_FORCE_ALL_PLAYERS,20.,s+" (|cffFFFF00"+t+"|r gold in total)")
endif
set g=EA()
set s=""
set t=""
set i=0
loop
if(Co[i]==g)then
if(s=="")then
set s=PlayerNames[i]
else
set s=s+", "+PlayerNames[i]
endif
endif
set i=i+1
exitwhen i>$B
endloop
call DisplayTimedTextToForce(bj_FORCE_ALL_PLAYERS,20.,"Constructor: "+s+" - |cffFFFF00"+I2S(g))
if(HasSpecials)then
set g=VA()
set s=""
set i=0
if(g>0)then
loop
if(do[i]==g)then
if(s=="")then
set s=PlayerNames[i]
else
set s=s+", "+PlayerNames[i]
endif
endif
set i=i+1
exitwhen i>$B
endloop
endif
call DisplayTimedTextToForce(bj_FORCE_ALL_PLAYERS,20.,"Specialist: "+s+" - |cffFFFF00"+I2S(g)+"|r")
endif
set g=nA()
if(Fo[g]>0)then
call DisplayTimedTextToForce(bj_FORCE_ALL_PLAYERS,20.,"Striker: "+PlayerNames[g]+" - |cffFFFF00"+I2S(Fo[g])+"|r (|cffFFFF00"+I2S(go[g])+"|r units killed)")
endif
call DisplayTimedTextToForce(bj_FORCE_ALL_PLAYERS,20.,"|cffFFFF80--------------------------------------------------------------------|r")
call SaveLog()
endfunction
function AA takes nothing returns nothing
set Bi[0]=.0
set Bi[1]=1.
set Bi[2]=1.85
set Bi[3]=2.57
set Bi[4]=3.18
set Bi[5]=3.7
set Bi[6]=4.14
set Bi[7]=4.52
set Bi[8]=4.84
set Bi[9]=5.11
set He[0]=1.
set He[1]=1.
endfunction
function NA takes nothing returns nothing
local timer t=GetExpiredTimer()
local unit u=LoadUnitHandle(rx,'CaTm',GetHandleId(t))
if(u!=null)then
call SetUnitPathing(u,true)
call WI(u)
endif
call PauseTimer(t)
call DestroyTimer(t)
set u=null
set t=null
endfunction
function bA takes nothing returns nothing
local unit u=GetEnumUnit()
local timer t
local integer n=LoadInteger(rx,'CaCn',GetHandleId(u))
if(GetUnitCurrentOrder(u)==0)then
set n=n+1
if(n>=3)then
call SetUnitPathing(u,false)
call WI(u)
set t=CreateTimer()
call TimerStart(t,3.,false,function NA)
call SaveUnitHandle(rx,'CaTm',GetHandleId(t),u)
set t=null
set n=0
endif
else
set n=0
endif
call SaveInteger(rx,'CaCn',GetHandleId(u),n)
set u=null
endfunction
function BA takes nothing returns nothing
call ForGroup(Ci,function bA)
endfunction
function cA takes unit u returns nothing
call SaveInteger(rx,'CaCn',GetHandleId(u),0)
call GroupAddUnit(Ci,u)
endfunction
function CA takes nothing returns nothing
if(CagingMode)then
call TimerStart(di,1.,true,function BA)
endif
endfunction
function dA takes nothing returns nothing
local integer i=0
loop
if(pe[i]!=null)then
if(GetLocalPlayer()==Player(i))then
call MultiboardDisplay(pe[i],true)
endif
else
if(GetLocalPlayer()==Player(i))then
call MultiboardDisplay(Se,true)
endif
endif
set i=i+1
exitwhen i>$B
endloop
endfunction
function DA takes nothing returns nothing
local integer i=0
local integer x=0
local multiboarditem fA
local player p
loop
if(Pe[i]!=null)then
set p=Player(i)
set fA=MultiboardGetItem(Pe[i],qe[i],3)
call MultiboardSetItemValue(fA,I2S(GetPlayerState(p,PLAYER_STATE_RESOURCE_GOLD)))
call MultiboardReleaseItem(fA)
set fA=MultiboardGetItem(Pe[i],qe[i],4)
call MultiboardSetItemValue(fA,I2S(GetPlayerState(p,PLAYER_STATE_RESOURCE_LUMBER)))
call MultiboardReleaseItem(fA)
set fA=MultiboardGetItem(Pe[i],qe[i],5)
call MultiboardSetItemValue(fA,I2S(GetPlayerState(p,PLAYER_STATE_RESOURCE_FOOD_USED))+"/"+I2S(GetPlayerState(p,PLAYER_STATE_RESOURCE_FOOD_CAP)))
call MultiboardReleaseItem(fA)
endif
if(te[i]>0)then
set p=Player(i)
if(IsPlayerInForce(p,WesternForce))then
set x=0
else
set x=6
endif
set fA=MultiboardGetItem(Se,te[i],x+2)
call MultiboardSetItemValue(fA,I2S(GetPlayerState(p,PLAYER_STATE_RESOURCE_GOLD)))
call MultiboardReleaseItem(fA)
set fA=MultiboardGetItem(Se,te[i],x+3)
call MultiboardSetItemValue(fA,I2S(GetPlayerState(p,PLAYER_STATE_RESOURCE_LUMBER)))
call MultiboardReleaseItem(fA)
set fA=MultiboardGetItem(Se,te[i],x+4)
call MultiboardSetItemValue(fA,I2S(PlayerIncome[i]))
call MultiboardReleaseItem(fA)
endif
set i=i+1
exitwhen i>$B
endloop
set fA=null
endfunction
function FA takes integer dE,string gA returns nothing
local integer i=0
local integer j=0
local multiboarditem fA
call MultiboardSetRowCount(pe[dE],CountPlayersInForceBJ(PerPlayerForce[dE])+6)
set fA=MultiboardGetItem(pe[dE],4,0)
call MultiboardSetItemStyle(fA,false,false)
call MultiboardReleaseItem(fA)
set fA=MultiboardGetItem(pe[dE],4,1)
call MultiboardSetItemStyle(fA,false,false)
call MultiboardReleaseItem(fA)
set fA=MultiboardGetItem(pe[dE],4,2)
call MultiboardSetItemStyle(fA,false,false)
call MultiboardReleaseItem(fA)
set fA=MultiboardGetItem(pe[dE],4,3)
call MultiboardSetItemStyle(fA,false,false)
call MultiboardReleaseItem(fA)
set fA=MultiboardGetItem(pe[dE],4,4)
call MultiboardSetItemStyle(fA,false,false)
call MultiboardReleaseItem(fA)
set fA=MultiboardGetItem(pe[dE],4,5)
call MultiboardSetItemStyle(fA,false,false)
call MultiboardReleaseItem(fA)
set fA=MultiboardGetItem(pe[dE],5,0)
call MultiboardSetItemStyle(fA,false,false)
call MultiboardReleaseItem(fA)
set fA=MultiboardGetItem(pe[dE],5,1)
call MultiboardSetItemStyle(fA,true,false)
call MultiboardSetItemValue(fA,gA)
call MultiboardSetItemWidth(fA,.1)
call MultiboardReleaseItem(fA)
set fA=MultiboardGetItem(pe[dE],5,2)
call MultiboardSetItemStyle(fA,false,false)
call MultiboardReleaseItem(fA)
set fA=MultiboardGetItem(pe[dE],5,3)
call MultiboardSetItemStyle(fA,false,false)
call MultiboardReleaseItem(fA)
set fA=MultiboardGetItem(pe[dE],5,4)
call MultiboardSetItemStyle(fA,false,false)
call MultiboardReleaseItem(fA)
set fA=MultiboardGetItem(pe[dE],5,5)
call MultiboardSetItemStyle(fA,false,false)
call MultiboardReleaseItem(fA)
loop
if(IsPlayerInForce(Player(i),PerPlayerForce[dE]))then
set fA=MultiboardGetItem(pe[dE],j+6,0)
call MultiboardSetItemStyle(fA,true,false)
call MultiboardSetItemValue(fA,PlayerNames[i])
call MultiboardSetItemWidth(fA,.09)
call MultiboardReleaseItem(fA)
set fA=MultiboardGetItem(pe[dE],j+6,1)
call MultiboardSetItemStyle(fA,false,false)
call MultiboardSetItemWidth(fA,.0001)
call MultiboardReleaseItem(fA)
set fA=MultiboardGetItem(pe[dE],j+6,2)
call MultiboardSetItemStyle(fA,false,false)
call MultiboardSetItemWidth(fA,.0001)
call MultiboardReleaseItem(fA)
set fA=MultiboardGetItem(pe[dE],j+6,3)
call MultiboardSetItemStyle(fA,true,true)
call MultiboardSetItemIcon(fA,"UI\\Feedback\\Resources\\ResourceGold.blp")
call MultiboardSetItemWidth(fA,.035)
call MultiboardReleaseItem(fA)
set fA=MultiboardGetItem(pe[dE],j+6,4)
call MultiboardSetItemStyle(fA,true,true)
call MultiboardSetItemIcon(fA,"UI\\Feedback\\Resources\\ResourceLumber.blp")
call MultiboardSetItemWidth(fA,.035)
call MultiboardReleaseItem(fA)
set fA=MultiboardGetItem(pe[dE],j+6,5)
call MultiboardSetItemStyle(fA,true,true)
call MultiboardSetItemIcon(fA,"UI\\Feedback\\Resources\\ResourceManaStone.blp")
call MultiboardSetItemWidth(fA,.03)
call MultiboardReleaseItem(fA)
set Pe[i]=pe[dE]
set qe[i]=j+6
set j=j+1
endif
set i=i+1
exitwhen i>$B
endloop
set fA=null
endfunction
function GA takes nothing returns nothing
local integer i=IMaxBJ(CountPlayersInForceBJ(WesternForce),CountPlayersInForceBJ(EasternForce))
local integer j=0
local multiboarditem fA
call MultiboardSetTitleText(Se,Di)
call MultiboardSetRowCount(Se,6+i)
set Te=4+i
call MultiboardSetColumnCount(Se,$B)
call MultiboardSetItemStyleBJ(Se,0,0,true,false)
call MultiboardSetItemWidthBJ(Se,1,0,8.)
call MultiboardSetItemWidthBJ(Se,6,0,1.)
call MultiboardSetItemWidthBJ(Se,7,0,8.)
set fA=MultiboardGetItem(Se,Te+1,0)
call MultiboardSetItemWidth(fA,10.)
call MultiboardReleaseItem(fA)
set i=0
loop
set fA=MultiboardGetItem(Se,0,i+0)
call MultiboardSetItemValue(fA,"|cffFFFF80Team|r")
call MultiboardReleaseItem(fA)
set fA=MultiboardGetItem(Se,0,i+1)
call MultiboardSetItemValue(fA,"|cffFFFF80Resc.|r")
call MultiboardReleaseItem(fA)
set fA=MultiboardGetItem(Se,0,i+2)
call MultiboardSetItemValue(fA,"|cffFFFF80Destr.|r")
call MultiboardReleaseItem(fA)
set fA=MultiboardGetItem(Se,0,i+3)
call MultiboardSetItemValue(fA,"|cffFFFF80Income|r")
call MultiboardReleaseItem(fA)
set fA=MultiboardGetItem(Se,0,i+4)
call MultiboardSetItemValue(fA,"|cffFFFF80Wins|r")
call MultiboardReleaseItem(fA)
call MultiboardSetItemWidthBJ(Se,i+5,0,1.8)
set i=i+(6)
exitwhen i>6
endloop
set fA=MultiboardGetItem(Se,1,0)
call MultiboardSetItemValue(fA,"|cffFF0000West|r")
call MultiboardReleaseItem(fA)
set fA=MultiboardGetItem(Se,1,6)
call MultiboardSetItemValue(fA,"|cff00FF00East|r")
call MultiboardReleaseItem(fA)
set fA=MultiboardGetItem(Se,1,2)
call MultiboardSetItemValue(fA,"0")
call MultiboardReleaseItem(fA)
set fA=MultiboardGetItem(Se,1,8)
call MultiboardSetItemValue(fA,"0")
call MultiboardReleaseItem(fA)
set fA=MultiboardGetItem(Se,1,4)
call MultiboardSetItemValue(fA,I2S(eo[0]))
call MultiboardReleaseItem(fA)
set fA=MultiboardGetItem(Se,1,$A)
call MultiboardSetItemValue(fA,I2S(eo[1]))
call MultiboardReleaseItem(fA)
set i=0
loop
set fA=MultiboardGetItem(Se,3,i+0)
call MultiboardSetItemValue(fA,"|cffFFFF80Player|r")
call MultiboardReleaseItem(fA)
set fA=MultiboardGetItem(Se,3,i+1)
call MultiboardSetItemStyle(fA,false,true)
call MultiboardSetItemIcon(fA,"ReplaceableTextures\\CommandButtons\\BTNHolyBolt.blp")
call MultiboardReleaseItem(fA)
set fA=MultiboardGetItem(Se,3,i+2)
call MultiboardSetItemStyle(fA,false,true)
call MultiboardSetItemIcon(fA,"UI\\Feedback\\Resources\\ResourceGold.blp")
call MultiboardReleaseItem(fA)
set fA=MultiboardGetItem(Se,3,i+3)
call MultiboardSetItemStyle(fA,false,true)
call MultiboardSetItemIcon(fA,"UI\\Feedback\\Resources\\ResourceLumber.blp")
call MultiboardReleaseItem(fA)
set fA=MultiboardGetItem(Se,3,i+4)
call MultiboardSetItemStyle(fA,false,true)
call MultiboardSetItemIcon(fA,"ReplaceableTextures\\CommandButtons\\BTNChestOfGold.blp")
call MultiboardReleaseItem(fA)
set i=i+(6)
exitwhen i>6
endloop
set i=0
set j=4
loop
if(IsPlayerInForce(Player(i),WesternForce))then
set te[i]=j
set fA=MultiboardGetItem(Se,te[i],0)
call MultiboardSetItemValue(fA,PlayerNames[i])
call MultiboardReleaseItem(fA)
set j=j+1
else
set te[i]=0
endif
set i=i+1
exitwhen i>$B
endloop
set i=0
set j=4
loop
if(IsPlayerInForce(Player(i),EasternForce))then
set te[i]=j
set fA=MultiboardGetItem(Se,te[i],6)
call MultiboardSetItemValue(fA,PlayerNames[i])
call MultiboardReleaseItem(fA)
set j=j+1
endif
set i=i+1
exitwhen i>$B
endloop
set fA=null
endfunction
function hA takes nothing returns nothing
local integer i=0
local player p
local string HA=GetLocalizedString("TEAM_RESOURCES")+":"
if(Wx>0 or zx>0)then
if(ee)then
call nR()
endif
endif
if(ee)then
call JX()
endif
if(Se!=null)then
call DestroyMultiboard(Se)
endif
set Se=CreateMultiboard()
call GA()
loop
set p=Player(i)
if(PerPlayerForce[i]!=null)then
if(pe[i]!=null)then
call DestroyMultiboard(pe[i])
endif
set pe[i]=CreateMultiboard()
call MultiboardSetRowCount(pe[i],4)
call MultiboardSetColumnCount(pe[i],6)
call MultiboardSetTitleText(pe[i],Di)
call MultiboardSetItemStyleBJ(pe[i],0,0,true,false)
call MultiboardSetItemValueBJ(pe[i],0,0,"0")
call MultiboardSetItemValueBJ(pe[i],0,4,"")
call MultiboardSetItemColorBJ(pe[i],6,0,'d',90.,.0,0)
call MultiboardSetItemValueBJ(pe[i],1,1,"")
call MultiboardSetItemValueBJ(pe[i],2,1,"Resc.")
call MultiboardSetItemValueBJ(pe[i],3,1,"Coins")
call MultiboardSetItemValueBJ(pe[i],4,1,"Destr.")
call MultiboardSetItemValueBJ(pe[i],5,1,"Income")
call MultiboardSetItemValueBJ(pe[i],6,1,"|cffFFFF80Wins|r")
call MultiboardSetItemValueBJ(pe[i],1,2,"|cffFF0000West|r")
call MultiboardSetItemValueBJ(pe[i],1,3,"|cff00FF00East|r")
call MultiboardSetItemValueBJ(pe[i],1,4,"|cffFFFF00Round Time:|r")
call MultiboardSetItemValueBJ(pe[i],6,4,"|cffFFFF000|cffFF8000:|cffFFFF0000|r")
call MultiboardSetItemWidthBJ(pe[i],0,4,2.)
call MultiboardSetItemWidthBJ(pe[i],1,4,7.)
call MultiboardSetItemWidthBJ(pe[i],6,4,3.)
if(CountPlayersInForceBJ(PerPlayerForce[i])>0)then
call FA(i,HA)
endif
endif
set i=i+1
exitwhen i>$B
endloop
if(fi==null)then
set fi=CreateTimer()
call TimerStart(fi,1.,true,function DA)
endif
call AO(5,1,I2S(eo[0]))
call AO(5,2,I2S(eo[1]))
call dA()
endfunction
function jA takes nothing returns nothing
local unit fV=GetAttacker()
local unit JA
if(GetUnitAbilityLevel(fV,'A0EZ')>0)then
set JA=GetTriggerUnit()
call UnitRemoveAbility(fV,'A0EZ')
call TriggerSleepAction(.0)
if(not IssueTargetOrderById(fV,$D0279,JA))then
call wI(fV)
endif
set JA=null
endif
set fV=null
endfunction
function kA takes nothing returns nothing
    call TriggerRegisterAnyUnitEventBJ(Fi,EVENT_PLAYER_UNIT_ATTACKED)
    call TriggerAddAction(Fi,function jA)
endfunction
function KA takes boolean lA returns nothing
if(lA)then
call EnableTrigger(Fi)
else
call DisableTrigger(Fi)
endif
endfunction
function LA takes boolean fl returns nothing
local string s1
local string s2
if((not fl)and Ji)then
return
endif
set Ji=true
if(Bx==1)then
if(bx==0)then
set s1=PlayerNames[0]+" has chosen single round/pick race. You may pick your race! The first round determines the winner!"
set s2="Single Round Pick"
elseif(bx==1)then
set s1=PlayerNames[0]+" has chosen single round/random race. You will get a random race! The first round determines the winner!"
set s2="Single Round Random"
elseif(bx==2)then
set s1=PlayerNames[0]+" has chosen single round/mirror mode. Both teams will get the same random races! The first round determines the winner!"
set s2="Single Round Random"
elseif(bx==3)then
set s1=PlayerNames[0]+" has chosen single round/draft race. Races will be drafted! The first round determines the winner!"
set s2="Single Round Draft"
endif
else
if(Gx)then
if(bx==0)then
set s1=PlayerNames[0]+" has chosen |cffFFFF00pick|r race. You may pick a race at the beginning that you keep for the |cffFFFF00whole game|r! Number of wins for overall victory: |cffFFFF00"+I2S(Bx)+"|r"
set s2="Pick once, |cffFFCC00"+I2S(Bx)+"|cffFFFF80 wins"
elseif(bx==1)then
set s1=PlayerNames[0]+" has chosen |cffFFFF00random|r race. You will get a random race at the beginning that you keep for the |cffFFFF00whole game|r! Number of wins for overall victory: |cffFFFF00"+I2S(Bx)+"|r"
set s2="Random once, |cffFFCC00"+I2S(Bx)+"|cffFFFF80 wins"
elseif(bx==2)then
set s1=PlayerNames[0]+" has chosen |cffFFFF00mirror mode|r. Both teams will get the same random races at the beginning that they will keep for the |cffFFFF00whole game|r! Number of wins for overall victory: |cffFFFF00"+I2S(Bx)+"|r"
set s2="Mirror once, |cffFFCC00"+I2S(Bx)+"|cffFFFF80 wins"
elseif(bx==3)then
set s1=PlayerNames[0]+" has chosen |cffFFFF00draft|r race. You will draft a race at the beginning that you keep for the |cffFFFF00whole game|r! Number of wins for overall victory: |cffFFFF00"+I2S(Bx)+"|r"
set s2="Draft once, |cffFFCC00"+I2S(Bx)+"|cffFFFF80 wins"
endif
else
if(bx==0)then
set s1=PlayerNames[0]+" has chosen |cffFFFF00pick|r race |cffFFFF00each round|r. You may pick a new race each round! Number of wins for overall victory: |cffFFFF00"+I2S(Bx)+"|r"
set s2="Pick each round, |cffFFCC00"+I2S(Bx)+"|cffFFFF80 wins"
elseif(bx==1)then
set s1=PlayerNames[0]+" has chosen |cffFFFF00random|r race |cffFFFF00each round|r. You will get a new random race each round! Number of wins for overall victory: |cffFFFF00"+I2S(Bx)+"|r"
set s2="Random each round, |cffFFCC00"+I2S(Bx)+"|cffFFFF80 wins"
elseif(bx==2)then
set s1=PlayerNames[0]+" has chosen  |cffFFFF00mirror mode each round|r. Both teams will get the same random races each round! Number of wins for overall victory: |cffFFFF00"+I2S(Bx)+"|r"
set s2="Mirror each round, |cffFFCC00"+I2S(Bx)+"|cffFFFF80 wins"
elseif(bx==3)then
set s1=PlayerNames[0]+" has chosen |cffFFFF00draft|r race |cffFFFF00each round|r. You will draft a new race each round! Number of wins for overall victory: |cffFFFF00"+I2S(Bx)+"|r"
set s2="Draft each round, |cffFFCC00"+I2S(Bx)+"|cffFFFF80 wins"
endif
endif
endif
set Di="|cffFFFF80"+s2+"|r"
if(fl or not Me)then
call DisplayTimedTextToForce(bj_FORCE_ALL_PLAYERS,25.,s1)
endif
endfunction
function mA takes nothing returns nothing
set ji[0]=null
set ji[1]=null
set ji[2]=null
set ji[3]=null
call DialogClear(Hi)
call DialogDestroy(Hi)
set Hi=null
call DestroyTimerDialog(Gi)
set Gi=null
call PauseTimer(gi)
call DestroyTimer(gi)
set gi=null
call DestroyTrigger(hi)
set hi=null
call LA(false)
call TriggerExecute(Nn)
endfunction
function MA takes nothing returns nothing
set Gx=not(GetClickedButton()==ji[0])
call TriggerSleepAction(.1)
call mA()
endfunction
function pA takes nothing returns nothing
    call TriggerSleepAction(.1)
    call DialogClear(Hi)
    call DialogSetMessage(Hi,"每轮重选?")
    set ji[0]=DialogAddButton(Hi,"是",0)
    set ji[1]=DialogAddButton(Hi,"否",0)
    call TriggerClearActions(hi)
    call TriggerAddAction(hi,function MA)
    call DialogDisplay(Player(0),Hi,true)
endfunction
function PA takes nothing returns nothing
if(GetClickedButton()==ji[0])then
set Rx="qA"
set bx=0
else
set Rx="QA"
set bx=1
endif
if(Bx==1)then
set Gx=false
call mA()
else
call pA()
endif
endfunction
function sA takes nothing returns nothing
call TriggerSleepAction(.1)
call DialogClear(Hi)
call DialogSetMessage(Hi,"种族选择?")
set ji[0]=DialogAddButton(Hi,"我自己选!",0)
set ji[1]=DialogAddButton(Hi,"随便来一个!",0)
call TriggerClearActions(hi)
call TriggerAddAction(hi,function PA)
call DialogDisplay(Player(0),Hi,true)
endfunction
function SA takes nothing returns nothing
local button cl=GetClickedButton()
local integer i=0
loop
exitwhen cl==ji[i]
set i=i+1
endloop
set Bx=i+1
set cl=null
call sA()
endfunction
function GameModeSelection takes nothing returns nothing
    call PauseTimer(gi)
    set CommandAvailable=false
    if(bx!=-1)then
        call mA()
        return
    endif
    call DialogSetMessage(Hi,"获胜场次?")
    set ji[0]=DialogAddButton(Hi,"1",0)
    set ji[1]=DialogAddButton(Hi,"2",0)
    set ji[2]=DialogAddButton(Hi,"3",0)
    set ji[3]=DialogAddButton(Hi,"4",0)
    call TriggerAddAction(hi,function SA)
    call DialogDisplay(Player(0),Hi,true)
endfunction
function PrepareGame takes nothing returns nothing
    call TimerStart(gi,20.,false,function GameModeSelection)
    set Gi=CreateTimerDialog(gi)
    call TimerDialogSetTitle(Gi,"比赛即将开始:")
    call TimerDialogDisplay(Gi,true)
    call DisplayTimedTextToPlayer(Player(0),.0,.0,30.,"欢迎来到 |cffFFFF80城堡战争|r! 你将有20秒用于选择模式，如果未输入任何有效命令，将会通过对话框选择游戏模式。如果不清楚怎么选择游戏模式，可以阅读 |cff80FF00帮助|r (|cffFFBA17F9|r)。")
    call CinematicFadeBJ(1,.0,"ReplaceableTextures\\CameraMasks\\Black_mask.blp",.0,0,0,6.)
    call FlashQuestDialogButton()
endfunction
function InitialGameStart takes nothing returns nothing
    call TimerStart(gi,.01,false,function PrepareGame)
    call TriggerRegisterDialogEvent(hi,Hi)
endfunction
function UA takes unit u,real r returns nothing
local integer wA=20+R2I((r-500.)/ 50)
local real x=GetUnitX(u)
local real y=GetUnitY(u)
local integer i=0
local string WA=""
local real an
local effect array e
if(GetOwningPlayer(u)==GetLocalPlayer())then
set WA="Abilities\\Spells\\NightElf\\Barkskin\\BarkSkinTarget.mdl"
endif
loop
exitwhen i>=wA
set an=2.*bj_PI*i/ wA
set e[i]=AddSpecialEffect("Abilities\\Spells\\NightElf\\Barkskin\\BarkSkinTarget.mdl",x+r*Cos(an),y+r*Sin(an))
set i=i+1
endloop
call TriggerSleepAction(6.)
set i=0
loop
exitwhen i>=wA
call DestroyEffect(e[i])
set e[i]=null
set i=i+1
endloop
endfunction
function yA takes unit u returns nothing
call IssuePointOrderByIdLoc(u,$D0012,xo[PlayerForce[GetPlayerId(GetOwningPlayer(u))]+2])
endfunction
function YA takes nothing returns boolean
local unit u=GetFilterUnit()
local boolean aX=GetWidgetLife(u)>.405 and IsUnitEnemy(u,EraserIssuer)and IsUnitType(u,UNIT_TYPE_SAPPER)and IsUnitType(u,UNIT_TYPE_GROUND)and GetUnitAbilityLevel(u,'Avul')<=0 and GetUnitAbilityLevel(u,'A08H')<=0
set u=null
return aX
endfunction
function zA takes nothing returns boolean
local unit u=GetFilterUnit()
local boolean aX=GetWidgetLife(u)>100. and IsUnitEnemy(u,EraserIssuer)and IsUnitType(u,UNIT_TYPE_SAPPER)and not IsUnitType(u,UNIT_TYPE_MECHANICAL)
set u=null
return aX
endfunction
function ZA takes unit u,integer vN returns nothing
local player p=GetOwningPlayer(u)
local integer dE=GetPlayerId(p)
if(LumberLimit>0)then
if(Ko[dE]+vN>=LumberLimit)then
set vN=LumberLimit-Ko[dE]
if(vN<=0)then
return
endif
set Ko[dE]=LumberLimit
else
set Ko[dE]=Ko[dE]+(vN)
endif
endif
call AdjustPlayerStateBJ(vN,p,PLAYER_STATE_RESOURCE_LUMBER)
set bj_lastCreatedTextTag=CreateTextTag()
call SetTextTagText(bj_lastCreatedTextTag,I2S(vN),.024)
call SetTextTagPos(bj_lastCreatedTextTag,GetUnitX(u)-36.,GetUnitY(u)-16.,.0)
call SetTextTagColor(bj_lastCreatedTextTag,0,$C8,80,$FF)
call SetTextTagPermanent(bj_lastCreatedTextTag,false)
call SetTextTagLifespan(bj_lastCreatedTextTag,3.)
call SetTextTagFadepoint(bj_lastCreatedTextTag,1.)
call SetTextTagVelocity(bj_lastCreatedTextTag,0,.06)
if(p!=GetLocalPlayer())then
call SetTextTagVisibility(bj_lastCreatedTextTag,false)
else
call SetTextTagVisibility(bj_lastCreatedTextTag,true)
endif
endfunction
function eN takes unit u returns boolean
local integer i
local boolean r
if(GetUnitAbilityLevel(u,'A09L')>0)then
set i=GetUnitAbilityLevel(u,'A09L')
if(i==2)then
call SetUnitAbilityLevel(u,'A09L',1)
call SetUnitAbilityLevel(u,'A09Q',1)
call SetUnitState(u,UNIT_STATE_LIFE,GetWidgetLife(u)+150.)
else
call UnitRemoveAbility(u,'A09L')
call UnitRemoveAbility(u,'A09Q')
endif
call DestroyEffect(AddSpecialEffectTarget("Abilities\\Spells\\Items\\AIvi\\AIviTarget.mdl",u,"origin"))
set r=true
elseif(GetUnitTypeId(u)=='n01T')then
set i=GetUnitAbilityLevel(u,'A09C')+1
if(i>=6)then
return false
else
call SetUnitAbilityLevel(u,'A09C',i)
call SetUnitAbilityLevel(u,'A09B',i)
call SetUnitAbilityLevel(u,'A00J',i)
call DestroyEffect(AddSpecialEffectTarget("Abilities\\Spells\\Human\\Avatar\\AvatarCaster.mdl",u,"origin"))
set r=true
endif
else
set r=GetUnitAbilityLevel(u,'A07H')>0
endif
if(r)then
call DestroyEffect(AddSpecialEffectTarget("Abilities\\Spells\\Human\\DispelMagic\\DispelMagicTarget.mdl",u,"origin"))
endif
return r
endfunction
function xN takes nothing returns boolean
local unit u=GetFilterUnit()
local boolean aX=GetWidgetLife(u)>.405 and IsUnitEnemy(u,EraserIssuer)and IsUnitType(u,UNIT_TYPE_SAPPER)and GetUnitAbilityLevel(u,'Avul')<=0 and GetUnitAbilityLevel(u,'A08H')<=0
set u=null
return aX
endfunction
function oN takes nothing returns nothing
call SR(GetEnumUnit())
endfunction
function rN takes nothing returns nothing
call ForGroup(Li,function oN)
endfunction
function iN takes nothing returns boolean
local unit u=GetFilterUnit()
local boolean aX=GetWidgetLife(u)>.405 and IsUnitType(u,UNIT_TYPE_SAPPER)and GetUnitCurrentOrder(u)==0 and GetUnitAbilityLevel(u,'A07I')<=0 and GetUnitAbilityLevel(u,'A07M')<=0 and GetUnitAbilityLevel(u,'A0ID')<=0
if(aX)then
endif
set u=null
return false
endfunction
function Functions___OrderGiverPerson takes nothing returns nothing
call wI(GetEnumUnit())
endfunction
function aN takes nothing returns nothing
local integer i=$B
local player p
local unit u
local location nN
loop
set p=Player(i)
set nN=xo[PlayerForce[i]]
call GroupEnumUnitsOfPlayer(ErasingGroup,p,null)
loop
set u=FirstOfGroup(ErasingGroup)
exitwhen u==null
if(IsUnitType(u,UNIT_TYPE_SAPPER)and GetUnitCurrentOrder(u)==0 and GetWidgetLife(u)>.405 and GetUnitAbilityLevel(u,'A07I')<=0 and GetUnitAbilityLevel(u,'A07M')<=0 and GetUnitAbilityLevel(u,'A0ID')<=0)then
call IssuePointOrderByIdLoc(u,$D000F,nN)
endif
call GroupRemoveUnit(ErasingGroup,u)
endloop
set i=i-1
exitwhen i<0
endloop
set p=null
set u=null
set nN=null
endfunction
function VN takes nothing returns nothing
local boolean EN=false
local integer i=0
loop
if(No[i]=='h089' or No[i]=='h06P')then
set EN=true
endif
set i=i+1
exitwhen i>$B or EN
endloop
if(EN)then
call TimerStart(Mi,2.,true,function rN)
endif
endfunction
function Functions_CheckAndStartCommon takes nothing returns nothing
call TimerStart(pi,2.,true,function aN)
endfunction
function XN takes nothing returns boolean
local unit u=GetFilterUnit()
local boolean aX=GetWidgetLife(u)>.405 and IsUnitType(u,UNIT_TYPE_PEON)
set u=null
return aX
endfunction
function EnumResetAnimation takes nothing returns nothing
call SetUnitAnimation(GetEnumUnit(),"stand")
endfunction
function ON takes unit u,unit RN returns nothing
local player p=GetOwningPlayer(RN)
local boolean IN=GetUnitAbilityLevel(RN,'B01K')>0
if(IN)then
call UnitAddAbility(u,'A09M')
call SetUnitAbilityLevel(u,'A09M',3)
call UnitRemoveAbility(u,'A09M')
call UnitAddAbility(u,'A09Q')
call UnitAddAbility(u,'A09R')
endif
if(CagingMode and not IsUnitType(u,UNIT_TYPE_FLYING))then
call cA(u)
endif
if(GetUnitAbilityLevel(u,'A07M')>=1)then
call GroupAddUnit(Li,u)
endif
endfunction
function AN takes unit u returns nothing
    local integer NN=BuildingToItsTrained[GetUnitPointValue(u)]
    call IssueImmediateOrderById(u,$D0008)
    call IssueImmediateOrderById(u,$D0008)
    call IssueImmediateOrderById(u,$D0008)
    call IssueImmediateOrderById(u,$D0008)
    call IssueImmediateOrderById(u,$D0008)
    call IssueImmediateOrderById(u,$D0008)
    call IssueImmediateOrderById(u,$D0008)
    call IssueImmediateOrderById(u,NN)
endfunction
function bN takes nothing returns nothing
local trigger t=GetTriggeringTrigger()
local unit u
local unit su
local lightning l
if(t!=null)then
set u=LoadUnitHandle(rx,'SyTm',GetHandleId(t))
if(u!=null)then
set su=LoadUnitHandle(rx,'SyUn',GetHandleId(u))
call SaveUnitHandle(rx,'SyTm',GetHandleId(t),null)
if(su!=null and GetWidgetLife(su)>.405)then
call AN(u)
set l=AddLightning("LEAS",true,GetUnitX(u),GetUnitY(u),GetUnitX(su),GetUnitY(su))
call SetLightningColor(l,1.,1.,1.,.7)
call TriggerSleepAction(.5)
call DestroyLightning(l)
set l=null
endif
set u=null
set su=null
endif
call DestroyTrigger(t)
set t=null
endif
endfunction
function Functions_RunSyncTask takes nothing returns nothing
local trigger t
local unit u=GetEnumUnit()
local real dt
if(GetWidgetLife(u)>.405)then
set dt=I2R(qi-GetUnitBuildTime(BuildingToItsTrained[GetUnitPointValue(u)]))
if(dt>0)then
set t=CreateTrigger()
call TriggerAddAction(t,function bN)
call SaveUnitHandle(rx,'SyTm',GetHandleId(t),u)
call TriggerRegisterTimerEvent(t,dt-.05,false)
set t=null
else
call AN(u)
set Qi=true
endif
endif
set u=null
endfunction
function BN takes unit u,unit RN returns nothing
local player p=GetOwningPlayer(RN)
local integer dE=GetPlayerId(p)
local integer cc
local boolean IN=GetUnitAbilityLevel(RN,'B01K')>0
local group sg
if(IN)then
call UnitAddAbility(u,'A09M')
call SetUnitAbilityLevel(u,'A09M',3)
call UnitRemoveAbility(u,'A09M')
call UnitAddAbility(u,'A09Q')
call UnitAddAbility(u,'A09R')
endif
if(CagingMode and not IsUnitType(u,UNIT_TYPE_FLYING))then
call cA(u)
endif
if(GetUnitAbilityLevel(u,'A07M')>=1)then
call GroupAddUnit(Li,u)
elseif(GetUnitAbilityLevel(u,'A09H')>0)then
call ON(CreateUnit(p,GetUnitTypeId(u),GetUnitX(u),GetUnitY(u),.0),RN)
endif
set cc=io[dE]
if(cc>0)then
if(ro[dE]>=6-cc)then
call ON(CreateUnit(p,GetUnitTypeId(u),GetUnitX(u),GetUnitY(u),.0),RN)
set ro[dE]=0
else
set ro[dE]=ro[dE]+1
endif
endif
endfunction
function cN takes nothing returns nothing
    set li=Filter(function xN)
    set mi=Filter(function iN)
    set ki=Filter(function YA)
    set Ki=Filter(function zA)
    set Pi=Filter(function XN)
endfunction
function MagicTowerRuinAction takes nothing returns nothing
local unit c
local integer i=GetRandomInt(0,8)
local real dN
local real DN
set EraserIssuer=GetOwningPlayer(De)
call GroupEnumUnitsInRect(ErasingGroup,bj_mapInitialPlayableArea,li)
call DestroyEffect(AddSpecialEffect("Abilities\\Spells\\Orc\\FeralSpirit\\feralspiritdone.mdl",GetUnitX(De),GetUnitY(De)))
set bj_groupRandomCurrentPick=IX(ErasingGroup)
if(bj_groupRandomCurrentPick==null)then
return
endif
call DestroyEffect(AddSpecialEffectTarget("Abilities\\Spells\\Orc\\FeralSpirit\\feralspiritdone.mdl",bj_groupRandomCurrentPick,"origin"))
if(eN(bj_groupRandomCurrentPick))then
return
endif
if(i==0)then
call ExplodeUnitBJ(bj_groupRandomCurrentPick)
set i=GetPlayerId(EraserIssuer)
set Bo[i]=Bo[i]+1
elseif(i==1)then
call UnitDamageTarget(De,bj_groupRandomCurrentPick,50000.,true,false,ATTACK_TYPE_NORMAL,DAMAGE_TYPE_DEATH,WEAPON_TYPE_WHOKNOWS)
elseif(i==2)then
call UnitDamageTarget(De,bj_groupRandomCurrentPick,500.,true,false,ATTACK_TYPE_NORMAL,DAMAGE_TYPE_DEATH,WEAPON_TYPE_WHOKNOWS)
elseif(i==3)then
call DestroyEffect(AddSpecialEffectTarget("Abilities\\Spells\\Human\\Avatar\\AvatarCaster.mdl",bj_groupRandomCurrentPick,"origin"))
if(GetRandomInt(0,99)>40)then
call UnitAddAbility(bj_groupRandomCurrentPick,'A06T')
endif
if(GetRandomInt(0,99)>40)then
call UnitAddAbility(bj_groupRandomCurrentPick,'A06U')
endif
call SetUnitState(bj_groupRandomCurrentPick,UNIT_STATE_LIFE,GetUnitState(bj_groupRandomCurrentPick,UNIT_STATE_MAX_LIFE))
elseif(i==4)then
set c=CreateUnit(EraserIssuer,'e008',GetUnitX(bj_groupRandomCurrentPick),GetUnitY(bj_groupRandomCurrentPick),.0)
call UnitAddAbility(c,'A018')
call UnitShareVision(bj_groupRandomCurrentPick,EraserIssuer,true)
call IssueTargetOrderById(c,$D0216,bj_groupRandomCurrentPick)
call UnitShareVision(bj_groupRandomCurrentPick,EraserIssuer,false)
call UnitApplyTimedLife(c,'BTLF',1.)
set c=bj_groupRandomCurrentPick
call TriggerSleepAction(1.)
call wI(c)
if(GetUnitTypeId(c)=='h03A')then
    call TriggerSleepAction(44.5)
    call IssueImmediateOrderById(c,$D0057)
    call TriggerSleepAction(.5)
    call wI(c)
endif
set c=null
elseif(i==5)then
set c=CreateUnit(EraserIssuer,'e008',GetUnitX(bj_groupRandomCurrentPick),GetUnitY(bj_groupRandomCurrentPick),.0)
call UnitAddAbility(c,'A06S')
call UnitShareVision(bj_groupRandomCurrentPick,EraserIssuer,true)
call IssueTargetOrderById(c,$D007F,bj_groupRandomCurrentPick)
call UnitShareVision(bj_groupRandomCurrentPick,EraserIssuer,false)
call UnitApplyTimedLife(c,'BTLF',1.2)
set c=null
elseif(i==6)then
set i=GetPlayerId(EraserIssuer)
set Bo[i]=Bo[i]+1
call ShowUnit(bj_groupRandomCurrentPick,false)
set dN=GetUnitX(bj_groupRandomCurrentPick)
set DN=GetUnitY(bj_groupRandomCurrentPick)
call DestroyEffect(AddSpecialEffect("Abilities\\Spells\\Orc\\FeralSpirit\\feralspiritdone.mdl",dN,DN))
call wI(CreateUnit(EraserIssuer,'n01S',dN,DN,GetUnitFacing(bj_groupRandomCurrentPick)))
call RemoveUnit(bj_groupRandomCurrentPick)
endif
endfunction
function EraserFilterFunc takes nothing returns boolean
    local unit u=GetFilterUnit()
    local boolean isEraserTarget=GetWidgetLife(u)>.405 and IsUnitEnemy(u,EraserIssuer)and GetUnitTypeId(u)==erasingUnitTypeId
    set u=null
    return isEraserTarget
endfunction
function EraseUnit takes nothing returns nothing
    local unit u=GetEnumUnit()
    call DestroyEffect(AddSpecialEffectTarget("Abilities\\Spells\\Items\\AIil\\AIilTarget.mdl",u,"origin"))
    if(GetUnitAbilityLevel(u,'A070')<=0)then
        if(GetRandomInt(0,99)>ErasePossibilityBound)then
            call UnitDamageTarget(De,u,100500.,true,false,ATTACK_TYPE_CHAOS,DAMAGE_TYPE_DEATH,WEAPON_TYPE_WHOKNOWS)
        else
            call KillUnit(u)
        endif
        set ErasingCount=ErasingCount+1
        set ErasePossibilityBound=ErasePossibilityBound+1
    endif
    set u=null
endfunction
function EraserAction takes nothing returns nothing
    set EraserIssuer=GetOwningPlayer(De)
    call GroupEnumUnitsInRect(ErasingGroup,bj_mapInitialPlayableArea,li)
    call DestroyEffect(AddSpecialEffect("Abilities\\Spells\\Items\\TomeOfRetraining\\TomeOfRetrainingCaster.mdl",GetUnitX(De),GetUnitY(De)))
    set bj_groupRandomCurrentPick=IX(ErasingGroup)
    if(bj_groupRandomCurrentPick==null)then
        return
    endif
    set erasingUnitTypeId=GetUnitTypeId(bj_groupRandomCurrentPick)
    call GroupEnumUnitsInRect(ErasingGroup,bj_mapInitialPlayableArea,EraserFilter)
    set ErasingCount=0
    set ErasePossibilityBound=GetRandomInt(30,70)
    call ForGroup(ErasingGroup,function EraseUnit)
    call DisplayTextToPlayer(EraserIssuer,.0,.0,"Eraser killed "+I2S(ErasingCount)+" "+GetObjectName(erasingUnitTypeId)+"(s)")
endfunction
function GN takes nothing returns nothing
local real x
local real y
local unit c
set EraserIssuer=GetOwningPlayer(De)
call GroupEnumUnitsInRect(ErasingGroup,bj_mapInitialPlayableArea,ki)
set bj_groupRandomCurrentPick=IX(ErasingGroup)
if(bj_groupRandomCurrentPick==null)then
return
endif
set x=GetUnitX(bj_groupRandomCurrentPick)+GetRandomReal(70.,70.)
set y=GetUnitY(bj_groupRandomCurrentPick)+GetRandomReal(70.,70.)
set c=CreateUnit(EraserIssuer,'e008',x,y,.0)
call UnitAddAbility(c,si)
call IssuePointOrderById(c,$D010E,x,y)
call UnitApplyTimedLife(c,'BTLF',5.5)
set c=null
endfunction
function hN takes nothing returns boolean
local unit u=GetFilterUnit()
local boolean aX=GetWidgetLife(u)>.405 and IsUnitEnemy(u,EraserIssuer)and IsUnitType(u,UNIT_TYPE_STRUCTURE)and GetPlayerId(GetOwningPlayer(u))<$C and GetUnitTypeId(u)!='hcas' and GetUnitAbilityLevel(u,'A06V')<=0
set u=null
return aX
endfunction
function HN takes nothing returns nothing
local integer t
set EraserIssuer=GetOwningPlayer(De)
call GroupEnumUnitsInRect(ErasingGroup,bj_mapInitialPlayableArea,Ui)
set bj_groupRandomCurrentPick=IX(ErasingGroup)
if(bj_groupRandomCurrentPick==null)then
return
endif
call DestroyEffect(AddSpecialEffect("Abilities\\Spells\\Human\\MarkOfChaos\\MarkOfChaosTarget.mdl",GetUnitX(bj_groupRandomCurrentPick),GetUnitY(bj_groupRandomCurrentPick)))
call KillUnit(bj_groupRandomCurrentPick)
set t=PlayerForce[GetPlayerId(EraserIssuer)]
set Xo[t]=Xo[t]+1
call AO(3,t+1,I2S(Xo[t]))
endfunction
function jN takes nothing returns nothing
local unit c
call DestroyEffect(AddSpecialEffectTarget("Abilities\\Spells\\NightElf\\BattleRoar\\RoarCaster.mdl",ge,"origin"))
set c=CreateUnit(GetOwningPlayer(ge),'e008',GetUnitX(ge),GetUnitY(ge),.0)
call UnitAddAbility(c,'A03R')
call IssueImmediateOrderById(c,$D00C4)
call UnitApplyTimedLife(c,'BTLF',1.)
set c=null
endfunction
function JN takes nothing returns boolean
    call SpawnCreep(ce,'h094',74.,38.5,28.)
    call SpawnCreep(ce,'h093',160.,-42.,-18.75)
    call SpawnCreep(ce,'h093',250.,3.75,-55.5)
    call SpawnCreep(ce,'h08Z',220.,43.,27.5)
    return false
endfunction
function kN takes nothing returns nothing
call SetupSpecialBuildingAction('h05I',function MagicTowerRuinAction) // Magic Tower Ruin
call BuildingTrains('h025','n00L')
call SetupSpecialBuildingAction('h01M',function EraserAction) // Eraser (Level 1)
call SetupSpecialBuildingAction('h01W',function EraserAction)
call SetupSpecialBuildingAction('h01X',function EraserAction)
call BuildingTrains('h01I','n00A')
call BuildingTrains('h026','z000')
call SetupSpecialBuildingAction('h01F',function GN)
call SetupSpecialBuildingAction('h01E',function HN)
call BuildingTrains('h01C','n008')
call BuildingTrains('h01D','n009')
call BuildingTrains('h03G','n00Z') // h03G  <- Greater Chaos Citadel
call AttachRegister('h03G',function JN)
call BuildingTrains('h009','n001')
call BuildingTrains('h007','n000')
endfunction
function KN takes nothing returns nothing
call PrepareRaceBuildingSetup(5)
call SetupBuildingUpgrades('h025',.2,true,0)
call SetupBuildingUpgrades('h01I',.2,true,0)
call SetupBuildingUpgrades('h026',.2,true,'h01I')
call SetupBuildingUpgrades('h01C',.2,true,0)
call SetupBuildingUpgrades('h01D',.2,true,0)
call SetupBuildingUpgrades('h03G',.2,true,'h01D')
call SetupBuildingUpgrades('h009',.2,true,0)
call SetupBuildingUpgrades('h007',.2,true,0)
call SetupBuildingUpgrades('h05I',.09,false,0)
call SetupBuildingUpgrades('h01M',.09,false,0)
call SetupBuildingUpgrades('h01W',.09,false,'h01M')
call SetupBuildingUpgrades('h01X',.09,false,'h01W')
call SetupBuildingUpgrades('h01F',.09,false,0)
call SetupBuildingUpgrades('h01E',.12,false,0)
call SetupBuildingUpgrades('h008',.05,false,0)
endfunction
function Chaos___RegisterUnitCasts takes nothing returns nothing
call RegisterSpell('n00Z','A03S',function jN)
endfunction
function lN takes unit u,integer tX returns unit
local unit n
call ShowUnit(u,false)
set n=CreateUnit(GetOwningPlayer(u),tX,GetUnitX(u),GetUnitY(u),GetUnitFacing(u))
call RemoveUnit(u)
return n
endfunction
function LN takes unit u returns unit
local integer i=GetRandomInt(0,99)
if(i<5)then
set u=lN(u,'n00M')
elseif(i<$E)then
set u=lN(u,'n00R')
else
set i=GetRandomInt(0,3)
if(i==0)then
set u=lN(u,'n00Q')
elseif(i==1)then
set u=lN(u,'n00N')
elseif(i==2)then
set u=lN(u,'n00O')
else
set u=lN(u,'n00P')
endif
endif
set i=GetRandomInt(0,99)
if(i<20)then
call UnitAddAbility(u,'A009')
elseif(i<55)then
call UnitAddAbility(u,'A01F')
endif
set i=GetRandomInt(0,99)
if(i<18)then
call UnitAddAbility(u,'A02B')
elseif(i<30)then
call UnitAddAbility(u,'A01B')
elseif(i<33)then
call UnitAddAbility(u,'A00Z')
elseif(i<43)then
call UnitAddAbility(u,'A07L')
endif
set i=GetRandomInt(0,99)
if(i<$A)then
call UnitAddAbility(u,'A00U')
elseif(i<32)then
call UnitAddAbility(u,'A00T')
elseif(i<35)then
call UnitAddAbility(u,'A05J')
endif
set i=GetRandomInt(0,99)
if(i<25)then
call UnitAddAbility(u,'A01A')
endif
set i=GetRandomInt(0,99)
if(i<$F)then
call UnitAddAbility(u,'A00V')
elseif(i<40)then
call UnitAddAbility(u,'A00D')
endif
set i=GetRandomInt(0,99)
if(i<8)then
call UnitAddAbility(u,'A01U')
elseif(i<16)then
call UnitAddAbility(u,'A010')
elseif(i<24)then
call UnitAddAbility(u,'A01P')
elseif(i<34)then
call UnitAddAbility(u,'A006')
elseif(i<44)then
call UnitAddAbility(u,'A01R')
elseif(i<47)then
call UnitAddAbility(u,'A012')
endif
return u
endfunction
function mN takes nothing returns nothing
    call kN()
    call KN()
    call RegisterSpell('n00Z','A03S',function jN)
    set EraserFilter=Filter(function EraserFilterFunc)
    set Ui=Filter(function hN)
endfunction
function MN takes nothing returns nothing
local player p=GetOwningPlayer(De)
local integer i=0
local real x
local real y
local real an=GetRandomReal(0,6.28)
local real r=GetRandomReal(45.,65.)
set EraserIssuer=p
call GroupEnumUnitsInRect(ErasingGroup,bj_mapInitialPlayableArea,ki)
set bj_groupRandomConsidered=0
set bj_groupRandomCurrentPick=null
set bj_groupRandomCurrentPick=IX(ErasingGroup)
if(bj_groupRandomCurrentPick==null)then
return
endif
if(bj_groupRandomCurrentPick==null)then
return
endif
set x=GetUnitX(bj_groupRandomCurrentPick)
set y=GetUnitY(bj_groupRandomCurrentPick)
loop
call UnitApplyTimedLife(CreateUnit(p,wi,x+65.*Cos(an),y+65.*Sin(an),0),'BTLF',4.1)
call TriggerSleepAction(.05)
set an=an+1.257
set i=i+1
exitwhen i>=5
endloop
endfunction
function pN takes nothing returns nothing
set EraserIssuer=GetOwningPlayer(De)
call GroupEnumUnitsInRect(ErasingGroup,bj_mapInitialPlayableArea,li)
set bj_groupRandomConsidered=0
set bj_groupRandomCurrentPick=null
call ForGroup(ErasingGroup,function GroupPickRandomUnitEnum)
if(bj_groupRandomCurrentPick==null)then
return
endif
call DestroyEffect(AddSpecialEffectTarget("Abilities\\Spells\\Undead\\DeathPact\\DeathPactTarget.mdl",bj_groupRandomCurrentPick,"origin"))
if not eN(bj_groupRandomCurrentPick)then
call UnitDamageTarget(De,bj_groupRandomCurrentPick,180.,true,false,ATTACK_TYPE_NORMAL,DAMAGE_TYPE_SONIC,WEAPON_TYPE_WHOKNOWS)
endif
endfunction
function PN takes nothing returns nothing
local player p=GetOwningPlayer(ge)
local real x=GetUnitX(ge)
local real y=GetUnitY(ge)
local real an=bj_RADTODEG*Atan2(GetUnitY(Ge)-y,GetUnitX(Ge)-x)-24.
local integer i=0
local unit c
loop
set c=CreateUnit(p,'e008',x,y,an)
call UnitAddAbility(c,'A0AF')
call IssuePointOrderById(c,$D024B,x+10.*Cos(an*bj_DEGTORAD),y+10.*Sin(an*bj_DEGTORAD))
call UnitApplyTimedLife(c,'BTLF',1.8)
set an=an+(12.)
set i=i+1
exitwhen i>3
endloop
set c=null
endfunction
function qN takes nothing returns boolean
call SpawnCreep(ce,'h04J',191.,.0,.0)
return false
endfunction
function QN takes nothing returns boolean
    call SpawnCreep(ce,'h09Z',270.,.0,.0) // h09z <- corrupted
    return false
endfunction
function sN takes nothing returns boolean
call SetUnitVertexColor(ce,82,0,$87,'f')
return false
endfunction
function SN takes nothing returns boolean
call SpawnCreep(ce,'h08I',.0,.0,.0)
return false
endfunction
function SetupChaosRaceBuildings takes nothing returns nothing
call ZX('n01J',800.)
call BuildingTrains('h04V','n01I')
call BuildingTrains('h04W','n01H')
call BuildingTrains('h09Y','n027')
call AttachRegister('h09Y',function QN) // h09Y <- Corrupted Ancient of Annihilation
call BuildingTrains('h04U','h04I')
call AttachRegister('h04U',function qN) // h04U <- Demonic Statue
call BuildingTrains('h04S','n01G')
call SetupSpecialBuildingAction('h04R',function MN)
call BuildingTrains('h04Q','n01F')
call BuildingTrains('h04P','n01E')
call BuildingTrains('h04O','n01D')
call BuildingTrains('h04M','n01B')
call AttachRegister('h04M',function sN)
call BuildingTrains('h04L','n019')
call BuildingTrains('h04N','n01A')
call SetupSpecialBuildingAction('h04K',function pN)
call AttachRegister('h04K',function SN)
endfunction
function SetupCorruptedRaceBuildings takes nothing returns nothing
call PrepareRaceBuildingSetup(0)
call SetupBuildingUpgrades('h04V',.2,true,0)
call SetupBuildingUpgrades('h04W',.2,true,'h04V')
call SetupBuildingUpgrades('h09Y',.2,false,'h04W')
call SetupBuildingUpgrades('h04U',.2,true,0)
call SetupBuildingUpgrades('h04S',.2,true,0)
call SetupSiegeBuildingUpgrades('h04Q',.18,true,0) // <-- hell's gate
call SetupSiegeBuildingUpgrades('h04P',.18,true,'h04Q') // H04P <- hell's portal
call SetupBuildingUpgrades('h04O',.2,true,0)
call SetupBuildingUpgrades('h04M',.2,true,'h04O')
call SetupBuildingUpgrades('h04L',.2,true,0)
call SetupBuildingUpgrades('h04N',.2,true,'h04L')
call SetupBuildingUpgrades('n01J',.0,false,0)
call SetupBuildingUpgrades('h04T',.12,false,0)
call SetupBuildingUpgrades('h04R',.09,false,0)
call SetupBuildingUpgrades('h04K',.09,false,0)
call SetupBuildingUpgrades('h008',.05,false,0)
endfunction
function Corrupted__RegisterUnitCasts takes nothing returns nothing
call RegisterSpell('n027','A0AE',function PN)
endfunction
function uN takes nothing returns nothing
    call SetupChaosRaceBuildings()
    call SetupCorruptedRaceBuildings()
    call RegisterSpell('n027','A0AE',function PN)
endfunction
function UN takes nothing returns nothing
local unit c
local integer i=$C
local player p=GetOwningPlayer(De)
local real x
local real y
local unit u
set EraserIssuer=p
set x=GetUnitX(De)
set y=GetUnitY(De)
call DestroyEffect(AddSpecialEffect("Abilities\\Spells\\Items\\TomeOfRetraining\\TomeOfRetrainingCaster.mdl",x,y))
call GroupEnumUnitsInRect(ErasingGroup,bj_mapInitialPlayableArea,ki)
set bj_groupRandomCurrentPick=null
set bj_groupRandomCurrentPick=IX(ErasingGroup)
if(bj_groupRandomCurrentPick==null or eN(bj_groupRandomCurrentPick))then
return
endif
set x=GetUnitX(bj_groupRandomCurrentPick)
set y=GetUnitY(bj_groupRandomCurrentPick)
set c=CreateUnit(GetOwningPlayer(De),'e00I',x,y,.0)
call UnitApplyTimedLife(c,'BTLF',12.)
loop
call TriggerSleepAction(1.)
set EraserIssuer=p
call GroupEnumUnitsInRange(ErasingGroup,x,y,128.,ki)
loop
set u=FirstOfGroup(ErasingGroup)
exitwhen(u==null)
call GroupRemoveUnit(ErasingGroup,u)
if(GetUnitAbilityLevel(u,'A07H')<=0)then
call UnitAddAbility(u,'A0IL')
call IssueTargetOrderById(u,$D024B,u)
call TriggerSleepAction(2.8)
call ShowUnit(u,false)
call RemoveUnit(u)
set i=0
exitwhen true
endif
endloop
set i=i-1
exitwhen i<=0
endloop
set u=null
set c=null
endfunction
function wN takes nothing returns nothing
local unit c
local unit t
local integer i=4
local player pl=GetOwningPlayer(De)
set EraserIssuer=pl
call DestroyEffect(AddSpecialEffect("Abilities\\Weapons\\ChimaeraAcidMissile\\ChimaeraAcidMissile.mdl",GetUnitX(De),GetUnitY(De)))
call GroupEnumUnitsInRect(ErasingGroup,bj_mapInitialPlayableArea,Ki)
set bj_groupRandomCurrentPick=IX(ErasingGroup)
if(bj_groupRandomCurrentPick==null)then
return
endif
set c=bj_groupRandomCurrentPick
if(c==null or eN(c))then
return
endif
set t=CreateUnit(Wi,'e008',GetUnitX(c),GetUnitY(c),.0)
call UnitAddAbility(t,'A0HY')
call IssueTargetOrderById(t,$D00CB,c)
call UnitAddAbility(t,'A00N')
call TriggerSleepAction(4.8)
if(GetRandomInt(0,99)>75)then
call UnitShareVision(c,pl,true)
call IssueTargetOrderById(t,$D0265,c)
call UnitShareVision(c,pl,false)
endif
call UnitApplyTimedLife(t,'BTLF',1.)
set c=null
set t=null
endfunction
function WN takes nothing returns nothing
local unit c
call EnableWeatherEffect(yi,true)
set c=CreateUnit(GetOwningPlayer(De),'e008',.0,3500.,.0)
call UnitAddAbility(c,'A02B')
call IssuePointOrderById(c,$D0270,16.,3500.)
call UnitAddAbility(c,'A0GC')
call UnitApplyTimedLife(c,'BTLF',8.)
set c=De
call SetUnitAnimation(c,"stand work")
call TriggerSleepAction(6.)
call EnableWeatherEffect(yi,false)
call SetUnitAnimation(c,"stand")
set c=null
endfunction
function yN takes nothing returns nothing
local unit ca=CreateUnit(GetOwningPlayer(ge),'e008',GetUnitX(Ge),GetUnitY(Ge),.0)
local integer i=0
if(GetUnitTypeId(ge)=='n035')then
call UnitAddAbility(ca,'A0HP')
else
call UnitAddAbility(ca,'A00I')
endif
call UnitApplyTimedLife(ca,'BTLF',5.5)
call wI(ge)
loop
if(not IssuePointOrderById(ca,$D0270,GetUnitX(Ge),GetUnitY(Ge)))then
call DisplayTextToPlayer(GetLocalPlayer(),.0,.0,GetUnitName(ge)+"->"+GetUnitName(Ge)+":"+GetUnitName(ca))
endif
call TriggerSleepAction(1.)
set i=i+1
exitwhen(i>4)
endloop
set ca=null
endfunction
function YN takes nothing returns nothing
local unit u=ge
call wI(u)
call TriggerSleepAction(GetRandomReal(.3,.6))
call IssueImmediateOrderById(ge,$D0084)
call TriggerSleepAction(.1)
call wI(ge)
set u=null
endfunction
function zN takes nothing returns nothing
call IssueTargetOrderById(ge,$D000F,Ge)
endfunction
function ZN takes nothing returns nothing
local real HP
local real vb
local unit u=Ge
local unit cu=ge
call TriggerSleepAction(GetRandomReal(.1,1.3))
set HP=GetRandomReal(40.,80.)
set vb=GetWidgetLife(u)
if(HP>vb)then
set HP=vb
endif
call UnitDamageTarget(cu,u,HP,true,false,ATTACK_TYPE_CHAOS,DAMAGE_TYPE_NORMAL,WEAPON_TYPE_WHOKNOWS)
call SetUnitState(cu,UNIT_STATE_LIFE,GetWidgetLife(cu)+HP)
call DestroyEffect(AddSpecialEffectTarget("Abilities\\Spells\\Items\\AIma\\AImaTarget.mdl",cu,"origin"))
call DestroyEffect(AddSpecialEffectTarget("Abilities\\Spells\\Items\\AIma\\AImaTarget.mdl",u,"overhead"))
set u=null
set cu=null
endfunction
function eb takes nothing returns nothing
local unit ca
local integer xb
local integer r=GetRandomInt(0,99)
if(r<30)then
set ca=ge
set xb='A0HB'+GetRandomInt(0,2)
call UnitAddAbility(ca,xb)
call IssueImmediateOrderById(ca,$D026A)
call TriggerSleepAction(6.)
call UnitRemoveAbility(ca,xb)
call wI(ca)
set ca=null
elseif(r>60)then
set ca=CreateUnit(GetOwningPlayer(ge),'e008',GetUnitX(Ge),GetUnitY(Ge),.0)
call UnitAddAbility(ca,'A0H0')
call IssueTargetOrderById(ca,$D0271,Ge)
call UnitApplyTimedLife(ca,'BTLF',2.1)
set ca=null
call wI(ge)
endif
endfunction
function ob takes nothing returns boolean
call SpawnCreep(ce,'h03H',.0,.0,.0)
return false
endfunction
function rb takes nothing returns nothing
call PrepareRaceBuildingSetup($C)
call BuildingTrains('n02O','n02S')
call SetupBuildingUpgrades('n02O',.2,true,0)
call BuildingTrains('n02I','n02T')
call SetupBuildingUpgrades('n02I',.2,true,'n02O')
call BuildingTrains('n02K','n02W')
call SetupBuildingUpgrades('n02K',.2,true,0)
call BuildingTrains('n031','n032')
call SetupBuildingUpgrades('n031',.2,true,'n02K')
call BuildingTrains('n033','n034')
call SetupBuildingUpgrades('n033',.2,true,'n031')
call BuildingTrains('n02L','n02X')
call SetupBuildingUpgrades('n02L',.18,true,0)
call BuildingTrains('n02R','n02Y')
call SetupBuildingUpgrades('n02R',.18,true,'n02L')
call BuildingTrains('n02J','n02V')
call SetupBuildingUpgrades('n02J',.2,true,0)
call BuildingTrains('n02N','n02U')
call SetupBuildingUpgrades('n02N',.2,true,'n02J')
call BuildingTrains('n02M','n02Z')
call SetupBuildingUpgrades('n02M',.2,true,0)
call BuildingTrains('n02P','n030')
call SetupBuildingUpgrades('n02P',.2,true,0)
call BuildingTrains('n036','n035')
call SetupBuildingUpgrades('n036',.2,true,'n02P')
call ZX('h06H',800.)
call SetupBuildingUpgrades('h06H',.0,false,0)
call SetupSpecialBuildingAction('h06L',function UN)
call SetupBuildingUpgrades('h06L',.12,false,0)
call SetupSpecialBuildingAction('h06I',function wN)
call SetupBuildingUpgrades('h06I',.12,false,0)
call SetupSpecialBuildingAction('h06M',function WN)
call SetupBuildingUpgrades('h06M',.09,false,0)
call AttachRegister('h06M',function ob)
call SetupBuildingUpgrades('h008',.05,false,0)
endfunction
function ib takes nothing returns nothing
call RegisterSpell('n030','A0G8',function yN)
call RegisterSpell('n035','A0G8',function yN)
call RegisterSpell('n02Y','A0GB',function YN)
call RegisterSpell('n02S','A0HK',function zN)
call RegisterSpell('n02T','A0HK',function zN)
call RegisterSpell('n034','A0H1',function eb)
call RegisterSpell('n032','A0G9',function ZN)
endfunction
function nb takes nothing returns boolean
call SpawnCreep(ce,'h071',45.,.0,.0)
return false
endfunction
function Vb takes nothing returns nothing
    call rb()
    call ib()
    set yi=AddWeatherEffect(bj_mapInitialPlayableArea,'WNcw')
    call EnableWeatherEffect(yi,false)
    call AttachRegister('n033',function nb)
    set Wi=Player($C)
endfunction
function Eb takes nothing returns nothing
local unit u=CreateUnit(GetOwningPlayer(ge),'e008',GetUnitX(ge),GetUnitY(ge),.0)
local integer i=GetRandomInt(0,2)
local real x=GetUnitX(Ge)
local real y=GetUnitY(Ge)
local unit uc=ge
if(i==0)then
call SetUnitAnimation(ge,"spell slam")
call UnitAddAbility(u,'A0F7')
call IssuePointOrderById(u,$D024B,x+GetRandomReal(-60.,60.),y+GetRandomReal(-60.,60.))
elseif(i==1)then
call UnitAddAbility(u,'A0F6')
set i=0
loop
set x=x+(GetRandomReal(-120.,120.))
set y=y+(GetRandomReal(-120.,120.))
call IssuePointOrderById(u,$D009D,x,y)
call TriggerSleepAction(.2)
set i=i+1
exitwhen i>=2
endloop
else
call SetUnitAnimation(ge,"spell throw")
call UnitAddAbility(u,'A0F0')
call IssuePointOrderById(u,$D00FA,x+GetRandomReal(-60.,60.),y+GetRandomReal(-60.,60.))
endif
call UnitApplyTimedLife(u,'BTLF',1.5)
call TriggerSleepAction(.33)
call wI(uc)
set u=null
set uc=null
endfunction
function Xb takes nothing returns nothing
call IssueTargetOrderById(ge,$D0213,ge)
endfunction
function Ob takes nothing returns nothing
local unit c
local integer i=GetRandomInt(0,99)
set EraserIssuer=GetOwningPlayer(De)
call GroupEnumUnitsInRect(ErasingGroup,bj_mapInitialPlayableArea,li)
set bj_groupRandomCurrentPick=IX(ErasingGroup)
if(bj_groupRandomCurrentPick==null)then
return
endif
set c=CreateUnit(EraserIssuer,'e008',GetUnitX(bj_groupRandomCurrentPick),GetUnitY(bj_groupRandomCurrentPick),.0)
if(i>50)then
call UnitAddAbility(c,Yi)
else
call UnitAddAbility(c,zi)
endif
call IssuePointOrderById(c,$D010D,GetUnitX(bj_groupRandomCurrentPick),GetUnitY(bj_groupRandomCurrentPick))
call UnitApplyTimedLife(c,'BTLF',8.)
set c=null
endfunction
function Rb takes nothing returns nothing
set EraserIssuer=GetOwningPlayer(De)
call GroupEnumUnitsInRect(ErasingGroup,bj_mapInitialPlayableArea,li)
set bj_groupRandomCurrentPick=IX(ErasingGroup)
if(bj_groupRandomCurrentPick==null)then
return
endif
if(eN(bj_groupRandomCurrentPick))then
return
endif
call UnitAddAbility(bj_groupRandomCurrentPick,'A0HJ')
call UnitAddAbility(bj_groupRandomCurrentPick,'A0IQ')
call DestroyEffect(AddSpecialEffectTarget("Abilities\\Spells\\Items\\AIam\\AIamTarget.mdl",bj_groupRandomCurrentPick,"origin"))
endfunction
function Ib takes nothing returns boolean
local unit u=GetFilterUnit()
local boolean aX=GetWidgetLife(u)>.405 and IsUnitAlly(u,EraserIssuer)and IsUnitType(u,UNIT_TYPE_SAPPER)and GetUnitAbilityLevel(u,'A0F4')<=0
set u=null
return aX
endfunction
function Ab takes nothing returns boolean
local unit u=GetFilterUnit()
local boolean aX=GetWidgetLife(u)>.405 and IsUnitAlly(u,EraserIssuer)and IsUnitType(u,UNIT_TYPE_SAPPER)and not IsUnitType(u,UNIT_TYPE_MECHANICAL)
set u=null
return aX
endfunction
function Nb takes nothing returns nothing
local integer i
local integer ab
set EraserIssuer=GetOwningPlayer(De)
call GroupEnumUnitsInRect(ErasingGroup,bj_mapInitialPlayableArea,va)
set bj_groupRandomCurrentPick=IX(ErasingGroup)
if(bj_groupRandomCurrentPick==null)then
return
endif
call DestroyEffect(AddSpecialEffectTarget("Abilities\\Spells\\Human\\HolyBolt\\HolyBoltSpecialArt.mdl",bj_groupRandomCurrentPick,"overhead"))
call DestroyEffect(AddSpecialEffect("Abilities\\Spells\\Undead\\ReplenishMana\\ReplenishManaCasterOverhead.mdl",GetUnitX(De),GetUnitY(De)))
set i=GetRandomInt(0,2)
if(i==0)then
set ab='A0FG'
elseif(i==1)then
set ab='A0FI'
else
set ab='A0FH'
endif
call UnitAddAbility(bj_groupRandomCurrentPick,ab)
call SetUnitState(bj_groupRandomCurrentPick,UNIT_STATE_LIFE,GetUnitState(bj_groupRandomCurrentPick,UNIT_STATE_LIFE)+100.)
call UnitAddAbility(bj_groupRandomCurrentPick,'A0F4')
call wI(bj_groupRandomCurrentPick)
endfunction
function Elementals__Animationh03X takes nothing returns boolean
call SpawnCreep(ce,'h050',270.,.0,28.)
call SpawnCreep(ce,'h050',90.,.0,-28.)
return false
endfunction
function bb takes nothing returns boolean
call SpawnCreep(ce,'h04Y',270.,.0,28.)
call SpawnCreep(ce,'h050',90.,.0,-28.)
return false
endfunction
function Bb takes nothing returns boolean
call SpawnCreep(ce,'h04Y',270.,.0,28.)
call SpawnCreep(ce,'h04Y',90.,.0,-28.)
return false
endfunction
function cb takes nothing returns boolean
call SpawnCreep(ce,'h04Y',270.,.0,28.)
call SpawnCreep(ce,'h050',90.,.0,-28.)
return false
endfunction
function Cb takes nothing returns boolean
call SpawnCreep(ce,'h04Y',270.,.0,28.)
call SpawnCreep(ce,'h04Y',90.,.0,-28.)
call SpawnCreep(ce,'h058',270.,.0,.0)
return false
endfunction
function db takes nothing returns boolean
call SpawnCreep(ce,'h04Y',270.,.0,28.)
call SpawnCreep(ce,'h050',90.,.0,-28.)
call SpawnCreep(ce,'h052',270.,.0,.0)
return false
endfunction
function Db takes nothing returns boolean
call SpawnCreep(ce,'h04Y',270.,.0,28.)
call SpawnCreep(ce,'h04Y',90.,.0,-28.)
call SpawnCreep(ce,'h053',270.,.0,.0)
return false
endfunction
function fb takes nothing returns boolean
call SpawnCreep(ce,'h04Y',270.,.0,28.)
call SpawnCreep(ce,'h050',90.,.0,-28.)
call SpawnCreep(ce,'h05O',270.,.0,.0)
return false
endfunction
function Fb takes nothing returns boolean
call SpawnCreep(ce,'h04Y',270.,.0,28.)
call SpawnCreep(ce,'h04Y',90.,.0,-28.)
call SpawnCreep(ce,'h057',270.,.0,.0)
call SpawnCreep(ce,'h05P',270.,.0,.0)
return false
endfunction
function gb takes nothing returns boolean
call SpawnCreep(ce,'h050',270.,.0,28.)
call SpawnCreep(ce,'h050',90.,.0,-28.)
return false
endfunction
function Gb takes nothing returns boolean
call SpawnCreep(ce,'h04Y',270.,.0,28.)
call SpawnCreep(ce,'h050',90.,.0,-28.)
call SpawnCreep(ce,'h05K',90.,.0,.0)
return false
endfunction
function hb takes nothing returns boolean
call SpawnCreep(ce,'h04Y',270.,.0,28.)
call SpawnCreep(ce,'h04Y',90.,.0,-28.)
call SpawnCreep(ce,'h05B',90.,.0,.0)
return false
endfunction
function Hb takes nothing returns boolean
call SpawnCreep(ce,'h04Y',270.,.0,28.)
call SpawnCreep(ce,'h04Y',90.,.0,-28.)
call SpawnCreep(ce,'h05Y',270.,.0,.0)
call SpawnCreep(ce,'h05Q',270.,.0,.0)
call SpawnCreep(ce,'h05S',270.,.0,.0)
call SpawnCreep(ce,'h05W',270.,.0,.0)
return false
endfunction
function jb takes nothing returns boolean
call SpawnCreep(ce,'h065',300.,.0,.0)
return false
endfunction
function Jb takes nothing returns boolean
call SpawnCreep(ce,'h066',270.,.0,.0)
return false
endfunction
function kb takes nothing returns boolean
call SpawnCreep(ce,'h067',270.,.0,.0)
return false
endfunction
function Kb takes nothing returns boolean
call SpawnCreep(ce,'h064',270.,.0,.0)
return false
endfunction
function Lb takes nothing returns nothing
call BuildingTrains('h03Y','h02X')
call BuildingTrains('h03Z','h02Y')
call BuildingTrains('h040','h034')
call BuildingTrains('h041','h03N')
call BuildingTrains('h042','h03P')
call BuildingTrains('h044','h03R')
call BuildingTrains('h045','h02Z')
call BuildingTrains('h046','h030')
call BuildingTrains('h04A','o00C')
call BuildingTrains('h04C','o00D')
call BuildingTrains('h04D','o00E')
call BuildingTrains('h04E','h03V')
call AttachRegister('h03Y',function bb)
call AttachRegister('h03Z',function Bb)
call AttachRegister('h040',function cb)
call AttachRegister('h041',function Cb)
call AttachRegister('h042',function db)
call AttachRegister('h044',function Db)
call AttachRegister('h045',function fb)
call AttachRegister('h046',function Fb)
call AttachRegister('h04A',function gb)
call AttachRegister('h04C',function Gb)
call AttachRegister('h04D',function hb)
call AttachRegister('h04E',function Hb)
call AttachRegister('h05Z',function Jb)
call AttachRegister('h060',function jb)
call AttachRegister('h061',function kb)
call AttachRegister('h063',function Kb)
call SetupSpecialBuildingAction('h060',function Nb)
call SetupSpecialBuildingAction('h05Z',function Ob)
call SetupSpecialBuildingAction('h062',function Rb)
call ZX('h061',850.)
endfunction
function mb takes nothing returns nothing
call PrepareRaceBuildingSetup($B)
call SetupBuildingUpgrades('h03Y',.2,true,0)
call SetupBuildingUpgrades('h03Z',.2,true,'h03Y')
call SetupBuildingUpgrades('h042',.2,true,0)
call SetupBuildingUpgrades('h044',.2,true,'h042')
call SetupBuildingUpgrades('h045',.2,true,0)
call SetupBuildingUpgrades('h046',.2,true,'h045')
call SetupBuildingUpgrades('h04E',.2,false,'h046')
call SetupBuildingUpgrades('h04A',.2,true,0)
call SetupBuildingUpgrades('h04C',.2,true,'h04A')
call SetupBuildingUpgrades('h04D',.2,true,'h04C')
call SetupSiegeBuildingUpgrades('h040',.18,true,0)
call SetupSiegeBuildingUpgrades('h041',.18,true,'h040')
call SetupBuildingUpgrades('h061',.0,false,0)
call SetupBuildingUpgrades('h060',.12,false,0)
call SetupBuildingUpgrades('h05Z',.09,false,0)
call SetupBuildingUpgrades('h062',.12,false,0)
call SetupBuildingUpgrades('h008',.05,false,0)
endfunction
function Mb takes nothing returns nothing
call RegisterSpell('h03V','A0E1',function Eb)
call RegisterSpell('e00G','A0F9',function Xb)
endfunction
function pb takes unit u returns nothing
local integer i=GetRandomInt(0,99)
if(i<33)then
call UnitAddAbility(u,'A0D8')
elseif(i<66)then
call UnitAddAbility(u,'A0D9')
call UnitAddAbility(u,'A0EX')
else
call UnitAddAbility(u,'A0FM')
endif
endfunction
function Pb takes integer id returns integer
if(Zi[id]==0)then
return 0
else
return 23+R2I(SquareRoot(300.*I2R(Zi[id])))
endif
endfunction
function qb takes player p returns nothing
local integer id=PlayerForce[GetPlayerId(p)]
set Zi[id]=Zi[id]+(1)
set ao[id]=Pb(id)
endfunction
function Qb takes unit u returns nothing
local integer id=PlayerForce[GetPlayerId(GetOwningPlayer(u))]
set Zi[id]=Zi[id]-(1)
set ao[id]=Pb(id)
endfunction
function sb takes unit du,unit ku returns nothing
local real x=GetUnitX(du)
local real y=GetUnitY(du)
local real da=GetUnitState(du,UNIT_STATE_MAX_LIFE)*GetRandomReal(.15,.4)
local unit u
local unit d=ku
set u=CreateUnit(GetOwningPlayer(du),'e008',x,y,GetUnitFacing(du))
call UnitAddAbility(u,'A0GT')
call IssueTargetOrderById(u,$D0097,ku)
call UnitApplyTimedLife(u,'BTLF',1.2)
call TriggerSleepAction(.4)
call UnitDamageTarget(u,d,da,true,false,ATTACK_TYPE_CHAOS,DAMAGE_TYPE_DEATH,WEAPON_TYPE_WHOKNOWS)
set u=null
set d=null
endfunction
function Sb takes nothing returns nothing
    call Lb()
    call mb()
    call Mb()
    set va=Filter(function Ib)
    set ea=Filter(function Ab)
endfunction
function tb takes nothing returns boolean
local unit u=GetFilterUnit()
local boolean aX=IsUnitType(u,UNIT_TYPE_FLYING)and GetWidgetLife(u)>.405 and IsUnitEnemy(u,EraserIssuer)and IsUnitType(u,UNIT_TYPE_SAPPER)and not IsUnitType(u,UNIT_TYPE_MECHANICAL)
set u=null
return aX
endfunction
function Tb takes nothing returns nothing
local real x
local real y
local integer i=0
local unit t
local unit c
set EraserIssuer=GetOwningPlayer(ge)
set x=GetUnitX(ge)
set y=GetUnitY(ge)
call GroupEnumUnitsInRange(ErasingGroup,GetUnitX(Ge),GetUnitY(Ge),400.,xa)
loop
set t=FirstOfGroup(ErasingGroup)
set i=i+1
exitwhen i>4 or t==null
call GroupRemoveUnit(ErasingGroup,t)
set c=CreateUnit(GetOwningPlayer(ge),'e008',x,y,.0)
call UnitAddAbility(c,'A08U')
call IssueTargetOrderById(c,$D007F,t)
call UnitApplyTimedLife(c,'BTLF',3.)
endloop
set t=null
set c=null
endfunction
function ub takes nothing returns nothing
local unit c
local integer r=GetRandomInt(0,99)
set EraserIssuer=GetOwningPlayer(De)
call GroupEnumUnitsInRect(ErasingGroup,bj_mapInitialPlayableArea,li)
set bj_groupRandomConsidered=0
set bj_groupRandomCurrentPick=null
call ForGroup(ErasingGroup,function GroupPickRandomUnitEnum)
if(bj_groupRandomCurrentPick==null or eN(bj_groupRandomCurrentPick))then
return
endif
set c=CreateUnit(EraserIssuer,'e008',GetUnitX(bj_groupRandomCurrentPick),GetUnitY(bj_groupRandomCurrentPick),.0)
if(r<33)then
call UnitAddAbility(c,'A018')
elseif(r>66)then
call UnitAddAbility(c,'A0GY')
else
call UnitAddAbility(c,'A0GX')
endif
call UnitShareVision(bj_groupRandomCurrentPick,EraserIssuer,true)
call IssueTargetOrderById(c,$D0216,bj_groupRandomCurrentPick)
call UnitShareVision(bj_groupRandomCurrentPick,EraserIssuer,false)
call UnitApplyTimedLife(c,'BTLF',1.)
set c=bj_groupRandomCurrentPick
call TriggerSleepAction(1.)
call wI(c)
set c=null
endfunction
function Ub takes nothing returns nothing
local unit c=CreateUnit(GetOwningPlayer(ge),'e008',GetUnitX(ge),GetUnitY(ge),.0)
call UnitAddAbility(c,'A0A8')
call IssueTargetOrderById(c,$D0215,Ge)
call UnitApplyTimedLife(c,'BTLF',2.)
set c=ge
call TriggerSleepAction(.8)
call wI(c)
set c=null
endfunction
function wb takes nothing returns nothing
local unit c=CreateUnit(GetOwningPlayer(ge),'e008',GetUnitX(ge),GetUnitY(ge),.0)
call UnitAddAbility(c,'A00Y')
call IssueTargetOrderById(c,$D0215,Ge)
call UnitApplyTimedLife(c,'BTLF',2.)
set c=ge
call TriggerSleepAction(.8)
call wI(c)
set c=null
endfunction
function Wb takes nothing returns boolean
call SetUnitVertexColor(ce,$FF,$FF,$FF,0)
call SpawnCreep(ce,'h08Z',250.,46.,33.5)
call SpawnCreep(ce,'h090',270.,-17.,18.)
return false
endfunction
function ArcheryTowerBuildAttach takes nothing returns boolean
    call SetUnitVertexColor(ce,$FF,$FF,$FF,0)
    call SpawnCreep(ce,'h08Z',250.,46.,33.5) // h08Z <- archery target
    call SpawnCreep(ce,'h091',270.,-17.,18.) // ELF build2
    call SpawnCreep(ce,'h08Z',350.,-22.,-40.)
    return false
endfunction
function Yb takes nothing returns nothing
call SetupSpecialBuildingAction('h00Z',function ub)
call ZX('h014',675.)
call BuildingTrains('h09X','h07B')
call BuildingTrains('h00X','h00W')
call BuildingTrains('h00V','h00U')
call BuildingTrains('h00T','n006')
call BuildingTrains('h03F','n00Y')
call BuildingTrains('h08X','n022')
call AttachRegister('h08X',function Wb)
call BuildingTrains('h08Y','n023') // h08Y <- archery tower
call AttachRegister('h08Y',function ArcheryTowerBuildAttach)
call BuildingTrains('h070','e005')
call BuildingTrains('h06Y','n01Y')
endfunction
function zb takes nothing returns nothing
call PrepareRaceBuildingSetup(7)
call SetupBuildingUpgrades('h09X',.2,true,0)
call SetupBuildingUpgrades('h00X',.2,false,'h09X')
call SetupBuildingUpgrades('h00V',.2,true,0)
call SetupBuildingUpgrades('h00T',.2,true,0)
call SetupBuildingUpgrades('h03F',.2,true,'h00T')
call SetupBuildingUpgrades('h08X',.2,true,0)
call SetupBuildingUpgrades('h08Y',.2,true,'h08X')
call SetupSiegeBuildingUpgrades('h070',.18,true,0)
call SetupBuildingUpgrades('h06Y',.2,true,0)
call SetupBuildingUpgrades('h00Z',.12,false,0)
call SetupBuildingUpgrades('h059',.12,false,0)
call SetupBuildingUpgrades('h005',.12,false,0)
call SetupBuildingUpgrades('h014',.0,false,0)
call SetupBuildingUpgrades('h008',.05,false,0)
endfunction
function Zb takes nothing returns nothing
call RegisterSpell('n01Y','A08V',function Tb)
call RegisterSpell('h07B','A0A7',function Ub)
call RegisterSpell('h00W','A00X',function wb)
endfunction
function vB takes integer id returns integer
if(oa[id]==0)then
return 0
else
return 16+4*oa[id]
endif
endfunction
function eB takes player p returns nothing
local integer id=PlayerForce[GetPlayerId(p)]
set oa[id]=oa[id]+(1)
set oo[id]=vB(id)
endfunction
function xB takes unit u returns nothing
local integer id=PlayerForce[GetPlayerId(GetOwningPlayer(u))]
set oa[id]=oa[id]-(1)
set oo[id]=vB(id)
endfunction
function oB takes nothing returns nothing
    call Yb()
    call zb()
    call Zb()
    set xa=Filter(function tb)
endfunction
function rB takes nothing returns nothing
local unit u=GetEnumUnit()
local unit c
if(aa<5)then
set c=CreateUnit(EraserIssuer,'e008',GetUnitX(u),GetUnitY(u),.0)
call UnitAddAbility(c,'A016')
call IssueTargetOrderById(c,$D0085,u)
call UnitApplyTimedLife(c,'BTLF',1.)
set aa=aa+1
set c=null
endif
set u=null
endfunction
function iB takes nothing returns nothing
local real x=GetUnitX(De)
local real y=GetUnitY(De)
call DestroyEffect(AddSpecialEffect("Abilities\\Spells\\Other\\HowlOfTerror\\HowlCaster.mdl",x,y))
set EraserIssuer=GetOwningPlayer(De)
call GroupEnumUnitsInRange(ErasingGroup,x,y,510.,ia)
set aa=0
call ForGroup(ErasingGroup,function rB)
endfunction
function aB takes nothing returns nothing
local unit u=ge
call IssueTargetOrderById(u,$D0062,Ge)
call TriggerSleepAction(1.)
call wI(u)
set u=null
endfunction
function nB takes nothing returns boolean
local unit u=GetFilterUnit()
local boolean aX=IsUnitAlly(u,EraserIssuer)and GetWidgetLife(u)<=.405 and not IsUnitType(u,UNIT_TYPE_MECHANICAL)
set u=null
return aX
endfunction
function VB takes nothing returns nothing
local unit u=ge
local unit c
local integer i=4
local player p=GetOwningPlayer(u)
set c=CreateUnit(p,'e008',GetUnitX(u),GetUnitY(u),.0)
call UnitAddAbility(c,'A0I1')
call UnitAddAbility(c,'A0I2')
call UnitAddAbility(c,'A0I3')
call SetUnitAbilityLevel(c,'A0I3',GetRandomInt(1,3))
call IssueImmediateOrderById(c,$D00C4)
call TriggerSleepAction(.1)
call IssueImmediateOrderById(u,$D008F)
call TriggerSleepAction(.1)
set EraserIssuer=p
call GroupEnumUnitsInRange(ErasingGroup,GetUnitX(c),GetUnitY(c),450.,na)
if(FirstOfGroup(ErasingGroup)!=null)then
call IssueImmediateOrderById(c,$D007E)
endif
call UnitApplyTimedLife(c,'BTLF',1.2)
call TriggerSleepAction(1.)
call wI(u)
set u=null
set c=null
endfunction
function EB takes nothing returns nothing
local unit u=ge
call IssueTargetOrderById(u,$D0062,Ge)
call UnitAddAbility(Ge,'A03L')
call TriggerSleepAction(.8)
set EraserIssuer=GetOwningPlayer(u)
call GroupEnumUnitsInRange(ErasingGroup,GetUnitX(u),GetUnitY(u),650.,na)
if(FirstOfGroup(ErasingGroup)!=null)then
call IssueImmediateOrderById(u,$D007E)
call TriggerSleepAction(.8)
endif
call wI(u)
set u=null
endfunction
function XB takes nothing returns nothing
local unit u=CreateUnit(GetOwningPlayer(ge),'e008',GetUnitX(ge),GetUnitY(ge),.0)
call UnitAddAbility(u,'A0EU')
call IssueTargetOrderById(u,$D0102,Ge)
call UnitApplyTimedLife(u,'BTLF',1.)
set u=ge
call UnitRemoveAbility(u,'A00F')
call UnitAddAbility(u,'A07I')
call TriggerSleepAction(.5)
call yA(u)
call TriggerSleepAction(5.)
if(GetUnitAbilityLevel(u,'A00F')<=0)then
call IssueImmediateOrderById(u,$D0019)
call TriggerSleepAction(6.6)
if(GetUnitAbilityLevel(u,'A00F')<=0)then
call UnitAddAbility(u,'A00F')
call UnitRemoveAbility(u,'A07I')
call UnitAddAbility(u,'A0EZ')
call wI(u)
endif
endif
set u=null
endfunction
function OB takes nothing returns boolean
call SetUnitVertexColor(ce,$FF,$FF,$FF,0)
call SpawnCreep(ce,'h0A0',170.,31.25,-43.)
call SpawnCreep(ce,'h0A0',80.,-38.,-40.25)
call SpawnCreep(ce,'h0A0',350.,-30.25,30.)
call SpawnCreep(ce,'h08Z',220.,43.,27.5)
return false
endfunction
function RB takes nothing returns nothing
call BuildingTrains('h000','hfoo')
call BuildingTrains('h039','h03A')
call BuildingTrains('h003','hrif')
call BuildingTrains('h0A1','h05C')
call AttachRegister('h0A1',function OB)
call BuildingTrains('h05D','h0A2')
call BuildingTrains('h004','hmtm')
call ZX('h006',950.)
call BuildingTrains('h00K','n005')
call ZX('h010',500.)
call SetupSpecialBuildingAction('h010',function iB)
call BuildingTrains('h015','h016')
call BuildingTrains('h037','h03B')
call BuildingTrains('h038','h03C')
call BuildingTrains('h072','h074')
endfunction
function SetupHumanRaceBuildings takes nothing returns nothing
call PrepareRaceBuildingSetup(1)
call SetupBuildingUpgrades('h037',.2,true,0) // h037 <-- chapel
call SetupBuildingUpgrades('h038',.2,true,'h037')
call SetupBuildingUpgrades('h072',.2,true,'h038')
call SetupBuildingUpgrades('h015',.2,true,0)
call SetupBuildingUpgrades('h00K',.2,true,0)
call SetupSiegeBuildingUpgrades('h004',.18,true,0) // h004 <- weapon lab
call SetupBuildingUpgrades('h003',.2,true,0)
call SetupBuildingUpgrades('h000',.2,true,0)
call SetupBuildingUpgrades('h039',.2,true,'h000')
call SetupBuildingUpgrades('h0A1',.2,true,'h003')
call SetupBuildingUpgrades('h05D',.2,true,'h003')
call SetupBuildingUpgrades('h001',.09,false,0)
call SetupBuildingUpgrades('h006',.0,false,0)
call SetupBuildingUpgrades('h010',.12,false,0)
call SetupBuildingUpgrades('h05G',.12,false,0)
call SetupBuildingUpgrades('h008',.05,false,0)
endfunction
function AB takes nothing returns nothing
call RegisterSpell('h03B','A03K',function aB)
call RegisterSpell('h03C','A03K',function EB)
call RegisterSpell('h074','A0I0',function VB)
call RegisterSpell('n005','A00K',function XB)
endfunction
function NB takes unit u returns nothing
    local real x=GetRandomReal(2000.,5700.)
    local real y=GetRandomReal(-2200.,2200.)
    if(GetPlayerId(GetOwningPlayer(u))>5)then
    set x=-x
    endif
    call IssuePointOrderById(u,$D0010,x,y)
endfunction
function bB takes nothing returns nothing
call NB(GetEnumUnit())
endfunction
function BB takes nothing returns nothing
call ForGroup(ra,function bB)
endfunction
function cB takes unit u returns nothing
local integer f=GetPlayerId(GetOwningPlayer(u))
set io[f]=io[f]+1
endfunction
function CB takes unit u returns nothing
local integer f=GetPlayerId(GetOwningPlayer(u))
set io[f]=io[f]-1
endfunction
function dB takes nothing returns boolean
local unit u=GetFilterUnit()
local boolean aX=GetWidgetLife(u)>.405 and IsUnitAlly(u,EraserIssuer)and IsUnitType(u,UNIT_TYPE_SAPPER)
set u=null
return aX
endfunction
function DB takes nothing returns nothing
call RB()
call SetupHumanRaceBuildings()
call AB()
call TimerStart(CreateTimer(),11.,true,function BB)
set na=Filter(function nB)
set ia=Filter(function dB)
endfunction
function fB takes nothing returns boolean
local unit u=GetFilterUnit()
local boolean aX=GetWidgetLife(u)>50. and IsUnitAlly(u,EraserIssuer)and IsUnitType(u,UNIT_TYPE_SAPPER)and GetUnitAbilityLevel(u,'Avul')<=0 and GetUnitAbilityLevel(u,'A09L')<=0
set u=null
return aX
endfunction
function FB takes nothing returns boolean
local unit u=GetFilterUnit()
local boolean aX=GetWidgetLife(u)>50. and IsUnitAlly(u,EraserIssuer)and IsUnitType(u,UNIT_TYPE_SAPPER)and GetUnitAbilityLevel(u,'Avul')<=0
set u=null
return aX
endfunction
function gB takes nothing returns nothing
local unit u
set EraserIssuer=GetOwningPlayer(De)
call GroupEnumUnitsInRect(ErasingGroup,bj_mapInitialPlayableArea,Xa)
set bj_groupRandomCurrentPick=IX(ErasingGroup)
if(bj_groupRandomCurrentPick==null)then
return
endif
call UnitAddAbility(bj_groupRandomCurrentPick,'A09L')
call UnitAddAbility(bj_groupRandomCurrentPick,'A09Q')
set u=De
call SetUnitAnimation(u,"death")
call TriggerSleepAction(.3)
call SetUnitAnimation(u,"stand")
set u=null
endfunction
function GB takes nothing returns nothing
local unit u
set EraserIssuer=GetOwningPlayer(De)
call GroupEnumUnitsInRect(ErasingGroup,bj_mapInitialPlayableArea,Xa)
set bj_groupRandomCurrentPick=IX(ErasingGroup)
if(bj_groupRandomCurrentPick==null)then
return
endif
call UnitAddAbility(bj_groupRandomCurrentPick,'A09L')
call UnitAddAbility(bj_groupRandomCurrentPick,'A09Q')
call SetUnitAbilityLevel(bj_groupRandomCurrentPick,'A09L',2)
call SetUnitAbilityLevel(bj_groupRandomCurrentPick,'A09Q',2)
set u=De
call SetUnitAnimation(u,"death")
call TriggerSleepAction(.3)
call SetUnitAnimation(u,"stand")
set u=null
endfunction
function hB takes nothing returns nothing
local player p=GetOwningPlayer(ge)
local real x=GetUnitX(Ge)
local real y=GetUnitY(Ge)
local real sx=GetUnitX(ge)
local real sy=GetUnitY(ge)
local unit c=CreateUnit(p,'h09Q',sx,sy,.0)
local unit t
call IssuePointOrderById(c,$D0010,x,y)
call UnitApplyTimedLife(c,'BTLF',3.)
set sx=sx-(x)
set sy=sy-(y)
call TriggerSleepAction(SquareRoot(sx*sx+sy*sy)/ 700.)
set c=CreateUnit(p,'e008',x,y,.0)
call UnitAddAbility(c,'A09E')
call IssueImmediateOrderById(c,$D0080)
call UnitApplyTimedLife(c,'BTLF',3.)
set EraserIssuer=p
call GroupEnumUnitsInRange(ErasingGroup,x,y,300.,ki)
loop
set t=FirstOfGroup(ErasingGroup)
exitwhen t==null
call GroupRemoveUnit(ErasingGroup,t)
set sy=GetUnitState(t,UNIT_STATE_MANA)
if(sy>.0)then
if(sy<100.)then
set sx=sy
else
set sx=100.
endif
call SetUnitState(t,UNIT_STATE_MANA,sy-sx)
call DestroyEffect(AddSpecialEffectTarget("Abilities\\Spells\\Human\\Feedback\\SpellBreakerAttack.mdl",t,"origin"))
call UnitDamageTarget(c,t,1.+sx,true,false,ATTACK_TYPE_CHAOS,DAMAGE_TYPE_NORMAL,WEAPON_TYPE_WHOKNOWS)
endif
endloop
set c=null
endfunction
function HB takes nothing returns nothing
local player p=GetOwningPlayer(ge)
local real sx=GetUnitX(ge)
local real sy=GetUnitY(ge)
local real r=GetRandomReal(320.,360.)
local real a=GetRandomReal(-3.14,3.14)
local unit c=CreateUnit(p,'h09M',sx,sy,.0)
set sx=sx+r*Cos(a)
set sy=sy+r*Sin(a)
call SetUnitState(ge,UNIT_STATE_MANA,GetUnitState(ge,UNIT_STATE_MANA)+GetRandomReal(-20.,16.))
call IssuePointOrderById(c,$D0010,sx,sy)
call UnitApplyTimedLife(c,'BTLF',3.)
call TriggerSleepAction(r/ 600.)
call UnitApplyTimedLife(CreateUnit(p,'n025',sx,sy,.0),'BTLF',150.)
set c=null
set p=null
endfunction
function jB takes nothing returns boolean
call SpawnCreep(ce,'e00L',.0,.0,.0)
return false
endfunction
function JB takes nothing returns nothing
local unit c
if(GetRandomInt(0,99)>75)then
set c=LoadUnitHandle(ox,GetHandleId(De),0)
call IssueTargetOrderById(c,$D0097,GetSpellTargetUnit())
set c=null
endif
endfunction
function kB takes nothing returns boolean
call SpawnCreep(ce,'h09V',270.,.0,.0)
call SpawnCreep(ce,'h09U',90.,20.,.0)
call SpawnCreep(ce,'h09U',.0,.0,-20.)
call SpawnCreep(ce,'h09U',270.,-20.,.0)
call SpawnCreep(ce,'h09U',180.,.0,20.)
return false
endfunction
function KB takes nothing returns boolean
call SpawnCreep(ce,'h09R',300.,3.5,65.25)
call SpawnCreep(ce,'h09R',70.,-16.5,-51.)
call SpawnCreep(ce,'h09N',238.,36.,53.)
call SpawnCreep(ce,'h09O',314.,-38.,-39.5)
return false
endfunction
function lB takes nothing returns boolean
call SpawnCreep(ce,'h09O',279.,-45.5,24.75)
call SpawnCreep(ce,'h09N',300.,31.,-32.25)
return false
endfunction
function LB takes nothing returns boolean
call SpawnCreep(ce,'h09K',238.,.0,.0)
return false
endfunction
function mB takes nothing returns boolean
call SpawnCreep(ce,'h09F',2.,36.25,41.)
call SpawnCreep(ce,'h09F',2.,33.25,-33.5)
call SpawnCreep(ce,'h09F',2.,-46.25,10.75)
call SpawnCreep(ce,'h09A',45.,-5.25,17.)
return false
endfunction
function MB takes nothing returns boolean
call SpawnCreep(ce,'h09D',225.,35.,-29.75)
call SpawnCreep(ce,'h09D',45.,20.,22.5)
call SpawnCreep(ce,'h09D',225.,-31.,26.25)
call SpawnCreep(ce,'h09G',23.,-25.25,-36.)
return false
endfunction
function pB takes nothing returns boolean
call SetUnitFacing(ce,.7)
call SpawnCreep(ce,'h09D',45.,35.,-29.75)
call SpawnCreep(ce,'h09D',45.,20.,22.5)
call SpawnCreep(ce,'h09D',-45.,-31.,26.25)
call SpawnCreep(ce,'h09G',23.,-25.25,-36.)
return false
endfunction
function PB takes nothing returns boolean
call SpawnCreep(ce,'h09C',33.,36.25,36.5)
call SpawnCreep(ce,'h09C',13.,21.,-47.5)
call SpawnCreep(ce,'h09C',319.,-46.25,11.75)
return false
endfunction
function qB takes nothing returns boolean
call SpawnCreep(ce,'h09C',33.,36.25,36.5)
call SpawnCreep(ce,'h09C',13.,21.,-47.5)
call SpawnCreep(ce,'h09C',319.,-46.25,11.75)
call SpawnCreep(ce,'h09E',348.,-6.5,9.)
return false
endfunction
function Mechanical___Animationh05L takes nothing returns boolean
    call SpawnCreep(ce,'h09K',45.,.0,.0)
return false
endfunction
function QB takes nothing returns boolean
call SpawnCreep(ce,'h096',180.,-45.75,21.75)
call SpawnCreep(ce,'h096',110.,9.,-62.5)
return false
endfunction
function sB takes nothing returns nothing
call AttachRegister('h09T',function kB)
call ZX('h09T',180.)
call BuildingTrains('h069','n01U')
call AttachRegister('h069',function KB)
call SetupSpecialBuildingAction('h06J',function gB)
call SetupSpecialBuildingAction('h05R',function GB)
call BuildingTrains('h05T','z002')
call BuildingTrains('h09P','z003')
call AttachRegister('h09P',function lB)
call BuildingTrains('h05U','n01T')
call BuildingTrains('h05M','n01V')
call BuildingTrains('h06D','n02G')
call BuildingTrains('h05J','h06Q')
call BuildingTrains('h09L','h06R')
call AttachRegister('h09L',function LB)
call BuildingTrains('h05V','n01X')
call BuildingTrains('h097','n024')
call AttachRegister('h097',function QB)
call BuildingTrains('h05X','h06T')
call BuildingTrains('h09J','h06U')
call AttachRegister('h09J',function mB)
call BuildingTrains('h09I','h099')
call AttachRegister('h09I',function MB)
call BuildingTrains('h06G','h06F')
call BuildingTrains('h077','h075')
call AttachRegister('h077',function pB)
call BuildingTrains('h09B','h06S')
call AttachRegister('h09B',function PB)
call BuildingTrains('h09H','h098')
call AttachRegister('h09H',function qB)
call ZX('h05L',600.)
call AttachRegister('h05L',function jB)
endfunction
function SB takes nothing returns nothing
call PrepareRaceBuildingSetup(9)
call SetupBuildingUpgrades('h05T',.2,true,0)
call SetupBuildingUpgrades('h09P',.2,true,'h05T')
call SetupBuildingUpgrades('h05U',.2,true,0)
call SetupBuildingUpgrades('h05M',.2,true,0)
call SetupBuildingUpgrades('h06D',.2,true,'h05M')
call SetupBuildingUpgrades('h05J',.2,true,0)
call SetupBuildingUpgrades('h09L',.2,true,'h05J')
call SetupBuildingUpgrades('h05V',.2,true,0)
call SetupBuildingUpgrades('h097',.2,false,'h05V')
call SetupBuildingUpgrades('h05X',.2,true,0)
call SetupBuildingUpgrades('h09J',.2,true,'h05X')
call SetupBuildingUpgrades('h09I',.2,true,'h05X')
call SetupBuildingUpgrades('h077',.2,false,'h09I')
call SetupBuildingUpgrades('h06G',.18,true,'h05X')
call SetupBuildingUpgrades('h09B',.2,true,'h05X')
call SetupBuildingUpgrades('h09H',.2,true,'h09B')
call SetupBuildingUpgrades('h09T',.12,false,0)
call SetupBuildingUpgrades('h069',.12,false,0)
call SetupBuildingUpgrades('h06J',.12,false,0)
call SetupBuildingUpgrades('h05R',.12,false,'h06J')
call SetupBuildingUpgrades('h05L',.0,false,0)
call SetupBuildingUpgrades('h008',.05,false,0)
endfunction
function tB takes nothing returns nothing
call RegisterSpell('z003','A09D',function hB)
call RegisterSpell('h06U','A095',function HB)
call SetupSpecialBuildingAction('h05L',function JB)
endfunction
function TB takes nothing returns nothing
call sB()
call SB()
call tB()
set Xa=Filter(function FB)
set Ea=Filter(function fB)
endfunction
function uB takes nothing returns nothing
local unit c
set EraserIssuer=GetOwningPlayer(De)
call GroupEnumUnitsInRect(ErasingGroup,bj_mapInitialPlayableArea,li)
set bj_groupRandomConsidered=0
set bj_groupRandomCurrentPick=null
set bj_groupRandomCurrentPick=IX(ErasingGroup)
if(bj_groupRandomCurrentPick==null)then
return
endif
set c=CreateUnit(GetOwningPlayer(De),'e008',GetUnitX(De),GetUnitY(De),.0)
call UnitAddAbility(c,'A00P')
call UnitShareVision(bj_groupRandomCurrentPick,EraserIssuer,true)
call IssueTargetOrderById(c,$D00FA,bj_groupRandomCurrentPick)
call UnitShareVision(bj_groupRandomCurrentPick,EraserIssuer,false)
call UnitApplyTimedLife(c,'BTLF',15.)
set c=null
endfunction
function UB takes nothing returns nothing
local unit c
set EraserIssuer=GetOwningPlayer(De)
call GroupEnumUnitsInRect(ErasingGroup,bj_mapInitialPlayableArea,li)
set bj_groupRandomConsidered=0
set bj_groupRandomCurrentPick=null
set bj_groupRandomCurrentPick=IX(ErasingGroup)
if(bj_groupRandomCurrentPick==null or eN(bj_groupRandomCurrentPick))then
return
endif
set c=CreateUnit(GetOwningPlayer(De),'e008',GetUnitX(bj_groupRandomCurrentPick),GetUnitY(bj_groupRandomCurrentPick),.0)
call UnitAddAbility(c,'A00N')
call UnitShareVision(bj_groupRandomCurrentPick,EraserIssuer,true)
call IssueTargetOrderById(c,$D0265,bj_groupRandomCurrentPick)
call UnitShareVision(bj_groupRandomCurrentPick,EraserIssuer,false)
call UnitApplyTimedLife(c,'BTLF',1.5)
set c=null
endfunction
function wB takes nothing returns boolean
call SpawnCreep(ce,'e00K',.0,.0,40.)
return false
endfunction
function WB takes nothing returns nothing
local unit u
set u=LoadUnitHandle(ox,GetHandleId(De),0)
call IssueTargetOrderById(u,$D0215,GetSpellTargetUnit())
set u=null
endfunction
function yB takes nothing returns nothing
local unit c
set EraserIssuer=GetOwningPlayer(De)
call GroupEnumUnitsInRect(ErasingGroup,bj_mapInitialPlayableArea,ki)
set bj_groupRandomConsidered=0
set bj_groupRandomCurrentPick=null
set bj_groupRandomCurrentPick=IX(ErasingGroup)
if(bj_groupRandomCurrentPick==null)then
return
endif
set c=CreateUnit(EraserIssuer,'e008',GetUnitX(bj_groupRandomCurrentPick),GetUnitY(bj_groupRandomCurrentPick),.0)
call UnitAddAbility(c,'A00B')
call IssueImmediateOrderById(c,$D0080)
call UnitApplyTimedLife(c,'BTLF',1.)
set c=null
endfunction
function YB takes nothing returns nothing
    local unit c=CreateUnit(GetOwningPlayer(ge),'e008',GetUnitX(ge),GetUnitY(ge),.0)
    call UnitAddAbility(c,'A02T')
    call IssueTargetOrderById(c,$D008F,Ge)
    call UnitApplyTimedLife(c,'BTLF',2.)
    set c=ge
    call TriggerSleepAction(1.)
    if(IssueImmediateOrderById(c,$D009E))then
    call TriggerSleepAction(1.)
    endif
    call wI(c)
    set c=null
endfunction
function zB takes nothing returns nothing
call BuildingTrains('h01Z','n00S')
call SetupSpecialBuildingAction('h00N',function uB)
call SetupSpecialBuildingAction('h00M',function UB)
call AttachRegister('h00G',function wB)
call SetupSpecialBuildingAction('h00G',function WB)
call BuildingTrains('h00J','n004')
call BuildingTrains('h05F','n01P')
call BuildingTrains('h01B','n007')
call SetupSpecialBuildingAction('h00I',function yB)
call BuildingTrains('h020','n00I')
call BuildingTrains('h021','n00J')
call BuildingTrains('h022','n00K')
call ZX('h00G',650.)
call BuildingTrains('h01Y','n00H')
call BuildingTrains('h00F','n002')
call BuildingTrains('h032','n00X')
endfunction
function ZB takes nothing returns nothing
call PrepareRaceBuildingSetup(3)
call SetupBuildingUpgrades('h01Z',.2,true,0)
call SetupBuildingUpgrades('h00J',.2,true,0)
call SetupBuildingUpgrades('h05F',.2,false,'h00J')
call SetupSiegeBuildingUpgrades('h01B',.18,true,0)
call SetupBuildingUpgrades('h020',.2,true,0)
call SetupBuildingUpgrades('h021',.2,true,'h020')
call SetupBuildingUpgrades('h022',.2,true,'h021')
call SetupBuildingUpgrades('h01Y',.2,true,0)
call SetupBuildingUpgrades('h00F',.2,true,0)
call SetupBuildingUpgrades('h032',.2,true,'h00F')
call SetupBuildingUpgrades('h00N',.09,false,0)
call SetupBuildingUpgrades('h00I',.18,false,0)
call SetupBuildingUpgrades('h00M',.18,false,0)
call SetupBuildingUpgrades('h00G',.0,false,0)
call SetupBuildingUpgrades('h008',.05,false,0)
endfunction
function Naga___RegisterUnitCasts takes nothing returns nothing
    call RegisterSpell('n00S','A02U',function YB)
endfunction
function vc takes nothing returns nothing
    call zB()
    call ZB()
    call RegisterSpell('n00S','A02U',function YB)
endfunction
function ec takes nothing returns boolean
local unit u=GetFilterUnit()
local boolean b=GetWidgetLife(u)>.405 and IsUnitType(u,UNIT_TYPE_GROUND)and IsUnitType(u,UNIT_TYPE_SAPPER)
set u=null
return b
endfunction
function xc takes nothing returns nothing
local player p=GetOwningPlayer(ge)
local integer i=0
local real x=GetUnitX(ge)
local real y=GetUnitY(ge)
local destructable array oc
local real an
local real r
local unit u
local real x2
local real y2
call GroupEnumUnitsInRange(ErasingGroup,x,y,144.,Ia)
loop
set u=FirstOfGroup(ErasingGroup)
exitwhen u==null
call GroupRemoveUnit(ErasingGroup,u)
if(u!=ge)then
set r=GetRandomReal(160.,218.)
set an=(GetRandomReal(135.,234.)+180.*PlayerForce[GetPlayerId(GetOwningPlayer(u))])*bj_DEGTORAD
set x2=x+r*Cos(an)
set y2=y+r*Sin(an)
call SetUnitX(u,x2)
call SetUnitY(u,y2)
call DestroyEffect(AddSpecialEffect("Abilities\\Spells\\Human\\MassTeleport\\MassTeleportCaster.mdl",x2,y2))
endif
endloop
set u=ge
loop
set an=72.*I2R(i)
set oc[i]=CreateDestructable('YTct',x+120.*Cos(an*bj_DEGTORAD),y+120.*Sin(an*bj_DEGTORAD),an,1.,0)
set i=i+1
exitwhen i>=5
endloop
call TriggerSleepAction(3.)
if(GetWidgetLife(u)>.405)then
set i=0
loop
if(GetWidgetLife(oc[i])>.405)then
call KillDestructable(oc[i])
set an=72.*I2R(i)
set x2=x+112.*Cos(an*bj_DEGTORAD)
set y2=y+112.*Sin(an*bj_DEGTORAD)
call UnitApplyTimedLife(CreateUnit(p,'e00D',x2,y2,an),'B021',20.)
call DestroyEffect(AddSpecialEffect("Objects\\Spawnmodels\\NightElf\\EntBirthTarget\\EntBirthTarget.mdl",x2,y2))
endif
set i=i+1
exitwhen i>=5
endloop
call wI(u)
else
set i=0
loop
call KillDestructable(oc[i])
set i=i+1
exitwhen i>=5
endloop
endif
call TriggerSleepAction(3.)
set i=0
loop
call RemoveDestructable(oc[i])
set oc[i]=null
set i=i+1
exitwhen i>=5
endloop
set u=null
endfunction
function ic takes nothing returns nothing
local unit c=CreateUnit(GetOwningPlayer(ge),'e008',GetUnitX(ge),GetUnitY(ge),.0)
call UnitAddAbility(c,'A0AW')
call IssueTargetOrderById(c,$D00C0,Ge)
call UnitApplyTimedLife(c,'BTLF',2.)
set c=ge
call TriggerSleepAction(.8)
call wI(c)
set c=null
endfunction
function ac takes nothing returns nothing
local unit c=CreateUnit(GetOwningPlayer(ge),'e008',GetUnitX(ge),GetUnitY(ge),.0)
call UnitAddAbility(c,'A0AW')
call IssueTargetOrderById(c,$D00C0,Ge)
call UnitApplyTimedLife(c,'BTLF',2.)
set c=ge
call TriggerSleepAction(.8)
call wI(c)
set c=null
endfunction
function nc takes nothing returns nothing
local unit u=ge
call IssueImmediateOrderById(u,$D0228)
call TriggerSleepAction(.33)
call wI(u)
set u=null
endfunction
function Vc takes nothing returns boolean
local unit u=GetFilterUnit()
local real r=GetWidgetLife(u)
local boolean aX=r>.405 and IsUnitAlly(u,EraserIssuer)and IsUnitType(u,UNIT_TYPE_SAPPER)and GetUnitAbilityLevel(u,'A08C')<=0 and GetUnitAbilityLevel(u,'Bhea')<=0 and GetUnitState(u,UNIT_STATE_MAX_LIFE)-r>200.
set u=null
return aX
endfunction
function Ec takes nothing returns nothing
local unit u=ge
call UnitAddAbility(Ge,'AId2')
call DestroyEffect(AddSpecialEffectTarget("mdx\\sfx\\sin2.mdx",Ge,"overhead"))
call TriggerSleepAction(.5)
call wI(u)
set u=null
endfunction
function Xc takes nothing returns nothing
local unit u=ge
call UnitAddAbility(Ge,'AId3')
call DestroyEffect(AddSpecialEffectTarget("mdx\\sfx\\sin2.mdx",Ge,"overhead"))
call TriggerSleepAction(.5)
if(IssueImmediateOrderById(u,$D009E))then
call TriggerSleepAction(1.)
endif
call wI(u)
set u=null
endfunction
function Oc takes nothing returns nothing
local unit u=ge
call TriggerSleepAction(3.)
call IssueImmediateOrderById(u,$D00F4)
call TriggerSleepAction(3.)
call IssueImmediateOrderById(u,$D027A)
call wI(u)
set u=null
endfunction
function Rc takes nothing returns boolean
local unit u=GetFilterUnit()
local real r=GetWidgetLife(u)
local boolean b
set b=r>.405 and IsUnitEnemy(u,ba)and IsUnitType(u,UNIT_TYPE_SAPPER)and not IsUnitType(u,UNIT_TYPE_MECHANICAL)and GetUnitAbilityLevel(u,'A07H')<=0
if(b)then
set Ba=Ba+1
if(Ba>3)then
set Ba=0
else
set b=false
endif
endif
set u=null
return b
endfunction
function Ic takes nothing returns nothing
local unit u
local real hp
local real x
local real y
local real a
local integer ut
set Ba=GetRandomInt(0,2)
set ba=GetOwningPlayer(De)
call PlaySoundBJ(TranquilitySound)
call GroupEnumUnitsInRect(Da,bj_mapInitialPlayableArea,Ca)
loop
set u=FirstOfGroup(Da)
exitwhen u==null
set hp=GetWidgetLife(u)
if(IsUnitType(u,UNIT_TYPE_FLYING))then
set ut=Ra[GetRandomInt(0,1)]
else
if(hp<600.)then
set ut=Ra[GetRandomInt(2,6)]
else
set ut=Ra[GetRandomInt(7,9)]
endif
endif
set x=GetUnitX(u)
set y=GetUnitY(u)
set a=GetUnitFacing(u)
call GroupRemoveUnit(Da,u)
call RemoveUnit(u)
call CreateUnit(ba,ut,x,y,a)
call DestroyEffect(AddSpecialEffect("Abilities\\Spells\\NightElf\\TargetArtLumber\\TargetArtLumber.mdl",x,y))
endloop
endfunction
function Ac takes nothing returns nothing
call IssueTargetOrderById(ge,$D000F,Ge)
endfunction
function Nc takes nothing returns nothing
local unit c
set EraserIssuer=GetOwningPlayer(De)
call GroupEnumUnitsInRect(ErasingGroup,bj_mapInitialPlayableArea,li)
set bj_groupRandomConsidered=0
set bj_groupRandomCurrentPick=null
call ForGroup(ErasingGroup,function GroupPickRandomUnitEnum)
if(bj_groupRandomCurrentPick==null or eN(bj_groupRandomCurrentPick))then
return
endif
set c=CreateUnit(EraserIssuer,'e008',GetUnitX(bj_groupRandomCurrentPick),GetUnitY(bj_groupRandomCurrentPick),.0)
call UnitAddAbility(c,'A0BL')
call UnitShareVision(bj_groupRandomCurrentPick,EraserIssuer,true)
call IssueTargetOrderById(c,$D0206,bj_groupRandomCurrentPick)
call UnitShareVision(bj_groupRandomCurrentPick,EraserIssuer,false)
call UnitApplyTimedLife(c,'BTLF',1.)
set c=null
endfunction
function bc takes nothing returns nothing
local unit c
set EraserIssuer=GetOwningPlayer(De)
call GroupEnumUnitsInRect(ErasingGroup,bj_mapInitialPlayableArea,li)
set bj_groupRandomConsidered=0
set bj_groupRandomCurrentPick=null
call ForGroup(ErasingGroup,function GroupPickRandomUnitEnum)
if(bj_groupRandomCurrentPick==null)then
return
endif
set c=CreateUnit(EraserIssuer,'e008',GetUnitX(bj_groupRandomCurrentPick),GetUnitY(bj_groupRandomCurrentPick),.0)
call UnitAddAbility(c,Oa)
call IssuePointOrderById(c,$D0275,GetUnitX(bj_groupRandomCurrentPick),GetUnitY(bj_groupRandomCurrentPick))
call UnitApplyTimedLife(c,'BTLF',5.)
set c=null
endfunction
function Bc takes nothing returns boolean
call SpawnCreep(ce,'h02J',270.,.0,.0)
return false
endfunction
function Cc takes nothing returns boolean
call SpawnCreep(ce,'h02J',270.,.0,.0)
call SpawnCreep(ce,'h02E',270.,.0,.0)
return false
endfunction
function dc takes nothing returns boolean
call SpawnCreep(ce,'h02J',270.,.0,.0)
call SpawnCreep(ce,'h02E',270.,.0,.0)
call SpawnCreep(ce,'h02F',270.,-25.,-25.)
return false
endfunction
function Dc takes nothing returns boolean
call SpawnCreep(ce,'h02J',270.,.0,.0)
call SpawnCreep(ce,'h02E',270.,.0,.0)
call SpawnCreep(ce,'h02F',270.,-35.,-40.)
call SpawnCreep(ce,'h02G',211.,-35.,35.)
return false
endfunction
function fc takes nothing returns boolean
call SpawnCreep(ce,'h02Q',270.,-35.,30.)
return false
endfunction
function Fc takes nothing returns boolean
call SpawnCreep(ce,'h02L',270.,.0,.0)
call SpawnCreep(ce,'h02M',270.,25,20.)
return false
endfunction
function gc takes nothing returns boolean
call SpawnCreep(ce,'h02T',49.,-40.,20.)
return false
endfunction
function Gc takes nothing returns nothing
call BuildingTrains('n02C','n00T')
call AttachRegister('n02C',function Bc)
call BuildingTrains('h002','n00U')
call AttachRegister('h002',function Cc)
call BuildingTrains('h00Q','n01N')
call AttachRegister('h00Q',function dc)
call BuildingTrains('h00R','n01W')
call AttachRegister('h00R',function Dc)
call BuildingTrains('h00Y','n026')
call BuildingTrains('h012','n028')
call AttachRegister('h012',function fc)
call BuildingTrains('h013','e006')
call BuildingTrains('h01H','e009')
call BuildingTrains('h01J','e00C')
call BuildingTrains('h023','n029')
call BuildingTrains('h024','n02B')
call AttachRegister('h024',function Fc)
call BuildingTrains('h027','n02A')
call BuildingTrains('h028','e00F')
call AttachRegister('h028',function gc)
call ZX('n02D',700.)
call SetupSpecialBuildingAction('h02D',function Ic)
call SetupSpecialBuildingAction('h02C',function Nc)
call SetupSpecialBuildingAction('h02A',function bc)
endfunction
function hc takes nothing returns nothing
call PrepareRaceBuildingSetup($A)
call SetupBuildingUpgrades('h002',.2,true,0)
call SetupBuildingUpgrades('h00Q',.2,true,'h002')
call SetupBuildingUpgrades('h00R',.2,true,'h00Q')
call SetupBuildingUpgrades('h00Y',.2,true,0)
call SetupBuildingUpgrades('h012',.2,true,'h00Y')
call SetupBuildingUpgrades('h013',.2,true,0)
call SetupBuildingUpgrades('h01H',.2,true,'h013')
call SetupBuildingUpgrades('h01J',.2,false,'h01H')
call SetupBuildingUpgrades('h023',.2,true,0)
call SetupBuildingUpgrades('h024',.2,true,'h023')
call SetupBuildingUpgrades('h027',.2,true,0)
call SetupBuildingUpgrades('h028',.2,true,0)
call SetupBuildingUpgrades('n02D',.0,false,0)
call SetupBuildingUpgrades('h02A',.12,false,0)
call SetupBuildingUpgrades('h02C',.09,false,0)
call SetupBuildingUpgrades('h02D',.12,false,0)
call SetupBuildingUpgrades('h008',.05,false,0)
endfunction
function Hc takes nothing returns nothing
call RegisterSpell('n026','A0C0',function ic)
call RegisterSpell('n028','A0C1',function ac)
call RegisterSpell('e006','A004',function Ec)
call RegisterSpell('e009','A0BT',function Xc)
call RegisterSpell('e00C','A0BX',function xc)
call RegisterSpell('n01W','A0AV',function Oc)
call RegisterSpell('e00F','A0BJ',function nc)
call RegisterSpell('n03E','A0IS',function Ac)
endfunction
function jc takes unit u returns nothing
local real x=GetUnitX(u)
local real y=GetUnitY(u)
local real an=GetUnitFacing(u)*bj_DEGTORAD
local destructable d=CreateDestructable('VTlt',x+32.*Cos(an),y+32.*Sin(an),0,1.,0)
call IssueTargetOrderById(u,$D021F,d)
call TriggerSleepAction(.3)
call wI(u)
call RemoveDestructable(d)
set d=null
endfunction
function Jc takes nothing returns nothing
    call Gc()
    call hc()
    call Hc()
    set Aa=Filter(function Vc)
    set Ia=Filter(function ec)
    set Ca=Filter(function Rc)
    set Ra[0]='n03K'
    set Ra[1]='n03G'
    set Ra[2]='n03F'
    set Ra[3]='n03H'
    set Ra[4]='n03I'
    set Ra[5]='n03B'
    set Ra[6]='n03L'
    set Ra[7]='n03C'
    set Ra[8]='n03E'
    set Ra[9]='n03D'
    set Da=CreateGroup()
endfunction
function kc takes nothing returns boolean
local unit u=GetFilterUnit()
local boolean aX=GetWidgetLife(u)>.405 and IsUnitAlly(u,EraserIssuer)and IsUnitType(u,UNIT_TYPE_SAPPER)and GetUnitAbilityLevel(u,'A08C')<=0
set u=null
return aX
endfunction
function Kc takes nothing returns nothing
set EraserIssuer=GetOwningPlayer(De)
call GroupEnumUnitsInRect(ErasingGroup,bj_mapInitialPlayableArea,ga)
call DestroyEffect(AddSpecialEffect("Abilities\\Spells\\Human\\Polymorph\\PolyMorphTarget.mdl",GetUnitX(De),GetUnitY(De)))
set bj_groupRandomConsidered=0
set bj_groupRandomCurrentPick=null
call ForGroup(ErasingGroup,function GroupPickRandomUnitEnum)
if(bj_groupRandomCurrentPick==null)then
return
endif
call DestroyEffect(AddSpecialEffectTarget("Abilities\\Spells\\Human\\ControlMagic\\ControlMagicTarget.mdl",bj_groupRandomCurrentPick,"overhead"))
call UnitAddAbility(bj_groupRandomCurrentPick,'A08C')
call UnitAddAbility(bj_groupRandomCurrentPick,'A08D')
call UnitAddAbility(bj_groupRandomCurrentPick,'A08F')
endfunction
function lc takes nothing returns boolean
local unit u=GetFilterUnit()
local boolean aX=GetWidgetLife(u)>.405 and IsUnitAlly(u,EraserIssuer)and IsUnitType(u,UNIT_TYPE_SAPPER)and(not IsUnitType(u,UNIT_TYPE_MECHANICAL))
if(aX)then
set ha=ha+1
endif
set u=null
return aX
endfunction
function Lc takes nothing returns nothing
local real mc
local unit u=GetTriggerUnit()
local player p
local integer id
local real dN
local real DN
if(IsUnitType(u,UNIT_TYPE_STRUCTURE)or(not IsUnitType(GetTriggerUnit(),UNIT_TYPE_SAPPER))or GetUnitAbilityLevel(u,'A08H')>0)then
set u=null
return
endif
set p=GetOwningPlayer(u)
set id=PlayerForce[GetPlayerId(p)]
if(Ha[id]>0)then
set dN=GetUnitX(u)
set DN=GetUnitY(u)
call DestroyEffect(AddSpecialEffect("Abilities\\Spells\\Items\\AIda\\AIdaCaster.mdl",dN,DN))
set u=CreateUnit(p,'e008',dN,DN,.0)
call UnitAddAbility(u,'A08A')
call IssueImmediateOrderById(u,$D012D)
call UnitApplyTimedLife(u,'BTLF',1.)
set EraserIssuer=p
set ha=0
call GroupEnumUnitsInRange(ErasingGroup,dN,DN,250.,Ga)
set mc=50.+300./(1.+.75*I2R(ha))
loop
set u=FirstOfGroup(ErasingGroup)
exitwhen u==null
call GroupRemoveUnit(ErasingGroup,u)
call SetUnitState(u,UNIT_STATE_LIFE,GetWidgetLife(u)+mc)
endloop
set Ha[id]=Ha[id]-1
if(Ha[0]<=0 and Ha[1]<=0)then
call DisableTrigger(ja)
endif
endif
set u=null
endfunction
function Mc takes nothing returns nothing
local integer id=PlayerForce[GetPlayerId(GetOwningPlayer(De))]
set Ha[id]=Ha[id]+1
call DestroyEffect(AddSpecialEffect("Abilities\\Spells\\Items\\TomeOfRetraining\\TomeOfRetrainingCaster.mdl",GetUnitX(De),GetUnitY(De)))
if(not IsTriggerEnabled(ja))then
call EnableTrigger(ja)
endif
endfunction
function Pc takes nothing returns nothing
local effect e
local fogmodifier f
local real x
local real y
local boolean fl
local unit c
set EraserIssuer=GetOwningPlayer(De)
call GroupEnumUnitsInRect(ErasingGroup,bj_mapInitialPlayableArea,li)
set bj_groupRandomConsidered=0
set bj_groupRandomCurrentPick=null
call ForGroup(ErasingGroup,function GroupPickRandomUnitEnum)
if(bj_groupRandomCurrentPick==null)then
return
endif
set e=AddSpecialEffect("Abilities\\Spells\\NightElf\\Starfall\\StarfallCaster.mdl",GetUnitX(De),GetUnitY(De))
set x=GetUnitX(bj_groupRandomCurrentPick)
set y=GetUnitY(bj_groupRandomCurrentPick)
set fl=not Ox
if(fl)then
set f=CreateFogModifierRadius(EraserIssuer,FOG_OF_WAR_VISIBLE,x,y,1050.,true,false)
call FogModifierStart(f)
endif
set c=CreateUnit(EraserIssuer,'e008',x,y,.0)
if(haveArtillery)then
call UnitAddAbility(c,'A0HV')
else
call UnitAddAbility(c,'A0HT')
endif
call IssuePointOrderById(c,$D010D,x,y)
call UnitApplyTimedLife(c,'BTLF',8.)
set c=null
call TriggerSleepAction(8.5)
if(fl)then
call DestroyFogModifier(f)
set f=null
endif
call DestroyEffect(e)
set e=null
endfunction
function qc takes nothing returns nothing
local unit c=CreateUnit(GetOwningPlayer(ge),'e008',GetUnitX(Ge),GetUnitY(Ge),.0)
call UnitAddAbility(c,'A07A')
call IssueTargetOrderById(c,$D00CB,Ge)
call UnitApplyTimedLife(c,'BTLF',6.)
set c=null
endfunction
function Qc takes nothing returns boolean
local unit u=GetFilterUnit()
local boolean aX=GetWidgetLife(u)>.405 and IsUnitEnemy(u,EraserIssuer)and IsUnitType(u,UNIT_TYPE_SAPPER)and IsUnitType(u,UNIT_TYPE_GROUND)and GetUnitAbilityLevel(u,'Avul')<=0 and GetUnitAbilityLevel(u,'A08H')<=0
if(aX and GetUnitAbilityLevel(u,'BEer')<=0 and GetUnitAbilityLevel(u,'B00M')<=0)then
call GroupAddUnit(Fa,u)
set u=null
return false
endif
set u=null
return aX
endfunction
function sc takes nothing returns nothing
local real x
local real y
local unit t
local unit c
set EraserIssuer=GetOwningPlayer(ge)
set x=GetUnitX(Ge)
set y=GetUnitY(Ge)
set bj_forLoopAIndex=3
call GroupClear(Fa)
call GroupEnumUnitsInRange(ErasingGroup,x,y,300.,Ja)
loop
set t=FirstOfGroup(Fa)
exitwhen bj_forLoopAIndex<=0 or t==null
set bj_forLoopAIndex=bj_forLoopAIndex-1
call GroupRemoveUnit(Fa,t)
set c=CreateUnit(EraserIssuer,'e008',x,y,.0)
if(GetRandomInt(0,99)<50)then
call UnitAddAbility(c,'A07Q')
elseif(GetRandomInt(0,99)<55)then
call UnitAddAbility(c,'A07A')
else
call UnitAddAbility(c,'A0A6')
endif
call UnitShareVision(t,EraserIssuer,true)
call IssueTargetOrderById(c,$D00CB,t)
call UnitShareVision(t,EraserIssuer,false)
call UnitApplyTimedLife(c,'BTLF',7.)
endloop
set t=null
set c=null
endfunction
function Sc takes nothing returns nothing
local unit u=ge
call TriggerSleepAction(1.2)
call wI(u)
set u=null
endfunction
function tc takes nothing returns boolean
call SpawnCreep(ce,'h08L',32.,12.,-11.5)
return false
endfunction
function Tc takes nothing returns boolean
call SpawnCreep(ce,'h08D',116.,-3.,-10.5)
call SpawnCreep(ce,'h08N',323.,20.,5.75)
return false
endfunction
function Uc takes nothing returns boolean
call SpawnCreep(ce,'h08A',.0,.0,.0)
return false
endfunction
function wc takes nothing returns boolean
call SpawnCreep(ce,'h08K',.0,.0,.0)
return false
endfunction
function Wc takes nothing returns boolean
call SpawnCreep(ce,'h08K',.0,.0,.0)
call SpawnCreep(ce,'h08S',.0,.0,.0)
return false
endfunction
function yc takes nothing returns boolean
call SpawnCreep(ce,'h08N',226.,37.75,-41.5)
return false
endfunction
function Yc takes nothing returns boolean
call SpawnCreep(ce,'h08O',318,43.5,-41.75)
call SpawnCreep(ce,'h08N',$E2,-38.25,40.25)
return false
endfunction
function zc takes nothing returns boolean
call SpawnCreep(ce,'h08K',.0,15.,.0)
call SpawnCreep(ce,'h08R',.0,.0,.0)
return false
endfunction
function Zc takes nothing returns boolean
call SpawnCreep(ce,'h08M',.0,.0,.0)
call SpawnCreep(ce,'h08Q',.0,.0,.0)
return false
endfunction
function vC takes nothing returns nothing
call SetupSpecialBuildingAction('h07H',function Kc)
call AttachRegister('h07H',function tc)
call SetupSpecialBuildingAction('h08P',function Mc)
call AttachRegister('h08P',function Tc)
call ZX('h073',850.)
call SetupSpecialBuildingAction('h07I',function Pc)
call AttachRegister('h07I',function Uc)
call BuildingTrains('h088','e007')
call AttachRegister('h088',function wc)
call BuildingTrains('h07D','e00J')
call AttachRegister('h07D',function Wc)
call BuildingTrains('h07M','n01Z')
call AttachRegister('h07M',function yc)
call BuildingTrains('h07L','n020')
call AttachRegister('h07L',function Yc)
call BuildingTrains('h07O','e00B')
call AttachRegister('h07O',function zc)
call BuildingTrains('h07N','e00A')
call AttachRegister('h07N',function Zc)
call BuildingTrains('h011','e002')
call BuildingTrains('h00S','e001')
call BuildingTrains('h03D','e003')
call BuildingTrains('h03E','e004')
call BuildingTrains('h00B','e000')
endfunction
function eC takes nothing returns nothing
call PrepareRaceBuildingSetup(8)
call SetupBuildingUpgrades('h088',.2,true,0)
call SetupBuildingUpgrades('h07D',.2,true,'h088')
call SetupBuildingUpgrades('h07M',.2,true,0)
call SetupBuildingUpgrades('h07L',.2,true,'h07M')
call SetupBuildingUpgrades('h07O',.2,true,0)
call SetupBuildingUpgrades('h07N',.2,true,'h07O')
call SetupSiegeBuildingUpgrades('h011',.18,true,0)
call SetupBuildingUpgrades('h00S',.2,true,0)
call SetupBuildingUpgrades('h03D',.2,true,'h00S')
call SetupBuildingUpgrades('h03E',.2,true,'h03D')
call SetupBuildingUpgrades('h00B',.2,true,0)
call SetupBuildingUpgrades('h07H',.12,false,0)
call SetupBuildingUpgrades('h08P',.12,false,0)
call SetupBuildingUpgrades('h073',.0,false,0)
call SetupBuildingUpgrades('h07I',.09,false,0)
call SetupBuildingUpgrades('h008',.05,false,0)
endfunction
function xC takes nothing returns nothing
call RegisterSpell('e007','A07P',function qc)
call RegisterSpell('e00J','A07R',function sc)
call RegisterSpell('e000','A0CG',function Sc)
endfunction
function oC takes nothing returns nothing
    call vC()
    call eC()
    call xC()
    set ga=Filter(function kc)
    set Ga=Filter(function lc)
    set Ja=Filter(function Qc)
    call TriggerAddAction(ja,function Lc)
    call TriggerRegisterAnyUnitEventBJ(ja,EVENT_PLAYER_UNIT_ATTACKED)
    call DisableTrigger(ja)
endfunction
function rC takes nothing returns boolean
local unit u=GetFilterUnit()
local boolean aX=GetWidgetLife(u)>.405 and IsUnitEnemy(u,EraserIssuer)and IsUnitType(u,UNIT_TYPE_SAPPER)and IsUnitType(u,UNIT_TYPE_FLYING)
set u=null
return aX
endfunction
function iC takes nothing returns nothing
local unit c
set EraserIssuer=GetOwningPlayer(De)
call GroupEnumUnitsInRect(ErasingGroup,bj_mapInitialPlayableArea,ka)
set bj_groupRandomConsidered=0
set bj_groupRandomCurrentPick=null
call ForGroup(ErasingGroup,function GroupPickRandomUnitEnum)
if(bj_groupRandomCurrentPick==null or eN(bj_groupRandomCurrentPick))then
return
endif
set c=CreateUnit(EraserIssuer,'e008',GetUnitX(De),GetUnitY(De),.0)
call UnitAddAbility(c,'A0AK')
call UnitShareVision(bj_groupRandomCurrentPick,EraserIssuer,true)
call UnitApplyTimedLife(c,'BTLF',6.)
call IssueTargetOrderById(c,$D007F,bj_groupRandomCurrentPick)
set c=bj_groupRandomCurrentPick
call TriggerSleepAction(2.)
call UnitShareVision(c,EraserIssuer,false)
set c=null
endfunction
function aC takes nothing returns boolean
local unit u=GetFilterUnit()
local boolean aX=GetWidgetLife(u)>.405 and IsUnitEnemy(u,EraserIssuer)and IsUnitType(u,UNIT_TYPE_STRUCTURE)and GetPlayerId(GetOwningPlayer(u))<$C and GetUnitTypeId(u)!='hcas'
set u=null
return aX
endfunction
function nC takes nothing returns nothing
local real x
local real y
local unit c
set EraserIssuer=GetOwningPlayer(De)
call GroupEnumUnitsInRect(ErasingGroup,bj_mapInitialPlayableArea,Ka)
set bj_groupRandomCurrentPick=null
set bj_groupRandomCurrentPick=IX(ErasingGroup)
if(bj_groupRandomCurrentPick==null)then
return
endif
set x=GetUnitX(bj_groupRandomCurrentPick)
set y=GetUnitY(bj_groupRandomCurrentPick)
call DestroyEffect(AddSpecialEffect("Objects\\Spawnmodels\\Naga\\NagaDeath\\NagaDeath.mdl",GetUnitX(De),GetUnitY(De)))
set c=CreateUnit(EraserIssuer,'h04G',x,y,.0)
call UnitApplyTimedLife(c,'BTLF',1.)
set c=null
endfunction
function VC takes nothing returns nothing
local real x
local real y
local unit c
set EraserIssuer=GetOwningPlayer(De)
call GroupEnumUnitsInRect(ErasingGroup,bj_mapInitialPlayableArea,Ka)
set bj_groupRandomConsidered=0
set bj_groupRandomCurrentPick=null
set bj_groupRandomCurrentPick=IX(ErasingGroup)
if(bj_groupRandomCurrentPick==null)then
return
endif
set x=GetUnitX(bj_groupRandomCurrentPick)
set y=GetUnitY(bj_groupRandomCurrentPick)
call DestroyEffect(AddSpecialEffect("Objects\\Spawnmodels\\Naga\\NagaDeath\\NagaDeath.mdl",GetUnitX(De),GetUnitY(De)))
set c=CreateUnit(EraserIssuer,'h04H',x,y,.0)
call UnitApplyTimedLife(c,'BTLF',1.)
set c=null
endfunction
function EC takes nothing returns nothing
local integer i=0
local real x
local real y
local unit u
local unit c
loop
exitwhen i>=pa
set u=La[i]
set x=GetUnitX(u)+ma[i]
if(x>=Qa or x<=qa or GetWidgetLife(u)<.405)then
call RemoveUnit(u)
set pa=pa-1
set La[i]=La[pa]
else
set y=GetUnitY(u)+ma[i]*Sin(Ma[i])
if(y>1100.)then
set y=y-15.
elseif(y<-1100.)then
set y=y+15.
endif
set Ma[i]=Ma[i]+.03
call SetUnitX(u,x)
call SetUnitY(u,y)
if(GetRandomInt(0,'d')>94)then
set EraserIssuer=GetOwningPlayer(u)
call GroupEnumUnitsInRange(ErasingGroup,x,y,550.,li)
set bj_groupRandomConsidered=0
set bj_groupRandomCurrentPick=null
call ForGroup(ErasingGroup,function GroupPickRandomUnitEnum)
if(bj_groupRandomCurrentPick!=null)then
if(IsUnitType(bj_groupRandomCurrentPick,UNIT_TYPE_FLYING))then
set c=CreateUnit(GetOwningPlayer(De),'e008',GetUnitX(bj_groupRandomCurrentPick),GetUnitY(bj_groupRandomCurrentPick),.0)
call UnitAddAbility(c,'A082')
call UnitShareVision(bj_groupRandomCurrentPick,EraserIssuer,true)
call IssueTargetOrderById(c,$D007F,bj_groupRandomCurrentPick)
call UnitShareVision(bj_groupRandomCurrentPick,EraserIssuer,false)
call UnitApplyTimedLife(c,'BTLF',2.)
else
set c=CreateUnit(GetOwningPlayer(De),'e008',GetUnitX(bj_groupRandomCurrentPick),GetUnitY(bj_groupRandomCurrentPick),.0)
call UnitAddAbility(c,'A083')
call UnitShareVision(bj_groupRandomCurrentPick,EraserIssuer,true)
call IssueTargetOrderById(c,$D007F,bj_groupRandomCurrentPick)
call UnitShareVision(bj_groupRandomCurrentPick,EraserIssuer,false)
call UnitApplyTimedLife(c,'BTLF',2.)
set c=CreateUnit(GetOwningPlayer(De),'e008',GetUnitX(bj_groupRandomCurrentPick),GetUnitY(bj_groupRandomCurrentPick),.0)
call UnitAddAbility(c,'A04H')
call UnitShareVision(bj_groupRandomCurrentPick,EraserIssuer,true)
call IssueTargetOrderById(c,$D00CB,bj_groupRandomCurrentPick)
call UnitShareVision(bj_groupRandomCurrentPick,EraserIssuer,false)
call UnitApplyTimedLife(c,'BTLF',4.5)
endif
endif
endif
set i=i+1
endif
endloop
if(pa==0)then
call PauseTimer(la)
endif
set u=null
set c=null
endfunction
function XC takes nothing returns nothing
local unit u=De
local real x=GetUnitX(u)
local real y=GetUnitY(u)
local player p=GetOwningPlayer(u)
local integer an=1-PlayerForce[GetPlayerId(p)]*2
local integer i=0
local unit c
call SetUnitAnimation(u,"death")
call TriggerSleepAction(1.5)
call TimerStart(la,.06,true,function EC)
loop
set c=CreateUnit(p,'h08U',x,y,.0)
if(haveArtillery)then
call UnitRemoveAbility(c,'A080')
call UnitAddAbility(c,'A084')
endif
set La[pa]=c
set ma[pa]=GetRandomReal(18.,30.)*R2I(an)
set Ma[pa]=I2R(i-1)+GetRandomReal(-.36,.36)
set pa=pa+1
set i=i+1
exitwhen i>2
endloop
set c=null
call EnableWeatherEffect(Pa,true)
call TriggerSleepAction(3.7)
call SetUnitAnimation(u,"stand")
call TriggerSleepAction(2.6)
call EnableWeatherEffect(Pa,false)
set u=null
endfunction
function OC takes nothing returns boolean
call SetUnitVertexColor(ce,0,$A6,$FF,'s')
return false
endfunction
function RC takes nothing returns nothing
local unit c=CreateUnit(GetOwningPlayer(ge),'e008',GetUnitX(ge),GetUnitY(ge),.0)
call UnitAddAbility(c,'A05D')
call IssueImmediateOrderById(c,$D009F)
call UnitApplyTimedLife(c,'BTLF',1.)
set c=null
endfunction
function IC takes nothing returns nothing
local unit c=CreateUnit(GetOwningPlayer(ge),'e008',GetUnitX(ge),GetUnitY(ge),.0)
call UnitAddAbility(c,'A043')
call IssueTargetOrderById(c,$D0102,Ge)
call UnitApplyTimedLife(c,'BTLF',1.)
set c=null
endfunction
function AC takes nothing returns nothing
local unit c=CreateUnit(GetOwningPlayer(ge),'e008',GetUnitX(ge),GetUnitY(ge),.0)
call UnitAddAbility(c,'A05B')
call IssueImmediateOrderById(c,$D026C)
call UnitApplyTimedLife(c,'BTLF',1.)
set c=null
endfunction
function NC takes nothing returns nothing
call SetupSpecialBuildingAction('h047',function iC)
call SetupSpecialBuildingAction('h048',function nC)
call SetupSpecialBuildingAction('h03L',function VC)
call SetupSpecialBuildingAction('h03O',function XC)
call BuildingTrains('h049','n017')
call BuildingTrains('h04F','n018')
call BuildingTrains('h03W','n016')
call BuildingTrains('h03T','n012')
call BuildingTrains('h043','n013')
call BuildingTrains('h03S','n014')
call AttachRegister('h03S',function OC)
call BuildingTrains('h03K','n015')
call BuildingTrains('h03J','o00A')
call ZX('h03Q',750.)
call BuildingTrains('h03U','n011')
call BuildingTrains('h03I','n010')
call BuildingTrains('h076','n03A')
endfunction
function bC takes nothing returns nothing
call PrepareRaceBuildingSetup(4)
call SetupBuildingUpgrades('h049',.2,true,0)
call SetupBuildingUpgrades('h04F',.2,true,'h049')
call SetupBuildingUpgrades('h03W',.2,true,'h04F')
call SetupBuildingUpgrades('h03T',.2,true,0)
call SetupBuildingUpgrades('h043',.2,true,'h03T')
call SetupBuildingUpgrades('h03S',.2,true,0)
call SetupBuildingUpgrades('h03K',.2,true,0)
call SetupBuildingUpgrades('h03J',.2,true,'h03K')
call SetupBuildingUpgrades('h03U',.2,true,0)
call SetupBuildingUpgrades('h03I',.2,true,0)
call SetupBuildingUpgrades('h076',.2,true,'h03I')
call SetupBuildingUpgrades('h047',.12,false,0)
call SetupBuildingUpgrades('h03Q',.0,false,0)
call SetupBuildingUpgrades('h048',.09,false,0)
call SetupBuildingUpgrades('h03L',.09,false,'h048')
call SetupBuildingUpgrades('h03O',.09,false,0)
call SetupBuildingUpgrades('h008',.05,false,0)
endfunction
function BC takes nothing returns nothing
call RegisterSpell('n016','A05E',function RC)
call RegisterSpell('n013','A05C',function AC)
call RegisterSpell('n014','A044',function IC)
endfunction
function cC takes nothing returns nothing
    call NC()
    call bC()
    call BC()
    set ka=Filter(function rC)
    set Ka=Filter(function aC)
    set qa=GetRectMinX(bj_mapInitialPlayableArea)
    set Qa=GetRectMaxX(bj_mapInitialPlayableArea)
    set sa=GetRectMinY(bj_mapInitialPlayableArea)
    set Sa=GetRectMaxY(bj_mapInitialPlayableArea)
    set Pa=AddWeatherEffect(bj_mapInitialPlayableArea,'SNhs')
    call EnableWeatherEffect(Pa,false)
endfunction
function CC takes nothing returns boolean
local unit u=GetFilterUnit()
local boolean aX=GetWidgetLife(u)<.405 and IsUnitType(u,UNIT_TYPE_SAPPER)and not IsUnitType(u,UNIT_TYPE_UNDEAD)and not IsUnitType(u,UNIT_TYPE_MECHANICAL)
set u=null
return aX
endfunction
function dC takes player p,unit tu,integer DC returns nothing
local real hp=GetUnitState(tu,UNIT_STATE_MAX_LIFE)
local integer st
local unit su
local boolean r=GetRandomInt(0,99)<DC
local boolean r2=GetRandomInt(0,99)<DC
if(IsUnitType(tu,UNIT_TYPE_RANGED_ATTACKER))then
if(GetUnitState(tu,UNIT_STATE_MAX_MANA)>50.)then
if((hp>460. and r)or r2)then
set st='u003'
else
set st='u00A'
endif
else
if((hp>460. and r)or r2)then
set st='n01L'
else
set st='n00D'
endif
endif
else
if(((hp>840. and r)or r2)and(GetRandomInt(0,99)>60))then
set st='n01M'
elseif((hp>680. and r)or r2)then
if(GetRandomInt(0,99)<60)then
set st='u00B'
else
set st='n00C'
endif
else
set st='u002'
endif
endif
set su=CreateUnit(p,st,GetUnitX(tu),GetUnitY(tu),GetRandomReal(.0,360.))
call wI(su)
set su=null
endfunction
function fC takes unit u,real x,real y returns nothing
local unit c=CreateUnit(GetOwningPlayer(u),'e008',x,y,.0)
call UnitAddAbility(c,'A086')
call IssuePointOrderById(c,$D00FD,x,y)
call UnitApplyTimedLife(c,'BTLF',6.)
set c=null
endfunction
function FC takes nothing returns nothing
local timer t=GetExpiredTimer()
local integer id=GetHandleId(t)
local unit u=LoadUnitHandle(rx,'lich',id)
local unit tu
if(u!=null and GetWidgetLife(u)>.405)then
set id=GetRandomInt(0,99)
if(id<45)then
call GroupEnumUnitsInRange(ua,GetUnitX(u),GetUnitY(u),520.,ta)
set tu=FirstOfGroup(ua)
if(tu!=null and IssueTargetOrderById(u,$D00E5,tu))then
call dC(GetOwningPlayer(u),tu,30)
endif
elseif(id>60)then
set tu=LoadUnitHandle(rx,'lict',GetHandleId(u))
if(tu!=null and GetWidgetLife(tu)>.405)then
if(GetRandomInt(0,99)>60)then
call fC(u,GetUnitX(tu),GetUnitY(tu))
else
call IssueTargetOrderById(u,$D0207,tu)
endif
endif
endif
call TimerStart(t,3.3,false,function FC)
else
call PauseTimer(t)
call DestroyTimer(t)
endif
set t=null
set u=null
set tu=null
endfunction
function gC takes unit u returns nothing
local timer t=CreateTimer()
call SaveUnitHandle(rx,'lich',GetHandleId(t),u)
call TimerStart(t,2.,false,function FC)
set t=null
endfunction
function GC takes nothing returns nothing
local real x
local real y
call GroupEnumUnitsInRect(ErasingGroup,bj_mapInitialPlayableArea,ta)
set bj_groupRandomConsidered=0
set bj_groupRandomCurrentPick=null
call ForGroup(ErasingGroup,function GroupPickRandomUnitEnum)
if(bj_groupRandomCurrentPick==null)then
return
endif
set x=GetUnitX(bj_groupRandomCurrentPick)
set y=GetUnitY(bj_groupRandomCurrentPick)
call DestroyEffect(AddSpecialEffect("Abilities\\Spells\\Items\\AIam\\AIamTarget.mdl",x,y))
call dC(GetOwningPlayer(De),bj_groupRandomCurrentPick,2)
call RemoveUnit(bj_groupRandomCurrentPick)
endfunction
function hC takes nothing returns nothing
local real x
local real y
call GroupEnumUnitsInRect(ErasingGroup,bj_mapInitialPlayableArea,ta)
set bj_groupRandomConsidered=0
set bj_groupRandomCurrentPick=null
call ForGroup(ErasingGroup,function GroupPickRandomUnitEnum)
if(bj_groupRandomCurrentPick==null)then
return
endif
set x=GetUnitX(bj_groupRandomCurrentPick)
set y=GetUnitY(bj_groupRandomCurrentPick)
call DestroyEffect(AddSpecialEffect("Abilities\\Spells\\Items\\AIam\\AIamTarget.mdl",x,y))
call dC(GetOwningPlayer(De),bj_groupRandomCurrentPick,32)
call RemoveUnit(bj_groupRandomCurrentPick)
endfunction
function HC takes nothing returns nothing
local unit u
set EraserIssuer=GetOwningPlayer(De)
call GroupEnumUnitsInRect(ErasingGroup,bj_mapInitialPlayableArea,li)
set bj_groupRandomConsidered=0
set bj_groupRandomCurrentPick=null
call ForGroup(ErasingGroup,function GroupPickRandomUnitEnum)
if(bj_groupRandomCurrentPick==null)then
return
endif
if not eN(bj_groupRandomCurrentPick)then
call UnitDamageTarget(De,bj_groupRandomCurrentPick,50000.,true,false,ATTACK_TYPE_NORMAL,DAMAGE_TYPE_DEATH,WEAPON_TYPE_WHOKNOWS)
endif
call DestroyEffect(AddSpecialEffect("Abilities\\Spells\\Undead\\DeathCoil\\DeathCoilSpecialArt.mdl",GetUnitX(bj_groupRandomCurrentPick),GetUnitY(bj_groupRandomCurrentPick)))
set u=De
call SetUnitAnimation(u,"work")
call TriggerSleepAction(1.)
call SetUnitAnimation(u,"stand")
set u=null
endfunction
function jC takes nothing returns nothing
call BuildingTrains('h01K','u005')
call BuildingTrains('h04B','u009')
call BuildingTrains('h055','u00D')
call ZX('h01O',800.)
call BuildingTrains('h01T','n00E')
call SetupSpecialBuildingAction('h01P',function GC)
call SetupSpecialBuildingAction('h056',function hC)
call BuildingTrains('h01P','n00D')
call BuildingTrains('h056','n01L')
call BuildingTrains('h01N','h01U')
call BuildingTrains('h054','h05H')
call BuildingTrains('h01L','u001')
call BuildingTrains('h01S','u000')
call SetupSpecialBuildingAction('h00A',function HC)
call BuildingTrains('h01R','n00B')
call BuildingTrains('h04Z','n01K')
call BuildingTrains('h03M','u007')
endfunction
function JC takes nothing returns nothing
call PrepareRaceBuildingSetup(6)
call SetupBuildingUpgrades('h01K',.2,true,0) // h01K <- temple of bone
call SetupBuildingUpgrades('h04B',.2,true,'h01K') // h04B <- temple of necromancy
call SetupBuildingUpgrades('h055',.2,false,'h04B') // h055 <-- high citadel of necromancy
call SetupSiegeBuildingUpgrades('h01T',.18,true,0) // h01T <- slauter house
call SetupBuildingUpgrades('h01P',.12,true,0) // h01P <- skull pile
call SetupBuildingUpgrades('h056',.12,true,'h01P') // h056 <- skull shrine
call SetupBuildingUpgrades('h01N',.2,true,0) // h01N <- crypt
call SetupBuildingUpgrades('h054',.2,true,'h01N')
call SetupBuildingUpgrades('h01L',.2,true,0)
call SetupBuildingUpgrades('h01S',.2,true,0)
call SetupBuildingUpgrades('h01R',.2,true,0)
call SetupBuildingUpgrades('h04Z',.2,true,'h01R')
call SetupBuildingUpgrades('h03M',.2,true,'h04Z')
call SetupBuildingUpgrades('h01O',.0,false,0)
call SetupBuildingUpgrades('h00A',.09,false,0)
call SetupBuildingUpgrades('h01Q',.09,false,0)
call SetupBuildingUpgrades('h008',.05,false,0)
endfunction
function kC takes nothing returns nothing
endfunction
function KC takes nothing returns nothing
    local unit u=GetSummonedUnit()
    local integer tX=GetUnitTypeId(u)
    if(tX=='u004')then
    call wI(ReplaceUnitBJ(u,Ta[GetRandomInt(0,2)],2))
    elseif(tX=='u008')then
    call wI(ReplaceUnitBJ(u,Ta[GetRandomInt(0,6)],2))
    elseif(tX=='u00E')then
    set tX=GetRandomInt(0,7)
    if(tX==0)then
    set tX=7
    else
    set tX=GetRandomInt(3,6)
    endif
    call wI(ReplaceUnitBJ(u,Ta[tX],2))
    call UnitAddAbility(bj_lastReplacedUnit,'A088')
    call UnitAddAbility(bj_lastReplacedUnit,'A089')
    endif
    set u=null
endfunction
function lC takes unit k,unit d,integer uX returns nothing
local real x=GetUnitX(d)
local real y=GetUnitY(d)
call CreateUnit(GetOwningPlayer(k),uX,x,y,.0)
call RemoveUnit(d)
call DestroyEffect(AddSpecialEffect("Abilities\\Spells\\Items\\AIam\\AIamTarget.mdl",x,y))
endfunction
function LC takes nothing returns nothing
    local trigger t
    call jC()
    call JC()
    call kC()
    set ta=Filter(function CC)
    set Ta[0]='u002'
    set Ta[1]='n00D'
    set Ta[2]='u00A'
    set Ta[3]='n00C'
    set Ta[4]='u00B'
    set Ta[5]='n01L'
    set Ta[6]='u003'
    set Ta[7]='n01M'
    set t=CreateTrigger()
    call TriggerRegisterAnyUnitEventBJ(t,EVENT_PLAYER_UNIT_SUMMON)
    call TriggerAddAction(t,function KC)
endfunction
function mC takes nothing returns nothing
set IncreaseRound=-1
call TimerDialogDisplay(wa,false)
call DisplayTextToForce(bj_FORCE_ALL_PLAYERS,"Time is up and not all players have agreed. Extra rounds declined!")
endfunction
function IssueAgree takes integer issuePlayer returns nothing
    if(IncreaseRound==-1)then
    return
    endif
    if(PlayerNotAgree[issuePlayer])then
        set PlayerNotAgree[issuePlayer]=false
        set VotesStillNeeded=VotesStillNeeded-1
        if(VotesStillNeeded>0)then
            call DisplayTextToForce(bj_FORCE_ALL_PLAYERS,PlayerNames[issuePlayer]+" has agreed, "+I2S(VotesStillNeeded)+" more votes needed")
        else
            set Bx=Bx+(IncreaseRound)
            call PauseTimer(Ua)
            call TimerDialogDisplay(wa,false)
            call DisplayTextToForce(bj_FORCE_ALL_PLAYERS,"All players have agreed, number of rounds is increased by "+I2S(IncreaseRound))
            set Me=true
            call LA(true)
            set IncreaseRound=-1
        endif
        else
        call DisplayTextToPlayer(Player(issuePlayer),.0,.0,"You have already agreed!")
    endif
endfunction
function pC takes integer mO returns nothing
local integer i=0
if(mO<1 or mO>3)then
call DisplayTextToPlayer(Player(0),.0,.0,"Invalid number of rounds, must be between 1 and 3")
return
endif
set IncreaseRound=mO
set VotesStillNeeded=0
loop
if(GetPlayerController(Player(i))==MAP_CONTROL_USER and GetPlayerSlotState(Player(i))==PLAYER_SLOT_STATE_PLAYING and(IsPlayerInForce(Player(i),WesternForce)or IsPlayerInForce(Player(i),EasternForce)))then
set PlayerNotAgree[i]=true
set VotesStillNeeded=VotesStillNeeded+1
endif
set i=i+1
exitwhen i>$B
endloop
call TimerStart(Ua,30.,false,function mC)
call TimerDialogDisplay(wa,true)
call DisplayTimedTextToForce(bj_FORCE_ALL_PLAYERS,30.,"|cffC6FF00"+I2S(mO)+" Extra Rounds|r vote has been started. You have 30 seconds to agree to it by typing |cffFFFF00-agree|r. If all players agree, the number of wins for overall victory will be increased by "+I2S(mO))
endfunction
function PC takes nothing returns nothing
call TimerDialogDisplay(wa,false)
call TimerDialogSetTitle(wa,"Voting XR")
endfunction
function GetGameConfigString takes nothing returns string
    local string aX
    if(Za!=null)then
    return Za
    endif
    if(bx==1)then
    set aX=" -r"
    elseif(bx==2)then
    set aX=" -m"
    elseif(bx==3)then
    set aX=" -d"
    else
    set aX=" -p"
    endif
    if(Gx)then
    set aX=aX+("p")
    else
    set aX=aX+("r")
    endif
    set aX=aX+(I2S(Bx))
    if(cx==1)then
    set aX=aX+("-slt")
    elseif(cx==2)then
    set aX=aX+("-slb")
    endif
    if(Dx>0)then
    set aX=aX+"-fow"+I2S(Dx)
    elseif(Dx==0)then
    set aX=aX+("-nfow")
    endif
    if(IncomeTime!=10.)then
    set aX=aX+"-it"+R2SW(IncomeTime,2,1)
    endif
    if(EnableStreamingIncome)then
    set aX=aX+"-si"
    endif
    if(DuralRaceMode)then
    set aX=aX+("-du")
    endif
    if(haveAI)then
    set aX=aX+("-ai")
    endif
    if(haveArtillery)then
    set aX=aX+("-na")
    endif
    if(NoTreasureBox)then
    set aX=aX+("-ntb")
    endif
    if(NoBounty)then
    set aX=aX+("-nb")
    endif
    if(not HasSpecials)then
    set aX=aX+("-ns")
    endif
    if(not HaveItem)then
    set aX=aX+("-ni")
    endif
    if(not haveLegend)then
    set aX=aX+("-la")
    endif
    if(not HaveDS)then
    set aX=aX+("-nrs")
    endif
    if(UniqueRaceMode)then
    set aX=aX+("-ur")
    endif
    if(DominationMode)then
    set aX=aX+("-dom")
    endif
    if(NoAFK)then
    set aX=aX+("-dafk")
    endif
    if(TaxMode==1)then
    set aX=aX+("-nt")
    elseif(TaxMode==2)then
    set aX=aX+("-ht")
    endif
    if(LumberLimit>-1)then
    set aX=aX+"-ll"+I2S(LumberLimit)
    endif
    if(NumberOfBans>0)then
    set aX=aX+"-ban"+I2S(NumberOfBans)
    endif
    if(NumberOfBans<0)then
    set aX=aX+"-rban"+I2S(-NumberOfBans)
    endif
    if(Wx>0)then
    set aX=aX+"-mp"+I2S(Wx)
    endif
    if(zx>0)then
    set aX=aX+"-emp"+I2S(zx)
    endif
    if(CoinsEveryPeriod==$A)then
    set aX=aX+(aX+"-cc")
    elseif(CoinsEveryPeriod==1)then
    set aX=aX+("-co")
    endif
    if(RoundTimeLimit!=0)then
    if(RoundTimeLimit>0)then
    set aX=aX+"-glw"+I2S(RoundTimeLimit)
    else
    set aX=aX+"-gld"+I2S(IAbsBJ(RoundTimeLimit))
    endif
    endif
    if(not CagingMode)then
    set aX=aX+("-ca")
    endif
    if(EnableCastleGates)then
    set aX=aX+("-cg")
    endif
    if(qx)then
    set aX=aX+("-bs")
    endif
    if(Ix!=$FA)then
    set aX=aX+("-srg"+I2S(Ix))
    endif
    if(Ax!='}')then
    set aX=aX+("-srl"+I2S(Ax))
    endif
    if(Nx!=1)then
    set aX=aX+("-sru"+I2S(Nx))
    endif
    if(Zx>0)then
    set aX=aX+("-nfr"+I2S(Zx))
    endif
    set aX=aX+"-bal"+I2S(AutoBalanceVariation)
    set Za=aX
    return aX
endfunction
function PauseCommand takes nothing returns nothing
    set GamePausing=not GamePausing
    if(GamePausing)then
        call PauseTimer(gi)
    else
        call ResumeTimer(gi)
        if(SkippingModeWaiting)then
            call GameModeSelection()
        endif
    endif
endfunction
function Console_SpecControlSendsResume takes nothing returns nothing
    if(not GamePausing)then
        call ResumeTimer(gi)
        if(SkippingModeWaiting)then
            call GameModeSelection()
        endif
    endif
endfunction
function FillCommand takes player SC,integer tC returns nothing
local integer i=0
local player p
if(tC>6)then
set tC=6
endif
if(CountPlayersInForceBJ(WesternForce)+CountPlayersInForceBJ(EasternForce)+CountPlayersInForceBJ(EmptyForce)<tC*2)then
call DisplayTextToPlayer(SC,.0,.0,"Command [|c00ff0000Fill|r] coudn't be executed. There are small count of quota players.")
return
endif
loop
exitwhen CountPlayersInForceBJ(WesternForce)>=tC
set p=FindHostPlayer(true)
call ForceRemovePlayer(EmptyForce,p)
call ForceAddPlayer(WesternForce,p)
call CreateFogModifierRectBJ(true,p,FOG_OF_WAR_VISIBLE,nx)
set BuilderInitialPosition[GetPlayerId(p)]=GetInitialBuilderPos(true)
set PerPlayerForce[GetPlayerId(p)]=CreateForce()
call JoinAI(GetPlayerId(p))
set i=i+1
endloop
loop
exitwhen CountPlayersInForceBJ(EasternForce)>=tC
set p=FindHostPlayer(false)
call ForceRemovePlayer(EmptyForce,p)
call ForceAddPlayer(EasternForce,p)
call CreateFogModifierRectBJ(true,p,FOG_OF_WAR_VISIBLE,nx)
set BuilderInitialPosition[GetPlayerId(p)]=GetInitialBuilderPos(false)
set PerPlayerForce[GetPlayerId(p)]=CreateForce()
call JoinAI(GetPlayerId(p))
set i=i+1
endloop
call JX()
call DisplayTextToPlayer(SC,.0,.0,"There are added "+I2S(i)+" players.")
endfunction
function TC takes string s returns boolean
local integer i=S2I(s)
if(i<=0)then
return false
endif
set Bx=IMinBJ(i,6)
return true
endfunction
function uC takes string s returns boolean
if(s=="g")then
set Gx=true
return true
elseif(s=="r")then
set Gx=false
return true
endif
return false
endfunction
function UC takes integer t returns nothing
if(t<0)then
return
endif
if(t==0)then
if(Dx==-1)then
call DisplayTextToForce(bj_FORCE_ALL_PLAYERS,"|cff808080Deprecated activation of Permanent Fog of War has been encountered. Ignored.|r")
return
endif
set Dx=-1
call DisplayTextToForce(bj_FORCE_ALL_PLAYERS,"Permanent |cffC6FF00Fog of War|r has been chosen")
return
endif
set Dx=t
call DisplayTextToForce(bj_FORCE_ALL_PLAYERS,"|cffC6FF00Fog of War|r time has been set to |cffFFFF00"+I2S(t)+"|r seconds.")
endfunction
function wC takes nothing returns nothing
set Dx=0
call DisplayTextToForce(bj_FORCE_ALL_PLAYERS,"|cffC6FF00Fog of War|r has been removed. All map will be visible.")
endfunction
function Roll takes integer range returns nothing
    if(range==0)then
    call DisplayTextToForce(bj_FORCE_ALL_PLAYERS,I2S(GetRandomInt(0,99)))
    else
    call DisplayTextToForce(bj_FORCE_ALL_PLAYERS,I2S(GetRandomInt(0,range)))
    endif
endfunction
function YC takes integer p,integer tC returns nothing
if(tC==0)then
if(wE(p))then
call DisplayTextToPlayer(Player(p),.0,.0,"Your |cffC6FF00Personal Timer|r has been disabled")
else
call DisplayTextToPlayer(Player(p),.0,.0,"Your |cffC6FF00Personal Timer|r is already disabled!")
endif
return
endif
if(tC<4)then
call DisplayTextToPlayer(Player(p),.0,.0,"The value for Personal Timer must be more that |c00ff00003|r!")
return
endif
call uE(p,tC)
call DisplayTextToPlayer(Player(p),.0,.0,"Your |cffC6FF00Personal Timer|r has been started")
endfunction
function AtCommand takes integer PV returns nothing
set vo[PV]=not vo[PV]
if(vo[PV])then
call DisplayTextToPlayer(Player(PV),.0,.0,"|cffC6FF00Auto Training|r has been activated")
else
call DisplayTextToPlayer(Player(PV),.0,.0,"|cffC6FF00Auto Training|r has been deactivated")
endif
endfunction
function ZC takes string vd,integer tC returns nothing
if(vd=="g" or vd=="G")then
call DisplayTextToForce(bj_FORCE_ALL_PLAYERS,"|cffC6FF00Start Resources|r has been changed. The amount of start |c00ffdc00Gold|r is |cffFFFF00"+I2S(tC)+"|r.")
set Ix=tC
elseif(vd=="l" or vd=="L")then
call DisplayTextToForce(bj_FORCE_ALL_PLAYERS,"|cffC6FF00Start Resources|r has been changed. The amount of start |c0000c850Lumber|r is |cffFFFF00"+I2S(tC)+"|r.")
set Ax=tC
elseif(vd=="u" or vd=="U")then
call DisplayTextToForce(bj_FORCE_ALL_PLAYERS,"|cffC6FF00Start Resources|r has been changed. The amount of start |c008000ffLegendaries limit|r is |cffFFFF00"+I2S(tC)+"|r.")
set Nx=tC
else
call DisplayTextToPlayer(Player(0),.0,.0,"Resource [|c00ff0000"+vd+"|r] couldn't be identified.")
endif
endfunction
function ExecuteCommand takes string s,integer IssuePlayer returns nothing
    local player toPlayer
    if(StringLength(s)<=2)then
        return
    endif
    if(CommandAvailable and IssuePlayer==0 and SubString(s,1,3)=="na")then
        call EnableNoArtilleryMode(false)
    elseif(CommandAvailable and IssuePlayer==0 and SubString(s,1,3)=="ai")then
        call EnableAI(true)
    elseif(CommandAvailable and IssuePlayer==0 and SubString(s,1,3)=="co")then
        call EnableCoinMode()
    elseif(CommandAvailable and IssuePlayer==0 and SubString(s,1,3)=="cc")then
        call EnableCrazyCoinMode()
    elseif(CommandAvailable and IssuePlayer==0 and SubString(s,1,3)=="du")then
        call EnableDualRaceMode(true)
    elseif(CommandAvailable and IssuePlayer==0 and SubString(s,1,4)=="ntb")then
        call EnableNoTreasureBoxMode(false)
    elseif(CommandAvailable and IssuePlayer==0 and SubString(s,1,3)=="nb")then
        call EnableNoBountyMode(false)
    elseif(CommandAvailable and IssuePlayer==0 and SubString(s,1,3)=="ns")then
        call EnableNoSpecialsMode(false)
    elseif(CommandAvailable and IssuePlayer==0 and SubString(s,1,3)=="ni")then
        call EnableNoItemMode(false)
    elseif(CommandAvailable and IssuePlayer==0 and SubString(s,1,3)=="la")then
        call EnableNoLegendMode(false)
    elseif(CommandAvailable and IssuePlayer==0 and SubString(s,1,3)=="sr" and StringLength(s)>4)then
        call ZC(SubString(s,3,4),S2I(SubString(s,4,StringLength(s))))
    elseif(CommandAvailable and IssuePlayer==0 and SubString(s,1,4)=="nrs")then
        call EnableNoDevastatingStrikeMode(false)
    elseif(CommandAvailable and IssuePlayer==0 and SubString(s,1,3)=="ur")then
        call EnableUniqueRaceMode(true)
    elseif(CommandAvailable and IssuePlayer==0 and SubString(s,1,3)=="it")then
        call MO(S2R(SubString(s,3,StringLength(s))))
    elseif(CommandAvailable and IssuePlayer==0 and SubString(s,1,3)=="si")then
        set EnableStreamingIncome=true
        set IncomeRate=1./ IncomeTime
        call DisplayTextToForce(bj_FORCE_ALL_PLAYERS,"|cffC6FF00Streaming Income|r has been enabled|r.")
    elseif(CommandAvailable and IssuePlayer==0 and SubString(s,1,4)=="glw")then
        call UO(S2I(SubString(s,4,StringLength(s))))
    elseif(CommandAvailable and IssuePlayer==0 and SubString(s,1,4)=="gld")then
        call UO(-1*S2I(SubString(s,4,StringLength(s))))
    elseif((not CommandAvailable)and IssuePlayer==0 and SubString(s,1,3)=="xr")then
        call pC(S2I(SubString(s,3,StringLength(s))))
    elseif(CommandAvailable and IssuePlayer==0 and SubString(s,1,3)=="mp")then
        call uO(S2I(SubString(s,3,StringLength(s))))
    elseif(CommandAvailable and IssuePlayer==0 and SubString(s,1,4)=="emp")then
        call TO(S2I(SubString(s,4,StringLength(s))))
    elseif(CommandAvailable and IssuePlayer==0 and SubString(s,1,3)=="ll")then
        call EnableLumberLimitMode(S2I(SubString(s,3,StringLength(s))))
    elseif(CommandAvailable and IssuePlayer==0 and SubString(s,1,3)=="ht")then
        call SetTax(2)
    elseif(CommandAvailable and IssuePlayer==0 and SubString(s,1,3)=="nt")then
        call SetTax(1)
    elseif(CommandAvailable and IssuePlayer==0 and SubString(s,1,3)=="ca")then
        call EnableCagingMode(false)
    elseif(CommandAvailable and IssuePlayer==0 and SubString(s,1,3)=="cg")then
        set EnableCastleGates=true
        call DisplayTextToForce(bj_FORCE_ALL_PLAYERS,"|cffC6FF00Castle gates|r have been enabled. You can control castle gates.")
    elseif(CommandAvailable and IssuePlayer==0 and SubString(s,1,4)=="dom")then
        call EnableDominationMode(true)
    elseif(CommandAvailable and IssuePlayer==0 and SubString(s,1,4)=="fow")then
        call UC(S2I(SubString(s,4,StringLength(s))))
    elseif(CommandAvailable and IssuePlayer==0 and SubString(s,1,5)=="nfow")then
        call wC()
    elseif(CommandAvailable and IssuePlayer==0 and SubString(s,1,5)=="rban")then
        call enableRandomBanRaceMode(S2I(SubString(s,5,StringLength(s))))
    elseif(CommandAvailable and IssuePlayer==0 and SubString(s,1,4)=="ban")then
        call enableBanRaceMode(S2I(SubString(s,4,StringLength(s))))
    elseif(CommandAvailable and IssuePlayer==0 and SubString(s,1,4)=="bal")then
        call EnableAutoBalance(S2I(SubString(s,4,StringLength(s))))
    elseif(CommandAvailable and IssuePlayer==0 and SubString(s,1,3)=="bs")then
        set qx=true
    elseif(CommandAvailable and IssuePlayer==0 and SubString(s,1,4)=="nfr")then
        call wO(S2I(SubString(s,4,StringLength(s))))
    elseif(CommandAvailable and IssuePlayer==0 and SubString(s,1,5)=="fill")then
        call FillCommand(Player(IssuePlayer),S2I(SubString(s,5,StringLength(s))))
    elseif(CommandAvailable and IssuePlayer==0 and SubString(s,1,5)=="dafk")then
        call EnableNoAFKMode(true)
    elseif(CommandAvailable and IssuePlayer==0 and SubString(s,1,6)=="pause")then
        call PauseCommand()
    elseif(CommandAvailable and IssuePlayer==0 and SubString(s,1,5)=="skip")then
        if(GamePausing)then
            set SkippingModeWaiting=true
        else
            call GameModeSelection()
        endif
    elseif(CommandAvailable and IssuePlayer==0 and SubString(s,1,2)=="r" and uC(SubString(s,2,3))and TC(SubString(s,3,4)))then
        set bx=1
        set Rx="QA"
        call LA(true)
    elseif(CommandAvailable and IssuePlayer==0 and SubString(s,1,2)=="p" and uC(SubString(s,2,3))and TC(SubString(s,3,4)))then
        set bx=0
        set Rx="qA"
        call LA(true)
    elseif(CommandAvailable and IssuePlayer==0 and SubString(s,1,2)=="m" and uC(SubString(s,2,3))and TC(SubString(s,3,4)))then
        set bx=2
        set Rx="xd"
        call LA(true)
    elseif(CommandAvailable and IssuePlayer==0 and SubString(s,1,2)=="d" and uC(SubString(s,2,3))and TC(SubString(s,3,4)))then
        set bx=3
        set Rx="od"
        call LA(true)
    elseif(SubString(s,1,6)=="stats" and not CommandAvailable)then
        call ShowStat(Player(IssuePlayer))
    elseif(SubString(s,1,4)=="afk" and(not CommandAvailable)and not NoAFK)then
        call GoAFK(IssuePlayer)
    elseif(SubString(s,1,3)=="at")then
        call AtCommand(IssuePlayer)
    elseif(SubString(s,1,5)=="mode" and(not CommandAvailable))then
        call DisplayTimedTextToPlayer(Player(IssuePlayer),.0,.0,10.,"|cffFFFF00Game-config-string|r:")
        call DisplayTimedTextToPlayer(Player(IssuePlayer),.0,.0,10.,GetGameConfigString())
    elseif(SubString(s,1,7)=="income" and not CommandAvailable)then
        call CheckIncome(Player(IssuePlayer))
    elseif(SubString(s,1,6)=="armor")then
        set toPlayer=Player(IssuePlayer)
        call DisplayTimedTextToPlayer(toPlayer,.0,.0,10.,"|cffFFFF00Armor table:")
        call DisplayTimedTextToPlayer(toPlayer,.0,.0,10.,"|cffFFCC00Chaos damage:    |cffFFFF00neutral against all|r")
        call DisplayTimedTextToPlayer(toPlayer,.0,.0,10.,"|cffFFCC00Normal damage: |cff00FF00good against:|r medium |cffFF0000bad against:|r light")
        call DisplayTimedTextToPlayer(toPlayer,.0,.0,10.,"|cffFFCC00Pierce damage:   |cff00FF00good against:|r light        |cffFF0000bad against:|r heavy")
        call DisplayTimedTextToPlayer(toPlayer,.0,.0,10.,"|cffFFCC00Magic damage:   |cff00FF00good against:|r heavy      |cffFF0000bad against:|r medium")
        call DisplayTimedTextToPlayer(toPlayer,.0,.0,10.,"|cffFFCC00Siege damage:     |cff00FF00good against:|r fortified |cffFF0000bad against:|r all others")
        call DisplayTimedTextToPlayer(toPlayer,.0,.0,10.,"|cffFFCC00Note:|r All attack types are |cffFF0000bad|r against divine besides chaos!")
    elseif(IssuePlayer==0 and SubString(s,1,5)=="roll")then
        call Roll(S2I(SubString(s,5,StringLength(s))))
    elseif(SubString(s,1,5)=="draw")then
        call IssueDraw(IssuePlayer)
    elseif(SubString(s,1,5)=="nuke")then
        call IssueNuke(IssuePlayer)
    elseif(SubString(s,1,$A)=="surrender")then
        call IssueSurrender(IssuePlayer)
    elseif(SubString(s,1,3)=="mt")then
        call YC(IssuePlayer,S2I(SubString(s,3,StringLength(s))))
    elseif(SubString(s,1,6)=="agree")then
        call IssueAgree(IssuePlayer)
    else
    call DisplayTextToPlayer(Player(IssuePlayer),.0,.0,"Command [|c00ff0000"+SubString(s,1,StringLength(s))+"|r] coudn't be executed. You are not allowed to use it or syntax is wrong.")
    endif
endfunction
function HyphenBegins takes nothing returns boolean
    return SubString(GetEventPlayerChatString(),0,1)=="-"
endfunction
function HandleCommand takes nothing returns nothing
    local string nd=GetEventPlayerChatString()
    local string s=StringCase(nd,false)
    local integer Vd=0
    local integer Ed=0
    local integer Xd=StringLength(s)
    local integer i=0
    local integer id=GetPlayerId(GetTriggerPlayer())
    local string ch
    loop
    set ch=SubString(s,i,i+1)
    if ch=="-" then
    if Vd!=i then
    if Ed>0 then
    call ExecuteCommand(SubString(s,Vd,Ed)+SubString(nd,Ed,i),id)
    else
    call ExecuteCommand(SubString(s,Vd,i),id)
    endif
    endif
    set Vd=i
    set Ed=0
    elseif Ed==0 and ch==" " then
    set Ed=i
    endif
    set i=i+1
    exitwhen i>=Xd
    endloop
    if Ed>0 then
    call ExecuteCommand(SubString(s,Vd,Ed)+SubString(nd,Ed,i),id)
    else
    call ExecuteCommand(SubString(s,Vd,i),id)
    endif
endfunction
function Od takes nothing returns nothing
    local trigger t=CreateTrigger()
    call PauseTimer(GetExpiredTimer())
    call DestroyTimer(GetExpiredTimer())
    call TriggerRegisterPlayerChatEvent(t,Player(0),"-",false)
    call TriggerRegisterPlayerChatEvent(t,Player(1),"-",false)
    call TriggerRegisterPlayerChatEvent(t,Player(2),"-",false)
    call TriggerRegisterPlayerChatEvent(t,Player(3),"-",false)
    call TriggerRegisterPlayerChatEvent(t,Player(4),"-",false)
    call TriggerRegisterPlayerChatEvent(t,Player(5),"-",false)
    call TriggerRegisterPlayerChatEvent(t,Player(6),"-",false)
    call TriggerRegisterPlayerChatEvent(t,Player(7),"-",false)
    call TriggerRegisterPlayerChatEvent(t,Player(8),"-",false)
    call TriggerRegisterPlayerChatEvent(t,Player(9),"-",false)
    call TriggerRegisterPlayerChatEvent(t,Player($A),"-",false)
    call TriggerRegisterPlayerChatEvent(t,Player($B),"-",false)
    call TriggerAddCondition(t,Condition(function HyphenBegins))
    call TriggerAddAction(t,function HandleCommand)
    set t=null
endfunction
function SetupCommandDetect takes nothing returns nothing
    call TimerStart(CreateTimer(),.2,false,function Od)
endfunction
function Id takes unit v returns nothing
local unit dN
if(GetRandomInt(0,99)<$F)then
set dN=CreateUnit(GetOwningPlayer(v),'e008',GetUnitX(v),GetUnitY(v),.0)
call UnitAddAbility(dN,'A0B7')
call IssueTargetOrderById(dN,$D0062,v)
call UnitApplyTimedLife(dN,'BTLF',2.)
set dN=CreateUnit(GetOwningPlayer(v),'e008',GetUnitX(v),GetUnitY(v),.0)
call UnitAddAbility(dN,'A0B5')
call IssueTargetOrderById(dN,$D0085,v)
call UnitApplyTimedLife(dN,'BTLF',2.)
set dN=null
endif
endfunction
function Ad takes unit v returns nothing
local unit dN
if(GetRandomInt(0,99)<20)then
set dN=CreateUnit(GetOwningPlayer(v),'e008',GetUnitX(v),GetUnitY(v),.0)
call UnitAddAbility(dN,'A0B8')
call IssueTargetOrderById(dN,$D0062,v)
call UnitApplyTimedLife(dN,'BTLF',2.)
set dN=CreateUnit(GetOwningPlayer(v),'e008',GetUnitX(v),GetUnitY(v),.0)
call UnitAddAbility(dN,'A0B6')
call IssueTargetOrderById(dN,$D0085,v)
call UnitApplyTimedLife(dN,'BTLF',2.)
set dN=null
endif
endfunction
function Nd takes nothing returns nothing
local unit u=GetEnumUnit()
call UnitRemoveBuffsEx(u,true,false,true,false,false,false,false)
call DestroyEffect(AddSpecialEffectTarget("Abilities\\Spells\\Human\\MarkOfChaos\\MarkOfChaosDone.mdl",u,"overhead"))
set u=null
endfunction
function bd takes unit s,unit u returns nothing
local integer Bd=GetUnitLevel(u)
local unit dN
if(IsUnitType(s,UNIT_TYPE_MELEE_ATTACKER)and GetRandomInt(0,99)<=$F*Bd)then
set dN=CreateUnit(GetOwningPlayer(u),'e008',GetUnitX(u),GetUnitY(u),.0)
call UnitAddAbility(dN,'A0D5')
call SetUnitAbilityLevel(dN,'A0D5',Bd)
call IssueTargetOrderById(dN,$D007F,s)
call UnitApplyTimedLife(dN,'BTLF',2.)
set dN=null
endif
endfunction
function cd takes nothing returns nothing
local unit u=GetTriggerUnit()
local unit t=GetEventTargetUnit()
local integer ut=GetUnitTypeId(u)
if(ut=='u00D')then
call SaveUnitHandle(rx,'lict',GetHandleId(u),t)
elseif(ut=='n02T' and not IsUnitType(u,UNIT_TYPE_STRUCTURE))then
if(IssueImmediateOrderById(u,$D00A1))then
call TriggerSleepAction(.1)
call IssuePointOrderById(u,$D0012,GetUnitX(u)+GetRandomReal(-50.,50.),GetUnitY(u)+GetRandomReal(-120.,120.))
call TriggerSleepAction(GetRandomReal(.3,.6))
call IssueTargetOrderById(u,$D000F,t)
endif
else
call IssueTargetOrderById(u,$D000F,t)
endif
set u=null
set t=null
endfunction
function Cd takes nothing returns nothing
local unit s=GetEventDamageSource()
local unit u=GetTriggerUnit()
local integer dd
if(LoadInteger(rx,'DCTm',GetHandleId(u))>Ze)then
set s=null
set u=null
return
endif
if(GetWidgetLife(u)>.405)then
set dd=GetUnitTypeId(u)
if(dd=='n029')then
call Id(u)
elseif(dd=='n02B')then
call Ad(u)
elseif(GetUnitAbilityLevel(u,'A0DX')>0)then
call bd(GetEventDamageSource(),u)
endif
call SaveInteger(rx,'DCTm',GetHandleId(u),Ze+1)
endif
set u=null
set s=null
endfunction
function Dd takes nothing returns nothing
    if(en!=null)then
    call TriggerClearActions(en)
    call DestroyTrigger(en)
    endif
    set en=CreateTrigger()
    call TriggerAddAction(en,function Cd)
    if(xn!=null)then
    call TriggerClearActions(xn)
    call DestroyTrigger(xn)
    endif
    set xn=CreateTrigger()
    call TriggerAddAction(xn,function cd)
endfunction
function Fd takes nothing returns boolean
local unit u=GetTriggerUnit()
local integer gd
if(u!=null)then
set gd=GetIssuedOrderId()
if(GetUnitTypeId(u)=='h001' and gd==0)then
call NB(u)
elseif(gd==$D0003)then
set rn[GetPlayerId(GetOwningPlayer(u))]=Ye
if(IsUnitType(u,UNIT_TYPE_SAPPER))then
call WI(u)
endif
endif
set u=null
endif
return false
endfunction
function Gd takes nothing returns nothing
if(on!=null)then
return
endif
set on=CreateTrigger()
call TriggerRegisterAnyUnitEventBJ(on,EVENT_PLAYER_UNIT_ISSUED_TARGET_ORDER)
call TriggerRegisterAnyUnitEventBJ(on,EVENT_PLAYER_UNIT_ISSUED_POINT_ORDER)
call TriggerAddCondition(on,Condition(function Fd))
endfunction
function AFKDetect takes nothing returns nothing
local integer i=0
local player p
loop
set p=Player(i)
if(GetPlayerSlotState(p)==PLAYER_SLOT_STATE_PLAYING and GetPlayerController(p)==MAP_CONTROL_USER and not Vr[i])then
if(Ye-rn[i]>4)then
call DisplayTextToPlayer(Player(i),.0,.0,"|cffCA0000WARNING|r: You did not move your worker for 5 minutes. AI will take control in 60 seconds!")
if(Ye-rn[i]>5)then
call GoAFK(i)
endif
endif
endif
set i=i+1
exitwhen i>$B
endloop
endfunction
function Hd takes nothing returns nothing
if(AFKTimer!=null)then
call PauseTimer(AFKTimer)
endif
endfunction
function jd takes nothing returns nothing
    local integer i=0
    loop
        set rn[i]=0
        set i=i+1
        exitwhen i>$B
    endloop
    if(AFKTimer!=null)then
    call TimerStart(AFKTimer,60.,true,function AFKDetect)
    endif
endfunction
function SetupAFKTimer takes nothing returns nothing
    if(AFKTimer==null)then
        set AFKTimer=CreateTimer()
    endif
endfunction
function Victory takes nothing returns nothing
    call CustomVictoryBJ(GetEnumPlayer(),true,true)
endfunction
function Defeated takes nothing returns nothing
    call CustomDefeatBJ(GetEnumPlayer(),"You were defeated!")
endfunction
function EndRoundScenario___RemovePersonal takes nothing returns nothing
call RemoveUnit(GetEnumUnit())
endfunction
function EndRoundScenario___HidenKillPersonal takes nothing returns nothing
local unit u=GetEnumUnit()
call ShowUnit(u,false)
call KillUnit(u)
call RemoveUnit(u)
set u=null
endfunction
function ld takes nothing returns nothing
call RemoveItem(GetEnumItem())
endfunction
function RestartRound takes nothing returns nothing
    local integer i=0
    local integer j=0
    local unit u
    set RoundRunning=false
    set mr=true
    call WE(false)
    call Hd()
    call FogEnable(false)
    call PauseTimer(Mi)
    call PauseTimer(pi)
    call PauseTimer(IncomeTimer)
    call PauseTimer(ye)
    call vE(false)
    call DestroyFogModifier(bn)
    call DestroyFogModifier(Bn)
    call TriggerClearActions(Vn)
    call DestroyTrigger(Vn)
    call TriggerClearActions(En)
    call DestroyTrigger(En)
    call DisplayTextToForce(bj_FORCE_ALL_PLAYERS,"The Score is |cffFF0000West|r: |cffFFCC00"+I2S(eo[0])+" |cff00FF00East|r:|cffFFCC00 "+I2S(eo[1])+"|r. Number of wins for overall victory: |cffFFCC00"+I2S(Bx)+"|r")
    call IA()
    call ME()
    call TriggerSleepAction(4.)
    call CinematicFadeBJ(1,2,"ReplaceableTextures\\CameraMasks\\Black_mask.blp",0,0,0,6.)
    call TriggerSleepAction(2.)
    set Ox=false
    set VV=false
    call DisableTrigger(eV)
    loop
    loop
    call GroupEnumUnitsOfPlayer(ErasingGroup,Player(j),DrawFilter)
    loop
    set u=FirstOfGroup(ErasingGroup)
    exitwhen(u==null)
    call RemoveUnit(u)
    call GroupRemoveUnit(ErasingGroup,u)
    endloop
    set i=i+1
    call TriggerSleepAction(.02)
    exitwhen i>=4
    endloop
    set io[j]=0
    set oo[j]=0
    set j=j+1
    exitwhen(j>$C)
    endloop
    call EnableTrigger(eV)
    set VV=true
    call FlushChildHashtable(rx,'incm')
    call FlushChildHashtable(rx,'CaTm')
    call FlushChildHashtable(rx,'ASTR')
    call FlushChildHashtable(rx,'SyUn')
    set Ha[0]=0
    set Ha[1]=0
    call EnumItemsInRect(me,null,function ld)
    if(Rn>0)then
    call TriggerSleepAction(11.)
    if(Rn==2)then
    call ForForce(WesternForce,function Victory)
    call ForForce(EasternForce,function Defeated)
    else
    call ForForce(EasternForce,function Victory)
    call ForForce(WesternForce,function Defeated)
    endif
    else
    call DisplayTimedTextToForce(bj_FORCE_ALL_PLAYERS,10.,"Preparing for new round...")
    call TriggerSleepAction(7.)
    call TriggerExecute(Nn)
    endif
endfunction
function DrawFilterFunction takes nothing returns boolean
    local unit u=GetFilterUnit()
    local boolean canDraw=GetPlayerId(GetOwningPlayer(u))<=$C and GetUnitAbilityLevel(u,'A02E')<1
    set u=null
    return canDraw
endfunction
function WesternCastleDeath takes nothing returns nothing
    if(not RoundRunning)then
    return
    endif
    set eo[1]=eo[1]+1
    call AO(5,2,I2S(eo[1]))
    call DisplayTextToForce(bj_FORCE_ALL_PLAYERS,"|cff00FF00Eastern Forces|r have won the round!")
    if(eo[1]>=Bx)then
    call DisplayTextToForce(bj_FORCE_ALL_PLAYERS,"|cffFFFF00Congratulations! |cff00FF00Eastern Forces|r|cffFFFF00 have won the match! Game ends in one minute.|r")
    set Rn=1
    set Xx=true
    call SaveLog()
    endif
    call RestartRound()
endfunction
function EasternCastleDeath takes nothing returns nothing
if(not RoundRunning)then
return
endif
set eo[0]=eo[0]+1
call AO(5,1,I2S(eo[0]))
call DisplayTextToForce(bj_FORCE_ALL_PLAYERS,"|cffFF0000Western Forces|r have won the round!")
if(eo[0]>=Bx)then
call DisplayTextToForce(bj_FORCE_ALL_PLAYERS,"|cffFFFF00Congratulations! |cffFF0000Western Forces|r|cffFFFF00 have won the match! Game ends in one minute.|r")
set Rn=2
set Xx=true
call SaveLog()
endif
call RestartRound()
endfunction
function DrawTriggerHandle takes nothing returns nothing
    if(not RoundRunning)then
    return
    endif
    call DisplayTextToForce(bj_FORCE_ALL_PLAYERS,"|cffFFAC00All players have voted for a draw, round will restart!|r")
    call RestartRound()
endfunction
function CreateDrawTrigger takes nothing returns nothing
    set DrawFilter=Filter(function DrawFilterFunction)
    set DrawTrigger=CreateTrigger()
    call TriggerAddAction(DrawTrigger,function DrawTriggerHandle)
endfunction
function Qd takes nothing returns nothing
    call FogEnable(false)
    set Ox=true
endfunction
function sd takes integer Sd returns nothing
local integer p
local real x=-3650.
local unit u
if(Sd==0)then
set p=0
else
set p=6
set x=0-x
endif
set u=CreateUnit(Player(p),'h06A',x,.0,.0)
call SetUnitAnimation(u,"stand alternate")
set Ro[Sd+2]=u
call SetUnitInvulnerable(u,true)
set u=CreateUnit(Player(p),'h068',x,.0,.0)
call SetUnitAnimation(u,"stand alternate")
call ShowUnit(u,false)
set Ro[Sd]=u
set u=null
endfunction
function td takes integer Sd,string s returns nothing
if(Sd==0)then
call DisplayTextToForce(WesternForce,s)
else
call DisplayTextToForce(EasternForce,s)
endif
endfunction
function Td takes integer Sd returns nothing
local unit u=Ro[Sd]
local real hp=GetWidgetLife(u)
local real mp
local string s
if(hp<.405 or Ao[Sd])then
set u=null
return
endif
if(Io[Sd]<1.)then
set Ao[Sd]=true
call SetUnitAnimation(u,"stand alternate")
call StartSound(cn)
call TriggerSleepAction(2.2)
set hp=GetWidgetLife(u)
call ShowUnit(u,false)
set u=Ro[Sd+2]
call SetUnitState(u,UNIT_STATE_LIFE,hp)
call SetUnitState(u,UNIT_STATE_MANA,GetUnitState(Ro[Sd],UNIT_STATE_MANA))
call ShowUnit(u,true)
call td(Sd,"|cffFFCC00The Gates|r are opened!")
set Io[Sd]=1.
set Ao[Sd]=false
elseif(GetUnitState(Ro[Sd+2],UNIT_STATE_MANA)>80.)then
set Ao[Sd]=true
set hp=GetWidgetLife(Ro[Sd+2])
call ShowUnit(Ro[Sd+2],false)
call ShowUnit(u,true)
call SetUnitState(u,UNIT_STATE_LIFE,hp)
call SetUnitAnimation(u,"birth")
set Io[Sd]=.3
call StartSound(cn)
call SetUnitState(u,UNIT_STATE_MANA,GetUnitState(Ro[Sd+2],UNIT_STATE_MANA))
call TriggerSleepAction(5.)
call td(Sd,"|cffFFCC00The Gates|r are closed!")
set Ao[Sd]=false
loop
call TriggerSleepAction(1.)
set hp=GetWidgetLife(u)
if(GetUnitState(u,UNIT_STATE_MANA)<10.)then
call Td(Sd)
exitwhen true
endif
exitwhen(hp<.405)or Ao[Sd]
endloop
endif
set u=null
endfunction
function StartGame takes nothing returns nothing
    local integer i
    local unit u
    local player westernRandomPlayer
    local player easternRandomPlayer
    local real incomeTime
    local boolean Ud=false
    set Round=Round+1
    set ex=-1
    set xx=0
    call Log("Round: "+I2S(Round))
    call FogEnable(true)
    set westernRandomPlayer=ForcePickRandomPlayer(WesternForce)
    set easternRandomPlayer=ForcePickRandomPlayer(EasternForce)
    if(Round==1)then
        call FillAI()
    endif
    if(westernRandomPlayer==null)then
        set westernRandomPlayer=Player(0)
    endif
    if(easternRandomPlayer==null)then
        set easternRandomPlayer=Player(6)
        if(Round==1)then
            call ForceRemovePlayer(EmptyForce,easternRandomPlayer)
            call ForceAddPlayer(EasternForce,easternRandomPlayer)
            call CreateFogModifierRectBJ(true,easternRandomPlayer,FOG_OF_WAR_VISIBLE,nx)
            set BuilderInitialPosition[6]=GetInitialBuilderPos(false)
            set PerPlayerForce[6]=CreateForce()
            call JoinAI(6)
        endif
    endif
    call hA()
    call CA()
    call DisplayTimedTextToForce(bj_FORCE_ALL_PLAYERS,9.5,"Get ready for round |cffFFCC00"+I2S(Round)+"|r!")
    call CinematicFadeBJ(0,4.,"ReplaceableTextures\\CameraMasks\\Black_mask.blp",0,0,0,6.)
    set bn=CreateFogModifierRectBJ(true,ForcePickRandomPlayer(WesternForce),FOG_OF_WAR_VISIBLE,EasternBuildArea)
    set Bn=CreateFogModifierRectBJ(true,ForcePickRandomPlayer(EasternForce),FOG_OF_WAR_VISIBLE,WesternBuildArea)
    set Vn=CreateTrigger()
    set En=CreateTrigger()
    set MainCastle[0]=CreateUnitAtLoc(westernRandomPlayer,'hcas',xo[1],270.)
    call TriggerRegisterUnitEvent(Pr,MainCastle[0],EVENT_UNIT_ATTACKED)
    call SetUnitX(MainCastle[0],GetLocationX(xo[1]))
    call SetUnitY(MainCastle[0],GetLocationY(xo[1]))
    call SetUnitColor(MainCastle[0],PLAYER_COLOR_RED)
    if(not HaveItem)then
        call UnitRemoveAbility(MainCastle[0],'Aall')
        call UnitRemoveAbility(MainCastle[0],'Apit')
    endif
    call TriggerRegisterDeathEvent(Vn,MainCastle[0])
    set MainCastle[1]=CreateUnitAtLoc(easternRandomPlayer,'hcas',xo[0],270.)
    call TriggerRegisterUnitEvent(Pr,MainCastle[1],EVENT_UNIT_ATTACKED)
    call SetUnitX(MainCastle[1],GetLocationX(xo[0]))
    call SetUnitY(MainCastle[1],GetLocationY(xo[0]))
    call SetUnitColor(MainCastle[1],PLAYER_COLOR_GREEN)
    if(not HaveItem)then
        call UnitRemoveAbility(MainCastle[1],'Aall')
        call UnitRemoveAbility(MainCastle[1],'Apit')
    endif
    call TriggerRegisterDeathEvent(En,MainCastle[1])
    call TriggerAddAction(Vn,function WesternCastleDeath)
    call TriggerAddAction(En,function EasternCastleDeath)
    if(DominationMode)then
        call SetupDomination()
    endif
    call TriggerSleepAction(3.)
    call nX()
    call PE()
    call Dd()
    call UnitShareVision(MainCastle[0],easternRandomPlayer,true)
    call UnitShareVision(MainCastle[1],westernRandomPlayer,true)
    call TriggerSleepAction(1.)
    call UnitShareVision(MainCastle[0],easternRandomPlayer,false)
    call UnitShareVision(MainCastle[1],westernRandomPlayer,false)
    call Gd()
    if(not Gx or Round==1)then
    if(not NoAFK)then
        call SetupAFKTimer()
    endif
    call mR()
    if(NumberOfBans!=0)then
    if(NumberOfBans>0)then
    call ExecuteFunc("wd")
    else
    call ExecuteFunc("Wd")
    endif
    loop
    call TriggerSleepAction(.5)
    exitwhen An
    endloop
    set An=false
    endif
    set i=0
    loop
    set No[i]=0
    set i=i+1
    exitwhen i>$B
    endloop
    call LR()
    call ExecuteFunc(Rx)
    loop
    call TriggerSleepAction(.5)
    exitwhen An
    endloop
    set An=false
    call DisableTrigger(zo)
    endif
    set Vo[0]=0
    set Vo[1]=0
    set Eo[0]=0
    set Eo[1]=0
    set Xo[0]=0
    set Xo[1]=0
    set i=0
    loop
    if(No[i]!=0)then
    call DestroyEffect(AddSpecialEffectLoc("Abilities\\Spells\\Human\\Resurrect\\ResurrectTarget.mdl",BuilderInitialPosition[i]))
    call Log(I2S(i)+": "+cR(No[i]))
    endif
    set i=i+1
    exitwhen i>$B
    endloop
    call TriggerSleepAction(.5)
    set i=0
    loop
    if(No[i]!=0)then
    if(No[i]=='h00C')then
    set Ud=true
    endif
    set u=CreateUnitAtLoc(Player(i),No[i],BuilderInitialPosition[i],180.*PlayerForce[i])
    set Io[0]=.99
    set Io[1]=.99
    if(EnableCastleGates)then
    call UnitAddAbility(u,'A07C')
    if(i==0)then
    call sd(0)
    elseif(i==6)then
    call sd(1)
    endif
    endif
    if(qx)then
    if(i==0)then
    call CreateItemLoc('I001',BuilderInitialPosition[0])
    elseif(i==6)then
    call CreateItemLoc('I001',BuilderInitialPosition[6])
    endif
    endif
    if(not HaveDS)then
    call UnitRemoveAbility(u,'A005')
    call UnitRemoveAbility(u,'A06E')
    else
    set Vo[PlayerForce[i]]=Vo[PlayerForce[i]]+1
    call NO(te[i],PlayerForce[i]*6+1,"V")
    endif
    call PanCameraToTimedLocForPlayer(Player(i),BuilderInitialPosition[i],.01)
    call SetPlayerState(Player(i),PLAYER_STATE_RESOURCE_GOLD,Ix)
    call SetPlayerState(Player(i),PLAYER_STATE_RESOURCE_LUMBER,Ax)
    if(haveLegend)then
    call SetPlayerState(Player(i),PLAYER_STATE_RESOURCE_FOOD_CAP,Nx)
    else
    call SetPlayerState(Player(i),PLAYER_STATE_RESOURCE_FOOD_CAP,0)
    endif
    if(Pe[i]!=null)then
    call UnitAddAbility(u,'A0A5')
    endif
    call YO(i)
    else
    call yO(i)
    endif
    set i=i+1
    exitwhen i>$B
    endloop
    call AO(1,1,I2S(Vo[0]))
    call AO(1,2,I2S(Vo[1]))
    if(EnableStreamingIncome)then
    set incomeTime=1.
    else
    set incomeTime=IncomeTime
    endif
    call TimerStart(IncomeTimer,incomeTime,true,function IncomeAction)
    call StartBounty()
    if(Dx!=-1)then
        call TimerStart(In,Dx,false,function Qd)
    endif
    set Ye=0
    set ze=0
    set Ze=0
    set vx=4
    set nr=-1
    call TimerStart(ye,.25,true,function BO)
    call VN()
    call TimerStart(pi,2.,true,function aN)
    call kE()
    call bE()
    call DisplayTextToForce(bj_FORCE_ALL_PLAYERS,"Round |cffFFCC00"+I2S(Round)+"|r started! gl & hf!")
    call PlaySoundBJ(HornOfCenariusSound)
    call UI()
    call tE()
    set RoundRunning=true
    set u=null
    call KA(Ud)
    call WE(true)
    call jd()
    if(EnableCastleGates)then
        set Io[0]=1.
        set Io[1]=1.
    endif
    call NO(Te+1,0,"|cffFFCC00Modes:|r"+GetGameConfigString())
endfunction
function Common_InitPools takes nothing returns nothing
call VX()
endfunction
function Common_RelisePoolsAndResume takes nothing returns nothing
set An=true
endfunction
function yd takes integer id,boolean Yd returns nothing
if(DuralRaceMode)then
if(UniqueRaceMode)then
call XX(id,not Yd)
endif
else
if(UniqueRaceMode)then
call XX(id,true)
call XX(id,false)
else
call XX(id,Yd)
endif
endif
endfunction
function zd takes nothing returns nothing
    call TriggerAddAction(Nn,function StartGame)
endfunction
function wd takes nothing returns nothing
local timer Zd
local timerdialog vD
local integer eD
local integer xD
local player p
local integer oD
local integer dE
call VX()
set Zd=CreateTimer()
set vD=CreateTimerDialog(Zd)
call TimerDialogSetTitle(vD,"Time to ban:")
call TimerDialogDisplay(vD,true)
set eD=GetRandomInt(0,1)
set xD=NumberOfBans*2
loop
if(eD==0)then
set p=CX(WesternForce)
set eD=1
else
set p=CX(EasternForce)
set eD=0
endif
set dE=GetPlayerId(p)
call DisplayTextToForce(bj_FORCE_ALL_PLAYERS,PlayerNames[dE]+", your turn to ban race now...")
call TimerStart(Zd,10.,false,null)
set oD=HR(CreateUnit(p,'h09W',GetLocationX(BuilderInitialPosition[dE]),GetLocationY(BuilderInitialPosition[dE]),270.),15.)
if(oD==-1)then
set oD=RX(dE<7)
endif
call DisplayTextToForce(bj_FORCE_ALL_PLAYERS,PlayerNames[dE]+" has banned |cffFFFF00"+cR(oD))
call XX(oD,dE<7)
call DR(oD,false)
set xD=xD-1
exitwhen xD<=0
endloop
call DestroyTimerDialog(vD)
set vD=null
call PauseTimer(Zd)
call DestroyTimer(Zd)
set Zd=null
set An=true
endfunction
function rD takes integer SC returns nothing
call yd(No[SC],IsPlayerInForce(Player(SC),WesternForce))
if(DuralRaceMode)then
if(UniqueRaceMode)then
call FR(No[SC],false,ModuloInteger(PlayerForce[SC]+1,2))
endif
else
if(UniqueRaceMode)then
call DR(No[SC],false)
else
call FR(No[SC],false,PlayerForce[SC])
endif
endif
endfunction
function iD takes nothing returns nothing
local trigger t=GetTriggeringTrigger()
local timer Zd
local timerdialog vD
local integer aD=0
local integer nD=0
local integer eD
local player VD
local integer i=0
local integer dE
call VX()
set Zd=CreateTimer()
set vD=CreateTimerDialog(Zd)
call TimerDialogSetTitle(vD,"Time to select:")
call TimerDialogDisplay(vD,true)
if(Cn<0)then
set Cn=GetRandomInt(0,1)
endif
set Cn=ModuloInteger(Cn+1,2)
set eD=1+2*Cn
loop
set No[i]=0
set i=i+1
exitwhen i>$B
endloop
loop
set VD=null
if(eD<2)then
loop
if(IsPlayerInForce(Player(aD),WesternForce))then
set VD=Player(aD)
endif
set aD=aD+1
exitwhen VD!=null or aD>$B
endloop
else
loop
if(IsPlayerInForce(Player(nD),EasternForce))then
set VD=Player(nD)
endif
set nD=nD+1
exitwhen VD!=null or nD>$B
endloop
endif
set eD=eD+1
if(eD>=4)then
set eD=0
endif
exitwhen VD==null and aD>$B and nD>$B
if(VD!=null)then
set dE=GetPlayerId(VD)
call DisplayTextToForce(bj_FORCE_ALL_PLAYERS,PlayerNames[dE]+" is selecting now...")
call TimerStart(Zd,15.,false,null)
set No[dE]=HR(CreateUnit(VD,'h033',GetLocationX(BuilderInitialPosition[dE]),GetLocationY(BuilderInitialPosition[dE]),270.),15.)
if(No[dE]==-1)then
call DisplayTextToForce(bj_FORCE_ALL_PLAYERS,PlayerNames[dE]+" skipped selection.")
else
call DisplayTextToForce(bj_FORCE_ALL_PLAYERS,PlayerNames[dE]+" controls |cffFFFF00"+cR(No[dE])+"|r.")
call rD(dE)
endif
endif
endloop
set i=0
loop
if(No[i]==-1)then
set VD=Player(i)
if(IsPlayerInForce(VD,WesternForce))then
set No[i]=RX(true)
call rD(i)
elseif(IsPlayerInForce(VD,EasternForce))then
set No[i]=RX(false)
call rD(i)
endif
call DisplayTextToForce(bj_FORCE_ALL_PLAYERS,PlayerNames[i]+" controls |cffFFFF00"+cR(No[i])+"|r.")
endif
set i=i+1
exitwhen i>$B
endloop
call DestroyTimerDialog(vD)
set vD=null
call PauseTimer(Zd)
call DestroyTimer(Zd)
set Zd=null
set An=true
call TriggerClearActions(t)
call DestroyTrigger(t)
set t=null
endfunction
function od takes nothing returns nothing
local trigger t=CreateTrigger()
call TriggerAddAction(t,function iD)
call TriggerExecute(t)
set t=null
endfunction
function xd takes nothing returns nothing
local integer i=0
local integer j=0
local integer array ED
local force f1
local force f2
call VX()
if(CountPlayersInForceBJ(WesternForce)>=CountPlayersInForceBJ(EasternForce))then
set f1=WesternForce
set f2=EasternForce
else
set f1=EasternForce
set f2=WesternForce
endif
loop
if(IsPlayerInForce(Player(i),f1))then
set No[i]=RX(true)
if(not DuralRaceMode)then
call XX(No[i],true)
endif
set ED[j]=No[i]
set j=j+1
endif
set i=i+1
exitwhen i>$B
endloop
set i=0
set j=0
loop
if(IsPlayerInForce(Player(i),f2))then
set No[i]=ED[j]
set j=j+1
endif
set i=i+1
exitwhen i>$B
endloop
set f1=null
set f2=null
set An=true
endfunction
function XD takes integer SC returns nothing
call yd(To[SC],IsPlayerInForce(Player(SC),WesternForce))
if(DuralRaceMode)then
if(UniqueRaceMode)then
call FR(To[SC],false,ModuloInteger(PlayerForce[SC]+1,2))
endif
else
if(UniqueRaceMode)then
call DR(To[SC],false)
else
call FR(To[SC],false,PlayerForce[SC])
endif
endif
endfunction
function OD takes nothing returns boolean
set dn=dn-1
if(To[to]==-1)then
return false
endif
call XD(to)
return false
endfunction
function RD takes nothing returns nothing
local trigger t=GetTriggeringTrigger()
local timer Zd
local timerdialog vD
local unit array ID
local integer i=0
local player p
local integer oD
local integer dE
call VX()
set Zd=CreateTimer()
set vD=CreateTimerDialog(Zd)
call TimerDialogSetTitle(vD,"Time to select:")
call TimerDialogDisplay(vD,true)
set Dn=CreateTrigger()
call TriggerAddCondition(Dn,Condition(function OD))
set So=Dn
set dn=0
loop
set p=Player(i)
if(IsPlayerInForce(p,WesternForce)or IsPlayerInForce(p,EasternForce))then
set ID[i]=hR(CreateUnit(p,'h033',GetLocationX(BuilderInitialPosition[i]),GetLocationY(BuilderInitialPosition[i]),270.))
set dn=dn+1
endif
set i=i+1
exitwhen i>$B
endloop
call TimerStart(Zd,10.,false,null)
loop
call TriggerSleepAction(.33)
exitwhen TimerGetRemaining(Zd)<.33 or dn<=0
endloop
call TriggerClearConditions(Dn)
call DestroyTrigger(Dn)
set i=0
loop
set p=Player(i)
if(IsPlayerInForce(p,WesternForce)or IsPlayerInForce(p,EasternForce))then
if(To[i]==-1 or To[i]==0)then
if(IsPlayerInForce(p,WesternForce))then
set To[i]=RX(true)
elseif(IsPlayerInForce(p,EasternForce))then
set To[i]=RX(false)
endif
call XD(i)
endif
set No[i]=To[i]
else
set No[i]=0
endif
call RemoveUnit(ID[i])
set ID[i]=null
set i=i+1
exitwhen i>$B
endloop
call DestroyTimerDialog(vD)
set vD=null
call PauseTimer(Zd)
call DestroyTimer(Zd)
set Zd=null
set An=true
call TriggerClearActions(t)
call DestroyTrigger(t)
set t=null
endfunction
function qA takes nothing returns nothing
local trigger t=CreateTrigger()
call TriggerAddAction(t,function RD)
call TriggerExecute(t)
set t=null
endfunction
function Wd takes nothing returns nothing
local integer xD=IAbsBJ(NumberOfBans)
local string s=""
local integer oD
call VX()
loop
set oD=RX(true)
call XX(oD,true)
call DR(oD,false)
if(s=="")then
set s=cR(oD)
else
set s=s+", "+cR(oD)
endif
set xD=xD-1
exitwhen xD<=0
endloop
call DisplayTextToForce(bj_FORCE_ALL_PLAYERS,s+" have banned by Random.")
set An=true
endfunction
function QA takes nothing returns nothing
local integer i=0
local integer AD
local integer rr
local integer n
local integer ND
local player p
call VX()
call IO()
if(Round==0)then
set n=0
loop
set se[n]=0
exitwhen n>39
set n=n+1
endloop
endif
loop
set AD=Qe[i]
set p=Player(AD)
set n=0
if(IsPlayerInForce(p,WesternForce))then
loop
set rr=RX(true)
set ND=BR(rr)
exitwhen se[ND]==0 or GetRandomInt(0,99)>89 or n>=24
set n=n+1
call TriggerSleepAction(.01)
endloop
call yd(rr,true)
set se[ND]=se[ND]+1
set No[AD]=rr
elseif(IsPlayerInForce(p,EasternForce))then
loop
set rr=RX(false)
set ND=BR(rr)
exitwhen se[ND+20]==0 or GetRandomInt(0,99)>89 or n>=24
set n=n+1
call TriggerSleepAction(.01)
endloop
call yd(rr,false)
set se[ND+20]=se[ND+20]+1
set No[AD]=rr
endif
set i=i+1
exitwhen i>$B
endloop
set An=true
endfunction
function bD takes integer dE returns nothing
local unit u
call GroupEnumUnitsOfPlayer(ErasingGroup,Player(dE),Pi)
set u=FirstOfGroup(ErasingGroup)
if(u==null)then
return
endif
if(GetUnitAbilityLevel(u,'A005')>0)then
set Vo[PlayerForce[dE]]=Vo[PlayerForce[dE]]-1
if(Vo[PlayerForce[dE]]==0)then
call AO(1,PlayerForce[dE]+1,"|cffFF00000|r")
else
call AO(1,PlayerForce[dE]+1,I2S(Vo[PlayerForce[dE]]))
endif
endif
call RemoveUnit(u)
set u=null
endfunction
function BD takes nothing returns nothing
local unit u=GetEnumUnit()
local integer dN
if(IsUnitType(u,UNIT_TYPE_STRUCTURE))then
call SetUnitOwner(u,ForcePickRandomPlayer(nV),true)
set dN=(BuildingToItsTrained[GetUnitPointValue((u))])
if(dN>0)then
call IssueImmediateOrderById(u,dN)
call IssueImmediateOrderById(u,dN)
endif
set dN=GetPlayerId(GetOwningPlayer(u))
call eA(dN,u)
if(Ve[GetUnitPointValue(u)]<0)then
set do[dN]=do[dN]+1
endif
else
call SetUnitOwner(u,ForcePickRandomPlayer(nV),true)
call WI(u)
endif
set u=null
endfunction
function cD takes nothing returns nothing
local player p=GetEnumPlayer()
local integer dE=GetPlayerId(p)
local integer i=CountPlayersInForceBJ(nV)
local integer g=GetPlayerState(p,PLAYER_STATE_RESOURCE_GOLD)/ i
local integer l=GetPlayerState(p,PLAYER_STATE_RESOURCE_LUMBER)/ i
local string s="You received |cffFFFF00"+I2S(g)+"|r gold and |cffFFFF00"+I2S(l)+"|r lumber from "+PlayerNames[dE]
call yO(dE)
call bD(dE)
call vX(BuilderInitialPosition[dE])
call ForceAddPlayer(EmptyForce,p)
call GroupEnumUnitsOfPlayer(ErasingGroup,p,null)
call ForGroup(ErasingGroup,function BD)
set i=0
loop
set p=Player(i)
if(IsPlayerInForce(p,nV))then
call AdjustPlayerStateBJ(g,p,PLAYER_STATE_RESOURCE_GOLD)
call AdjustPlayerStateBJ(l,p,PLAYER_STATE_RESOURCE_LUMBER)
call DisplayTextToPlayer(p,.0,.0,s)
endif
set i=i+1
exitwhen i>$B
endloop
endfunction
function CD takes integer dE returns nothing
    local player p=Player(dE)
    call ForceRemovePlayer(nV,p)
    call dX(nV,PerPlayerForce[dE])
    call ForceAddPlayer(PerPlayerForce[dE],p)
    call ForForce(PerPlayerForce[dE],function cD)
    call DestroyForce(PerPlayerForce[dE])
    set PerPlayerForce[dE]=null
    endfunction
    function dD takes integer dE returns nothing
    local string HA=GetLocalizedString("TEAM_RESOURCES")+":"
    local integer i=0
    local unit u
    local player p=Player(dE)
    local force DD=PerPlayerForce[dE]
    call ForceAddPlayer(DD,p)
    set PerPlayerForce[dE]=null
    loop
    if(IsPlayerInForce(Player(i),nV)and PerPlayerForce[i]!=null)then
    set p=CX(DD)
    exitwhen p==null
    call ForceRemovePlayer(DD,p)
    call ForceAddPlayer(PerPlayerForce[i],p)
    call SetPlayerName(p,PlayerNames2[i])
    call ZO(GetPlayerId(p))
    call GroupEnumUnitsOfPlayer(ErasingGroup,p,Pi)
    set u=FirstOfGroup(ErasingGroup)
    if(u!=null and GetUnitAbilityLevel(u,'A0A5')<=0)then
    call UnitAddAbility(u,'A0A5')
    endif
    call FA(i,HA)
    endif
    set i=i+1
    if(i>$B)then
    set i=0
    endif
    endloop
    call JX()
    call dA()
    set u=null
endfunction

function PlayerLeaveCallback takes player p returns nothing
    local integer playerId=GetPlayerId(p)
    if(Xx)then
    return
    endif
    call DisplayTextToForce(bj_FORCE_ALL_PLAYERS,PlayerNames[playerId]+" |cffCA0000离开了游戏!|r")
    call IssueDraw(playerId)
    if(Vr[playerId])then
    call GoAFK(playerId)
    endif
    if(AutoBalanceVariation==0)then
    if(IsPlayerInForce(p,WesternForce))then
    if(DX()<=0)then
    set Rn=1
    set Xx=true
    call DisplayTimedTextToForce(bj_FORCE_ALL_PLAYERS,60.,"All players of |cffFF0000Western Forces|r left. |cff00FF00Eastern Forces|r have won!")
    call ForForce(WesternForce,function Defeated)
    call ForForce(EasternForce,function Victory)
    return
    endif
    elseif(IsPlayerInForce(p,EasternForce))then
    if(fX()<=0)then
    set Rn=2
    set Xx=true
    call DisplayTimedTextToForce(bj_FORCE_ALL_PLAYERS,60.,"All players of |cff00FF00Eastern Forces|r left. |cffFF0000Western Forces|r have won!")
    call ForForce(WesternForce,function Victory)
    call ForForce(EasternForce,function Defeated)
    return
    endif
    else
    return
    endif
    call CD(playerId)
    elseif(AutoBalanceVariation==1)then
    call dD(playerId)
    else
    call JoinAI(playerId)
    endif
endfunction
function OnPlayerLeave takes nothing returns nothing
    call PlayerLeaveCallback(GetTriggerPlayer())
endfunction
function GD takes integer dE returns nothing
set H[PlayerForce[dE]+4]=H[PlayerForce[dE]+4]+1
call AO(2,PlayerForce[dE]+1,I2S(H[PlayerForce[dE]+4]))
if(H[PlayerForce[dE]]==dE)then
set H[PlayerForce[dE]+2]=H[PlayerForce[dE]+2]+1
if(H[PlayerForce[dE]+2]==3)then
call DisplayTextToForce(bj_FORCE_ALL_PLAYERS,PlayerNames[dE]+"|cffFFFF80 just collected |cffFFFF003|cffFFFF80 coins in a row for the "+ForceName[PlayerForce[dE]]+"|cffFFFF00! Very nice!")
elseif(H[PlayerForce[dE]+2]==5)then
call DisplayTextToForce(bj_FORCE_ALL_PLAYERS,PlayerNames[dE]+"|cffFFFF80 just collected|cffFFFF00 5|cffFFFF80 coins in a row for the "+ForceName[PlayerForce[dE]]+"|cffFFFF00! Impressive!")
elseif(H[PlayerForce[dE]+2]==$A)then
call DisplayTextToForce(bj_FORCE_ALL_PLAYERS,PlayerNames[dE]+"|cffFFFF80 just collected|cffFFFF00 10|cffFFFF80 coins in a row for the "+ForceName[PlayerForce[dE]]+"|cffFFFF00! Sick!")
endif
else
set H[PlayerForce[dE]]=dE
set H[PlayerForce[dE]+2]=1
endif
endfunction
function hD takes unit HD,integer jD returns integer
local integer PV=0
local integer wX=0
loop
if(GetItemTypeId(UnitItemInSlot(HD,PV))==jD)then
set wX=wX+1
endif
set PV=PV+1
exitwhen PV>=5
endloop
return wX
endfunction
function JD takes unit HD,integer jD,integer kD,integer KD returns nothing
local integer PV=0
local integer wX=0
local integer rc=0
local integer lD
loop
set lD=GetItemTypeId(UnitItemInSlot(HD,PV))
if(lD==jD or lD==kD)then
call RemoveItem(UnitRemoveItemFromSlot(HD,PV))
if(rc==0)then
call UnitAddItemById(HD,KD)
endif
set rc=rc+1
endif
set PV=PV+1
exitwhen PV>=6
endloop
endfunction
function BuyItemAction takes nothing returns nothing
    local integer playerId
    local unit u=GetTriggerUnit()
    local player p=GetOwningPlayer(u)
    local item it=GetManipulatedItem()
    local integer itemTypeId=GetItemTypeId(it)
    if(itemTypeId=='I004')then
        // add legendenry
        call RemoveItem(it)
        if(haveLegend)then
            set playerId=GetPlayerId(p)
            set PayedGolds[playerId]=PayedGolds[playerId]+($5DC)
            call AdjustPlayerStateBJ(1,p,PLAYER_STATE_RESOURCE_FOOD_CAP)
        else
            call AdjustPlayerStateBJ($5DC,p,PLAYER_STATE_RESOURCE_GOLD)
            call DisplayTextToPlayer(p,.0,.0,"|cffFF0000You can't increase your Legendaries limit! No Legendaries is activated!|r")
        endif
    elseif(itemTypeId=='I008')then
        set playerId=GetPlayerId(p)
        set PayedGolds[playerId]=PayedGolds[playerId]+(600)
        set u=CreateUnitAtLoc(p,'e008',Vx,.0)
        call UnitAddAbility(u,'A06D')
        call UnitApplyTimedLife(u,'BTLF',29.)
    elseif(itemTypeId=='I007')then
        set playerId=GetPlayerId(p)
        set PayedGolds[playerId]=PayedGolds[playerId]+($578)
        set u=CreateUnitAtLoc(p,'e008',Vx,.0)
        call UnitAddAbility(u,'A06C')
        call UnitApplyTimedLife(u,'BTLF',29.)
    elseif(itemTypeId=='I001')then
        set playerId=GetPlayerId(p)
        set PayedGolds[playerId]=PayedGolds[playerId]+($96)
        if(hD(u,'I001')==2)then
            call JD(u,'I001','I001','I031')
            if(hD(u,'I031')==2)then
                call JD(u,'I031','I031','I032')
            endif
        endif
    elseif(itemTypeId=='I002')then
        set playerId=GetPlayerId(p)
        set PayedGolds[playerId]=PayedGolds[playerId]+($5DC)
        call UnitAddAbility(u,'A005')
        call UnitAddAbility(u,'A06E')
    elseif(itemTypeId=='I003')then
        set playerId=GetPlayerId(p)
        set PayedGolds[playerId]=PayedGolds[playerId]+(650)
    if(hD(u,'I003')>=2)then
        call JD(u,'I003','I003','I013')
    elseif(hD(u,'I013')==1)then
        call JD(u,'I013','I003','I014')
    elseif(hD(u,'I014')==1)then
    call JD(u,'I014','I003','I015')
    elseif(hD(u,'I015')==1)then
    call JD(u,'I015','I003','I016')
    endif
    elseif(itemTypeId=='I005')then
    set playerId=GetPlayerId(p)
    set PayedGolds[playerId]=PayedGolds[playerId]+($96)
    elseif(itemTypeId=='I00A')then
    set playerId=GetPlayerId(p)
    set PayedGolds[playerId]=PayedGolds[playerId]+(600)
    elseif(itemTypeId=='I009')then
    set playerId=GetPlayerId(p)
    set PayedGolds[playerId]=PayedGolds[playerId]+(500)
    elseif(itemTypeId=='I006')then
    set playerId=GetPlayerId(p)
    set PayedGolds[playerId]=PayedGolds[playerId]+(550)
    elseif(itemTypeId=='I000')then
    call PlayerFoundGold(p)
    call RemoveItem(it)
    call DestroyEffect(AddSpecialEffectTarget("Abilities\\Spells\\Other\\Transmute\\PileofGold.mdl",u,"origin"))
    call GD(GetPlayerId(p))
    endif
    set it=null
    set u=null
endfunction
function BuilderLeaveCastleCond takes nothing returns boolean
    local unit u=GetTriggerUnit()
    local player dN
    if(IsUnitType(u,UNIT_TYPE_PEON))then
    set dN=GetOwningPlayer(u)
    call PingMinimapForPlayer(dN,GetUnitX(u),GetUnitY(u),1.)
    call SetUnitPositionLoc(u,BuilderInitialPosition[GetPlayerId(dN)])
    call DisplayTextToPlayer(dN,.0,.0,"|cffFF0000Your worker may not leave your castle!|r")
    endif
    if(CagingMode)then
    call GroupRemoveUnit(Ci,u)
    endif
    set u=null
    return false
endfunction
function PD takes nothing returns nothing
    local unit u=GetTriggerUnit()
    local player p=GetOwningPlayer(u)
    local integer NN=GetPlayerId(p)
    local integer tX=GetUnitPointValue(u)
    local integer qD
    call zX(u)
    set jo[NN]=jo[NN]+(UnitPrices[tX])
    if(Ve[tX]>0)then
        if(Xe[tX])then
            call ZA(u,(UnitPrices[tX]*3)/ 4)
        else
            call ZA(u,UnitPrices[tX])
        endif
    else
        set do[NN]=do[NN]+1
        if(Ve[tX]==0)then
            call DisplayTextToPlayer(GetLocalPlayer(),.0,.0,"Unregistered special:"+GetUnitName(u))
        endif
    endif
    call zI(NN,u)
    set qD=(BuildingToItsTrained[GetUnitPointValue((u))])
    if(qD!=0)then
        call rI(GetUnitTypeId(u),NN)
        if(vo[GetPlayerId(p)])then
        call IssueImmediateOrderById(u,qD)
        call IssueImmediateOrderById(u,qD)
        endif
        if(GetUnitTypeId(u)=='h056')then
            call IssueImmediateOrderById(u,$D027A)
            call TriggerSleepAction(.5)
            call IssueTargetOrderById(u,$D0279,GroupPickRandomUnit(ix))
        endif
    else
        set tX=GetUnitTypeId(u)
        if(tX=='h001')then
        call NB(u)
        call GroupAddUnit(ra,u)
        elseif(tX=='h05G')then
        call cB(u)
        elseif(tX=='h059')then
        call eB(p)
        elseif(tX=='h063')then
        call qb(p)
        elseif(tX=='h02D')then
        call TimerStart(cv,6.,true,function mE)
        elseif(tX=='h00G')then
        call UnitAddAbility(u,'A008')
        elseif(tX=='h061')then
        call pb(u)
        elseif(tX=='h056' or tX=='h03L' or tX=='h01W' or tX=='h01X' or tX=='h05R')then
        call IssueImmediateOrderById(u,$D027A)
        call TriggerSleepAction(.5)
        call IssueTargetOrderById(u,$D0279,GroupPickRandomUnit(ix))
        elseif(tX=='h09T')then
        call UnitAddAbility(u,'A09S')
        call UnitAddAbility(u,'A09P')
        call UnitAddAbility(u,'A09V')
        call GroupAddUnit(Va,u)
        elseif(tX=='h01O')then
        call UnitAddAbility(u,'A01V')
        elseif(tX=='h008')then
        set tX=GetPlayerId(p)
        set IncomeMultiplier[tX]=IncomeMultiplier[tX]+.24/ IncomeMultiplier[tX]
        endif
    endif
    set u=null
    set p=null
endfunction
function sD takes nothing returns nothing
    local unit u=GetTriggerUnit()
    call UX(u)
    set u=null
endfunction
function tD takes nothing returns nothing
    call zX(GetTriggerUnit())
endfunction
function uD takes nothing returns boolean
    local unit u=GetTriggerUnit()
    local integer dN
    if((BuildingToItsTrained[GetUnitPointValue((u))])>0)then
    set dN=GetPlayerId(GetOwningPlayer(u))
    set Co[dN]=Co[dN]+1
    endif
    set u=null
    return false
endfunction
function wD takes nothing returns boolean
local unit u=GetFilterUnit()
if(GetWidgetLife(u)>.405 and IsUnitAlly(u,EraserIssuer)and IsUnitType(u,UNIT_TYPE_SAPPER))then
if(GetUnitTypeId(u)==bj_forLoopAIndex)then
call SetWidgetLife(u,GetWidgetLife(u)+bj_forLoopAIndexEnd)
else
call SetWidgetLife(u,GetWidgetLife(u)+.3*bj_forLoopAIndexEnd)
endif
call DestroyEffect(AddSpecialEffectTarget("Abilities\\Spells\\Human\\Heal\\HealTarget.mdl",u,"overhead"))
endif
set u=null
return false
endfunction
function WD takes nothing returns nothing
    local unit u=GetTriggerUnit()
    local unit k=GetKillingUnit()
    local integer t
    local integer xI
    if(IsUnitType(u,UNIT_TYPE_SAPPER))then
    if(GetUnitAbilityLevel(u,'A07M')>=1)then
    call GroupRemoveUnit(Li,u)
    endif
    if(k!=null)then
    if(not IsUnitType(k,UNIT_TYPE_STRUCTURE))then
    set t=GetPlayerId(GetOwningPlayer(k))
    set Bo[t]=Bo[t]+1
    if(GetUnitTypeId(u)=='e00A')then
    call UnitDamageTarget(u,k,350.,true,false,ATTACK_TYPE_CHAOS,DAMAGE_TYPE_NORMAL,WEAPON_TYPE_WHOKNOWS)
    endif
    set t=GetUnitTypeId(k)
    if(t=='n00V' or t=='n01O')then
    call IssueImmediateOrderById(k,$D0084)
    call wI(k)
    elseif(t=='e00B')then
    call SetUnitLifePercentBJ(k,GetUnitLifePercent(k)+14.)
    elseif(t=='e00A')then
    call SetUnitLifePercentBJ(k,GetUnitLifePercent(k)+20.)
    elseif(t=='h01U' and GetUnitAbilityLevel(u,'A08H')<=0 and(not IsUnitType(u,UNIT_TYPE_MECHANICAL))and(not IsUnitType(u,UNIT_TYPE_UNDEAD)))then
    call lC(k,u,'h01V')
    set u=null
    elseif(t=='h05H' and GetUnitAbilityLevel(u,'A08H')<=0 and(not IsUnitType(u,UNIT_TYPE_MECHANICAL))and(not IsUnitType(u,UNIT_TYPE_UNDEAD)))then
    call lC(k,u,'h01U')
    set u=null
    elseif(GetUnitAbilityLevel(u,'A07M')>=1)then
    call SR(u)
    endif
    endif
    set t=oo[PlayerForce[GetPlayerId(GetOwningPlayer(u))]]
    if(t>0 and GetRandomInt(0,99)<t)then
    if(u!=null and GetWidgetLife(u)<.405 and GetUnitAbilityLevel(u,'A07G')<=0 and GetUnitAbilityLevel(u,'A07H')<=0 and not IsUnitType(u,UNIT_TYPE_SUMMONED)and GetUnitAbilityLevel(u,'A0GS')<=0 and not IsUnitType(u,UNIT_TYPE_MECHANICAL))then
    set k=CreateUnit(GetOwningPlayer(u),GetUnitTypeId(u),GetUnitX(u),GetUnitY(u),.0)
    call UnitAddAbility(k,'A0GS')
    call ShowUnit(k,false)
    call RemoveUnit(u)
    set u=null
    call TriggerSleepAction(GetRandomReal(.5,1.25))
    call DestroyEffect(AddSpecialEffectTarget("Abilities\\Spells\\Items\\AIam\\AIamTarget.mdl",k,"origin"))
    call ShowUnit(k,true)
    if(GetUnitAbilityLevel(k,'A07M')>=1)then
    call GroupAddUnit(Li,k)
    endif
    endif
    if(u!=null and GetUnitAbilityLevel(u,'A0F5')>0)then
    if(GetRandomInt(0,99)<ao[t])then
    call sb(u,k)
    endif
    endif
    endif
    endif
    elseif(IsUnitType(u,UNIT_TYPE_STRUCTURE))then
    call UX(u)
    call vA(GetPlayerId(GetOwningPlayer(u)),u)
    set t=GetUnitTypeId(u)
    set xI=PlayerForce[GetPlayerId(GetOwningPlayer(u))]
    call eI(t,xI)
    if(t=='h05G')then
    call CB(u)
    elseif(t=='h059')then
    call xB(u)
    elseif(t=='h063')then
    call Qb(u)
    elseif(t=='h068')then
    set Io[(xI)]=1.
    elseif(t=='h008')then
    set t=GetPlayerId(GetOwningPlayer(u))
    set IncomeMultiplier[t]=IncomeMultiplier[t]-.24/ IncomeMultiplier[t]
    endif
    call FlushChildHashtable(ox,GetHandleId(u))
    call GroupRemoveUnit(ra,u)
    call GroupRemoveUnit(Va,u)
    set u=GetKillingUnit()
    if(u!=null and VV)then
    set Xo[xI]=Xo[xI]+1
    call AO(3,t+1,I2S(Xo[xI]))
    endif
    endif
    set k=null
    set u=null
endfunction
function YD takes unit u,real tx,real ty returns nothing
local player p=GetOwningPlayer(u)
local integer dE=GetPlayerId(p)
local integer n=2
local unit c
local real zD=.0
local integer wX=0
local unit j
local boolean ZD
if(Eo[PlayerForce[dE]]>0)then
call DisplayTextToForce(bj_FORCE_ALL_PLAYERS,PlayerNames[dE]+" almost wasted its Devastating Strike!")
set p=null
return
endif
set Eo[PlayerForce[dE]]=1
set c=CreateUnit(p,'h04X',tx,ty,.0)
call SetUnitVertexColor(c,0,0,0,0)
call UnitRemoveAbility(u,'A005')
call UnitRemoveAbility(u,'A06E')
call DestroyEffect(AddSpecialEffectTarget("Abilities\\Spells\\Items\\TomeOfRetraining\\TomeOfRetrainingCaster.mdl",u,"origin"))
call DestroyEffect(AddSpecialEffectTarget("Units\\NightElf\\Wisp\\WispExplode.mdl",c,"origin"))
call DestroyEffect(AddSpecialEffectTarget("Units\\NightElf\\Wisp\\WispExplode.mdl",c,"origin"))
call DestroyEffect(AddSpecialEffectTarget("Units\\NightElf\\Wisp\\WispExplode.mdl",c,"origin"))
call TriggerSleepAction(.2)
set EraserIssuer=p
set ZD=haveAI
set haveAI=false
loop
call GroupEnumUnitsInRange(ax,tx,ty,800.,null)
loop
set j=FirstOfGroup(ax)
exitwhen j==null
call GroupRemoveUnit(ax,j)
if(IsUnitEnemy(j,p)and GetWidgetLife(j)>.405 and GetUnitAbilityLevel(j,'Avul')<=0 and not IsUnitType(j,UNIT_TYPE_STRUCTURE))then
set wX=wX+1
set zD=zD+(GetWidgetLife(j))
call UnitDamageTarget(u,j,10000.,true,false,ATTACK_TYPE_CHAOS,DAMAGE_TYPE_DEATH,WEAPON_TYPE_WHOKNOWS)
call UnitDamageTarget(u,j,10000.,true,false,ATTACK_TYPE_MAGIC,DAMAGE_TYPE_DEATH,WEAPON_TYPE_WHOKNOWS)
endif
endloop
call TriggerSleepAction(.25)
set n=n-1
exitwhen(n==0)
endloop
call IssueImmediateOrderById(c,$D022E)
set haveAI=ZD
call TriggerSleepAction(1.5)
call RemoveUnit(c)
set c=null
set Eo[PlayerForce[dE]]=0
set Fo[dE]=R2I(zD)
set go[dE]=wX
set Vo[PlayerForce[dE]]=Vo[PlayerForce[dE]]-1
if(Vo[PlayerForce[dE]]==0)then
call AO(1,PlayerForce[dE]+1,"|cffFF00000|r")
else
call AO(1,PlayerForce[dE]+1,I2S(Vo[PlayerForce[dE]]))
endif
call NO(te[dE],PlayerForce[dE]*6+1," ")
if (wX == 0) then
    call DisplayTextToForce(bj_FORCE_ALL_PLAYERS,PlayerNames[dE]+" 用大招放了一个烟花。")
elseif (wX == 1) then
    call DisplayTextToForce(bj_FORCE_ALL_PLAYERS,PlayerNames[dE]+" 用大招进行了外科手术式打击，保证了只会杀死一个单位。")
else
    call DisplayTextToForce(bj_FORCE_ALL_PLAYERS,PlayerNames[dE]+" 用大招造成了 |cffFFFF00"+I2S(Fo[dE])+"|r 点伤害，并且杀死了 |cffFFFF00"+I2S(wX)+"|r 个单位!")
endif
endfunction
function vf takes unit u,real tx,real ty returns nothing
local unit c=CreateUnit(GetOwningPlayer(u),'e008',tx,ty,.0)
call UnitAddAbility(c,'A02G')
call IssueImmediateOrderById(c,$D012D)
call UnitApplyTimedLife(c,'BTLF',1.)
set c=null
endfunction
function ef takes unit u,integer xf returns nothing
local player p=GetOwningPlayer(u)
if(xf==0)then
set xf='I008'
elseif(xf==1)then
set xf='I007'
elseif(xf==2)then
set xf='I006'
elseif(xf==3)then
set xf='I003'
elseif(xf==4)then
set xf='I004'
elseif(xf==5)then
set xf='I005'
elseif(xf==6)then
set xf='I00A'
elseif(xf==7)then
set xf='I001'
elseif(xf==8)then
set xf='I009'
endif
call IssueNeutralImmediateOrderById(p,MainCastle[PlayerForce[GetPlayerId(p)]],xf)
endfunction
function of takes nothing returns nothing
    local unit u=GetTriggerUnit()
    local integer xb=GetSpellAbilityId()
    if(IsUnitType(u,UNIT_TYPE_STRUCTURE))then
    if(xb=='A09A')then
        call UA(u,(Ce[GetUnitPointValue((u))]))
    else
        call xO(u)
    endif
    elseif(xb=='A005')then
    call YD(u,GetSpellTargetX(),GetSpellTargetY())
    elseif(xb=='A07C')then
    call Td(PlayerForce[GetPlayerId(GetOwningPlayer(u))])
    elseif(xb=='A08Y')then
    call vf(u,GetSpellTargetX(),GetSpellTargetY())
    elseif(xb>='IBA0' and xb<='IBA8')then
    call ef(u,xb-'IBA0')
    elseif(IsUnitType(u,UNIT_TYPE_SAPPER))then
    call aO(u,xb,GetSpellTargetUnit())
    endif
    set u=null
endfunction
function af takes nothing returns nothing
local unit u=GetTrainedUnit()
local unit j=GetTriggerUnit()
local integer uX=GetTrainedUnitType()
if(GetUnitAbilityLevel(u,'A07J')>0)then
set u=LN(u)
endif
call BN(u,j)
set u=null
call TriggerSleepAction(.05)
call IssueImmediateOrderById(j,uX)
set j=null
endfunction
function Vf takes nothing returns boolean
local unit u=GetFilterUnit()
local boolean aX=IsUnitType(u,UNIT_TYPE_SAPPER)and IsUnitAlly(u,RV)and GetWidgetLife(u)>50.
if(aX)then
set OV=OV+1
endif
set u=null
return aX
endfunction
function Ef takes nothing returns boolean
    local unit u=GetTriggerUnit()
    local integer tX=GetUnitTypeId(u)
    if(IsUnitType(u,UNIT_TYPE_SAPPER))then
    if(GetUnitAbilityLevel(u,'A0C5')>0)then
    call TriggerRegisterUnitEvent(en,u,EVENT_UNIT_DAMAGED)
    endif
    if(tX=='u00D')then
    call TriggerRegisterUnitEvent(xn,u,EVENT_UNIT_ACQUIRED_TARGET)
    call gC(u)
    elseif(tX=='n02T')then
    call TriggerRegisterUnitEvent(xn,u,EVENT_UNIT_ACQUIRED_TARGET)
    elseif(tX=='e00F')then
    call jc(u)
    endif
    call WI(u)
    elseif(IsUnitType(u,UNIT_TYPE_STRUCTURE))then
    call TriggerRegisterUnitEvent(Pr,u,EVENT_UNIT_ATTACKED)
    if(tX=='h061' or tX=='n02D')then
    call TriggerRegisterUnitEvent(xn,u,EVENT_UNIT_ACQUIRED_TARGET)
    endif
    elseif(tX=='n01U')then
    call UnitAddAbility(u,'Aloc')
    call UnitAddAbility(u,'S003')
    call UnitApplyTimedLife(u,'BTLF',55.)
    endif
    set u=null
return false
endfunction
function Of takes nothing returns nothing
local unit u=GetTriggerUnit()
if(IsUnitType(GetTriggerUnit(),UNIT_TYPE_SAPPER)and not IsUnitType(GetTriggerUnit(),UNIT_TYPE_STRUCTURE))then
if(GetUnitAbilityLevel(u,'A07H')>0)then
call DisableTrigger(iV)
call SetUnitOwner(u,GetChangingUnitPrevOwner(),true)
call EnableTrigger(iV)
call DestroyEffect(AddSpecialEffectTarget("Abilities\\Spells\\Human\\DispelMagic\\DispelMagicTarget.mdl",u,"origin"))
endif
endif
call WI(u)
set u=null
endfunction
function If takes nothing returns nothing
local unit u=GetSummonedUnit()
local integer tX=GetUnitTypeId(u)
local integer dd=GetUnitTypeId(GetSummoningUnit())
local real hp
if(tX=='h03C')then
call SetUnitState(u,UNIT_STATE_MANA,GetRandomReal(20.,40.))
elseif(GetUnitAbilityLevel(u,'A07M')>0)then
call GroupAddUnit(Li,u)
elseif(GetUnitAbilityLevel(u,'A07H')>0)then
call RemoveUnit(u)
elseif(dd=='h02X' or dd=='h02Y')then
set hp=50.+GetUnitState(u,UNIT_STATE_MAX_LIFE)
call SetUnitVertexColor(u,$B4,$B4,$FF,'x')
call TriggerSleepAction(.5)
call UnitApplyTimedLife(u,'BTLF',GetRandomReal(3.,5.))
endif
call WI(u)
set u=null
endfunction
function InitCustomTeams takes nothing returns nothing
call SetPlayerTeam(Player(0),0)
call SetPlayerState(Player(0),PLAYER_STATE_ALLIED_VICTORY,1)
call SetPlayerTeam(Player(1),0)
call SetPlayerState(Player(1),PLAYER_STATE_ALLIED_VICTORY,1)
call SetPlayerTeam(Player(2),0)
call SetPlayerState(Player(2),PLAYER_STATE_ALLIED_VICTORY,1)
call SetPlayerAllianceStateAllyBJ(Player(0),Player(1),true)
call SetPlayerAllianceStateAllyBJ(Player(0),Player(2),true)
call SetPlayerAllianceStateAllyBJ(Player(1),Player(0),true)
call SetPlayerAllianceStateAllyBJ(Player(1),Player(2),true)
call SetPlayerAllianceStateAllyBJ(Player(2),Player(0),true)
call SetPlayerAllianceStateAllyBJ(Player(2),Player(1),true)
call SetPlayerAllianceStateVisionBJ(Player(0),Player(1),true)
call SetPlayerAllianceStateVisionBJ(Player(0),Player(2),true)
call SetPlayerAllianceStateVisionBJ(Player(1),Player(0),true)
call SetPlayerAllianceStateVisionBJ(Player(1),Player(2),true)
call SetPlayerAllianceStateVisionBJ(Player(2),Player(0),true)
call SetPlayerAllianceStateVisionBJ(Player(2),Player(1),true)
call SetPlayerTeam(Player(6),1)
call SetPlayerState(Player(6),PLAYER_STATE_ALLIED_VICTORY,1)
call SetPlayerTeam(Player(7),1)
call SetPlayerState(Player(7),PLAYER_STATE_ALLIED_VICTORY,1)
call SetPlayerTeam(Player(8),1)
call SetPlayerState(Player(8),PLAYER_STATE_ALLIED_VICTORY,1)
call SetPlayerAllianceStateAllyBJ(Player(6),Player(7),true)
call SetPlayerAllianceStateAllyBJ(Player(6),Player(8),true)
call SetPlayerAllianceStateAllyBJ(Player(7),Player(6),true)
call SetPlayerAllianceStateAllyBJ(Player(7),Player(8),true)
call SetPlayerAllianceStateAllyBJ(Player(8),Player(6),true)
call SetPlayerAllianceStateAllyBJ(Player(8),Player(7),true)
call SetPlayerAllianceStateVisionBJ(Player(6),Player(7),true)
call SetPlayerAllianceStateVisionBJ(Player(6),Player(8),true)
call SetPlayerAllianceStateVisionBJ(Player(7),Player(6),true)
call SetPlayerAllianceStateVisionBJ(Player(7),Player(8),true)
call SetPlayerAllianceStateVisionBJ(Player(8),Player(6),true)
call SetPlayerAllianceStateVisionBJ(Player(8),Player(7),true)
endfunction

function main takes nothing returns nothing
    local weathereffect we
    local integer LoopIndex
    local integer PlayingUsers
    local version GameVersion
    local integer idx
    call SetCameraBounds(-6656.+GetCameraMargin(CAMERA_MARGIN_LEFT),-3456.+GetCameraMargin(CAMERA_MARGIN_BOTTOM),6656.-GetCameraMargin(CAMERA_MARGIN_RIGHT),3456.-GetCameraMargin(CAMERA_MARGIN_TOP),-6656.+GetCameraMargin(CAMERA_MARGIN_LEFT),3456.-GetCameraMargin(CAMERA_MARGIN_TOP),6656.-GetCameraMargin(CAMERA_MARGIN_RIGHT),-3456.+GetCameraMargin(CAMERA_MARGIN_BOTTOM))
    call SetDayNightModels("Environment\\DNC\\DNCAshenvale\\DNCAshenvaleTerrain\\DNCAshenvaleTerrain.mdl","Environment\\DNC\\DNCAshenvale\\DNCAshenvaleUnit\\DNCAshenvaleUnit.mdl")
    call NewSoundEnvironment("Default")
    call SetAmbientDaySound("AshenvaleDay")
    call SetAmbientNightSound("AshenvaleNight")
    call SetMapMusic("Music",true,0)
    set HornOfCenariusSound=CreateSound("Sound\\Ambient\\DoodadEffects\\TheHornOfCenarius.wav",false,false,false,$A,$A,"DefaultEAXON")
    call SetSoundParamsFromLabel(HornOfCenariusSound,"HornOfCenariusSound")
    call SetSoundDuration(HornOfCenariusSound,$2F59)
    set CreepAggroSound=CreateSound("Sound\\Interface\\CreepAggroWhat1.wav",false,false,false,$A,$A,"DefaultEAXON")
    call SetSoundParamsFromLabel(CreepAggroSound,"CreepAggro")
    call SetSoundDuration(CreepAggroSound,$4D4)
    set HeroPitLordYesAttackSound=CreateSound("Units\\Demon\\HeroPitLord\\HPitLordYesAttack2.wav",false,false,false,$A,$A,"HeroAcksEAX")
    call SetSoundParamsFromLabel(HeroPitLordYesAttackSound,"HeroPitLordYesAttack")
    call SetSoundDuration(HeroPitLordYesAttackSound,$944)
    set WispPissedSound=CreateSound("Units\\NightElf\\Wisp\\WispPissed3.wav",false,false,false,$A,$A,"DefaultEAXON")
    call SetSoundParamsFromLabel(WispPissedSound,"WispPissed")
    call SetSoundDuration(WispPissedSound,$A7A)
    set BloodElfEngineerWarcrySound=CreateSound("Units\\Critters\\BloodElfPeasant\\BloodElfEngineerWarcry1.wav",false,false,false,$A,$A,"DefaultEAXON")
    call SetSoundParamsFromLabel(BloodElfEngineerWarcrySound,"BloodElfEngineerWarcry")
    call SetSoundDuration(BloodElfEngineerWarcrySound,$4EC)
    set PeasantReadySound=CreateSound("Units\\Human\\Peasant\\PeasantReady1.wav",false,false,false,$A,$A,"DefaultEAXON")
    call SetSoundParamsFromLabel(PeasantReadySound,"PeasantReady")
    call SetSoundDuration(PeasantReadySound,$482)
    set HeroTinkerReadySound=CreateSound("Units\\Creeps\\HeroTinker\\HeroTinkerReady1.wav",false,false,false,$A,$A,"HeroAcksEAX")
    call SetSoundParamsFromLabel(HeroTinkerReadySound,"HeroTinkerReady")
    call SetSoundDuration(HeroTinkerReadySound,$AF3)
    set MurlocPissedSound=CreateSound("Units\\Creeps\\Murloc\\MurlocPissed2.wav",false,false,false,$A,$A,"DefaultEAXON")
    call SetSoundParamsFromLabel(MurlocPissedSound,"MurlocPissed")
    call SetSoundDuration(MurlocPissedSound,853)
    set EntReadySound=CreateSound("Units\\NightElf\\Ent\\EntReady1.wav",false,false,false,$A,$A,"DefaultEAXON")
    call SetSoundParamsFromLabel(EntReadySound,"EntReady")
    call SetSoundDuration(EntReadySound,$912)
    set RunnerWarcrySound=CreateSound("Units\\NightElf\\Runner\\RunnerWarcry1.wav",false,false,false,$A,$A,"DefaultEAXON")
    call SetSoundParamsFromLabel(RunnerWarcrySound,"RunnerWarcry")
    call SetSoundDuration(RunnerWarcrySound,$551)
    set BanditWhatSound=CreateSound("Units\\Creeps\\Bandit\\BanditWhat1.wav",false,false,false,$A,$A,"DefaultEAXON")
    call SetSoundParamsFromLabel(BanditWhatSound,"BanditWhat")
    call SetSoundDuration(BanditWhatSound,$4DA)
    set PeonReadySound=CreateSound("Units\\Orc\\Peon\\PeonReady1.wav",false,false,false,$A,$A,"DefaultEAXON")
    call SetSoundParamsFromLabel(PeonReadySound,"PeonReady")
    call SetSoundDuration(PeonReadySound,$3EF)
    set AcolyteWarcrySound=CreateSound("Units\\Undead\\Acolyte\\AcolyteWarcry1.wav",false,false,false,$A,$A,"HeroAcksEAX")
    call SetSoundParamsFromLabel(AcolyteWarcrySound,"AcolyteWarcry")
    call SetSoundDuration(AcolyteWarcrySound,$5A4)
    set PitLordYesAttackSound=CreateSound("Units\\Demon\\Pitlord\\PitLordYesAttack1.wav",false,true,true,$A,$A,"DefaultEAXON")
    call SetSoundParamsFromLabel(PitLordYesAttackSound,"PitLordYesAttack")
    call SetSoundDuration(PitLordYesAttackSound,$A67)
    set ChatroomTimerTickSound=CreateSound("Sound\\Interface\\BattleNetTick.wav",false,false,false,$A,$A,"DefaultEAXON")
    call SetSoundParamsFromLabel(ChatroomTimerTickSound,"ChatroomTimerTick")
    call SetSoundDuration(ChatroomTimerTickSound,476)
    set HintSound=CreateSound("Sound\\Interface\\Hint.wav",false,false,false,$A,$A,"DefaultEAXON")
    call SetSoundParamsFromLabel(HintSound,"Hint")
    call SetSoundDuration(HintSound,$7D6)
    set KoboldPissedSound=CreateSound("Units\\Creeps\\Kobold\\KoboldPissed3.wav",false,true,true,$A,$A,"DefaultEAXON")
    call SetSoundParamsFromLabel(KoboldPissedSound,"KoboldPissed")
    call SetSoundDuration(KoboldPissedSound,$3F0)
    set TranquilitySound=CreateSound("Abilities\\Spells\\NightElf\\Tranquility\\Tranquility.wav",false,false,false,$A,$A,"DefaultEAXON")
    call SetSoundParamsFromLabel(TranquilitySound,"Tranquility")
    call SetSoundDuration(TranquilitySound,$DF4)
    call SetSoundChannel(TranquilitySound,$A)
    set EasternBuildArea=Rect(-5632.,-2176.,-1952.,2176.)
    set WesternBuildArea=Rect(1984.,-2176.,5632.,2176.)
    set gn=Rect(-5280.,-416.,-4608.,416.)
    set Gn=Rect(4608.,-416.,5280.,416.)
    set hn=Rect(-5440.,-672.,5440.,672.)
    call ConfigureNeutralVictim()
    set PassThruFilter=Filter(function AlwaysTrue)
    set filterIssueHauntOrderAtLocBJ=Filter(function IssueHauntOrderAtLocBJFilter)
    set filterEnumDestructablesInCircleBJ=Filter(function EnumDstrutablesInCircle)
    set filterGetUnitsInRectOfPlayer=Filter(function GetUnitsInRectOfPlayerFilter)
    set filterGetUnitsOfTypeIdAll=Filter(function GetUnitsOfTypeIdAllFilter)
    set filterGetUnitsOfPlayerAndTypeId=Filter(function GetUnitsOfPlayerAndTypeIdFilter)
    set filterMeleeTrainedUnitIsHeroBJ=Filter(function MeleeTrainedUnitIsHeroBJFilter)
    set filterLivingPlayerUnitsOfTypeId=Filter(function LivingPlayerUnitsOfTypeIdFilter)
    set LoopIndex=0
    loop
        exitwhen LoopIndex==16
        set bj_FORCE_PLAYER[LoopIndex]=CreateForce()
        call ForceAddPlayer(bj_FORCE_PLAYER[LoopIndex], Player(LoopIndex))
        set LoopIndex=LoopIndex+1
    endloop

    set bj_FORCE_ALL_PLAYERS=CreateForce()
    call ForceEnumPlayers(bj_FORCE_ALL_PLAYERS,null)
    set bj_cineModePriorSpeed=GetGameSpeed()
    set bj_cineModePriorFogSetting=IsFogEnabled()
    set bj_cineModePriorMaskSetting=IsFogMaskEnabled()
    set LoopIndex=0
    loop
        exitwhen LoopIndex>=bj_MAX_QUEUED_TRIGGERS
        set bj_queuedExecTriggers[LoopIndex]=null
        set bj_queuedExecUseConds[LoopIndex]=false
        set LoopIndex=LoopIndex+1
    endloop
    set bj_isSinglePlayer=false
    set PlayingUsers=0
    set LoopIndex=0
    loop
        exitwhen LoopIndex>=12
        if(GetPlayerController(Player(LoopIndex))==MAP_CONTROL_USER and GetPlayerSlotState(Player(LoopIndex))==PLAYER_SLOT_STATE_PLAYING)then
            set PlayingUsers=PlayingUsers+1
        endif
        set LoopIndex=LoopIndex+1
    endloop
    set bj_isSinglePlayer=(PlayingUsers==1)
    set bj_rescueSound=CreateSoundFromLabel("Rescue",false,false,false,$2710,$2710)
    set bj_questDiscoveredSound=CreateSoundFromLabel("QuestNew",false,false,false,$2710,$2710)
    set bj_questUpdatedSound=CreateSoundFromLabel("QuestUpdate",false,false,false,$2710,$2710)
    set bj_questCompletedSound=CreateSoundFromLabel("QuestCompleted",false,false,false,$2710,$2710)
    set bj_questFailedSound=CreateSoundFromLabel("QuestFailed",false,false,false,$2710,$2710)
    set bj_questHintSound=CreateSoundFromLabel("Hint",false,false,false,$2710,$2710)
    set bj_questSecretSound=CreateSoundFromLabel("SecretFound",false,false,false,$2710,$2710)
    set bj_questItemAcquiredSound=CreateSoundFromLabel("ItemReward",false,false,false,$2710,$2710)
    set bj_questWarningSound=CreateSoundFromLabel("Warning",false,false,false,$2710,$2710)
    set bj_victoryDialogSound=CreateSoundFromLabel("QuestCompleted",false,false,false,$2710,$2710)
    set bj_defeatDialogSound=CreateSoundFromLabel("QuestFailed",false,false,false,$2710,$2710)

    call DelayedSuspendDecayCreate()
    set GameVersion=VersionGet()
    if(GameVersion == VERSION_REIGN_OF_CHAOS)then
        set bj_MELEE_MAX_TWINKED_HEROES=bj_MELEE_MAX_TWINKED_HEROES_V0
    else
        set bj_MELEE_MAX_TWINKED_HEROES=bj_MELEE_MAX_TWINKED_HEROES_V1
    endif
    call InitQueuedTriggers()
    call InitRescuableBehaviorBJ()
    call InitDNCSounds()
    call InitMapRects()
    call InitSummonableCaps()
    set idx=0
    loop
        set bj_stockAllowedPermanent[idx]=false
        set bj_stockAllowedCharged[idx]=false
        set bj_stockAllowedArtifact[idx]=false
        set idx=idx+1
        exitwhen idx > 10
    endloop
    call SetAllItemTypeSlots($B)
    call SetAllUnitTypeSlots($B)
    set bj_stockUpdateTimer=CreateTimer()
    call TimerStart(bj_stockUpdateTimer,bj_STOCK_RESTOCK_INITIAL_DELAY,false,function DealStock)
    set bj_stockItemPurchased=CreateTrigger()
    call TriggerRegisterPlayerUnitEvent(bj_stockItemPurchased,Player($F),EVENT_PLAYER_UNIT_SELL_ITEM,null)
    call TriggerAddAction(bj_stockItemPurchased,function RemovePurchasedItem)
    call DetectGameStarted()
    call ExecuteFunc("Nf")
    set PlayerLeaveTrigger=CreateTrigger()
    call TriggerRegisterPlayerEventLeave(PlayerLeaveTrigger,Player(0))
    call TriggerRegisterPlayerEventLeave(PlayerLeaveTrigger,Player(1))
    call TriggerRegisterPlayerEventLeave(PlayerLeaveTrigger,Player(2))
    call TriggerRegisterPlayerEventLeave(PlayerLeaveTrigger,Player(3))
    call TriggerRegisterPlayerEventLeave(PlayerLeaveTrigger,Player(4))
    call TriggerRegisterPlayerEventLeave(PlayerLeaveTrigger,Player(5))
    call TriggerRegisterPlayerEventLeave(PlayerLeaveTrigger,Player(6))
    call TriggerRegisterPlayerEventLeave(PlayerLeaveTrigger,Player(7))
    call TriggerRegisterPlayerEventLeave(PlayerLeaveTrigger,Player(8))
    call TriggerRegisterPlayerEventLeave(PlayerLeaveTrigger,Player(9))
    call TriggerRegisterPlayerEventLeave(PlayerLeaveTrigger,Player($A))
    call TriggerRegisterPlayerEventLeave(PlayerLeaveTrigger,Player($B))
    call TriggerAddAction(PlayerLeaveTrigger,function OnPlayerLeave)
    set BuyItemTrigger=CreateTrigger()
    call TriggerAddAction(BuyItemTrigger,function BuyItemAction)
    call TriggerRegisterAnyUnitEventBJ(BuyItemTrigger,EVENT_PLAYER_UNIT_PICKUP_ITEM)
    set WorkerLeaveCastleTrigger=CreateTrigger()
    call TriggerRegisterLeaveRectSimple(WorkerLeaveCastleTrigger,EasternBuildArea)
    call TriggerRegisterLeaveRectSimple(WorkerLeaveCastleTrigger,WesternBuildArea)
    call TriggerAddCondition(WorkerLeaveCastleTrigger,Condition(function BuilderLeaveCastleCond))

    // what is this?
    set Yn=CreateTrigger()
    call TriggerRegisterAnyUnitEventBJ(Yn,EVENT_PLAYER_UNIT_CONSTRUCT_FINISH)
    call TriggerRegisterAnyUnitEventBJ(Yn,EVENT_PLAYER_UNIT_UPGRADE_FINISH)
    call TriggerAddAction(Yn,function PD)

    set zn=CreateTrigger()
    call TriggerRegisterAnyUnitEventBJ(zn,EVENT_PLAYER_UNIT_UPGRADE_START)
    call TriggerAddAction(zn,function sD)

    set Zn=CreateTrigger()
    call TriggerRegisterAnyUnitEventBJ(Zn,EVENT_PLAYER_UNIT_UPGRADE_CANCEL)
    call TriggerAddAction(Zn,function tD)

    set vV=CreateTrigger()
    call TriggerRegisterAnyUnitEventBJ(vV,EVENT_PLAYER_UNIT_CONSTRUCT_FINISH)
    call TriggerAddCondition(vV,Condition(function uD))

    set eV=CreateTrigger()
    call TriggerRegisterAnyUnitEventBJ(eV,EVENT_PLAYER_UNIT_DEATH)
    call TriggerAddAction(eV,function WD)

    set EV=Filter(function wD)
    set xV=CreateTrigger()
    call TriggerRegisterAnyUnitEventBJ(xV,EVENT_PLAYER_UNIT_SPELL_EFFECT)
    call TriggerAddAction(xV,function of)

    set oV=CreateTrigger()
    call TriggerRegisterAnyUnitEventBJ(oV,EVENT_PLAYER_UNIT_TRAIN_FINISH)
    call TriggerAddAction(oV,function af)

    set rV=CreateTrigger()
    call TriggerRegisterEnterRectSimple(rV,bj_mapInitialPlayableArea)
    call TriggerAddCondition(rV,Condition(function Ef))

    set XV=Filter(function Vf)
    set iV=CreateTrigger()
    call TriggerRegisterAnyUnitEventBJ(iV,EVENT_PLAYER_UNIT_CHANGE_OWNER)
    call TriggerAddAction(iV,function Of)

    set aV=CreateTrigger()
    call TriggerRegisterAnyUnitEventBJ(aV,EVENT_PLAYER_UNIT_SUMMON)
    call TriggerAddAction(aV,function If)
endfunction
function config takes nothing returns nothing
    call SetMapName("Castle Fight 1.30 (SL)")
    call SetMapDescription("An epic battle between the two castles!\n")
    call SetPlayers(6)
    call SetTeams(6)
    call SetGamePlacement(MAP_PLACEMENT_TEAMS_TOGETHER)
    call DefineStartLocation(0,-4416.,448.)
    call DefineStartLocation(1,-4416.,320.)
    call DefineStartLocation(2,-4416.,192.)
    call DefineStartLocation(3,4416.,448.)
    call DefineStartLocation(4,4416.,320.)
    call DefineStartLocation(5,4416.,192.)
    call SetPlayerStartLocation(Player(0),0)
    call ForcePlayerStartLocation(Player(0),0)
    call SetPlayerColor(Player(0),ConvertPlayerColor(0))
    call SetPlayerRacePreference(Player(0),RACE_PREF_NIGHTELF)
    call SetPlayerRaceSelectable(Player(0),false)
    call SetPlayerController(Player(0),MAP_CONTROL_USER)
    call SetPlayerStartLocation(Player(1),1)
    call ForcePlayerStartLocation(Player(1),1)
    call SetPlayerColor(Player(1),ConvertPlayerColor(1))
    call SetPlayerRacePreference(Player(1),RACE_PREF_NIGHTELF)
    call SetPlayerRaceSelectable(Player(1),false)
    call SetPlayerController(Player(1),MAP_CONTROL_USER)
    call SetPlayerStartLocation(Player(2),2)
    call ForcePlayerStartLocation(Player(2),2)
    call SetPlayerColor(Player(2),ConvertPlayerColor(2))
    call SetPlayerRacePreference(Player(2),RACE_PREF_NIGHTELF)
    call SetPlayerRaceSelectable(Player(2),false)
    call SetPlayerController(Player(2),MAP_CONTROL_USER)
    call SetPlayerStartLocation(Player(6),3)
    call ForcePlayerStartLocation(Player(6),3)
    call SetPlayerColor(Player(6),ConvertPlayerColor(6))
    call SetPlayerRacePreference(Player(6),RACE_PREF_UNDEAD)
    call SetPlayerRaceSelectable(Player(6),false)
    call SetPlayerController(Player(6),MAP_CONTROL_USER)
    call SetPlayerStartLocation(Player(7),4)
    call ForcePlayerStartLocation(Player(7),4)
    call SetPlayerColor(Player(7),ConvertPlayerColor(7))
    call SetPlayerRacePreference(Player(7),RACE_PREF_UNDEAD)
    call SetPlayerRaceSelectable(Player(7),false)
    call SetPlayerController(Player(7),MAP_CONTROL_USER)
    call SetPlayerStartLocation(Player(8),5)
    call ForcePlayerStartLocation(Player(8),5)
    call SetPlayerColor(Player(8),ConvertPlayerColor(8))
    call SetPlayerRacePreference(Player(8),RACE_PREF_UNDEAD)
    call SetPlayerRaceSelectable(Player(8),false)
    call SetPlayerController(Player(8),MAP_CONTROL_USER)
    call InitCustomTeams()
    call SetStartLocPrioCount(0,1)
    call SetStartLocPrio(0,0,1,MAP_LOC_PRIO_HIGH)
    call SetStartLocPrioCount(1,2)
    call SetStartLocPrio(1,0,0,MAP_LOC_PRIO_HIGH)
    call SetStartLocPrio(1,1,2,MAP_LOC_PRIO_HIGH)
    call SetStartLocPrioCount(2,1)
    call SetStartLocPrio(2,0,1,MAP_LOC_PRIO_HIGH)
    call SetStartLocPrioCount(3,1)
    call SetStartLocPrio(3,0,4,MAP_LOC_PRIO_HIGH)
    call SetStartLocPrioCount(4,2)
    call SetStartLocPrio(4,0,3,MAP_LOC_PRIO_HIGH)
    call SetStartLocPrio(4,1,5,MAP_LOC_PRIO_HIGH)
    call SetStartLocPrioCount(5,1)
    call SetStartLocPrio(5,0,4,MAP_LOC_PRIO_HIGH)
endfunction
function Nf takes nothing returns nothing
call ExecuteFunc("sV")
call ExecuteFunc("SetupBounty")
call ExecuteFunc("SetupDebugLog")
call ExecuteFunc("SetupFirstBuilderBounty")
call ExecuteFunc("LE")
call ExecuteFunc("YE")
call ExecuteFunc("SetupStartLocation")
call ExecuteFunc("SetupMapArea")
call ExecuteFunc("nO")
call ExecuteFunc("InitialSetups")
call ExecuteFunc("bR")
call ExecuteFunc("SetupRaces")
call ExecuteFunc("tR")
call ExecuteFunc("AA")
call ExecuteFunc("kA")
call ExecuteFunc("InitialGameStart")
call ExecuteFunc("cN")
call ExecuteFunc("mN")
call ExecuteFunc("uN")
call ExecuteFunc("Vb")
call ExecuteFunc("Sb")
call ExecuteFunc("oB")
call ExecuteFunc("DB")
call ExecuteFunc("TB")
call ExecuteFunc("vc")
call ExecuteFunc("Jc")
call ExecuteFunc("oC")
call ExecuteFunc("cC")
call ExecuteFunc("LC")
call ExecuteFunc("PC")
call ExecuteFunc("SetupCommandDetect")
call ExecuteFunc("Dd")
call ExecuteFunc("CreateDrawTrigger")
call ExecuteFunc("StartGame")
endfunction
